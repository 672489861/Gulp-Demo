angular.module("app.contract",["app.contract.primary","app.contract.material.purchase","app.contract.material.lease","app.contract.subcontract","app.contract.equipment.purchase","app.contract.equipment.lease","app.contract.other","app.contract.equipment.lease","app.contract.other","app.contract.account"]),angular.module("app.device",["app.device.information","app.device.inspection.inspection-remind","app.device.inspection.inspection-record","app.device.maintain.maintain-remind","app.device.maintain.maintain-record"]).filter("showAttachType",function(){return function(fileName){var url="";switch(fileName){case 0:url="检验证书";break;case 1:url="合格证书";break;case 2:url="使用证书"}return url}}),angular.module("app.market",["app.market.ep"]).filter("prjAttachType",function(){return function(fileName){var url="";switch(fileName){case 1:url="中标通知书";break;case 2:url="承包合同";break;case 3:url="施工许可证";break;case 4:url="竣工验收证明";break;case 5:url="项目矢量效果图";break;case 6:url="工程实景图"}return url}}).filter("sexFilter",function(){return function(sex){var url="不限";return 0==sex&&(url="男"),1==sex&&(url="女"),url}}).filter("insureFilter",function(){return function(sex){var url="不限";return 0==sex&&(url="未参保"),1==sex&&(url="已参保"),url}}),angular.module("app.merchant",["app.merchant.information"]),angular.module("app.quality",["app.quality.check"]),angular.module("app.safety",["app.safety.dailyCheck","app.safety.multipleCheck","app.safety.safetyData"]),angular.module("app.subcontract",["app.subcontract.team","app.subcontract.person","app.subcontract.salary","app.subcontract.merchant","app.subcontract.contract","app.subcontract.measure","app.subcontract.settlement"]),angular.module("app.subcontract").factory("SubContractCommonService",["YTService","UserService",function(YT,userService){return{queryMerchantList:function(moduleId,callback){var data={m:moduleId,t:"v_merchant_list",order:"id",filter:JSON.stringify([{field:"orgId",value:userService.getRootOrgId(),operator:"=",relation:""}])};YT.query({data:data,successCallback:function(result){return callback(200==result.status?result.object:[])}})},queryTeamList:function(moduleId,callback){var data={m:moduleId,t:"v_subcontract_team",order:"id",filter:JSON.stringify([{field:"orgId",value:userService.getRootOrgId(),operator:"=",relation:""}])};YT.query({data:data,successCallback:function(result){return callback(200==result.status?result.object:[])}})},queryWorkTypeList:function(moduleId,callback){var data={m:moduleId,t:"subcontract_d_worktype",order:"id"};YT.query({data:data,successCallback:function(result){return callback(200==result.status?result.object:[])}})},queryContractList:function(moduleId,callback){var data={m:moduleId,t:"v_contract_subcontract",order:"id"};YT.query({data:data,successCallback:function(result){return callback(200==result.status?result.object:[])}})}}}]),angular.module("app.contract.account",[]).config(function($stateProvider,$urlRouterProvider){$stateProvider.state("contract/account/account-list",{url:"contract/account/account-list",templateUrl:"modules/contract/account/account-list.html",controller:"accountListController"}).state("contract/account/account-detail",{url:"contract/account/account-detail",templateUrl:"modules/contract/account/account-detail.html",controller:"accountDetailController",params:{id:-1}})}),angular.module("app.contract.other",[]).config(function($stateProvider,$urlRouterProvider){$stateProvider.state("contract/other/other-list",{url:"contract/other/other-list",templateUrl:"modules/contract/other/other-list.html",controller:"OtherListController"}).state("contract/other/other-detail",{url:"contract/other/other-detail",templateUrl:"modules/contract/other/other-detail.html",controller:"OtherDetailController",params:{id:null}}).state("contract/other/invoice-info",{url:"contract/other/invoice-info",templateUrl:"modules/contract/other/invoice-info.html",controller:"OtherInvoiceController"})}),angular.module("app.contract.primary",[]).config(function($stateProvider,$urlRouterProvider){$stateProvider.state("contract/primary/primary-list",{url:"contract/primary/primary-list",templateUrl:"modules/contract/primary/primary-list.html",controller:"PrimaryListController"}).state("contract/primary/primary-detail",{url:"contract/primary/primary-detail",templateUrl:"modules/contract/primary/primary-detail.html",controller:"PrimaryDetailController",params:{id:null}})}),angular.module("app.contract.subcontract",[]).config(function($stateProvider,$urlRouterProvider){$stateProvider.state("contract/subcontract/subcontract-list",{url:"contract/subcontract/subcontract-list",templateUrl:"modules/contract/subcontract/subcontract-list.html",controller:"SubcontractListController"}).state("contract/subcontract/subcontract-detail",{url:"contract/subcontract/subcontract-detail",templateUrl:"modules/contract/subcontract/subcontract-detail.html",controller:"SubcontractDetailController",params:{id:null}}).state("contract/subcontract/subcontract-info",{url:"contract/subcontract/subcontract-info",templateUrl:"modules/contract/subcontract/subcontract-info.html",controller:"SubcontractSubcontractController"}).state("contract/subcontract/charges-info",{url:"contract/subcontract/charges-info",templateUrl:"modules/contract/subcontract/charges-info.html",controller:"SubcontractChargesController"}).state("contract/subcontract/invoice-info",{url:"contract/subcontract/invoice-info",templateUrl:"modules/contract/subcontract/invoice-info.html",controller:"SubcontractInvoiceController"})}),angular.module("app.device.information",[]).config(function($stateProvider,$urlRouterProvider){$stateProvider.state("device/information/device-info-list",{url:"device/information/device-info-list",templateUrl:"modules/device/information/device-info-list.html",controller:"DeviceListController"}).state("device/information/device-info-detail",{url:"device/information/device-info-detail",templateUrl:"modules/device/information/device-info-detail.html",controller:"DeviceDetailController",params:{id:null}})}),angular.module("app.market.ep",["app.market.ep.employee","app.market.ep.project"]),angular.module("app.merchant.information",[]).config(function($stateProvider,$urlRouterProvider){$stateProvider.state("merchant/information/merchant-info-list",{url:"merchant/information/merchant-info-list",templateUrl:"modules/merchant/information/merchant-info-list.html",controller:"MerchantInfoListController"}).state("merchant/information/merchant-info-detail",{url:"merchant/information/merchant-info-detail",templateUrl:"modules/merchant/information/merchant-info-detail.html",controller:"MerchantInfoDetailController",params:{id:null}}).state("merchant/information/merchant-attachment-detail",{url:"merchant/information/merchant-attachment-detail",templateUrl:"modules/merchant/information/merchant-attachment-detail.html",controller:"MerchantAttachmentDetailController",params:{merchantBaseAttachList:null}}).state("merchant/information/merchant-safety-permit-detail",{url:"merchant/information/merchant-safety-permit-detail",templateUrl:"modules/merchant/information/merchant-safety-permit-detail.html",controller:"MerchantSafetyPermitDetailController",params:{merchantSafetyPermitDetail:null}}).state("merchant/information/merchant-qualification-detail",{url:"merchant/information/merchant-qualification-detail",templateUrl:"modules/merchant/information/merchant-qualification-detail.html",controller:"MerchantQualificationDetailController",params:{merchantQualificationDetail:null}})}),angular.module("app.quality.check",[]).config(function($stateProvider,$urlRouterProvider){$stateProvider.state("quality/check/quality-list",{url:"quality/check/quality-list",templateUrl:"modules/quality/check/quality-list.html",controller:"qualityCheckListController"}).state("quality/check/quality-detail",{url:"quality/check/quality-detail",templateUrl:"modules/quality/check/quality-detail.html",controller:"qualityCheckDetailController",params:{id:null,backUrl:null}}).state("quality/check/quality-add",{url:"quality/check/quality-add",templateUrl:"modules/quality/check/quality-add.html",controller:"qualityCheckAddController",params:{type:"add",backUrl:null}}).state("quality/check/quality-solver",{url:"quality/check/quality-solver",templateUrl:"modules/quality/check/quality-solver.html",controller:"qualityCheckSolverController",params:{backUrl:null}}).state("quality/check/quality-content",{url:"quality/check/quality-content",templateUrl:"modules/quality/check/quality-content.html",controller:"qualityCheckContentController",params:{backUrl:null}}).state("quality/check/quality-content-problem",{url:"quality/check/quality-content-problem",templateUrl:"modules/quality/check/quality-content-problem.html",controller:"qualityCheckContentProblemController",params:{type:null,id:null,backUrl:null}}).state("quality/check/quality-edit",{url:"quality/check/quality-edit",templateUrl:"modules/quality/check/quality-add.html",controller:"qualityCheckEditController",params:{type:"edit",id:null,backUrl:null}}).state("quality/check/quality-drafts-list",{url:"quality/check/quality-drafts-list",templateUrl:"modules/quality/check/quality-drafts-list.html",controller:"qualityCheckDraftsListController"}).state("quality/check/quality-drafts-edit",{url:"quality/check/quality-drafts-edit",templateUrl:"modules/quality/check/quality-add.html",controller:"qualityCheckDraftsEditController",params:{type:"draft",id:null}}).state("quality/check/quality-solve",{url:"quality/check/quality-solve",templateUrl:"modules/quality/check/quality-solve.html",controller:"qualityCheckSolveController",params:{id:null,backUrl:null}}).state("quality/check/quality-recheck",{url:"quality/check/quality-recheck",templateUrl:"modules/quality/check/quality-recheck.html",controller:"qualityCheckRecheckController",params:{id:null,backUrl:null}}).state("quality/check/canvas",{url:"quality/check/canvas",templateUrl:"modules/quality/check/canvas.html",controller:"qualityCheckCanvasController",params:{image:null,index:null,backUrl:null}})}),angular.module("app.safety.dailyCheck",[]).config(function($stateProvider,$urlRouterProvider){$stateProvider.state("safety/dailyCheck/dailyCheck-list",{url:"safety/dailyCheck/dailyCheck-list",templateUrl:"modules/safety/dailyCheck/dailyCheck-list.html",controller:"dailyCheckListController"}).state("safety/dailyCheck/dailyCheck-detail",{url:"safety/dailyCheck/dailyCheck-detail",templateUrl:"modules/safety/dailyCheck/dailyCheck-detail.html",controller:"dailyCheckDetailController",params:{id:null,backUrl:null}}).state("safety/dailyCheck/dailyCheck-add",{url:"safety/dailyCheck/dailyCheck-add",templateUrl:"modules/safety/dailyCheck/dailyCheck-add.html",controller:"dailyCheckAddController",params:{type:"add",backUrl:null}}).state("safety/dailyCheck/dailyCheck-position",{url:"safety/dailyCheck/dailyCheck-position",templateUrl:"modules/safety/dailyCheck/dailyCheck-position.html",controller:"dailyCheckPositionController",params:{backUrl:null}}).state("safety/dailyCheck/dailyCheck-solver",{url:"safety/dailyCheck/dailyCheck-solver",templateUrl:"modules/safety/dailyCheck/dailyCheck-solver.html",controller:"dailyCheckSolverController",params:{backUrl:null}}).state("safety/dailyCheck/dailyCheck-content",{url:"safety/dailyCheck/dailyCheck-content",templateUrl:"modules/safety/dailyCheck/dailyCheck-content.html",controller:"dailyCheckContentController",params:{backUrl:null}}).state("safety/dailyCheck/dailyCheck-content-item",{url:"safety/dailyCheck/dailyCheck-content-item",templateUrl:"modules/safety/dailyCheck/dailyCheck-content-item.html",controller:"dailyCheckContentItemController",params:{id:null,backUrl:null}}).state("safety/dailyCheck/dailyCheck-content-item-problem",{url:"safety/dailyCheck/dailyCheck-content-item-problem",templateUrl:"modules/safety/dailyCheck/dailyCheck-content-item-problem.html",controller:"dailyCheckContentItemProblemController",params:{type:null,pId:null,id:null,backUrl:null}}).state("safety/dailyCheck/dailyCheck-edit",{url:"safety/dailyCheck/dailyCheck-edit",templateUrl:"modules/safety/dailyCheck/dailyCheck-add.html",controller:"dailyCheckEditController",params:{type:"edit",id:null,backUrl:null}}).state("safety/dailyCheck/dailyCheck-drafts-list",{url:"safety/dailyCheck/dailyCheck-drafts-list",templateUrl:"modules/safety/dailyCheck/dailyCheck-drafts-list.html",controller:"dailyCheckDraftsListController"}).state("safety/dailyCheck/dailyCheck-drafts-edit",{url:"safety/dailyCheck/dailyCheck-drafts-edit",templateUrl:"modules/safety/dailyCheck/dailyCheck-add.html",controller:"dailyCheckDraftsEditController",params:{type:"draft",id:null}}).state("safety/dailyCheck/dailyCheck-solve",{url:"safety/dailyCheck/dailyCheck-solve",templateUrl:"modules/safety/dailyCheck/dailyCheck-solve.html",controller:"dailyCheckSolveController",params:{id:null,backUrl:null}}).state("safety/dailyCheck/dailyCheck-recheck",{url:"safety/dailyCheck/dailyCheck-recheck",templateUrl:"modules/safety/dailyCheck/dailyCheck-recheck.html",controller:"dailyCheckRecheckController",params:{id:null,backUrl:null}}).state("safety/dailyCheck/canvas",{url:"safety/dailyCheck/canvas",templateUrl:"modules/safety/dailyCheck/canvas.html",controller:"dailyCheckCanvasController",params:{image:null,index:null,backUrl:null}})}),angular.module("app.safety.safetyData",[]).config(function($stateProvider,$urlRouterProvider){$stateProvider.state("safety/safetyData/safetyData-list",{url:"safety/safetyData/safetyData-list",templateUrl:"modules/safety/safetyData/safetyData-list.html",controller:"SafetyDataListController"}).state("safety/safetyData/safetyData-detail",{url:"safety/safetyData/safetyData-detail",templateUrl:"modules/safety/safetyData/safetyData-detail.html",params:{data:null},controller:"SafetyDataDetailController"}).state("safety/safetyData/safetyData-kinds-detail",{url:"safety/safetyData/safetyData-kinds-detail",templateUrl:"modules/safety/safetyData/safetyData-kinds-detail.html",params:{subs:[]},controller:"SafetyDataKindsDetailController"})}),angular.module("app.safety.multipleCheck",[]).config(function($stateProvider,$urlRouterProvider){$stateProvider.state("safety/multipleCheck/multipleCheck-list",{url:"safety/multipleCheck/multipleCheck-list",templateUrl:"modules/safety/multipleCheck/multipleCheck-list.html",controller:"multipleCheckListController"}).state("safety/multipleCheck/multipleCheck-item-list",{url:"safety/multipleCheck/multipleCheck-item-list",templateUrl:"modules/safety/multipleCheck/multipleCheck-item-list.html",controller:"multipleCheckItemListController",params:{projectId:null,backUrl:null,editId:null}}).state("safety/multipleCheck/multipleCheck-item-detail",{url:"safety/multipleCheck/multipleCheck-item-detail",templateUrl:"modules/safety/multipleCheck/multipleCheck-item-detail.html",controller:"multipleCheckItemDetailController",params:{id:null,backUrl:null}}).state("safety/multipleCheck/multipleCheck-item-detail-random-info",{url:"safety/multipleCheck/multipleCheck-item-detail-random-info",templateUrl:"modules/safety/multipleCheck/multipleCheck-item-detail-random-info.html",controller:"multipleCheckItemDetailRandomInfoController",params:{id:null,backUrl:null}}).state("safety/multipleCheck/multipleCheck-item-add",{url:"safety/multipleCheck/multipleCheck-item-add",templateUrl:"modules/safety/multipleCheck/multipleCheck-item-add.html",controller:"multipleCheckItemAddController",params:{projectId:null,backUrl:null,editId:null}}).state("safety/multipleCheck/multipleCheck-person-info-edit",{url:"safety/multipleCheck/multipleCheck-person-info-edit",templateUrl:"modules/safety/multipleCheck/multipleCheck-person-info-edit.html",controller:"multipleCheckPersonInfoEditController",params:{backUrl:null}}).state("safety/multipleCheck/multipleCheck-project-info-edit",{url:"safety/multipleCheck/multipleCheck-project-info-edit",templateUrl:"modules/safety/multipleCheck/multipleCheck-project-info-edit.html",controller:"multipleCheckProjectInfoEditController",params:{backUrl:null}}).state("safety/multipleCheck/multipleCheck-structure-type",{url:"safety/multipleCheck/multipleCheck-structure-type",templateUrl:"modules/safety/multipleCheck/multipleCheck-structure-type.html",controller:"multipleCheckStructureTypeController",params:{backUrl:null,preBackUrl:null}}).state("safety/multipleCheck/multipleCheck-project-status",{url:"safety/multipleCheck/multipleCheck-project-status",templateUrl:"modules/safety/multipleCheck/multipleCheck-project-status.html",controller:"multipleCheckProjectStatusController",params:{backUrl:null}}).state("safety/multipleCheck/multipleCheck-advice-text",{url:"safety/multipleCheck/multipleCheck-advice-text",templateUrl:"modules/safety/multipleCheck/multipleCheck-advice-text.html",controller:"multipleCheckAdviceTextController",params:{backUrl:null}}).state("safety/multipleCheck/multipleCheck-checker-list",{url:"safety/multipleCheck/multipleCheck-checker-list",templateUrl:"modules/safety/multipleCheck/multipleCheck-checker-list.html",controller:"multipleCheckCheckerListController",params:{backUrl:null}}).state("safety/multipleCheck/multipleCheck-item-add-random-info",{url:"safety/multipleCheck/multipleCheck-item-add-random-info",templateUrl:"modules/safety/multipleCheck/multipleCheck-item-add-random-info.html",controller:"multipleCheckItemAddRandomInfoController",params:{backUrl:null}}).state("safety/multipleCheck/multipleCheck-check-position",{url:"safety/multipleCheck/multipleCheck-check-position",templateUrl:"modules/safety/multipleCheck/multipleCheck-check-position.html",controller:"multipleCheckPositionController",params:{backUrl:null}}).state("safety/multipleCheck/multipleCheck-content",{url:"safety/multipleCheck/multipleCheck-content",templateUrl:"modules/safety/multipleCheck/multipleCheck-content.html",controller:"multipleCheckContentController",params:{index:null,backUrl:null}}).state("safety/multipleCheck/multipleCheck-content-item",{url:"safety/multipleCheck/multipleCheck-content-item",templateUrl:"modules/safety/multipleCheck/multipleCheck-content-item.html",controller:"multipleCheckContentItemController",params:{index:null,id:null,backUrl:null}}).state("safety/multipleCheck/multipleCheck-content-item-problem",{url:"safety/multipleCheck/multipleCheck-content-item-problem",templateUrl:"modules/safety/multipleCheck/multipleCheck-content-item-problem.html",controller:"multipleCheckContentItemProblemController",params:{index:null,pId:null,id:null,backUrl:null}}).state("safety/multipleCheck/canvas",{url:"safety/multipleCheck/canvas",templateUrl:"modules/safety/multipleCheck/canvas.html",controller:"multipleCheckCanvasController",params:{editId:null,image:null,groupIndex:null,index:null,backUrl:null}}).state("safety/multipleCheck/multipleCheck-item-edit",{url:"safety/multipleCheck/multipleCheck-item-edit",templateUrl:"modules/safety/multipleCheck/multipleCheck-item-add.html",controller:"multipleCheckItemEditController",params:{id:null,backUrl:null}}).state("safety/multipleCheck/multipleCheck-storage-list",{url:"safety/multipleCheck/multipleCheck-storage-list",templateUrl:"modules/safety/multipleCheck/multipleCheck-storage-list.html",controller:"multipleCheckStorageListController",params:{projectId:null,backUrl:null}}).state("safety/multipleCheck/multipleCheck-storage-edit",{url:"safety/multipleCheck/multipleCheck-storage-edit",templateUrl:"modules/safety/multipleCheck/multipleCheck-item-add.html",controller:"multipleCheckStorageEditController",params:{id:null,backUrl:null}}).state("safety/multipleCheck/multipleCheck-detail-project-status",{url:"safety/multipleCheck/multipleCheck-detail-project-status",templateUrl:"modules/safety/multipleCheck/multipleCheck-detail-project-status.html",controller:"multipleCheckDetailProjectStatusController",params:{backUrl:null}}).state("safety/multipleCheck/multipleCheck-detail-advice-text",{url:"safety/multipleCheck/multipleCheck-detail-advice-text",templateUrl:"modules/safety/multipleCheck/multipleCheck-detail-advice-text.html",controller:"multipleCheckDetailAdviceTextController",params:{backUrl:null}})}),angular.module("app.subcontract.contract",[]).config(function($stateProvider,$urlRouterProvider){$stateProvider.state("subcontract/contract/contract-list",{url:"subcontract/contract/contract-list",templateUrl:"modules/subcontract/contract/contract-list.html",controller:"ContractListController"})}),angular.module("app.subcontract.merchant",[]).config(function($stateProvider,$urlRouterProvider){$stateProvider.state("subcontract/merchant/merchant-list",{url:"subcontract/merchant/merchant-list",templateUrl:"modules/subcontract/merchant/merchant-list.html",controller:"MerchantListController"})}),angular.module("app.subcontract.measure",[]).config(function($stateProvider,$urlRouterProvider){$stateProvider.state("subcontract/measure/measure-list",{url:"subcontract/measure/measure-list",templateUrl:"modules/subcontract/measure/measure-list.html",controller:"MeasureListController"}).state("subcontract/measure/measure-detail",{url:"subcontract/measure/measure-detail",templateUrl:"modules/subcontract/measure/measure-detail.html",controller:"MeasureDetailController",params:{id:null}}).state("subcontract/measure/measure-contract-list",{url:"subcontract/measure/measure-contract-list",templateUrl:"modules/subcontract/measure/measure-contract-list.html",controller:"MeasureContractListController",params:{id:null,merchantId:null,merchantName:""}}).state("subcontract/measure/measure-team-list",{url:"subcontract/measure/measure-team-list",templateUrl:"modules/subcontract/measure/measure-team-list.html",controller:"MeasureTeamListController",params:{id:null,contractId:null,contractName:""}})}),angular.module("app.subcontract.person",[]).config(function($stateProvider,$urlRouterProvider){$stateProvider.state("subcontract/person/person-list",{url:"subcontract/person/person-list",templateUrl:"modules/subcontract/person/person-list.html",controller:"PersonListController"}).state("subcontract/person/person-detail",{url:"subcontract/person/person-detail",templateUrl:"modules/subcontract/person/person-detail.html",controller:"PersonDetailController",params:{personId:null}})}),angular.module("app.subcontract.salary",[]).config(function($stateProvider,$urlRouterProvider){$stateProvider.state("subcontract/salary/salary-list",{url:"subcontract/salary/salary-list",templateUrl:"modules/subcontract/salary/salary-list.html",controller:"SalaryListController"}).state("subcontract/salary/salary-detail",{url:"subcontract/salary/salary-detail",templateUrl:"modules/subcontract/salary/salary-detail.html",controller:"SalaryDetailController",params:{personId:null}})}),angular.module("app.subcontract.settlement",[]).config(function($stateProvider,$urlRouterProvider){$stateProvider.state("subcontract/settlement/settlement-list",{url:"subcontract/settlement/settlement-list",templateUrl:"modules/subcontract/settlement/settlement-list.html",controller:"SettlementListController"}).state("subcontract/settlement/settlement-detail",{url:"subcontract/settlement/settlement-detail",templateUrl:"modules/subcontract/settlement/settlement-detail.html",controller:"SettlementDetailController",params:{settlementId:null}})}),angular.module("app.subcontract.team",[]).config(function($stateProvider,$urlRouterProvider){$stateProvider.state("subcontract/team/team-list",{url:"subcontract/team/team-list",templateUrl:"modules/subcontract/team/team-list.html",controller:"TeamListController"}).state("subcontract/team/team-detail",{url:"subcontract/team/team-detail",templateUrl:"modules/subcontract/team/team-detail.html",controller:"TeamDetailController",params:{id:null}})}),angular.module("app.contract.account").controller("accountDetailController",["$scope","$stateParams","AccountService",function($scope,$stateParams,AccountService){$scope.projectInfo=!0,$scope.reportDetail=!0,$scope.projectInfoShow=function(){$scope.projectInfo=!$scope.projectInfo},$scope.reportDetailShow=function(){$scope.reportDetail=!$scope.reportDetail},$scope.$on("$ionicView.loaded",function(){AccountService.queryDetail($stateParams.id,function(data){$scope.detail=data}),AccountService.queryReport($stateParams.id,function(data){$scope.report=data})})}]),angular.module("app.contract.account").controller("accountListController",["$scope","$state","$ionicViewSwitcher","AccountService",function($scope,$state,$ionicViewSwitcher,AccountService){$scope.filterFlag=!1,$scope.$on("$ionicView.loaded",function(){$scope.condition.searchText="",$scope.accountList=AccountService.getServiceData(),$scope.hasNextPage=AccountService.hasNextPage()}),$scope.loadListData=function(){AccountService.loadListData(function(){$scope.fillData(),$scope.$broadcast("scroll.infiniteScrollComplete")})},$scope.refreshListData=function(){AccountService.refreshListData(function(){$scope.fillData(),$scope.$broadcast("scroll.refreshComplete")})},$scope.fillData=function(){$scope.accountList=AccountService.getServiceData(),$scope.hasNextPage=AccountService.hasNextPage()},$scope.condition=AccountService.getCondition(),$scope.resetFilter=function(){$scope.filterFlag=!0},$scope.searchFilter=function(value){var returnFlag=!0;if(""!=$scope.condition.searchText||null!=$scope.condition.searchText){var flag1=value.displayId.indexOf($scope.condition.searchText)>=0,flag2=value.projectName.indexOf($scope.condition.searchText)>=0,flag3=value.orgName.indexOf($scope.condition.searchText)>=0;returnFlag=flag1||flag2||flag3}return returnFlag&&($scope.filterFlag=!1),returnFlag},$scope.clearSearchText=function(){$scope.condition.searchText=""},$scope.back=function(){$state.go("menu"),$ionicViewSwitcher.nextDirection("back")}}]),angular.module("app.contract.account").factory("AccountService",["YTService","UserService",function(YT,userService){var nowYear,nowMonth,serviceData=[],pageIndex=0,pageSize=10,hasNextPage=!0,condition={searchText:""},typeId=userService.getTypeId(),orgId=userService.getRootOrgId();return{getModule:function(){var module=6003001001;return YT.haveRight(6003001004)?module=6003001004:YT.haveRight(6003001003)?module=6003001003:YT.haveRight(6003001002)?module=6003001002:YT.haveRight(6003001001)?module=6003001001:void 0},getSysParam:function(callback){var self=this;YT.getOwnerGroupId(function(data){var filter=[{field:"name",value:"contract-report-begin-time",operator:"=",relation:"AND"},{field:"orgId",value:data,operator:"=",relation:"AND"}],data={m:self.getModule(),t:"sys_param",filter:JSON.stringify(filter)};YT.query({data:data,successCallback:function(data){if(200==data.status){var now=new Date,nowYear=now.getFullYear(),nowMonth=now.getMonth()+1,day=now.getDate();day<=data.object[0].reportTime&&(1==nowMonth&&(nowYear-=1),nowMonth-=1),callback({nowYear:nowYear,nowMonth:nowMonth})}}})})},getAccount:function(id,callback){var filter=[],field="orgId";id&&filter.push({field:"contractId",value:id,operator:"=",relation:"AND"}),1==typeId&&(field="groupId"),filter.push({field:field,value:orgId,operator:"=",relation:"AND"},{field:"year",value:nowYear,operator:"=",relation:"AND"},{field:"month",value:nowMonth,operator:"=",relation:"AND"});var data={m:this.getModule(),t:"v_contract_account",filter:JSON.stringify(filter),params:JSON.stringify({year:nowYear,month:nowMonth})};YT.query({data:data,successCallback:function(data){if(200==data.status){for(var items=data.object,list=[],i=0;i<items.length;i++)list[items[i].contractId]=items[i];callback(list)}}})},setAccountList:function(id,contractList,callback){var self=this;self.getSysParam(function(data){nowYear=data.nowYear,nowMonth=data.nowMonth,self.getAccount(id,function(data){for(var i=0;i<contractList.length;i++){var obj=data[contractList[i].id];void 0!=obj&&(contractList[i].monthReportAmount=obj.monthReportAmount,contractList[i].monthContractReport=obj.monthContractReport,contractList[i].agoContractReport=obj.agoContractReport)}callback(contractList)})})},loadListData:function(successCallback){++pageIndex;var self=this;YT.query({data:self.getSearchData(),successCallback:function(data){var items=data.object.items,contractList=data;self.setAccountList(null,items,function(data){contractList.object.items=data,self.loadListDataCallback(contractList),successCallback.call()})}})},loadListDataCallback:function(data){for(var pageInfo=data.object,i=0;i<pageInfo.items.length;i++)serviceData.push(pageInfo.items[i]);hasNextPage=!(pageIndex>=pageInfo.pageCount)},refreshListData:function(successCallBack){this.clearCachedData(),this.loadListData(successCallBack)},clearCachedData:function(){condition.searchText="",pageIndex=0,hasNextPage=!0,serviceData=[]},getSearchData:function(){var data={m:this.getModule(),t:"v_contract_primary_processing",order:"reviewTime desc, submitTime desc",page:pageIndex,rows:pageSize},filter=this.getSearchFilter();return data.filter=JSON.stringify(filter),data},getSearchFilter:function(){var filter=[],field="orgId";return 1==typeId&&(field="groupId"),filter.push({field:field,value:orgId,operator:"=",relation:"AND"}),filter},queryDetail:function(id,successCallback){var self=this,filter=[{field:"id",value:id,operator:"=",relation:"and"}],data={m:this.getModule(),t:"v_contract_primary_processing",filter:JSON.stringify(filter)};YT.query({data:data,successCallback:function(data){self.setAccountList(id,data.object,function(data){successCallback.call(this,data[0])})}})},queryReport:function(id,successCallback){var filter=[{field:"contractId",value:id,operator:"=",relation:"and"}],data={m:this.getModule(),t:"contract_account_report_detail",filter:JSON.stringify(filter),order:"year desc, month desc"};YT.query({data:data,successCallback:function(data){for(var items=data.object,list=[],report={},i=0;i<items.length;i++){var obj=items[i];if(0==i)report={},report.year=obj.year,report.amount=obj.amount,report.list=[],list.push(report);else{var oldObj=items[i-1];obj.year!=oldObj.year?(report={},report.year=obj.year,report.amount=obj.amount,report.list=[],list.push(report)):report.amount+=obj.amount}list[list.length-1].list.push(obj)}successCallback.call(this,list)}})},getCondition:function(){return condition},getServiceData:function(){return serviceData},hasNextPage:function(){return hasNextPage}}}]),angular.module("app.contract.equipment.lease",[]).config(function($stateProvider,$urlRouterProvider){$stateProvider.state("contract/equipment/lease/equipment-lease-list",{url:"contract/equipment/lease/equipment-lease-list",templateUrl:"modules/contract/equipment/lease/equipment-lease-list.html",controller:"EquipmentLeaseListController"}).state("contract/equipment/lease/equipment-lease-detail",{url:"contract/equipment/lease/equipment-lease-detail",templateUrl:"modules/contract/equipment/lease/equipment-lease-detail.html",controller:"EquipmentLeaseDetailController",params:{id:null}}).state("contract/equipment/lease/equipment-lease-equipment-info",{url:"contract/equipment/lease/equipment-lease-equipment-info",templateUrl:"modules/contract/equipment/lease/equipment-info.html",controller:"EquipmentLeaseEquipmentController"}).state("contract/equipment/lease/equipment-lease-charges-info",{url:"contract/equipment/lease/equipment-lease-charges-info",templateUrl:"modules/contract/equipment/lease/charges-info.html",controller:"EquipmentLeaseChargesController"}).state("contract/equipment/lease/equipment-lease-invoice-info",{url:"contract/equipment/lease/equipment-lease-invoice-info",templateUrl:"modules/contract/equipment/lease/invoice-info.html",controller:"EquipmentLeaseInvoiceController"})}),angular.module("app.contract.equipment.purchase",[]).config(function($stateProvider,$urlRouterProvider){$stateProvider.state("contract/equipment/purchase/equipment-purchase-list",{url:"contract/equipment/purchase/equipment-purchase-list",templateUrl:"modules/contract/equipment/purchase/equipment-purchase-list.html",controller:"EquipmentPurchaseListController"}).state("contract/equipment/purchase/equipment-purchase-detail",{url:"contract/equipment/purchase/equipment-purchase-detail",templateUrl:"modules/contract/equipment/purchase/equipment-purchase-detail.html",controller:"EquipmentPurchaseDetailController",
params:{id:null}}).state("contract/equipment/purchase/equipment-purchase-equipment-info",{url:"contract/equipment/purchase/equipment-purchase-equipment-info",templateUrl:"modules/contract/equipment/purchase/equipment-info.html",controller:"EquipmentPurchaseEquipmentController"}).state("contract/equipment/purchase/equipment-purchase-charges-info",{url:"contract/equipment/purchase/equipment-purchase-charges-info",templateUrl:"modules/contract/equipment/purchase/charges-info.html",controller:"EquipmentPurchaseChargesController"}).state("contract/equipment/purchase/equipment-purchase-invoice-info",{url:"contract/equipment/purchase/equipment-purchase-invoice-info",templateUrl:"modules/contract/equipment/purchase/invoice-info.html",controller:"EquipmentPurchaseInvoiceController"})}),angular.module("app.contract.material.lease",[]).config(function($stateProvider,$urlRouterProvider){$stateProvider.state("contract/material/lease/material-lease-list",{url:"contract/material/lease/material-lease-list",templateUrl:"modules/contract/material/lease/material-lease-list.html",controller:"MaterialLeaseListController"}).state("contract/material/lease/material-lease-detail",{url:"contract/material/lease/material-lease-detail",templateUrl:"modules/contract/material/lease/material-lease-detail.html",controller:"MaterialLeaseDetailController",params:{id:null}}).state("contract/material/lease/material-lease-material-info",{url:"contract/material/lease/material-lease-material-info",templateUrl:"modules/contract/material/lease/material-info.html",controller:"MaterialLeaseMaterialController"}).state("contract/material/lease/material-lease-charges-info",{url:"contract/material/lease/material-lease-charges-info",templateUrl:"modules/contract/material/lease/charges-info.html",controller:"MaterialLeaseChargesController"}).state("contract/material/lease/material-lease-invoice-info",{url:"contract/material/lease/material-lease-invoice-info",templateUrl:"modules/contract/material/lease/invoice-info.html",controller:"MaterialLeaseInvoiceController"})}),angular.module("app.contract.material.purchase",[]).config(function($stateProvider,$urlRouterProvider){$stateProvider.state("contract/material/purchase/material-purchase-list",{url:"contract/material/purchase/material-purchase-list",templateUrl:"modules/contract/material/purchase/material-purchase-list.html",controller:"MaterialPurchaseListController"}).state("contract/material/purchase/material-purchase-detail",{url:"contract/material/purchase/material-purchase-detail",templateUrl:"modules/contract/material/purchase/material-purchase-detail.html",controller:"MaterialPurchaseDetailController",params:{id:null}}).state("contract/material/purchase/material-purchase-material-info",{url:"contract/material/purchase/material-purchase-material-info",templateUrl:"modules/contract/material/purchase/material-info.html",controller:"MaterialPurchaseMaterialController"}).state("contract/material/purchase/material-purchase-charges-info",{url:"contract/material/purchase/material-purchase-charges-info",templateUrl:"modules/contract/material/purchase/charges-info.html",controller:"MaterialPurchaseChargesController"}).state("contract/material/purchase/material-purchase-invoice-info",{url:"contract/material/purchase/material-purchase-invoice-info",templateUrl:"modules/contract/material/purchase/invoice-info.html",controller:"MaterialPurchaseInvoiceController"})}),angular.module("app.contract.other").controller("OtherDetailController",["$scope","$state","$stateParams","OtherService","$sce",function($scope,$state,$stateParams,OtherService,$sce){$scope.projectInfo=!0,$scope.workmoney=!0,$scope.remark=!0,$scope.attachment=!0,$scope.bill=!0,$scope.contractContent=!0,$scope.projectInfoShow=function(){$scope.projectInfo=!$scope.projectInfo},$scope.workmoneyShow=function(){$scope.workmoney=!$scope.workmoney},$scope.remarkShow=function(){$scope.remark=!$scope.remark},$scope.attachmentShow=function(){$scope.attachment=!$scope.attachment},$scope.billShow=function(){$scope.bill=!$scope.bill},$scope.contractContentShow=function(){$scope.contractContent=!$scope.contractContent},$scope.$on("$ionicView.loaded",function(){OtherService.queryDetail($stateParams.id,function(data){$scope.otherInfo=data,$scope.formatMoney=YTM.tool.money.numberToChineseCurrency(data.cost),$scope.content=$sce.trustAsHtml(data.content),$scope.memo=$sce.trustAsHtml(data.memo)}),OtherService.queryInvoice($stateParams.id,function(data){$scope.invoiceLength=data.length}),OtherService.queryAttach($stateParams.id,function(data){$scope.attachInfo=data})}),$scope.downloadAttach=function(attach){OtherService.downloadAttach(attach)}}]),angular.module("app.contract.other").controller("OtherInvoiceController",["$scope","$state","$stateParams","OtherService",function($scope,$state,$stateParams,OtherService){$scope.$on("$ionicView.loaded",function(){$scope.invoiceInfo=OtherService.getInvoice()})}]),angular.module("app.contract.other").controller("OtherListController",["$scope","$state","$ionicHistory","$ionicModal","$ionicScrollDelegate","OtherService","$ionicViewSwitcher",function($scope,$state,$ionicHistory,$ionicModal,$ionicScrollDelegate,OtherService,$ionicViewSwitcher){$scope.condition=OtherService.getCondition(),$scope.$on("$ionicView.loaded",function(){$scope.otherList=OtherService.getServiceData(),$scope.hasNextPage=OtherService.hasNextPage()}),$scope.loadListData=function(){OtherService.loadListData(function(){$scope.fillData(),$scope.$broadcast("scroll.infiniteScrollComplete")})},$scope.refreshListData=function(){OtherService.refreshListData(function(){$scope.fillData(),$scope.$broadcast("scroll.refreshComplete")})},$scope.fillData=function(){$scope.otherList=OtherService.getServiceData(),$scope.hasNextPage=OtherService.hasNextPage()},$scope.searchData=function(){$scope.modalQueryMore.hide(),$scope.modal.hide(),OtherService.clearCachedData(),$ionicScrollDelegate.scrollTop(),$scope.loadListData()},$scope.back=function(){OtherService.clearCachedData(),OtherService.resetCondition(),$state.go("menu"),$ionicViewSwitcher.nextDirection("back")},$ionicModal.fromTemplateUrl("contract-status.html",{scope:$scope,animation:"slide-in-up"}).then(function(modal){$scope.modal=modal}),$scope.openContractStatus=function(){$scope.modal.show()},$scope.hideContractStatus=function(){$scope.modal.hide()},$ionicModal.fromTemplateUrl("query-more.html",{scope:$scope,animation:"slide-in-up"}).then(function(modal){$scope.modalQueryMore=modal}),$scope.openQueryMore=function(){$scope.modalQueryMore.show()},$scope.hideQueryMore=function(){$scope.modalQueryMore.hide()},$scope.clearSearchText=function(){OtherService.clearSearchText(),$scope.condition=OtherService.getCondition()}}]),angular.module("app.contract.other").factory("OtherService",["YTService","UserService","$ionicPopup",function(YT,userService,$ionicPopup){var serviceData=[],pageIndex=0,pageSize=10,hasNextPage=!0,condition={statusId:-1,displayId:"",firstPartyName:"",secondPartyName:"",projectName:""},invoiceInfo=[];return{clearSearchText:function(){condition={statusId:-1,displayId:"",firstPartyName:"",secondPartyName:"",projectName:""}},loadListData:function(successCallback){++pageIndex;var self=this;YT.query({data:self.getSearchData(),successCallback:function(data){self.loadListDataCallback(data),successCallback.call()}})},loadListDataCallback:function(data){for(var pageInfo=data.object,i=0;i<pageInfo.items.length;i++)serviceData.push(pageInfo.items[i]);hasNextPage=!(pageIndex>=pageInfo.pageCount)},refreshListData:function(successCallBack){this.clearCachedData(),this.loadListData(successCallBack)},clearCachedData:function(){pageIndex=0,hasNextPage=!0,serviceData=[]},getSearchData:function(){var data={m:6001007,t:"v_contract_othercontract",order:"id desc",page:pageIndex,rows:pageSize},filter=this.getSearchFilter();return data.filter=JSON.stringify(filter),data},getSearchFilter:function(){var typeId=userService.getTypeId(),rootId=userService.getRootOrgId(),filter=[];return condition.statusId!=-1&&filter.push({field:"statusId",value:condition.statusId,operator:"=",relation:"AND"}),""!=condition.displayId&&"请输入合同编号"!=condition.displayId&&filter.push({field:"displayId",value:"%"+condition.displayId+"%",operator:"like",relation:"and"}),""!=condition.projectName&&"请输入工程名称"!=condition.projectName&&filter.push({field:"projectName",value:"%"+condition.projectName+"%",operator:"like",relation:"and"}),""!=condition.firstPartyName&&"请输入甲方"!=condition.firstPartyName&&filter.push({field:"firstPartyName",value:"%"+condition.firstPartyName+"%",operator:"like",relation:"and"}),""!=condition.secondPartyName&&"请输入乙方"!=condition.secondPartyName&&filter.push({field:"secondPartyName",value:"%"+condition.secondPartyName+"%",operator:"like",relation:"and"}),filter.push({field:"statusId",value:2,operator:"<>",relation:"And"}),1==typeId?filter.push({field:"groupId",value:rootId,operator:"=",relation:""}):2==typeId?filter.push({field:"companyId",value:rootId,operator:"=",relation:""}):3==typeId&&filter.push({field:"orgId",value:rootId,operator:"=",relation:""}),filter},queryDetail:function(id,successCallback){var data={m:6001007,t:"v_contract_othercontract"},filter=[{field:"id",value:id,operator:"=",relation:"and"}];data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){successCallback.call(this,data.object[0])}})},queryInvoice:function(id,successCallback){var data={m:6001007,t:"v_contract_othercontract_taxinvoice"},filter=[{field:"id",value:id,operator:"=",relation:"and"}];data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){invoiceInfo=data.object,successCallback.call(this,data.object)}})},queryAttach:function(id,successCallback){var data={m:6001007,t:"contract_othercontract_attach"},filter=[{field:"id",value:id,operator:"=",relation:"and"}];data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){successCallback.call(this,data.object)}})},downloadAttach:function(attach){YT.download(attach)},resetCondition:function(){condition={statusId:-1,displayId:"",firstPartyName:"",secondPartyName:"",projectName:""}},getServiceData:function(){return serviceData},hasNextPage:function(){return hasNextPage},getCondition:function(){return condition},getInvoice:function(){return invoiceInfo},setInvoice:function(data){invoiceInfo=data}}}]),angular.module("app.contract.primary").controller("PrimaryDetailController",["$scope","$state","$stateParams","PrimaryService",function($scope,$state,$stateParams,primaryService){$scope.$on("$ionicView.loaded",function(){primaryService.getPrimaryDetail($stateParams.id,function(data){$scope.primaryInfo=data,$scope.formatMoney=YTM.tool.money.numberToChineseCurrency(1e4*data.amount)})}),primaryService.queryPrimaryAttach($stateParams.id,function(data){$scope.attaches=data}),$scope.downloadAttach=function(attach){primaryService.downloadAttach(attach)},$scope.back=function(){3==primaryService.getTypeId()?$state.go("menu"):$state.go("contract/primary/primary-list")}}]),angular.module("app.contract.primary").controller("PrimaryListController",["$scope","$state","$ionicHistory","$ionicModal","$ionicScrollDelegate","PrimaryService","$ionicPopup","$filter","$ionicViewSwitcher",function($scope,$state,$ionicHistory,$ionicModal,$ionicScrollDelegate,primaryService,$ionicPopup,$filter,$ionicViewSwitcher){$scope.isProjectStatus=!1,$scope.isWorkCategory=!1,$scope.condition=primaryService.getCondition(),$scope.signTime=YTM.initDatePicker({callback:function(){$scope.condition.signTime=$filter("date")($scope.signTime.date,"yyyy-MM-dd"),$scope.signTimerPopup.close()}}),$scope.startTime=YTM.initDatePicker({callback:function(){$scope.condition.startTime=$filter("date")($scope.startTime.date,"yyyy-MM-dd"),$scope.startTimerPopup.close()}}),$scope.endTime=YTM.initDatePicker({callback:function(){$scope.condition.endTime=$filter("date")($scope.endTime.date,"yyyy-MM-dd"),$scope.endTimerPopup.close()}}),$scope.fillData=function(){$scope.primaryList=primaryService.getPrimaryList(),$scope.hasNextPage=primaryService.hasNextPage()},$ionicModal.fromTemplateUrl("contract-type.html",{scope:$scope,animation:"slide-in-up"}).then(function(modal){$scope.modalContractTypeUp=modal}),$ionicModal.fromTemplateUrl("query-more.html",{scope:$scope,animation:"slide-in-up"}).then(function(modal){$scope.modalQueryMore=modal}),$scope.close=function(){$scope.isProjectStatus=!1,$scope.isWorkCategory=!1},$scope.$on("$ionicView.loaded",function(){$scope.primaryList=primaryService.getPrimaryList(),$scope.hasNextPage=primaryService.hasNextPage()}),$scope.openSignTime=function(){$scope.signTimerPopup=$ionicPopup.show({templateUrl:"sign-time.html",scope:$scope,cssClass:"customTimerPopover"}),$scope.signTimerPopup.then(function(res){console.log("Tapped!",res)})},$scope.openStartTime=function(){$scope.startTimerPopup=$ionicPopup.show({templateUrl:"start-time.html",scope:$scope,cssClass:"customTimerPopover"}),$scope.startTimerPopup.then(function(res){console.log("Tapped!",res)})},$scope.openEndTime=function(){$scope.endTimerPopup=$ionicPopup.show({templateUrl:"end-time.html",scope:$scope,cssClass:"customTimerPopover"}),$scope.endTimerPopup.then(function(res){console.log("Tapped!",res)})},$scope.loadListData=function(){primaryService.loadListData(function(){$scope.fillData(),$scope.$broadcast("scroll.infiniteScrollComplete")})},$scope.refreshListData=function(){primaryService.refreshListData(function(){$scope.fillData(),$scope.$broadcast("scroll.refreshComplete")})},$scope.back=function(){primaryService.clearCachedData(),primaryService.resetCondition(),$state.go("menu"),$ionicViewSwitcher.nextDirection("back")},$scope.openContractType=function(){$scope.modalContractTypeUp.show()},$scope.hideContractType=function(){$scope.modalContractTypeUp.hide()},$scope.openQueryMore=function(){$scope.modalQueryMore.show()},$scope.hideQueryMore=function(){$scope.modalQueryMore.hide()},$scope.openProjectStatus=function(){$scope.isProjectStatus=!0},$scope.closeProjectStatus=function(name){$scope.isProjectStatus=!1,$scope.condition.psName=name},$scope.openWorkCategory=function(){$scope.isWorkCategory=!0},$scope.closeWorkCategory=function(name){$scope.isWorkCategory=!1,$scope.condition.wcName=name},$scope.clearSearchText=function(){primaryService.clearSearchText(),$scope.condition=primaryService.getCondition()},$scope.searchData=function(){if($scope.modalContractTypeUp.hide(),primaryService.clearCachedData(),$ionicScrollDelegate.scrollTop(),$scope.condition.startTime&&$scope.condition.endTime){var beginTimes=$scope.condition.startTime.substring(0,10).split("-"),endTimes=$scope.condition.endTime.substring(0,10).split("-"),beginTime=beginTimes[1]+"-"+beginTimes[2]+"-"+beginTimes[0]+" "+$scope.condition.startTime.substring(10,19),endTime=endTimes[1]+"-"+endTimes[2]+"-"+endTimes[0]+" "+$scope.condition.endTime.substring(10,19),a=(Date.parse(endTime)-Date.parse(beginTime))/3600/1e3;a<0?$ionicPopup.alert({title:"警告消息",template:"开工时间不能大于竣工时间！"}):($scope.modalQueryMore.hide(),$scope.loadListData())}else $scope.modalQueryMore.hide(),$scope.loadListData()}}]),angular.module("app.contract.primary").factory("PrimaryService",["YTService","UserService","$state",function(YT,userService,$state){var primaryList=[],pageIndex=0,pageSize=10,hasNextPage=!0,condition={typeId:-1,displayId:"",projectName:"",psid:-1,merchantName:"",wcid:-1,responsiblePersonName:"",manager:"",signTime:"",startTime:"",endTime:""};return{clearSearchText:function(){condition={typeId:-1,displayId:"",projectName:"",psid:-1,merchantName:"",wcid:-1,responsiblePersonName:"",manager:"",signTime:"",startTime:"",endTime:""}},loadListData:function(successCallback){++pageIndex;var self=this;YT.query({data:self.getSearchData(),successCallback:function(data){self.loadListDataCallback(data),successCallback.call()}})},loadListDataCallback:function(data){for(var pageInfo=data.object,i=0;i<pageInfo.items.length;i++)primaryList.push(pageInfo.items[i]);hasNextPage=!(pageIndex>=pageInfo.pageCount)},refreshListData:function(successCallBack){this.clearCachedData(),this.loadListData(successCallBack)},clearCachedData:function(){pageIndex=0,hasNextPage=!0,primaryList=[]},getSearchData:function(){var data={m:6001001003,t:"v_contract_primary_processing",order:"submitTime desc",page:pageIndex,rows:pageSize},filter=this.getSearchFilter();return data.filter=JSON.stringify(filter),data},getSearchFilter:function(){var typeId=userService.getTypeId(),rootId=userService.getRootOrgId(),userId=userService.getUserId(),filter=[];return 1==typeId&&filter.push({field:"groupId",value:rootId,operator:"=",relation:"AND"},{field:"projectStatusId",value:1,operator:"=",relation:"AND"}),YT.haveRight(6001001002)||2!=typeId?YT.haveRight(6001001002)&&2==typeId&&filter.push({field:"orgId",value:rootId,operator:"=",relation:"AND"}):filter.push([{field:"submitUserId",value:userId,operator:"=",relation:"or"},{field:"responsiblePersonId",value:userId,operator:"=",relation:"and"}]),condition.typeId!=-1&&filter.push({field:"typeId",value:condition.typeId,operator:"=",relation:"AND"}),""!=condition.displayId&&"请输入合同编号"!=condition.displayId&&filter.push({field:"displayId",value:"%"+condition.displayId+"%",operator:"like",relation:"and"}),""!=condition.projectName&&"请输入工程名称"!=condition.projectName&&filter.push({field:"projectName",value:"%"+condition.projectName+"%",operator:"like",relation:"and"}),condition.psid!=-1&&filter.push({field:"projectStatusId",value:condition.psid,operator:"=",relation:"AND"}),condition.wcid!=-1&&filter.push({field:"workCategoryId",value:condition.wcid,operator:"=",relation:"AND"}),""!=condition.merchantName&&"请输入发包人"!=condition.merchantName&&filter.push({field:"merchantName",value:condition.typeId,operator:"=",relation:"AND"}),""!=condition.responsiblePersonName&&"请输入责任人"!=condition.merchantName&&filter.push({field:"responsiblePersonName",value:condition.responsiblePersonName,operator:"=",relation:"AND"}),""!=condition.manager&&"请输入项目经理"!=condition.manager&&filter.push({field:"manager",value:condition.manager,operator:"=",relation:"AND"}),""!=condition.signTime&&filter.push({field:"signDate",value:condition.signTime,operator:">=",relation:"AND"}),""!=condition.startTime&&""!=condition.endTime?filter.push([{field:"beginDate",value:condition.startTime,operator:">=",relation:"AND"},{field:"endDate",value:condition.endTime,operator:"<=",relation:"AND"}]):""!=condition.startTime?filter.push({field:"beginDate",value:condition.startTime,operator:">=",relation:"AND"}):""!=condition.endTime&&filter.push({field:"endDate",value:condition.endTime,operator:"<=",relation:"AND"}),filter},getProjectContractId:function(callback){var data={m:6001001003,t:"v_org_org_extend",filter:JSON.stringify([{field:"id",value:userService.getRootOrgId(),operator:"=",relation:"and"}])};YT.query({data:data,successCallback:function(result){callback(result.object[0].contractId)}})},getPrimaryDetail:function(id,successCallback){var data={m:6001001003,t:"v_contract_primary"},filter=[{field:"id",value:id,operator:"=",relation:"and"}];data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){successCallback.call(this,data.object[0])}})},goContractDetail:function(){var self=this;3==userService.getTypeId()?self.getProjectContractId(function(id){$state.go("contract/primary/primary-detail",{id:id})}):$state.go("contract/primary/primary-list")},queryPrimaryAttach:function(id,successCallback){var attachData={m:6001001003,t:"contract_primary_attach"},attachFilter=[{field:"id",value:id,operator:"=",relation:"and"}];attachData.filter=JSON.stringify(attachFilter),YT.query({data:attachData,successCallback:function(data){successCallback.call(this,data.object)}})},downloadAttach:function(attach){YT.download(attach)},resetCondition:function(){condition={typeId:-1,displayId:"",projectName:"",psid:-1,merchantName:"",wcid:-1,responsiblePersonName:"",manager:"",signTime:"",startTime:"",endTime:""}},getPrimaryList:function(){return primaryList},hasNextPage:function(){return hasNextPage},getCondition:function(){return condition},getTypeId:function(){return userService.getTypeId()}}}]),angular.module("app.contract.subcontract").controller("SubcontractChargesController",["$scope","$state","$stateParams","SubcontractService",function($scope,$state,$stateParams,SubcontractService){$scope.$on("$ionicView.loaded",function(){$scope.chargesInfo=SubcontractService.getCharges();for(var chargesInfo=SubcontractService.getCharges(),sum=0,i=0;i<chargesInfo.length;i++)sum+=parseFloat(chargesInfo[i].money);$scope.chargesSum=sum})}]),angular.module("app.contract.subcontract").controller("SubcontractDetailController",["$scope","$state","$stateParams","SubcontractService","$sce",function($scope,$state,$stateParams,SubcontractService,$sce){$scope.projectInfo=!0,$scope.workmoney=!0,$scope.subcontractDetail=!0,$scope.quality=!0,$scope.remark=!0,$scope.attachment=!0,$scope.bill=!0,$scope.worktime=!0,$scope.worktimeShow=function(){$scope.worktime=!$scope.worktime},$scope.projectInfoShow=function(){$scope.projectInfo=!$scope.projectInfo},$scope.workmoneyShow=function(){$scope.workmoney=!$scope.workmoney},$scope.subcontractDetailShow=function(){$scope.subcontractDetail=!$scope.subcontractDetail},$scope.qualityShow=function(){$scope.quality=!$scope.quality},$scope.remarkShow=function(){$scope.remark=!$scope.remark},$scope.attachmentShow=function(){$scope.attachment=!$scope.attachment},$scope.billShow=function(){$scope.bill=!$scope.bill},$scope.$on("$ionicView.loaded",function(){SubcontractService.queryDetail($stateParams.id,function(data){$scope.subcontractInfo=data,$scope.formatMoney=YTM.tool.money.numberToChineseCurrency(data.cost),$scope.memo=$sce.trustAsHtml(data.memo)}),SubcontractService.querySubcontract($stateParams.id,function(data){$scope.subcontractLength=data.length}),SubcontractService.queryCharges($stateParams.id,function(data){$scope.chargesLength=data.length}),SubcontractService.queryInvoice($stateParams.id,function(data){$scope.invoiceLength=data.length}),SubcontractService.queryAttach($stateParams.id,function(data){$scope.attachInfo=data})}),$scope.downloadAttach=function(attach){SubcontractService.downloadAttach(attach)}}]),angular.module("app.contract.subcontract").controller("SubcontractInvoiceController",["$scope","$state","$stateParams","SubcontractService",function($scope,$state,$stateParams,SubcontractService){$scope.$on("$ionicView.loaded",function(){$scope.invoiceInfo=SubcontractService.getInvoice()})}]),angular.module("app.contract.subcontract").controller("SubcontractListController",["$scope","$state","$filter","$ionicHistory","$ionicModal","$ionicPopup","$ionicScrollDelegate","SubcontractService","$ionicViewSwitcher",function($scope,$state,$filter,$ionicHistory,$ionicModal,$ionicPopup,$ionicScrollDelegate,SubcontractService,$ionicViewSwitcher){$scope.condition=SubcontractService.getCondition(),$scope.$on("$ionicView.loaded",function(){$scope.subcontractList=SubcontractService.getServiceData(),$scope.hasNextPage=SubcontractService.hasNextPage()}),$scope.loadListData=function(){SubcontractService.loadListData(function(){$scope.fillData(),$scope.$broadcast("scroll.infiniteScrollComplete")})},$scope.refreshListData=function(){SubcontractService.refreshListData(function(){$scope.fillData(),$scope.$broadcast("scroll.refreshComplete")})},$scope.fillData=function(){$scope.subcontractList=SubcontractService.getServiceData(),$scope.hasNextPage=SubcontractService.hasNextPage()},$scope.searchData=function(){$scope.modalQueryMore.hide(),$scope.modal.hide(),SubcontractService.clearCachedData(),$ionicScrollDelegate.scrollTop(),$scope.loadListData()},$scope.back=function(){SubcontractService.clearCachedData(),SubcontractService.resetCondition(),$state.go("menu"),$ionicViewSwitcher.nextDirection("back")},$ionicModal.fromTemplateUrl("contract-status.html",{scope:$scope,animation:"slide-in-up"}).then(function(modal){$scope.modal=modal}),$scope.openContractStatus=function(){$scope.modal.show()},$scope.hideContractStatus=function(){$scope.modal.hide()},$ionicModal.fromTemplateUrl("query-more.html",{scope:$scope,animation:"slide-in-up"}).then(function(modal){$scope.modalQueryMore=modal}),$scope.openQueryMore=function(){$scope.modalQueryMore.show()},$scope.hideQueryMore=function(){$scope.modalQueryMore.hide()},$scope.clearSearchText=function(){SubcontractService.clearSearchText(),$scope.condition=SubcontractService.getCondition()},$scope.startTime=YTM.initDatePicker({callback:function(){$scope.condition.startTime=$filter("date")($scope.startTime.date,"yyyy-MM-dd"),$scope.startTimerPopup.close()}}),$scope.endTime=YTM.initDatePicker({callback:function(){$scope.condition.endTime=$filter("date")($scope.endTime.date,"yyyy-MM-dd"),$scope.endTimerPopup.close()}}),$scope.openStartTime=function(){$scope.startTimerPopup=$ionicPopup.show({templateUrl:"start-time.html",scope:$scope,cssClass:"customTimerPopover"}),$scope.startTimerPopup.then(function(res){console.log("Tapped!",res)})},$scope.openEndTime=function(){$scope.endTimerPopup=$ionicPopup.show({templateUrl:"end-time.html",scope:$scope,cssClass:"customTimerPopover"}),$scope.endTimerPopup.then(function(res){console.log("Tapped!",res)})}}]),angular.module("app.contract.subcontract").controller("SubcontractSubcontractController",["$scope","$state","$stateParams","SubcontractService",function($scope,$state,$stateParams,SubcontractService){$scope.$on("$ionicView.loaded",function(){$scope.subcontractInfo=SubcontractService.getSubcontract();for(var subcontractInfo=SubcontractService.getSubcontract(),sum=0,i=0;i<subcontractInfo.length;i++)sum+=parseFloat(subcontractInfo[i].total);$scope.subcontractSum=sum})}]),angular.module("app.contract.subcontract").factory("SubcontractService",["YTService","UserService",function(YT,userService){var serviceData=[],pageIndex=0,pageSize=10,hasNextPage=!0,condition={statusId:-1,displayId:"",contractName:"",ownerOrgName:"",merchantName:"",startTime:"",endTime:""},subcontractInfo=[],chargesInfo=[],invoiceInfo=[];return{clearSearchText:function(){condition={statusId:-1,displayId:"",contractName:"",ownerOrgName:"",merchantName:"",startTime:"",endTime:""}},loadListData:function(successCallback){++pageIndex;var self=this;YT.query({data:self.getSearchData(),successCallback:function(data){self.loadListDataCallback(data),successCallback.call()}})},loadListDataCallback:function(data){for(var pageInfo=data.object,i=0;i<pageInfo.items.length;i++)serviceData.push(pageInfo.items[i]);hasNextPage=!(pageIndex>=pageInfo.pageCount)},refreshListData:function(successCallBack){this.clearCachedData(),this.loadListData(successCallBack)},clearCachedData:function(){pageIndex=0,hasNextPage=!0,serviceData=[]},getSearchData:function(){var data={m:6001002,t:"v_contract_subcontract",order:"id desc",page:pageIndex,rows:pageSize},filter=this.getSearchFilter();return data.filter=JSON.stringify(filter),data},getSearchFilter:function(){var typeId=userService.getTypeId(),rootId=userService.getRootOrgId(),filter=[];return condition.statusId!=-1&&filter.push({field:"statusId",value:condition.statusId,operator:"=",relation:"AND"}),""!=condition.displayId&&"请输入合同编号"!=condition.displayId&&filter.push({field:"displayId",value:"%"+condition.displayId+"%",operator:"like",relation:"and"}),""!=condition.contractName&&"请输入工程名称"!=condition.contractName&&filter.push({field:"contractName",value:"%"+condition.contractName+"%",operator:"like",relation:"and"}),""!=condition.ownerOrgName&&"请输入发包方"!=condition.ownerOrgName&&filter.push({field:"ownerOrgName",value:"%"+condition.ownerOrgName+"%",operator:"like",relation:"and"}),""!=condition.merchantName&&"请输入承包方"!=condition.merchantName&&filter.push({field:"merchantName",value:"%"+condition.merchantName+"%",operator:"like",relation:"and"}),""!=condition.startTime&&""!=condition.endTime?filter.push([{field:"beginDate",value:condition.startTime,operator:">=",relation:"AND"},{field:"endDate",value:condition.endTime,operator:"<=",relation:"AND"}]):""!=condition.startTime?filter.push({field:"beginDate",value:condition.startTime,operator:">=",relation:"AND"}):""!=condition.endTime&&filter.push({field:"endDate",value:condition.endTime,operator:"<=",relation:"AND"}),filter.push({field:"statusId",value:2,operator:"<>",relation:"And"}),1==typeId?filter.push({field:"groupId",value:rootId,operator:"=",relation:""}):2==typeId?filter.push({field:"companyId",value:rootId,operator:"=",relation:""}):3==typeId&&filter.push({field:"orgId",value:rootId,operator:"=",relation:""}),filter},queryDetail:function(id,successCallback){var data={m:6001002,t:"v_contract_subcontract"},filter=[{field:"id",value:id,operator:"=",relation:"and"}];data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){successCallback.call(this,data.object[0])}})},querySubcontract:function(id,successCallback){var data={m:6001002,t:"contract_subcontract_content"},filter=[{field:"id",value:id,operator:"=",relation:"and"}];data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){subcontractInfo=data.object,successCallback.call(this,data.object)}})},queryCharges:function(id,successCallback){var data={m:6001002,t:"v_contract_subcontract_charges"},filter=[{field:"id",value:id,operator:"=",relation:"and"}];data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){chargesInfo=data.object,successCallback.call(this,data.object)}})},queryInvoice:function(id,successCallback){var data={m:6001002,t:"v_contract_subcontract_taxinvoice"},filter=[{field:"id",value:id,operator:"=",relation:"and"}];data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){invoiceInfo=data.object,successCallback.call(this,data.object)}})},queryAttach:function(id,successCallback){var data={m:6001002,t:"contract_subcontract_attach"},filter=[{field:"id",value:id,operator:"=",relation:"and"}];data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){successCallback.call(this,data.object)}})},downloadAttach:function(attach){YT.download(attach)},resetCondition:function(){condition={statusId:-1,displayId:"",contractName:"",ownerOrgName:"",merchantName:"",startTime:"",endTime:""}},getServiceData:function(){return serviceData},hasNextPage:function(){return hasNextPage},getCondition:function(){return condition},getSubcontract:function(){return subcontractInfo},setSubcontract:function(data){subcontractInfo=data},getCharges:function(){return chargesInfo},setCharges:function(data){chargesInfo=data},getInvoice:function(){return invoiceInfo},setInvoice:function(data){invoiceInfo=data}}}]),angular.module("app.device.information").controller("DeviceDetailController",["$scope","$state","$stateParams","InformationService",function($scope,$state,$stateParams,informationService){$scope.$on("$ionicView.loaded",function(){informationService.getDeviceInfoDetail($stateParams.id,function(data){$scope.deviceInfo=data})})}]),angular.module("app.device.information").controller("DeviceListController",["$scope","$state","$ionicHistory","$ionicModal","$ionicScrollDelegate","InformationService","$ionicPopup","$filter",function($scope,$state,$ionicHistory,$ionicModal,$ionicScrollDelegate,informationService,$ionicPopup,$filter){$scope.isDeviceKinds=!1,$scope.isDeviceFrom=!1,$scope.isDeviceMark=!1,$scope.condition=informationService.getCondition(),$scope.startTime=YTM.initDatePicker({callback:function(){$scope.condition.startTime=$filter("date")($scope.startTime.date,"yyyy-MM-dd"),$scope.startTimerPopup.close()}}),$scope.endTime=YTM.initDatePicker({callback:function(){$scope.condition.endTime=$filter("date")($scope.endTime.date,"yyyy-MM-dd"),$scope.endTimerPopup.close()}}),$ionicModal.fromTemplateUrl("query-type.html",{scope:$scope,animation:"slide-in-up"}).then(function(modal){$scope.modalQueryTypeUp=modal}),informationService.getStatuses(function(data){$scope.statuses=data}),$scope.openQueryTypeUp=function(){$scope.modalQueryTypeUp.show()},$scope.hideQueryType=function(){
$scope.modalQueryTypeUp.hide()},$ionicModal.fromTemplateUrl("query-more.html",{scope:$scope,animation:"slide-in-up"}).then(function(modal){$scope.modalQueryMore=modal}),$scope.openQueryMore=function(){$scope.modalQueryMore.show()},$scope.close=function(){$scope.isDeviceKinds=!1,$scope.isDeviceFrom=!1,$scope.isDeviceMark=!1},$scope.$on("$ionicView.loaded",function(){$scope.deviceInfoList=informationService.getDeviceInfoList(),$scope.hasNextPage=informationService.hasNextPage()}),$scope.openStartTime=function(){$scope.startTimerPopup=$ionicPopup.show({templateUrl:"start-time.html",scope:$scope,cssClass:"customTimerPopover"}),$scope.startTimerPopup.then(function(res){})},$scope.openEndTime=function(){$scope.endTimerPopup=$ionicPopup.show({templateUrl:"end-time.html",scope:$scope,cssClass:"customTimerPopover"}),$scope.endTimerPopup.then(function(res){})},informationService.getCategories(function(data){$scope.categories=data}),$scope.openDeviceKinds=function(){$scope.isDeviceKinds=!0},$scope.closeDeviceKinds=function(name){$scope.isDeviceKinds=!1,$scope.condition.categoryName=name},informationService.getSources(function(data){$scope.sources=data}),$scope.openDeviceFrom=function(){$scope.isDeviceFrom=!0},$scope.closeDeviceFrom=function(name){$scope.isDeviceFrom=!1,$scope.condition.sourceName=name},informationService.getIdentities(function(data){$scope.identities=data}),$scope.openDeviceMark=function(){$scope.isDeviceMark=!0},$scope.closeDeviceMark=function(name){$scope.isDeviceMark=!1,$scope.condition.markName=name},$ionicModal.fromTemplateUrl("company.html",{scope:$scope,animation:"slide-in-up"}).then(function(modal){$scope.modalCompanyList=modal}),$scope.openCompanyList=function(){$scope.modalCompanyList.show()},$scope.hideCompanyList=function(unitName){$scope.condition.provideName=unitName,$scope.modalCompanyList.hide()},$scope.hideCompany=function(unitName){$scope.condition.provideName=unitName,$scope.modalCompanyList.hide()},$ionicModal.fromTemplateUrl("supply.html",{scope:$scope,animation:"slide-in-up"}).then(function(modal){$scope.modalSupplyList=modal}),$scope.openSupplyList=function(){$scope.modalSupplyList.show()},$scope.hideSupplyList=function(unitName){$scope.condition.supplyName=unitName,$scope.modalSupplyList.hide()},$scope.hideSupply=function(unitName){$scope.condition.supplyName=unitName,$scope.modalSupplyList.hide()},$scope.clearSearchText=function(){informationService.clearSearchText(),$scope.condition=informationService.getCondition()},$scope.loadListData=function(){informationService.loadListData(function(){$scope.fillData(),$scope.$broadcast("scroll.infiniteScrollComplete")})},informationService.getProvideList(function(data){$scope.provideInfo=data}),informationService.getDeviceSupply(function(data){$scope.supplysInfo=data}),$scope.refreshListData=function(){informationService.refreshListData(function(){$scope.condition=informationService.getCondition(),$scope.fillData(),$scope.$broadcast("scroll.refreshComplete")})},$scope.fillData=function(){$scope.deviceInfoList=informationService.getDeviceInfoList(),$scope.hasNextPage=informationService.hasNextPage()},$scope.back=function(){informationService.clearCachedData(),informationService.resetCondition(),$ionicHistory.goBack()},$scope.searchData=function(){if($scope.modalQueryTypeUp.hide(),informationService.clearCachedData(),$ionicScrollDelegate.scrollTop(),$scope.condition.startTime&&$scope.condition.endTime){var beginTimes=$scope.condition.startTime.substring(0,10).split("-"),endTimes=$scope.condition.endTime.substring(0,10).split("-"),beginTime=beginTimes[1]+"-"+beginTimes[2]+"-"+beginTimes[0]+" "+$scope.condition.startTime.substring(10,19),endTime=endTimes[1]+"-"+endTimes[2]+"-"+endTimes[0]+" "+$scope.condition.endTime.substring(10,19),a=(Date.parse(endTime)-Date.parse(beginTime))/3600/1e3;a<0?$ionicPopup.alert({title:"警告消息",template:"进场时间（止）不能小于进场时间（起）！"}):($scope.modalQueryMore.hide(),$scope.loadListData())}else $scope.modalQueryMore.hide(),$scope.loadListData()}}]),angular.module("app.device.information").factory("InformationService",["YTService","UserService",function(YT,userService){var deviceInfoList=[],supplyList=[],pageIndex=0,pageSize=10,hasNextPage=!0,condition={statusId:-1,name:"",number:"",categoryId:-1,sourceId:-1,identifyId:-1,provideOrgId:-1,supplierId:-1,startTime:"",endTime:""};return{clearSearchText:function(){condition={statusId:-1,name:"",number:"",categoryId:-1,sourceId:-1,identifyId:-1,provideOrgId:-1,supplierId:-1,startTime:"",endTime:""}},loadListData:function(successCallback){++pageIndex;var self=this;YT.query({data:self.getSearchData(),successCallback:function(data){self.loadListDataCallback(data),successCallback.call()}})},loadListDataCallback:function(data){for(var pageInfo=data.object,i=0;i<pageInfo.items.length;i++)deviceInfoList.push(pageInfo.items[i]);hasNextPage=!(pageIndex>=pageInfo.pageCount)},refreshListData:function(successCallBack){this.clearCachedData(),this.clearSearchText(),this.loadListData(successCallBack)},clearCachedData:function(){pageIndex=0,hasNextPage=!0,deviceInfoList=[]},getDeviceSupply:function(callback){YT.query({data:{m:12001,t:"v_device_marchant_list",filter:JSON.stringify([{field:"typeId",value:"4",operator:"=",relation:"AND"},{field:"orgId",value:userService.getRootOrgId(),operator:"=",relation:"AND"}])},successCallback:function(data){callback(data.object)}})},getProvideList:function(callback){YT.getSubProjectByProjectId(function(data){for(var i=0;i<data.length;i++)data[i].id==userService.getRootOrgId()&&data.splice(i,1);callback(data)})},getSearchData:function(){var data={m:12001,t:"v_deviceinfo_list",order:"intime desc",page:pageIndex,rows:pageSize},filter=this.getSearchFilter();return data.filter=JSON.stringify(filter),data},getSearchFilter:function(){var filter=[{field:"orgId",value:userService.getRootOrgId(),operator:"=",relation:"AND"}];return condition.statusId!=-1&&filter.push({field:"statusId",value:condition.statusId,operator:"=",relation:"AND"}),""!=condition.name&&"请输入设备名称"!=condition.name&&filter.push({field:"name",value:condition.name,operator:"=",relation:"AND"}),""!=condition.number&&"请输入设备名称"!=condition.number&&filter.push({field:"number",value:condition.number,operator:"=",relation:"AND"}),condition.categoryId!=-1&&filter.push({field:"categoryId",value:condition.categoryId,operator:"=",relation:"AND"}),condition.sourceId!=-1&&filter.push({field:"sourceId",value:condition.sourceId,operator:"=",relation:"AND"}),condition.identifyId!=-1&&filter.push({field:"identifyId",value:condition.identifyId,operator:"=",relation:"AND"}),condition.provideOrgId!=-1&&filter.push({field:"provide",value:condition.provideOrgId,operator:"=",relation:"AND"}),condition.supplierId!=-1&&filter.push({field:"supplierId",value:condition.supplierId,operator:"=",relation:"AND"}),""!=condition.startTime&&""!=condition.endTime?filter.push([{field:"intime",value:condition.startTime,operator:">=",relation:"AND"},{field:"intime",value:condition.endTime,operator:"<=",relation:"AND"}]):""!=condition.startTime?filter.push({field:"intime",value:condition.startTime,operator:">=",relation:"AND"}):""!=condition.endTime&&filter.push({field:"intime",value:condition.endTime,operator:"<=",relation:"AND"}),filter},getDeviceInfoDetail:function(id,successCallback){var data={m:12001,t:"v_deviceinfo_list"},filter=[{field:"id",value:id,operator:"=",relation:"and"}];data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){successCallback.call(this,data.object[0])}})},resetCondition:function(){condition={statusId:-1,name:"",number:"",categoryId:-1,sourceId:-1,identifyId:-1,provideOrgId:-1,supplierId:-1,startTime:"",endTime:""}},getDictionary:function(t,callback){YT.query({data:{m:12001,t:t},successCallback:function(data){callback(data.object)}})},getSources:function(callback){this.getDictionary("device_d_source",callback)},getCategories:function(callback){this.getDictionary("device_d_category",callback)},getIdentities:function(callback){this.getDictionary("device_d_identify",callback)},getStatuses:function(callback){this.getDictionary("device_d_status",callback)},getDeviceInfoList:function(){return deviceInfoList},getDeviceSupplyList:function(){return supplyList},hasNextPage:function(){return hasNextPage},getCondition:function(){return condition}}}]),angular.module("app.device.maintain.maintain-record",[]).config(function($stateProvider,$urlRouterProvider){$stateProvider.state("device/maintain/maintain-record/maintain-record-list",{url:"device/maintain/maintain-record/maintain-record-list",templateUrl:"modules/device/maintain/maintain-record/maintain-record-list.html",controller:"MaintainRecordListController",params:{success:!1}}).state("device/maintain/maintain-record/maintain-device-detail",{url:"device/maintain/maintain-record/maintain-device-detail",templateUrl:"modules/device/maintain/maintain-record/maintain-device-detail.html",controller:"MaintainRecordDetailController",params:{id:null}})}),angular.module("app.device.maintain.maintain-remind",[]).config(function($stateProvider,$urlRouterProvider){$stateProvider.state("device/maintain/maintain-remind/maintain-remind-list",{url:"device/maintain/maintain-remind/maintain-remind-list",templateUrl:"modules/device/maintain/maintain-remind/maintain-remind-list.html",controller:"MaintainRemindListController"}).state("device/maintain/maintain-remind/maintain-device-detail",{url:"device/maintain/maintain-remind/maintain-device-detail",templateUrl:"modules/device/maintain/maintain-remind/maintain-device-detail.html",controller:"MaintainRemindDetailController",params:{id:null}}).state("device/maintain/maintain-remind/device-breakdown-deal",{url:"device/maintain/maintain-remind/device-breakdown-deal",templateUrl:"modules/device/maintain/maintain-remind/device-breakdown-deal.html",controller:"DeviceBreakdownDealController",params:{id:null}})}),angular.module("app.device.inspection.inspection-record",[]).config(function($stateProvider,$urlRouterProvider){$stateProvider.state("device/inspection/inspection-record/inspection-record-list",{url:"device/inspection/inspection-record/inspection-record-list",templateUrl:"modules/device/inspection/inspection-record/inspection-record-list.html",controller:"InspectionRecordListController",params:{success:!1}}).state("device/inspection/inspection-record/inspection-device-detail",{url:"device/inspection/inspection-record/inspection-device-detail",templateUrl:"modules/device/inspection/inspection-record/inspection-device-detail.html",controller:"InspectionRecordDetailController",params:{id:null}})}),angular.module("app.device.inspection.inspection-remind",[]).config(function($stateProvider,$urlRouterProvider){$stateProvider.state("device/inspection/inspection-remind/inspection-remind-list",{url:"device/inspection/inspection-remind/inspection-remind-list",templateUrl:"modules/device/inspection/inspection-remind/inspection-remind-list.html",controller:"InspectionRemindListController"}).state("device/inspection/inspection-remind/inspection-device-detail",{url:"device/inspection/inspection-remind/inspection-device-detail",templateUrl:"modules/device/inspection/inspection-remind/inspection-device-detail.html",controller:"InspectionRemindDetailController",params:{id:null}})}),angular.module("app.market.ep.employee",[]).config(function($stateProvider,$urlRouterProvider){$stateProvider.state("market/ep/employee/employee-list",{url:"market/ep/employee/employee-list",templateUrl:"modules/market/ep/employee/employee-list.html",controller:"EmployeeListController"}).state("market/ep/employee/employee-detail",{url:"market/ep/employee//employee-detail",templateUrl:"modules/market/ep/employee/employee-detail.html",controller:"EmployeeDetailController",params:{dataId:0}}).state("market/ep/employee/employee-certificate-detail",{url:"market/ep/employee/employee-certificate-detail",templateUrl:"modules/market/ep/employee/employee-certificate-detail.html",controller:"EmployeeCertificateDetailController",params:{certificate:null}}).state("market/ep/employee/employee-title-detail",{url:"market/ep/employee/employee-title-detail",templateUrl:"modules/market/ep/employee/employee-title-detail.html",controller:"EmployeeTitleDetailController",params:{title:null}}).state("market/ep/employee/employee-attach-detail",{url:"market/ep/employee/employee-attach-detail",templateUrl:"modules/market/ep/employee/employee-attach-detail.html",controller:"EmployeeAttachDetailController",params:{attaches:[]}})}),angular.module("app.market.ep.project",[]).config(function($stateProvider,$urlRouterProvider){$stateProvider.state("market/ep/project/project-list",{url:"market/ep/project/project-list",templateUrl:"modules/market/ep/project/project-list.html",controller:"ProjectListController"}).state("market/ep/project/project-detail",{url:"market/ep/project/project-detail",templateUrl:"modules/market/ep/project/project-detail.html",controller:"ProjectDetailController",params:{dataId:0}}).state("market/ep/project/project-attach-detail",{url:"market/ep/project/project-attach-detail",templateUrl:"modules/market/ep/project/project-attach-detail.html",controller:"ProjectAttachDetailController",params:{attaches:[]}}).state("market/ep/project/project-award-detail",{url:"market/ep/project/project-award-detail",templateUrl:"modules/market/ep/project/project-award-detail.html",controller:"ProjectAwardDetailController",params:{award:null}}).state("market/ep/project/project-punish-detail",{url:"market/ep/project/project-punish-detail",templateUrl:"modules/market/ep/project/project-punish-detail.html",controller:"ProjectPunishDetailController",params:{punish:null}})}),angular.module("app.merchant.information").controller("MerchantAttachmentDetailController",["$scope","$state","$stateParams","MerchantService",function($scope,$state,$stateParams,MerchantService){$scope.$on("$ionicView.loaded",function(){$scope.merchantBaseDetail=$stateParams.merchantBaseAttachList,$scope.attach={name:$scope.merchantBaseDetail.name,url:$scope.merchantBaseDetail.url,fileSize:$scope.merchantBaseDetail.fileSize}}),$scope.download=function(attach){MerchantService.downloadAttach(attach)},$scope.attachment=!0,$scope.attachmentShow=function(){$scope.attachment=!$scope.attachment}}]),angular.module("app.merchant.information").controller("MerchantInfoDetailController",["$scope","$state","$stateParams","MerchantService",function($scope,$state,$stateParams,merchantService){$scope.$on("$ionicView.loaded",function(){merchantService.getMerchantDetail($stateParams.id,function(data){$scope.merchantDetail=data}),merchantService.getMerchantBaseAttachDetail($stateParams.id,function(data){$scope.merchantBaseAttach=data}),merchantService.getMerchantSafetyPermitDetail($stateParams.id,function(data){$scope.merchantSafetyPermit=data}),merchantService.getMerchantQualificationDetail($stateParams.id,function(data){$scope.merchantQualification=data})}),$scope.identification=!0,$scope.identificationShow=function(){$scope.identification=!$scope.identification},$scope.essential=!0,$scope.essentialShow=function(){$scope.essential=!$scope.essential},$scope.attachment=!1,$scope.attachmentShow=function(){$scope.attachment=!$scope.attachment},$scope.qualification=!1,$scope.qualificationShow=function(){$scope.qualification=!$scope.qualification},$scope.license=!1,$scope.licenseShow=function(){$scope.license=!$scope.license},$scope.contract=!1,$scope.contractShow=function(){$scope.contract=!$scope.contract}}]),angular.module("app.merchant.information").controller("MerchantInfoListController",["$scope","$state","$ionicHistory","$ionicModal","$ionicScrollDelegate","MerchantService","$ionicViewSwitcher",function($scope,$state,$ionicHistory,$ionicModal,$ionicScrollDelegate,merchantService,$ionicViewSwitcher){$scope.condition=merchantService.getCondition(),$scope.$on("$ionicView.loaded",function(){$scope.merchantList=merchantService.getMerchantList(),$scope.hasNextPage=merchantService.hasNextPage(),merchantService.getMerchantTypeDetail(function(data){$scope.merchantTypeDetail=data})}),$scope.loadListData=function(){merchantService.loadListData(function(){$scope.fillData(),$scope.$broadcast("scroll.infiniteScrollComplete")})},$scope.refreshListData=function(){merchantService.refreshListData(function(){$scope.fillData(),$scope.$broadcast("scroll.refreshComplete")})},$scope.fillData=function(){$scope.merchantList=merchantService.getMerchantList(),$scope.hasNextPage=merchantService.hasNextPage()},$scope.searchType=function(){$scope.modalQueryTypeUp.hide(),merchantService.clearCachedData(),$ionicScrollDelegate.scrollTop(),$scope.loadListData()},$scope.searchMore=function(){$scope.modalQueryMore.hide(),merchantService.clearCachedData(),$ionicScrollDelegate.scrollTop(),$scope.loadListData()},$scope.back=function(){merchantService.clearCachedData(),merchantService.resetCondition(),$state.go("menu"),$ionicViewSwitcher.nextDirection("back")},$scope.clearUnifiedSocialCode=function(){$scope.condition.unifiedSocialCode=""},$scope.clearIdCode=function(){$scope.condition.code="",$scope.condition.idCard=""},$scope.clearSearchMore=function(){$scope.condition.number="",$scope.condition.name="",$scope.condition.kindId=0,$scope.condition.typeId=0,$scope.condition.code="",$scope.condition.idCard="",$scope.condition.unifiedSocialCode="",$scope.merchantTypeName=""},$scope.merchantTypeName="",$ionicModal.fromTemplateUrl("query-type.html",{scope:$scope,animation:"slide-in-up"}).then(function(modal){$scope.modalQueryTypeUp=modal}),$scope.openQueryTypeUp=function(){$scope.modalQueryTypeUp.show()},$scope.hideQueryType=function(){$scope.modalQueryTypeUp.hide()},$ionicModal.fromTemplateUrl("query-more.html",{scope:$scope,animation:"slide-in-up"}).then(function(modal){$scope.modalQueryMore=modal}),$scope.openQueryMore=function(){$scope.modalQueryMore.show()},$scope.openKinds=function(){$scope.kinds=!0},$scope.close=function(){$scope.kinds=!1}}]),angular.module("app.merchant.information").controller("MerchantQualificationDetailController",["$scope","$state","$stateParams","MerchantService",function($scope,$state,$stateParams,MerchantService){$scope.$on("$ionicView.loaded",function(){$scope.merchantQualificationDetail=$stateParams.merchantQualificationDetail,$scope.merchantQualificationName=$scope.merchantQualificationDetail.qualificationName,$scope.merchantQualificationNumber=$scope.merchantQualificationDetail.qualificationNo,$scope.merchantQualificationLevelName=$scope.merchantQualificationDetail.levelName,$scope.attach={name:$scope.merchantQualificationDetail.qualificationAttachName,url:$scope.merchantQualificationDetail.url,fileSize:$scope.merchantQualificationDetail.fileSize}}),$scope.download=function(attach){MerchantService.downloadAttach(attach)},$scope.attachment=!0,$scope.attachmentShow=function(){$scope.attachment=!$scope.attachment}}]),angular.module("app.merchant.information").controller("MerchantSafetyPermitDetailController",["$scope","$state","$stateParams","MerchantService",function($scope,$state,$stateParams,MerchantService){$scope.$on("$ionicView.loaded",function(){$scope.merchantSafetyPermitDetail=$stateParams.merchantSafetyPermitDetail,$scope.merchantSafetyPermitName=$scope.merchantSafetyPermitDetail.name,$scope.merchantSafetyPermitNumber=$scope.merchantSafetyPermitDetail.number,$scope.merchantSafetyPermitDeadline=$scope.merchantSafetyPermitDetail.deadline,$scope.attach={name:$scope.merchantSafetyPermitDetail.safetypermitAttachName,url:$scope.merchantSafetyPermitDetail.url,fileSize:$scope.merchantSafetyPermitDetail.fileSize}}),$scope.download=function(attach){MerchantService.downloadAttach(attach)},$scope.attachment=!0,$scope.attachmentShow=function(){$scope.attachment=!$scope.attachment}}]),angular.module("app.merchant.information").factory("MerchantService",["YTService","UserService",function(YT,userService){var merchantList=[],pageIndex=0,pageSize=10,hasNextPage=!0,condition={typeId:0,kindId:0,number:"",name:"",idCard:"",code:"",unifiedSocialCode:""};return{loadListData:function(successCallback){++pageIndex;var self=this;YT.query({data:self.getSearchData(),successCallback:function(data){self.loadListDataCallback(data),successCallback.call()}})},loadListDataCallback:function(data){for(var pageInfo=data.object,i=0;i<pageInfo.items.length;i++)merchantList.push(pageInfo.items[i]);hasNextPage=!(pageIndex>=pageInfo.pageCount)},refreshListData:function(successCallBack){this.clearCachedData(),this.loadListData(successCallBack)},clearCachedData:function(){pageIndex=0,hasNextPage=!0,merchantList=[]},getSearchData:function(){var data=(userService.getTypeId(),userService.getRootOrgId(),userService.getUserId(),{m:4001,t:"v_merchant_list",order:"time desc",page:pageIndex,rows:pageSize}),filter=this.getSearchFilter();return data.filter=JSON.stringify(filter),data},getSearchFilter:function(){var rootId=userService.getRootOrgId(),filter=[{field:"orgId",value:rootId,operator:"=",relation:"and"}];return 0!=condition.typeId&&filter.push({field:"typeId",value:condition.typeId,operator:"=",relation:"and"}),0!=condition.kindId&&filter.push({field:"kindId",value:condition.kindId,operator:"=",relation:"and"}),""!=condition.number&&filter.push({field:"number",value:"%"+condition.number+"%",operator:"like",relation:"and"}),""!=condition.name&&filter.push({field:"name",value:"%"+condition.name+"%",operator:"like",relation:"and"}),""!=condition.idCard&&filter.push({field:"idCard",value:"%"+condition.idCard+"%",operator:"like",relation:"and"}),""!=condition.code&&filter.push({field:"code",value:"%"+condition.code+"%",operator:"like",relation:"and"}),""!=condition.unifiedSocialCode&&filter.push({field:"unifiedSocialCode",value:condition.unifiedSocialCode,operator:"like",relation:"and"}),filter},getMerchantDetail:function(id,successCallback){var data={m:4001,t:"v_merchant_list"},filter=[{field:"id",value:id,operator:"=",relation:"and"}];data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){successCallback.call(this,data.object[0])}})},getMerchantBaseAttachDetail:function(id,successCallback){var data={m:4001,t:"merchant_baseinfo_attach"},filter=[{field:"id",value:id,operator:"=",relation:"and"}];data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){successCallback.call(this,data.object)}})},getMerchantQualificationDetail:function(id,successCallback){var data={m:4001,t:"v_merchant_qualification_detail"},filter=[{field:"id",value:id,operator:"=",relation:"and"}];data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){successCallback.call(this,data.object)}})},getMerchantSafetyPermitDetail:function(id,successCallback){var data={m:4001,t:"v_merchant_safetypermit_detail"},filter=[{field:"id",value:id,operator:"=",relation:"and"}];data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){successCallback.call(this,data.object)}})},getMerchantTypeDetail:function(successCallback){var data={m:4001,t:"merchant_d_type"};YT.query({data:data,successCallback:function(data){successCallback.call(this,data.object)}})},resetCondition:function(){condition.typeId=0,condition.kindId=0,condition.number="",condition.name="",condition.idCard="",condition.code="",condition.unifiedSocialCode=""},getMerchantList:function(){return merchantList},hasNextPage:function(){return hasNextPage},getCondition:function(){return condition},downloadAttach:function(attach){YT.download(attach)}}}]),angular.module("app.quality.check").controller("qualityCheckAddController",["$scope","$state","$stateParams","$ionicPopup","qualityCheckAddService","$filter","$ionicHistory","$ionicActionSheet","LocalStorageService","$ionicViewSwitcher","YTService",function($scope,$state,$stateParams,$ionicPopup,qualityCheckAddService,$filter,$ionicHistory,$ionicActionSheet,LocalStorageService,$ionicViewSwitcher,YTService){var now=new Date;$scope.checkData=qualityCheckAddService.getCheckData(),$scope.checkData.checkDate=now.getFullYear()+"-"+qualityCheckAddService.prefixInteger(now.getMonth()+1,2)+"-"+qualityCheckAddService.prefixInteger(now.getDate(),2),qualityCheckAddService.setCheckDate($scope.checkData.checkDate),$scope.checkDataShow=qualityCheckAddService.getCheckDataShow(),$scope.contentList=qualityCheckAddService.getContent(),$scope.checkDate=YTM.initDatePicker({callback:function(){$scope.checkData.checkDate=$filter("date")($scope.checkDate.date,"yyyy-MM-dd"),qualityCheckAddService.setCheckDate($scope.checkData.checkDate),$scope.checkDatePopup.close()}}),$scope.openCheckDate=function(){$scope.checkDatePopup=$ionicPopup.show({templateUrl:"check-date.html",scope:$scope,cssClass:"customTimerPopover"}),$scope.checkDatePopup.then(function(res){console.log("Tapped!",res)})},qualityCheckAddService.setType($stateParams.type),$scope.url="quality/check/quality-add",$scope.titleName="新增质量通病检查",$scope.$on("$ionicView.beforeEnter",function(){$stateParams.backUrl&&($scope.backUrl=$stateParams.backUrl),$scope.checkData=qualityCheckAddService.getCheckData(),$scope.checkDataShow=qualityCheckAddService.getCheckDataShow(),$scope.contentList=qualityCheckAddService.getContent(),$scope.checkDataShow.checker=qualityCheckAddService.getUserName(),qualityCheckAddService.setChecker($scope.checkDataShow.checker)}),$scope.showConfirmDel=function(id){var confirmPopup=$ionicPopup.confirm({title:"提示",template:'<p class="text-center">确认删除？</p>',cancelText:"取消",okText:"确定"});confirmPopup.then(function(res){res&&(qualityCheckAddService.removeContent(id),$scope.contentList=qualityCheckAddService.getContent(),$ionicPopup.alert({title:"提示",template:'<p class="text-center">删除成功!</p>'}))})},$scope.back=function(){$ionicPopup.confirm({title:"提示",template:'<p class="text-center">您确定要退出新增页面？</p>',cancelText:"取消",okText:"确定"}).then(function(res){res&&(qualityCheckAddService.clearCachedData(),$state.go($scope.backUrl),$ionicViewSwitcher.nextDirection("back"))})},$scope.submit=function(){$ionicActionSheet.show({buttons:[{text:"提交"},{text:"保存服务器"},{text:"保存本地"}],cancelText:"取消",cancel:function(){return!0},buttonClicked:function(index){if($scope.checkSheet()){var data={};if(0==index&&(data=$scope.getData(1),1==data.data.hasProblem?qualityCheckAddService.insertQualityCheckData(data.data,data.slave,{status:"audit",pushUserId:data.data.solverId,condition:{"状态":"处理"},wId:160001,userId:qualityCheckAddService.getUserId(),orgId:qualityCheckAddService.getRootOrgId()},function(data){200==data.status&&$ionicPopup.alert({title:"验证",template:'<p class="text-center">提交成功!</p>'}).then(function(){qualityCheckAddService.clearCachedData(),$state.go($scope.backUrl),$ionicViewSwitcher.nextDirection("back")})}):0==data.data.hasProblem&&qualityCheckAddService.insertQualityCheckData(data.data,data.slave,{status:"audit",pushUserId:data.data.solverId,condition:{"状态":"通过"},wId:160001,userId:qualityCheckAddService.getUserId(),orgId:qualityCheckAddService.getRootOrgId()},function(data){200==data.status&&$ionicPopup.alert({title:"验证",template:'<p class="text-center">提交成功!</p>'}).then(function(){qualityCheckAddService.clearCachedData(),$state.go($scope.backUrl),$ionicViewSwitcher.nextDirection("back")})})),1==index&&(data=$scope.getData(0),qualityCheckAddService.insertQualityCheckData(data.data,data.slave,{status:"saved"},function(data){200==data.status&&$ionicPopup.alert({title:"验证",template:'<p class="text-center">保存成功!</p>'}).then(function(){qualityCheckAddService.clearCachedData(),$state.go($scope.backUrl),$ionicViewSwitcher.nextDirection("back")})})),2==index){var problem=qualityCheckAddService.getProblems(),title="",checkDataShow=qualityCheckAddService.getCheckDataShow();if(1==checkDataShow.hasProblem){for(var i=0;i<problem.length-1;i++)title+=problem[i].name+"；";title+=problem[problem.length-1].name}else 0==checkDataShow.hasProblem&&(title="质量通病检查");var localDataList=JSON.parse(LocalStorageService.get("qualityCheckList")),localData={title:title,checkData:qualityCheckAddService.getCheckData(),checkDataShow:checkDataShow,content:qualityCheckAddService.getContent(),problems:problem,attach:qualityCheckAddService.getImagList()};if(void 0==localDataList){var dataList=[];localData.id=1,dataList.push(localData),localDataList=dataList}else{for(var maxId=1,k=0;k<localDataList.length;k++)localDataList[k].id>maxId&&(maxId=localDataList[k].id);localData.id=maxId+1,localDataList.push(localData)}LocalStorageService.set("qualityCheckList",JSON.stringify(localDataList)),$ionicPopup.alert({title:"验证",template:'<p class="text-center">本地存储成功!</p>'}).then(function(){qualityCheckAddService.clearCachedData(),$state.go($scope.backUrl),$ionicViewSwitcher.nextDirection("back")})}}return!0}})},$scope.checkSheet=function(){var flag=!0,checkData=qualityCheckAddService.getCheckData(),checkDataShow=qualityCheckAddService.getCheckDataShow(),content=qualityCheckAddService.getContent(),problem=qualityCheckAddService.getProblems();checkData.solverId==-1&&(flag=!1,$ionicPopup.alert({title:"验证",template:'<p class="text-center">未选择处理人!</p>'})),void 0!=checkData.checkPosName&&""!=checkData.checkPosName||(flag=!1,$ionicPopup.alert({title:"验证",template:'<p class="text-center">未填写检查位置!</p>'})),checkDataShow.hasProblem&&problem.length<=0&&(flag=!1,$ionicPopup.alert({title:"验证",template:'<p class="text-center">需要设置检查内容和问题!</p>'})),qualityCheckAddService.getImagList().length<=0&&(flag=!1,$ionicPopup.alert({title:"验证",template:'<p class="text-center">需要上传检查照片!</p>'}));for(var contentFlag=!0,i=0;i<content.length;i++)(void 0==content[i].problems||content[i].problems.length<=0)&&(contentFlag=!1);return contentFlag||(flag=!1,$ionicPopup.alert({title:"验证",template:'<p class="text-center">有检查内容未设置问题!</p>'})),flag},$scope.getData=function(statusId){var checkData=qualityCheckAddService.getCheckData(),checkDataShow=qualityCheckAddService.getCheckDataShow(),problem=qualityCheckAddService.getProblems(),imagList=qualityCheckAddService.getImagList(),data={wid:160001,title:"",checkDate:checkData.checkDate,checkerId:qualityCheckAddService.getUserId(),solverId:checkData.solverId,hasProblem:checkDataShow.hasProblem?1:0,checkPosName:checkData.checkPosName,orgId:qualityCheckAddService.getRootOrgId(),statusId:statusId},dataDetail=[],title="";if(1==data.hasProblem){for(var i=0;i<problem.length-1;i++)title+=problem[i].name+"；";title+=problem[problem.length-1].name,data.title=title;for(var j=0;j<problem.length;j++)dataDetail.push({t:"quality_qualitycheck_detail",data:{checkContentId:problem[j].pId,checkProblemId:problem[j].id},key:"id"})}else 0==data.hasProblem&&(data.title="质量通病检查");if(imagList.length>0)for(var k=0;k<imagList.length;k++)dataDetail.push({t:"quality_qualitycheck_attach",data:{name:imagList[k].data.name,url:imagList[k].data.url},key:"id"});return{data:data,slave:dataDetail}},$scope.image_list=[],$scope.addAttachment=function(){YTService.addAttachment($scope,function(item){$scope.image_list.push(item),qualityCheckAddService.setImagList($scope.image_list)})},$scope.previewOrDelete=function(imgIndex){YTService.previewOrDelete(imgIndex,$scope.image_list,function(){$state.go("quality/check/canvas",{image:$scope.image_list[imgIndex],index:imgIndex,backUrl:$scope.url}),$ionicViewSwitcher.nextDirection("forward")}),qualityCheckAddService.setImagList($scope.image_list)},$scope.toChoose=function(url,backUrl){$state.go(url,{backUrl:backUrl}),$ionicViewSwitcher.nextDirection("forward")},$scope.toChooseById=function(id,url,backUrl){$state.go(url,{id:id,backUrl:backUrl}),$ionicViewSwitcher.nextDirection("forward")}}]),angular.module("app.quality.check").controller("qualityCheckCanvasController",["$scope","$state","$stateParams","$ionicViewSwitcher","$ionicPopup","qualityCheckAddService","YTService","UserService","env",function($scope,$state,$stateParams,$ionicViewSwitcher,$ionicPopup,qualityCheckAddService,YTService,userService,env){$scope.$on("$ionicView.beforeEnter",function(){$stateParams.backUrl&&($scope.backUrl=$stateParams.backUrl),null!=$stateParams.index&&($scope.index=$stateParams.index),$stateParams.image&&($scope.image=$stateParams.image,
$scope.drawing=new Drawing({id:"canvas",src:$scope.image.src,fullScreen:!0}))}),$scope.back=function(){$state.go($scope.backUrl,{backUrl:"quality/check/quality-list"}),$ionicViewSwitcher.nextDirection("back")},$scope.save=function(){$ionicPopup.confirm({title:"提示",template:'<p class="text-center">您确定要保存编辑的图片？</p>',cancelText:"取消",okText:"确定"}).then(function(res){if(res){$scope.data=$scope.drawing.getImage();var imgList=qualityCheckAddService.getImagList();YTService.uploadBase64Attach($scope.data,function(item){var ticket=userService.getTicket();item.src=item.data.url.replace("\\","/"),item.src=env.server+"download.action?rnd="+Math.random()+"&tkt="+ticket+"&fileName="+item.src,imgList[$scope.index]=item,qualityCheckAddService.setImagList(imgList),$ionicPopup.alert({title:"提示",template:'<p class="text-center">保存成功!</p>'}).then(function(){$state.go($scope.backUrl,{backUrl:"quality/check/quality-list"}),$ionicViewSwitcher.nextDirection("back")})})}})}}]),angular.module("app.quality.check").controller("qualityCheckContentController",["$scope","$state","$stateParams","$ionicPopup","qualityCheckAddService","$ionicViewSwitcher",function($scope,$state,$stateParams,$ionicPopup,qualityCheckAddService,$ionicViewSwitcher){$scope.content=[],$scope.$on("$ionicView.beforeEnter",function(){$stateParams.backUrl&&($scope.backUrl=$stateParams.backUrl),qualityCheckAddService.queryCheckContent(-1,1,function(data){$scope.content=data,$scope.checkContent()})}),$scope.checkContent=function(){var contentList=qualityCheckAddService.getContent();if(void 0!=$scope.content)for(var j=0;j<$scope.content.length;j++){var flag=!1;if(void 0!=contentList)for(var i=0;i<contentList.length;i++)$scope.content[j].id==contentList[i].id&&(flag=!0);$scope.content[j].checked=flag}},$scope.chooseContent=function(list){for(var contentList=qualityCheckAddService.getContent(),i=0;i<list.length;i++)if(void 0!=list[i].checked&&""!=list[i].checked&&list[i].checked){for(var flag=!1,j=0;j<contentList.length;j++)contentList[j].id==list[i].id&&(flag=!0);flag||qualityCheckAddService.pushContent(list[i])}for(var delIds=[],m=0;m<contentList.length;m++){for(var delFlag=!0,n=0;n<list.length;n++)void 0!=list[n].checked&&""!=list[n].checked&&list[n].checked&&contentList[m].id==list[n].id&&(delFlag=!1);delFlag&&delIds.push(contentList[m].id)}if(delIds.length>0)for(var k=0;k<delIds.length;k++)qualityCheckAddService.removeContent(delIds[k]);$state.go($scope.backUrl,{backUrl:"quality/check/quality-list"}),$ionicViewSwitcher.nextDirection("back")},$scope.back=function(){$state.go($scope.backUrl,{backUrl:"quality/check/quality-list"}),$ionicViewSwitcher.nextDirection("back")}}]),angular.module("app.quality.check").controller("qualityCheckContentProblemController",["$scope","$state","$stateParams","$ionicPopup","qualityCheckAddService","$ionicViewSwitcher",function($scope,$state,$stateParams,$ionicPopup,qualityCheckAddService,$ionicViewSwitcher){$scope.$on("$ionicView.beforeEnter",function(){$stateParams.backUrl&&($scope.backUrl=$stateParams.backUrl),qualityCheckAddService.queryCheckContent($stateParams.id,2,function(data){$scope.problems=data,$scope.checkProblem($scope.problems)});var type=qualityCheckAddService.getType();"add"==type?$scope.url="quality/check/quality-add":"edit"==type?$scope.url="quality/check/quality-edit":"draft"==type&&($scope.url="quality/check/quality-drafts-edit")}),$scope.checkProblem=function(problemss){var problems=qualityCheckAddService.getProblems();if(problems.length>0)for(var j=0;j<problemss.length;j++){for(var flag=!1,i=0;i<problems.length;i++)problemss[j].id==problems[i].id&&(flag=!0);problemss[j].checked=flag}else for(var k=0;k<problemss.length;k++)problemss[k].checked=!1},$scope.chooseProblem=function(list){for(var content=qualityCheckAddService.getContent(),j=0;j<content.length;j++)if($stateParams.id==content[j].id){qualityCheckAddService.removeContentProblems(content[j].id);for(var problems=[],i=0;i<list.length;i++)void 0!=list[i].checked&&""!=list[i].checked&&list[i].checked&&(problems.push(list[i]),qualityCheckAddService.pushProblem(list[i]));content[j].problems=problems,qualityCheckAddService.setContent(content),$state.go($scope.backUrl,{backUrl:"quality/check/quality-list"}),$ionicViewSwitcher.nextDirection("back")}},$scope.back=function(){$state.go($scope.backUrl,{backUrl:"quality/check/quality-list"}),$ionicViewSwitcher.nextDirection("back")},$scope.showPrompt=function(){$ionicPopup.prompt({title:"新增问题",cancelText:"取消",okText:"确定"}).then(function(res){for(var problems=$scope.problems,flag=!1,index=-1,i=0;i<problems.length;i++)problems[i].name==res.trim()&&(flag=!0,index=i);if(flag)index!=-1&&($scope.problems[index].checked=!0);else{var problem={name:res.trim(),pid:$stateParams.id,level:2,orgId:qualityCheckAddService.getRootOrgId(),delFlag:0};qualityCheckAddService.insertCheckProblem(problem,function(data){problem.contentId=$stateParams.pId,problem.id=data,qualityCheckAddService.queryCheckContent(problem.pid,2,function(data){for(var list=qualityCheckAddService.deepClone($scope.problems),ids=[],j=0;j<list.length;j++)void 0!=list[j].checked&&""!=list[j].checked&&list[j].checked&&ids.push(list[j].id);$scope.problems=data;for(var i=0;i<$scope.problems.length;i++)if($scope.problems[i].id!=problem.id){for(var m=0;m<ids.length;m++)if($scope.problems[i].id==ids[m]){$scope.problems[i].checked=!0;break}}else $scope.problems[i].checked=!0})})}})}}]),angular.module("app.quality.check").controller("qualityCheckDetailController",["$scope","$state","$stateParams","qualityCheckService","$ionicViewSwitcher",function($scope,$state,$stateParams,qualityCheckService,$ionicViewSwitcher){$scope.$on("$ionicView.loaded",function(){qualityCheckService.queryDetail($stateParams.id,function(data){$scope.detailInfo=data}),qualityCheckService.queryDetailProblem($stateParams.id,function(){$scope.contentList=qualityCheckService.getContent()}),qualityCheckService.queryDetailCheckAttach($stateParams.id,function(data){$scope.checkAttach=data,qualityCheckService.changeAttach($scope.checkAttach)}),qualityCheckService.queryDetailRecheckAttach($stateParams.id,function(data){$scope.recheckAttach=data,qualityCheckService.changeAttach($scope.recheckAttach)}),$scope.backUrl=$stateParams.backUrl||"quality/check/quality-list"}),$scope.back=function(){$state.go($scope.backUrl),$ionicViewSwitcher.nextDirection("back")},$scope.preview=function(imgIndex,arr){qualityCheckService.preview(imgIndex,arr)}}]),angular.module("app.quality.check").controller("qualityCheckDraftsEditController",["$scope","$state","$stateParams","$ionicPopup","qualityCheckAddService","$filter","$ionicHistory","$ionicActionSheet","LocalStorageService","$ionicViewSwitcher","YTService",function($scope,$state,$stateParams,$ionicPopup,qualityCheckAddService,$filter,$ionicHistory,$ionicActionSheet,LocalStorageService,$ionicViewSwitcher,YTService){$scope.checkData=qualityCheckAddService.getCheckData(),$scope.checkDataShow=qualityCheckAddService.getCheckDataShow(),$scope.contentList=qualityCheckAddService.getContent(),$scope.checkTypeFlag=!1,$scope.checkDate=YTM.initDatePicker({callback:function(){$scope.checkData.checkDate=$filter("date")($scope.checkDate.date,"yyyy-MM-dd"),qualityCheckAddService.setCheckDate($scope.checkData.checkDate),$scope.checkDatePopup.close()}}),$scope.openCheckDate=function(){$scope.checkDatePopup=$ionicPopup.show({templateUrl:"check-date.html",scope:$scope,cssClass:"customTimerPopover"}),$scope.checkDatePopup.then(function(res){console.log("Tapped!",res)})},qualityCheckAddService.setType($stateParams.type),$scope.url="quality/check/quality-drafts-edit",$scope.titleName="编辑本地质量通病检查",$scope.$on("$ionicView.beforeEnter",function(){$scope.backUrl="quality/check/quality-drafts-list",$stateParams.id?qualityCheckAddService.getDraftData($stateParams.id,function(){$scope.checkData=qualityCheckAddService.getCheckData(),$scope.checkDataShow=qualityCheckAddService.getCheckDataShow(),$scope.contentList=qualityCheckAddService.getContent(),$scope.image_list=qualityCheckAddService.getImagList()}):($scope.image_list=qualityCheckAddService.getImagList(),$scope.checkData=qualityCheckAddService.getCheckData(),$scope.checkDataShow=qualityCheckAddService.getCheckDataShow(),$scope.contentList=qualityCheckAddService.getContent())}),$scope.showConfirmDel=function(id){var confirmPopup=$ionicPopup.confirm({title:"提示",template:'<p class="text-center">确认删除？</p>',cancelText:"取消",okText:"确定"});confirmPopup.then(function(res){res&&(qualityCheckAddService.removeContent(id),$scope.contentList=qualityCheckAddService.getContent(),$ionicPopup.alert({title:"提示",template:'<p class="text-center">删除成功!</p>'}))})},$scope.back=function(){qualityCheckAddService.clearCachedData(),$state.go($scope.backUrl),$ionicViewSwitcher.nextDirection("back")},$scope.submit=function(){$ionicActionSheet.show({buttons:[{text:"提交"},{text:"保存服务器"},{text:"保存本地"}],cancelText:"取消",cancel:function(){return!0},buttonClicked:function(index){if($scope.checkSheet()){var data={};if(0==index&&(data=$scope.getData(1),1==data.data.hasProblem?qualityCheckAddService.insertQualityCheckData(data.data,data.slave,{status:"audit",pushUserId:data.data.solverId,condition:{"状态":"处理"},wId:160001,userId:qualityCheckAddService.getUserId(),orgId:qualityCheckAddService.getRootOrgId()},function(data){200==data.status&&$ionicPopup.alert({title:"验证",template:'<p class="text-center">提交成功!</p>'}).then(function(){$scope.delDraft(qualityCheckAddService.getId()),qualityCheckAddService.clearCachedData(),$state.go($scope.backUrl),$ionicViewSwitcher.nextDirection("back")})}):0==data.data.hasProblem&&qualityCheckAddService.insertQualityCheckData(data.data,data.slave,{status:"audit",pushUserId:data.data.solverId,condition:{"状态":"通过"},wId:160001,userId:qualityCheckAddService.getUserId(),orgId:qualityCheckAddService.getRootOrgId()},function(data){200==data.status&&$ionicPopup.alert({title:"验证",template:'<p class="text-center">提交成功!</p>'}).then(function(){$scope.delDraft(qualityCheckAddService.getId()),qualityCheckAddService.clearCachedData(),$state.go($scope.backUrl),$ionicViewSwitcher.nextDirection("back")})})),1==index&&(data=$scope.getData(0),qualityCheckAddService.insertQualityCheckData(data.data,data.slave,{status:"saved"},function(data){200==data.status&&$ionicPopup.alert({title:"验证",template:'<p class="text-center">保存成功!</p>'}).then(function(){$scope.delDraft(qualityCheckAddService.getId()),qualityCheckAddService.clearCachedData(),$state.go($scope.backUrl),$ionicViewSwitcher.nextDirection("back")})})),2==index){var problem=qualityCheckAddService.getProblems(),title="",checkDataShow=qualityCheckAddService.getCheckDataShow();if(1==checkDataShow.hasProblem){for(var i=0;i<problem.length-1;i++)title+=problem[i].name+"；";title+=problem[problem.length-1].name}else 0==checkDataShow.hasProblem&&(title="质量通病检查");for(var localDataList=JSON.parse(LocalStorageService.get("qualityCheckList")),currentId=qualityCheckAddService.getId(),localData={id:currentId,title:title,checkData:qualityCheckAddService.getCheckData(),checkDataShow:checkDataShow,content:qualityCheckAddService.getContent(),problems:problem,attach:qualityCheckAddService.getImagList()},k=0;k<localDataList.length;k++)localDataList[k].id==currentId&&(localDataList[i]=localData);LocalStorageService.set("qualityCheckList",JSON.stringify(localDataList)),$ionicPopup.alert({title:"验证",template:'<p class="text-center">本地存储成功!</p>'}).then(function(){qualityCheckAddService.clearCachedData(),$state.go($scope.backUrl),$ionicViewSwitcher.nextDirection("back")})}}return!0}})},$scope.checkSheet=function(){var flag=!0,checkData=qualityCheckAddService.getCheckData(),checkDataShow=qualityCheckAddService.getCheckDataShow(),content=qualityCheckAddService.getContent(),problem=qualityCheckAddService.getProblems();checkData.solverId==-1&&(flag=!1,$ionicPopup.alert({title:"验证",template:'<p class="text-center">未选择处理人!</p>'})),checkData.checkTypeId==-1&&(flag=!1,$ionicPopup.alert({title:"验证",template:'<p class="text-center">未选择检查类型!</p>'})),checkData.checkPosId==-1&&""==checkDataShow.checkPositionName&&(flag=!1,$ionicPopup.alert({title:"验证",template:'<p class="text-center">未选择检查位置!</p>'})),checkDataShow.hasProblem&&problem.length<=0&&(flag=!1,$ionicPopup.alert({title:"验证",template:'<p class="text-center">需要设置检查内容和问题!</p>'})),qualityCheckAddService.getImagList().length<=0&&(flag=!1,$ionicPopup.alert({title:"验证",template:'<p class="text-center">需要上传检查照片!</p>'}));for(var contentFlag=!0,i=0;i<content.length;i++)(void 0==content[i].problems||content[i].problems.length<=0)&&(contentFlag=!1);return contentFlag||(flag=!1,$ionicPopup.alert({title:"验证",template:'<p class="text-center">有检查内容未设置问题!</p>'})),flag},$scope.getData=function(statusId){var checkData=qualityCheckAddService.getCheckData(),checkDataShow=qualityCheckAddService.getCheckDataShow(),problem=qualityCheckAddService.getProblems(),imagList=qualityCheckAddService.getImagList(),data={wid:160001,title:"",checkDate:checkData.checkDate,checkerId:qualityCheckAddService.getUserId(),solverId:checkData.solverId,hasProblem:checkDataShow.hasProblem?1:0,checkPosName:checkData.checkPosName,orgId:qualityCheckAddService.getRootOrgId(),statusId:statusId},dataDetail=[],title="";if(1==data.hasProblem){for(var i=0;i<problem.length-1;i++)title+=problem[i].name+"；";title+=problem[problem.length-1].name,data.title=title;for(var j=0;j<problem.length;j++)dataDetail.push({t:"quality_qualitycheck_detail",data:{checkContentId:problem[j].pId,checkProblemId:problem[j].id},key:"id"})}else 0==data.hasProblem&&(data.title="质量通病检查");if(imagList.length>0)for(var k=0;k<imagList.length;k++)dataDetail.push({t:"quality_qualitycheck_attach",data:{name:imagList[k].data.name,url:imagList[k].data.url},key:"id"});return{data:data,slave:dataDetail}},$scope.delDraft=function(id){for(var list=JSON.parse(LocalStorageService.get("qualityCheckList")),i=0;i<list.length;i++)if(list[i].id==id){list.splice(i,1);break}LocalStorageService.set("qualityCheckList",JSON.stringify(list))},$scope.addAttachment=function(){YTService.addAttachment($scope,function(item){$scope.image_list.push(item),qualityCheckAddService.setImagList($scope.image_list)})},$scope.previewOrDelete=function(imgIndex){YTService.previewOrDelete(imgIndex,$scope.image_list,function(){$state.go("quality/check/canvas",{image:$scope.image_list[imgIndex],index:imgIndex,backUrl:$scope.url}),$ionicViewSwitcher.nextDirection("forward")}),qualityCheckAddService.setImagList($scope.image_list)},$scope.toChoose=function(url,backUrl){$state.go(url,{backUrl:backUrl}),$ionicViewSwitcher.nextDirection("forward")},$scope.toChooseById=function(id,url,backUrl){$state.go(url,{id:id,backUrl:backUrl}),$ionicViewSwitcher.nextDirection("forward")}}]),angular.module("app.quality.check").controller("qualityCheckDraftsListController",["$scope","$state","LocalStorageService","$ionicViewSwitcher",function($scope,$state,LocalStorageService,$ionicViewSwitcher){$scope.$on("$ionicView.beforeEnter",function(){$scope.qualityCheckList=JSON.parse(LocalStorageService.get("qualityCheckList"))}),$scope.toEdit=function(id){$state.go("quality/check/quality-drafts-edit",{id:id}),$ionicViewSwitcher.nextDirection("forward")},$scope.back=function(){$state.go("quality/check/quality-list"),$ionicViewSwitcher.nextDirection("back")}}]),angular.module("app.quality.check").controller("qualityCheckEditController",["$scope","$state","$stateParams","$ionicPopup","qualityCheckAddService","$filter","$ionicHistory","$ionicActionSheet","LocalStorageService","$ionicViewSwitcher","YTService",function($scope,$state,$stateParams,$ionicPopup,qualityCheckAddService,$filter,$ionicHistory,$ionicActionSheet,LocalStorageService,$ionicViewSwitcher,YTService){$scope.checkData=qualityCheckAddService.getCheckData(),$scope.checkDataShow=qualityCheckAddService.getCheckDataShow(),$scope.contentList=qualityCheckAddService.getContent(),$scope.checkDate=YTM.initDatePicker({callback:function(){$scope.checkData.checkDate=$filter("date")($scope.checkDate.date,"yyyy-MM-dd"),qualityCheckAddService.setCheckDate($scope.checkData.checkDate),$scope.checkDatePopup.close()}}),$scope.openCheckDate=function(){$scope.checkDatePopup=$ionicPopup.show({templateUrl:"check-date.html",scope:$scope,cssClass:"customTimerPopover"}),$scope.checkDatePopup.then(function(res){console.log("Tapped!",res)})},qualityCheckAddService.setType($stateParams.type),$scope.url="quality/check/quality-edit",$scope.titleName="编辑质量通病检查",$scope.$on("$ionicView.beforeEnter",function(){$stateParams.backUrl&&($scope.backUrl=$stateParams.backUrl),$stateParams.id?(qualityCheckAddService.queryDetail($stateParams.id,function(){$scope.checkData=qualityCheckAddService.getCheckData(),$scope.checkDataShow=qualityCheckAddService.getCheckDataShow()}),qualityCheckAddService.queryDetailContent($stateParams.id,function(){$scope.contentList=qualityCheckAddService.getContent()}),qualityCheckAddService.queryAttach($stateParams.id,function(){$scope.image_list=qualityCheckAddService.getImagList()})):($scope.image_list=qualityCheckAddService.getImagList(),$scope.checkData=qualityCheckAddService.getCheckData(),$scope.checkDataShow=qualityCheckAddService.getCheckDataShow(),$scope.contentList=qualityCheckAddService.getContent())}),$scope.showConfirmDel=function(id){var confirmPopup=$ionicPopup.confirm({title:"提示",template:'<p class="text-center">确认删除？</p>',cancelText:"取消",okText:"确定"});confirmPopup.then(function(res){res&&(qualityCheckAddService.removeContent(id),$scope.contentList=qualityCheckAddService.getContent(),$ionicPopup.alert({title:"提示",template:'<p class="text-center">删除成功!</p>'}))})},$scope.back=function(){qualityCheckAddService.clearCachedData(),$state.go($scope.backUrl),$ionicViewSwitcher.nextDirection("back")},$scope.submit=function(){$ionicActionSheet.show({buttons:[{text:"提交"},{text:"保存"}],cancelText:"取消",cancel:function(){return!0},buttonClicked:function(index){if($scope.checkSheet()){var data={};0==index&&(data=$scope.getData(1),1==data.data.hasProblem?qualityCheckAddService.updateQualityCheckData(data.data,data.slave,{status:"audit",pushUserId:data.data.solverId,condition:{"状态":"处理"},wId:160001,userId:qualityCheckAddService.getUserId(),orgId:qualityCheckAddService.getRootOrgId()},function(data){200==data.status&&$ionicPopup.alert({title:"验证",template:'<p class="text-center">提交成功!</p>'}).then(function(){qualityCheckAddService.clearCachedData(),$state.go($scope.backUrl),$ionicViewSwitcher.nextDirection("back")})}):0==data.data.hasProblem&&qualityCheckAddService.updateQualityCheckData(data.data,data.slave,{status:"audit",pushUserId:data.data.solverId,condition:{"状态":"通过"},wId:160001,userId:qualityCheckAddService.getUserId(),orgId:qualityCheckAddService.getRootOrgId()},function(data){200==data.status&&$ionicPopup.alert({title:"验证",template:'<p class="text-center">提交成功!</p>'}).then(function(){qualityCheckAddService.clearCachedData(),$state.go($scope.backUrl),$ionicViewSwitcher.nextDirection("back")})})),1==index&&(data=$scope.getData(0),qualityCheckAddService.updateDailyCheckData(data.data,data.slave,{status:"saved"},function(data){200==data.status&&$ionicPopup.alert({title:"验证",template:'<p class="text-center">保存成功!</p>'}).then(function(){qualityCheckAddService.clearCachedData(),$state.go($scope.backUrl),$ionicViewSwitcher.nextDirection("back")})}))}return!0}})},$scope.checkSheet=function(){var flag=!0,checkData=qualityCheckAddService.getCheckData(),checkDataShow=qualityCheckAddService.getCheckDataShow(),content=qualityCheckAddService.getContent(),problem=qualityCheckAddService.getProblems();checkData.solverId==-1&&(flag=!1,$ionicPopup.alert({title:"验证",template:'<p class="text-center">未选择处理人!</p>'})),checkDataShow.hasProblem&&problem.length<=0&&(flag=!1,$ionicPopup.alert({title:"验证",template:'<p class="text-center">需要设置检查内容和问题!</p>'})),qualityCheckAddService.getImagList().length<=0&&(flag=!1,$ionicPopup.alert({title:"验证",template:'<p class="text-center">需要上传检查照片!</p>'}));for(var contentFlag=!0,i=0;i<content.length;i++)(void 0==content[i].problems||content[i].problems.length<=0)&&(contentFlag=!1);return contentFlag||(flag=!1,$ionicPopup.alert({title:"验证",template:'<p class="text-center">有检查内容未设置问题!</p>'})),flag},$scope.getData=function(statusId){var checkData=qualityCheckAddService.getCheckData(),checkDataShow=qualityCheckAddService.getCheckDataShow(),problem=qualityCheckAddService.getProblems(),imagList=qualityCheckAddService.getImagList(),data={id:qualityCheckAddService.getId(),wid:160001,title:"",checkDate:checkData.checkDate,checkerId:qualityCheckAddService.getUserId(),solverId:checkData.solverId,hasProblem:checkDataShow.hasProblem?1:0,checkPosName:checkData.checkPosName,orgId:qualityCheckAddService.getRootOrgId(),statusId:statusId},dataDetail=[],title="";if(1==data.hasProblem){for(var i=0;i<problem.length-1;i++)title+=problem[i].name+"；";title+=problem[problem.length-1].name,data.title=title;for(var j=0;j<problem.length;j++)dataDetail.push({t:"quality_qualitycheck_detail",data:{id:qualityCheckAddService.getId(),checkContentId:problem[j].pId,checkProblemId:problem[j].id},key:"id"})}else 0==data.hasProblem&&(data.title="质量通病检查");if(imagList.length>0)for(var k=0;k<imagList.length;k++)dataDetail.push({t:"quality_qualitycheck_attach",data:{id:qualityCheckAddService.getId(),name:imagList[k].data.name,url:imagList[k].data.url},key:"id"});return{data:data,slave:dataDetail}},$scope.addAttachment=function(){YTService.addAttachment($scope,function(item){$scope.image_list.push(item),qualityCheckAddService.setImagList($scope.image_list)})},$scope.previewOrDelete=function(imgIndex){YTService.previewOrDelete(imgIndex,$scope.image_list,function(){$state.go("quality/check/canvas",{image:$scope.image_list[imgIndex],index:imgIndex,backUrl:$scope.url}),$ionicViewSwitcher.nextDirection("forward")}),qualityCheckAddService.setImagList($scope.image_list)},$scope.toChoose=function(url,backUrl){$state.go(url,{backUrl:backUrl}),$ionicViewSwitcher.nextDirection("forward")},$scope.toChooseById=function(id,url,backUrl){$state.go(url,{id:id,backUrl:backUrl}),$ionicViewSwitcher.nextDirection("forward")}}]),angular.module("app.quality.check").controller("qualityCheckListController",["$scope","$state","$ionicHistory","$ionicModal","$ionicPopup","qualityCheckService","$ionicScrollDelegate","$filter","LocalStorageService","$ionicViewSwitcher",function($scope,$state,$ionicHistory,$ionicModal,$ionicPopup,qualityCheckService,$ionicScrollDelegate,$filter,LocalStorageService,$ionicViewSwitcher){$scope.condition=qualityCheckService.getCondition(),$scope.$on("$ionicView.beforeEnter",function(){$scope.refreshListData(),$ionicScrollDelegate.scrollTop();var localData=JSON.parse(LocalStorageService.get("qualityCheckList"));void 0==localData||localData.length<=0?($scope.showDrafts=!1,$scope.localDataLength=0):($scope.showDrafts=!0,$scope.localDataLength=localData.length)}),$scope.loadListData=function(){qualityCheckService.loadListData(function(){$scope.fillData(),$scope.$broadcast("scroll.infiniteScrollComplete")})},$scope.refreshListData=function(){qualityCheckService.clearCachedData(),qualityCheckService.refreshListData(function(){$scope.fillData(),$scope.$broadcast("scroll.refreshComplete")})},$scope.fillData=function(){$scope.qualityCheckList=qualityCheckService.getServiceData(),$scope.hasNextPage=qualityCheckService.hasNextPage(),$scope.right=qualityCheckService.getRight()},$scope.searchData=function(){if($scope.modalQueryType.hide(),qualityCheckService.clearCachedData(),$ionicScrollDelegate.scrollTop(),$scope.condition.startTime&&$scope.condition.endTime){var beginTimes=$scope.condition.startTime.substring(0,10).split("-"),endTimes=$scope.condition.endTime.substring(0,10).split("-"),beginTime=beginTimes[1]+"-"+beginTimes[2]+"-"+beginTimes[0]+" "+$scope.condition.startTime.substring(10,19),endTime=endTimes[1]+"-"+endTimes[2]+"-"+endTimes[0]+" "+$scope.condition.endTime.substring(10,19),a=(Date.parse(endTime)-Date.parse(beginTime))/3600/1e3;a<0?$ionicPopup.alert({title:"警告消息",template:"开始时间不能大于结束时间！"}):($scope.modalQueryMore.hide(),$scope.loadListData())}else $scope.modalQueryMore.hide(),$scope.loadListData()},$scope.clearSearchText=function(){qualityCheckService.resetCondition(),$scope.condition=qualityCheckService.getCondition()},$scope.back=function(){qualityCheckService.clearCachedData(),qualityCheckService.resetCondition(),$state.go("menu"),$ionicViewSwitcher.nextDirection("back")},$scope.toAdd=function(){qualityCheckService.clearCachedData(),qualityCheckService.resetCondition(),$state.go("quality/check/quality-add",{backUrl:"quality/check/quality-list"}),$ionicViewSwitcher.nextDirection("forward")},$scope.toDraftsList=function(){qualityCheckService.clearCachedData(),qualityCheckService.resetCondition(),$state.go("quality/check/quality-drafts-list"),$ionicViewSwitcher.nextDirection("forward")},$scope.toDetail=function(id,checkerId,solverId,nodeName){var right=qualityCheckService.getRight(),userId=qualityCheckService.getUserId();"草稿箱"==nodeName?$state.go("quality/check/quality-edit",{id:id,backUrl:"quality/check/quality-list"}):"处理人审核"==nodeName?right.solver&&solverId==userId?$state.go("quality/check/quality-solve",{id:id}):$state.go("quality/check/quality-detail",{id:id}):"复查人审核"==nodeName?right.rechecker?$state.go("quality/check/quality-recheck",{id:id}):$state.go("quality/check/quality-detail",{id:id}):"审批通过"==nodeName?$state.go("quality/check/quality-detail",{id:id}):"审批不通过"==nodeName&&(right.solver&&solverId==userId?$state.go("quality/check/quality-solve",{id:id}):$state.go("quality/check/quality-detail",{id:id})),$ionicViewSwitcher.nextDirection("forward")},$scope.isqueryType=!1,$scope.isqueryMore=!1,$scope.isProblem=!1,$scope.startTime=YTM.initDatePicker({callback:function(){$scope.condition.startTime=$filter("date")($scope.startTime.date,"yyyy-MM-dd"),qualityCheckService.setStartTime($scope.condition.startTime),$scope.startTimerPopup.close()}}),$scope.endTime=YTM.initDatePicker({callback:function(){$scope.condition.endTime=$filter("date")($scope.endTime.date,"yyyy-MM-dd"),qualityCheckService.setEndTime($scope.condition.endTime),$scope.endTimerPopup.close()}}),$scope.openStartTime=function(){$scope.startTimerPopup=$ionicPopup.show({templateUrl:"start-time.html",scope:$scope,cssClass:"customTimerPopover"}),$scope.startTimerPopup.then(function(res){console.log("Tapped!",res)})},$scope.openEndTime=function(){$scope.endTimerPopup=$ionicPopup.show({templateUrl:"end-time.html",scope:$scope,cssClass:"customTimerPopover"}),$scope.endTimerPopup.then(function(res){console.log("Tapped!",res)})},$scope.openQueryType=function(){$scope.modalQueryType.show(),$scope.isqueryType=!$scope.isqueryType,$scope.isqueryMore=!1},$scope.openQueryMore=function(){$scope.modalQueryMore.show(),$scope.isqueryMore=!$scope.isqueryMore,$scope.isqueryType=!1},$scope.closeQuery=function(){$scope.isqueryType=!1,$scope.isqueryMore=!1},$ionicModal.fromTemplateUrl("query-more.html",{scope:$scope,animation:"slide-in-up"}).then(function(modal){$scope.modalQueryMore=modal}),$ionicModal.fromTemplateUrl("query-type.html",{scope:$scope,animation:"slide-in-up"}).then(function(modal){$scope.modalQueryType=modal}),$scope.openProblem=function(){$scope.isProblem=!0},$scope.closeProblem=function(name){$scope.isProblem=!1,$scope.condition.hasProblemName=name}}]),angular.module("app.quality.check").controller("qualityCheckRecheckController",["$scope","$state","$stateParams","qualityCheckService","$ionicPopup","$ionicViewSwitcher","$ionicActionSheet","$filter","UserService","env","YTService",function($scope,$state,$stateParams,qualityCheckService,$ionicPopup,$ionicViewSwitcher,$ionicActionSheet,$filter,userService,env,YTService){$scope.detailInfo={},$scope.$on("$ionicView.beforeEnter",function(){qualityCheckService.queryDetail($stateParams.id,function(data){$scope.detailInfo=data;var now=new Date;$scope.detailInfo.recheckDate=now.getFullYear()+"-"+qualityCheckService.prefixInteger(now.getMonth()+1,2)+"-"+qualityCheckService.prefixInteger(now.getDate(),2),$scope.detailInfo.recheckerName=qualityCheckService.getUserName()}),qualityCheckService.queryDetailProblem($stateParams.id,function(){$scope.contentList=qualityCheckService.getContent()}),qualityCheckService.queryDetailCheckAttach($stateParams.id,function(data){$scope.checkAttach=data,$scope.changeAttach($scope.checkAttach)}),$scope.backUrl=$stateParams.backUrl||"quality/check/quality-list"}),$scope.recheckDate=YTM.initDatePicker({callback:function(){$scope.detailInfo.recheckDate=$filter("date")($scope.recheckDate.date,"yyyy-MM-dd"),$scope.recheckDatePopup.close()}}),$scope.openRecheckDate=function(){$scope.recheckDatePopup=$ionicPopup.show({templateUrl:"check-date.html",scope:$scope,cssClass:"customTimerPopover"}),$scope.recheckDatePopup.then(function(res){console.log("Tapped!",res)})},$scope.recheck=function(data){$ionicActionSheet.show({buttons:[{text:"通过"},{text:"不通过"}],cancelText:"取消",cancel:function(){return!0},buttonClicked:function(index){return $scope.check()&&(data.recheckerId=qualityCheckService.getUserId(),data.imagList=qualityCheckService.getImagList(),0==index?qualityCheckService.solveAndRecheckData(data,16001004,"通过",function(){$ionicPopup.alert({title:"提示",template:'<p class="text-center">您已通过该检查!</p>'}).then(function(){$state.go($scope.backUrl),$ionicViewSwitcher.nextDirection("back")})}):1==index&&qualityCheckService.solveAndRecheckData(data,16001004,"不通过",function(){$ionicPopup.alert({title:"提示",template:'<p class="text-center">您退回了该检查!</p>'}).then(function(){$state.go($scope.backUrl),$ionicViewSwitcher.nextDirection("back")})})),!0}})},$scope.check=function(){var flag=!0;return qualityCheckService.getImagList().length<=0&&(flag=!1,$ionicPopup.alert({title:"验证",template:'<p class="text-center">需要上传复查照片!</p>'})),flag},$scope.back=function(){$state.go($scope.backUrl),$ionicViewSwitcher.nextDirection("back")},$scope.changeAttach=function(list){if(list.length>0)for(var i=0;i<list.length;i++){var ticket=userService.getTicket();list[i].src=list[i].url.replace("\\","/"),list[i].src=env.server+"download.action?rnd="+Math.random()+"&tkt="+ticket+"&fileName="+list[i].src}},$scope.preview=function(imgIndex,arr){$ionicActionSheet.show({buttons:[{text:"预览"}],cancelText:"关闭",cancel:function(){return!0},buttonClicked:function(){return PhotoViewer.show(arr[imgIndex].src),!0}})},$scope.image_list=[],$scope.addAttachment=function(){YTService.addAttachment($scope,function(item){$scope.image_list.push(item),qualityCheckService.setImagList($scope.image_list)})},$scope.previewOrDelete=function(imgIndex){YTService.previewOrDelete(imgIndex,$scope.image_list,function(){$state.go("quality/check/canvas",{image:$scope.image_list[imgIndex],index:imgIndex,backUrl:$scope.url}),$ionicViewSwitcher.nextDirection("forward")}),qualityCheckService.setImagList($scope.image_list)},$scope.preview=function(imgIndex,arr){qualityCheckService.preview(imgIndex,arr)}}]),angular.module("app.quality.check").controller("qualityCheckSolveController",["$scope","$state","$stateParams","qualityCheckService","$ionicPopup","$ionicViewSwitcher","UserService","env","$ionicActionSheet",function($scope,$state,$stateParams,qualityCheckService,$ionicPopup,$ionicViewSwitcher,userService,env,$ionicActionSheet){$scope.$on("$ionicView.beforeEnter",function(){qualityCheckService.queryDetail($stateParams.id,function(data){$scope.detailInfo=data}),qualityCheckService.queryDetailProblem($stateParams.id,function(){$scope.contentList=qualityCheckService.getContent()}),qualityCheckService.queryDetailCheckAttach($stateParams.id,function(data){$scope.checkAttach=data,$scope.changeAttach($scope.checkAttach)}),qualityCheckService.queryDetailRecheckAttach($stateParams.id,function(data){$scope.recheckAttach=[],data.length>0&&($scope.recheckAttach=data,$scope.changeAttach($scope.recheckAttach))}),$scope.backUrl=$stateParams.backUrl||"quality/check/quality-list"}),$scope.solve=function(data){qualityCheckService.solveAndRecheckData(data,16001003,"复查",function(){$ionicPopup.alert({title:"验证",template:'<p class="text-center">处理成功!</p>'
}).then(function(){$state.go($scope.backUrl),$ionicViewSwitcher.nextDirection("back")})})},$scope.back=function(){$state.go($scope.backUrl),$ionicViewSwitcher.nextDirection("back")},$scope.changeAttach=function(list){if(list.length>0)for(var i=0;i<list.length;i++){var ticket=userService.getTicket();list[i].src=list[i].url.replace("\\","/"),list[i].src=env.server+"download.action?rnd="+Math.random()+"&tkt="+ticket+"&fileName="+list[i].src}},$scope.preview=function(imgIndex,arr){$ionicActionSheet.show({buttons:[{text:"预览"}],cancelText:"关闭",cancel:function(){return!0},buttonClicked:function(){return PhotoViewer.show(arr[imgIndex].src),!0}})}}]),angular.module("app.quality.check").controller("qualityCheckSolverController",["$scope","$state","$stateParams","$ionicPopup","qualityCheckAddService","$ionicViewSwitcher",function($scope,$state,$stateParams,$ionicPopup,qualityCheckAddService,$ionicViewSwitcher){$scope.$on("$ionicView.beforeEnter",function(){$stateParams.backUrl&&($scope.backUrl=$stateParams.backUrl),qualityCheckAddService.querySolver(function(data){$scope.solver=data}),$scope.solverId=qualityCheckAddService.getCheckData().solverId}),$scope.chooseSolver=function(obj){qualityCheckAddService.setSolverId(obj.userId),qualityCheckAddService.setSolverName(obj.realName),$state.go($scope.backUrl,{backUrl:"quality/check/quality-list"}),$ionicViewSwitcher.nextDirection("back")},$scope.back=function(){$state.go($scope.backUrl,{backUrl:"quality/check/quality-list"}),$ionicViewSwitcher.nextDirection("back")}}]),angular.module("app.quality.check").factory("qualityCheckAddService",["YTService","UserService","LocalStorageService","env",function(YT,userService,LocalStorageService,env){var checkData={title:"",checkDate:"",checkPosName:"",solverId:-1,statusId:-1},checkDataShow={checker:"",checkPositionName:"",solverName:"",addPositionName:[],hasProblem:!0},content=[],problems=[],position=[],solver=[],image_list=[],type="",id=-1;return{clearCachedData:function(){checkData={title:"",checkDate:"",checkPosName:"",solverId:-1,statusId:-1},checkDataShow={checker:"",checkPositionName:"",solverName:"",addPositionName:[],hasProblem:!0},content=[],problems=[],solver=[],position=[],image_list=[],type="",id=-1},queryDetail:function(id,successCallback){var self=this;self.setId(id);var data={m:16001002,t:"v_quality_qualitycheck"},filter=[{field:"id",value:id,operator:"=",relation:"and"}];data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){var detail=data.object[0];checkData={title:detail.title,checkDate:detail.checkDate,checkPosName:detail.checkPosName,solverId:detail.solverId,statusId:detail.statusId},checkDataShow={checker:detail.checkerName,checkPositionName:detail.checkPosName,solverName:detail.solverName,addPositionName:[],hasProblem:0!=detail.hasProblem},self.setCheckData(checkData),self.setCheckDataShow(checkDataShow),successCallback.call()}})},queryDetailContent:function(id,successCallback){var self=this,data={m:16001002,t:"v_quality_qualitycheck_detail"},filter=[{field:"id",value:id,operator:"=",relation:"and"}];data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){for(var contentData=data.object,contentList=[],problemList=[],contentMap={},problemMap={},i=0;i<contentData.length;i++)contentMap[contentData[i].checkContentId]={id:contentData[i].checkContentId,name:contentData[i].checkContentName,checked:!0},problemMap[contentData[i].checkProblemId]={id:contentData[i].checkProblemId,name:contentData[i].checkProblemName,pId:contentData[i].checkContentId,checked:!0},problemList.push({id:contentData[i].checkProblemId,name:contentData[i].checkProblemName,pId:contentData[i].checkContentId,checked:!0});for(var key in problemMap){var problems=contentMap[problemMap[key].pId].problems;problems=problems||[],problems.push(problemMap[key]),contentMap[problemMap[key].pId].problems=problems}for(var key in contentMap)contentList.push(contentMap[key]);self.setContent(contentList),self.setProblems(problemList),successCallback.call()}})},queryAttach:function(id,successCallback){var self=this,data={m:16001002,t:"quality_qualitycheck_attach"},filter=[{field:"id",value:id,operator:"=",relation:"and"}];data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){self.changeAttach(data.object),successCallback.call()}})},querySolver:function(successCallback){var data={m:16001002,t:"v_quality_projectperson"},filter=[];filter.push({field:"orgId",value:userService.getRootOrgId(),operator:"=",relation:"and"}),filter.push({field:"position",value:"处理人",operator:"=",relation:"and"}),data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){successCallback.call(this,data.object)}})},queryCheckContent:function(id,level,successCallback){var data={m:16001002,t:"v_quality_checkcontent",order:"id"},filter=[],oneFilter=[];oneFilter.push({field:"level",value:level,operator:"=",relation:"and"}),id!=-1&&oneFilter.push({field:"pId",value:id,operator:"=",relation:"and"}),oneFilter.push({field:"type",value:"通用",operator:"=",relation:"OR"});var twoFilter=[];twoFilter.push({field:"level",value:level,operator:"=",relation:"and"}),id!=-1&&twoFilter.push({field:"pId",value:id,operator:"=",relation:"and"}),twoFilter.push({field:"type",value:"项目部",operator:"=",relation:"and"}),twoFilter.push({field:"orgId",value:userService.getRootOrgId(),operator:"=",relation:""}),filter.push(oneFilter),filter.push(twoFilter),data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){successCallback.call(this,data.object)}})},insertCheckProblem:function(problem,successCallback){var data={m:16001002,t:"quality_d_checkcontent_extend",v:JSON.stringify([{t:"quality_d_checkcontent_extend",data:problem,ai:!0}])};YT.insert({data:data,successCallback:function(data){successCallback.call(this,data.object)}})},insertQualityCheckData:function(data,slave,params,successCallback){var postData={m:16001002,t:"quality_qualitycheck",v:JSON.stringify([{t:"quality_qualitycheck",data:data,ai:!0,slave:slave}]),params:JSON.stringify(params)};YT.insert({data:postData,successCallback:function(data){successCallback.call(this,data)}})},updateQualityCheckData:function(data,slave,params,successCallback){var filter=[{field:"id",value:data.id,operator:"=",relation:""}],postData={m:16001002,t:"quality_qualitycheck",v:JSON.stringify([{t:"quality_qualitycheck",data:data,slave:slave,filter:filter}]),params:JSON.stringify(params)};YT.update({data:postData,successCallback:function(data){successCallback.call(this,data)}})},getDraftData:function(id,successCallback){for(var self=this,draftDataList=JSON.parse(LocalStorageService.get("qualityCheckList")),i=0;i<draftDataList.length;i++)draftDataList[i].id==id&&(self.setId(id),self.setCheckData(draftDataList[i].checkData),self.setCheckDataShow(draftDataList[i].checkDataShow),self.setContent(draftDataList[i].content),self.setProblems(draftDataList[i].problems),self.setImagList(draftDataList[i].attach),successCallback.call())},getUserName:function(){return userService.getUserName()},getRootOrgId:function(){return userService.getRootOrgId()},getUserId:function(){return userService.getUserId()},prefixInteger:function(num,n){for(var len=num.toString().length;len<n;)num="0"+num,len++;return num},deepClone:function(obj){var o;switch(typeof obj){case"undefined":break;case"string":o=obj+"";break;case"number":o=obj-0;break;case"boolean":o=obj;break;case"object":if(null===obj)o=null;else if(obj instanceof Array){o=[];for(var i=0,len=obj.length;i<len;i++)o.push(this.deepClone(obj[i]))}else{o={};for(var k in obj)o[k]=this.deepClone(obj[k])}break;default:o=obj}return o},getType:function(){return type},setType:function(data){type=data},getCheckData:function(){return checkData},setCheckData:function(data){checkData=data},setTitle:function(data){checkData.title=data},getId:function(){return id},setId:function(data){id=data},setCheckDate:function(data){checkData.checkDate=data},setCheckPosName:function(data){checkData.checkPosName=data},setSolverId:function(data){checkData.solverId=data},getPositionList:function(){return position},setPositionList:function(data){position=data},getSolverList:function(){return solver},setSolverList:function(data){solver=data},setStatusId:function(data){checkData.statusId=data},getCheckDataShow:function(){return checkDataShow},setCheckDataShow:function(data){checkDataShow=data},setChecker:function(data){checkDataShow.checker=data},setCheckPositionName:function(data){checkDataShow.checkPositionName=data},setSolverName:function(data){checkDataShow.solverName=data},getContent:function(){return content},setContent:function(data){content=data},pushContent:function(data){content.push(data)},removeContent:function(id){for(var self=this,i=0;i<content.length;i++)content[i].id==id&&(content.splice(i,1),self.removeContentProblems(id))},setProblems:function(data){problems=data},getProblems:function(){return problems},pushProblem:function(data){problems.push(data)},removeContentProblems:function(contentId){for(var temp=[],i=0;i<problems.length;i++)problems[i].pId!=contentId&&temp.push(problems[i]);problems=temp},getImagList:function(){return image_list},pushImagList:function(data){image_list.push(data)},setImagList:function(data){image_list=data},changeAttach:function(list){if(list.length>0)for(var i=0;i<list.length;i++){var ticket=userService.getTicket(),url=list[i].url.replace("\\","/");list[i].src=env.server+"download.action?rnd="+Math.random()+"&tkt="+ticket+"&fileName="+url;var item={src:list[i].src,data:{name:list[i].name,url:list[i].url}};image_list.push(item)}}}}]),angular.module("app.quality.check").factory("qualityCheckService",["YTService","UserService","$ionicActionSheet","env",function(YT,userService,$ionicActionSheet,env){var serviceData=[],pageIndex=0,pageSize=10,hasNextPage=!0,right={checker:!1,solver:!1,rechecker:!1},condition={typeId:-1,checker:"",solver:"",problem:-1,hasProblemName:"",startTime:"",endTime:""},image_list=[],content=[];return{loadListData:function(successCallback){++pageIndex;var self=this;right.checker=YT.haveRight(16001002),right.solver=YT.haveRight(16001003),right.rechecker=YT.haveRight(16001004),YT.query({data:self.getSearchData(),successCallback:function(data){self.loadListDataCallback(data),successCallback.call()}})},loadListDataCallback:function(data){for(var pageInfo=data.object,i=0;i<pageInfo.items.length;i++)serviceData.push(pageInfo.items[i]);hasNextPage=!(pageIndex>=pageInfo.pageCount)},refreshListData:function(successCallBack){pageIndex=0,hasNextPage=!0,serviceData=[],right={checker:!1,solver:!1,rechecker:!1},this.loadListData(successCallBack)},clearCachedData:function(){pageIndex=0,hasNextPage=!0,serviceData=[],right={checker:!1,solver:!1,rechecker:!1},image_list=[],content=[]},getSearchData:function(){var data={m:16001001,t:"v_quality_qualitycheck_processing",order:"id desc",page:pageIndex,rows:pageSize},filter=this.getSearchFilter();return data.filter=JSON.stringify(filter),data},getSearchFilter:function(){var self=this,rootId=(userService.getTypeId(),userService.getRootOrgId()),userId=userService.getUserId(),filter=[];filter.push({field:"orgId",value:rootId,operator:"=",relation:"AND"}),condition.typeId!=-1&&(0==condition.typeId?filter.push({field:"nodeName",value:"草稿箱",operator:"=",relation:"AND"}):1==condition.typeId?filter.push({field:"nodeName",value:"处理人审核",operator:"=",relation:"AND"}):2==condition.typeId?filter.push({field:"nodeName",value:"复查人审核",operator:"=",relation:"AND"}):3==condition.typeId?filter.push({field:"nodeName",value:"审批通过",operator:"=",relation:"AND"}):4==condition.typeId?filter.push({field:"nodeName",value:"审批不通过",operator:"=",relation:"AND"}):5==condition.typeId&&filter.push({field:"checkerId",value:userId,operator:"=",relation:"AND"})),condition.problem!=-1&&(1==condition.problem?filter.push({field:"hasProblem",value:1,operator:"=",relation:"AND"}):0==condition.problem&&filter.push({field:"hasProblem",value:0,operator:"=",relation:"AND"})),""!=condition.startTime&&""!=condition.endTime?filter.push({field:"checkDate",value:condition.startTime,operator:">=",relation:"AND"},{field:"checkDate",value:condition.endTime,operator:"<=",relation:"AND"}):""!=condition.startTime?filter.push({field:"checkDate",value:condition.startTime,operator:">=",relation:"AND"}):""!=condition.endTime&&filter.push({field:"checkDate",value:condition.endTime,operator:"<=",relation:"AND"}),""!=condition.checker&&filter.push({field:"checkerName",value:"%"+condition.checker+"%",operator:"like",relation:"AND"}),""!=condition.solver&&filter.push({field:"solverName",value:"%"+condition.solver+"%",operator:"like",relation:"AND"});var oneFilter=self.deepClone(filter),twoFilter=self.deepClone(filter),threeFilter=self.deepClone(filter);if(filter=[],right.checker||right.solver||right.rechecker){if(right.checker&&(oneFilter.push({field:"checkerId",value:userId,operator:"=",relation:"OR"}),filter.push(oneFilter)),right.solver){var twoOneFilter=self.deepClone(twoFilter),twoTwoFilter=self.deepClone(twoFilter),twoThreeFilter=self.deepClone(twoFilter);twoOneFilter.push({field:"solverId",value:userId,operator:"=",relation:"AND"}),twoOneFilter.push({field:"nodeName",value:"处理人审核",operator:"=",relation:"OR"}),twoTwoFilter.push({field:"solverId",value:userId,operator:"=",relation:"AND"}),twoTwoFilter.push({field:"nodeName",value:"审批通过",operator:"=",relation:"OR"}),twoThreeFilter.push({field:"solverId",value:userId,operator:"=",relation:"AND"}),twoThreeFilter.push({field:"nodeName",value:"审批不通过",operator:"=",relation:"OR"}),filter.push(twoOneFilter),filter.push(twoTwoFilter),filter.push(twoThreeFilter)}if(right.rechecker){var threeOneFilter=self.deepClone(threeFilter),threeTwoFilter=self.deepClone(threeFilter),threeThreeFilter=self.deepClone(threeFilter);threeOneFilter.push({field:"nodeName",value:"复查人审核",operator:"=",relation:"OR"}),threeTwoFilter.push({field:"operaterId",value:userId,operator:"=",relation:"AND"}),threeTwoFilter.push({field:"nodeName",value:"审批通过",operator:"=",relation:"OR"}),threeThreeFilter.push({field:"operaterId",value:userId,operator:"=",relation:"AND"}),threeThreeFilter.push({field:"nodeName",value:"审批不通过",operator:"=",relation:"OR"}),filter.push(threeOneFilter),filter.push(threeTwoFilter),filter.push(threeThreeFilter)}}else filter.push({field:"checkerId",value:-999,operator:"=",relation:""});return filter},queryDetail:function(id,successCallback){var data={m:16001001,t:"v_quality_qualitycheck"},filter=[{field:"id",value:id,operator:"=",relation:"and"}];data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){successCallback.call(this,data.object[0])}})},queryDetailProblem:function(id,successCallback){var self=this,data={m:16001001,t:"v_quality_qualitycheck_detail"},filter=[{field:"id",value:id,operator:"=",relation:"and"}];data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){for(var contentData=data.object,contentList=[],problemList=[],contentMap={},problemMap={},i=0;i<contentData.length;i++)contentMap[contentData[i].checkContentId]={id:contentData[i].checkContentId,name:contentData[i].checkContentName,checked:!0},problemMap[contentData[i].checkProblemId]={id:contentData[i].checkProblemId,name:contentData[i].checkProblemName,pId:contentData[i].checkContentId,checked:!0},problemList.push({id:contentData[i].checkProblemId,name:contentData[i].checkProblemName,pId:contentData[i].checkContentId,checked:!0});for(var key in problemMap){var problems=contentMap[problemMap[key].pId].problems;problems=problems||[],problems.push(problemMap[key]),contentMap[problemMap[key].pId].problems=problems}for(var key in contentMap)contentList.push(contentMap[key]);self.setContent(contentList),successCallback.call()}})},queryDetailCheckAttach:function(id,successCallback){var data={m:16001001,t:"quality_qualitycheck_attach"},filter=[{field:"id",value:id,operator:"=",relation:"and"}];data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){successCallback.call(this,data.object)}})},queryDetailRecheckAttach:function(id,successCallback){var data={m:16001001,t:"quality_qualitycheck_recheck_attach"},filter=[{field:"id",value:id,operator:"=",relation:"and"}];data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){successCallback.call(this,data.object)}})},solveAndRecheckData:function(obj,m,status,successCallback){var checkData={wId:obj.wid,dataId:obj.id,opinion:"",checkerOrgId:userService.getRootOrgId()},attach={};if(void 0!=obj.imagList&&obj.imagList.length>0){attach.data=[];for(var c=0;c<obj.imagList.length;c++){var innerData=obj.imagList[c].data;attach.data.push(innerData)}}var pushUserId=-1;"复查"==status?pushUserId=obj.checkerId:"通过"!=status&&"不通过"!=status||(pushUserId=obj.solverId);var params={condition:{"状态":status},wId:obj.wid,orgId:userService.getRootOrgId(),id:obj.id,recheckDate:obj.recheckDate,recheckerId:obj.recheckerId,pushUserId:pushUserId,attach:attach},data={m:m,t:"wf_check",v:JSON.stringify([{t:"wf_check",data:checkData,ai:!0}]),params:JSON.stringify(params)};YT.insert({data:data,successCallback:function(data){200==data.status&&successCallback.call()}})},deepClone:function(obj){var o;switch(typeof obj){case"undefined":break;case"string":o=obj+"";break;case"number":o=obj-0;break;case"boolean":o=obj;break;case"object":if(null===obj)o=null;else if(obj instanceof Array){o=[];for(var i=0,len=obj.length;i<len;i++)o.push(this.deepClone(obj[i]))}else{o={};for(var k in obj)o[k]=this.deepClone(obj[k])}break;default:o=obj}return o},resetCondition:function(){condition={typeId:-1,checker:"",solver:"",problem:-1,hasProblemName:"",startTime:"",endTime:""}},getServiceData:function(){return serviceData},hasNextPage:function(){return hasNextPage},getContent:function(){return content},setContent:function(data){content=data},getCondition:function(){return condition},setStartTime:function(data){condition.startTime=data},setEndTime:function(data){condition.endTime=data},getRight:function(){return right},getUserName:function(){return userService.getUserName()},getUserId:function(){return userService.getUserId()},prefixInteger:function(num,n){for(var len=num.toString().length;len<n;)num="0"+num,len++;return num},changeAttach:function(list){if(list.length>0)for(var i=0;i<list.length;i++){var ticket=userService.getTicket();list[i].src=list[i].url.replace("\\","/"),list[i].src=env.server+"download.action?rnd="+Math.random()+"&tkt="+ticket+"&fileName="+list[i].src}},preview:function(imgIndex,arr){$ionicActionSheet.show({buttons:[{text:"预览"}],cancelText:"关闭",cancel:function(){return!0},buttonClicked:function(){return PhotoViewer.show(arr[imgIndex].src),!0}})},getImagList:function(){return image_list},pushImagList:function(data){image_list.push(data)},setImagList:function(data){image_list=data}}}]),angular.module("app.safety.dailyCheck").controller("dailyCheckAddController",["$scope","$state","$stateParams","$ionicPopup","dailyCheckAddService","$filter","$ionicHistory","$ionicActionSheet","LocalStorageService","$ionicViewSwitcher","YTService",function($scope,$state,$stateParams,$ionicPopup,dailyCheckAddService,$filter,$ionicHistory,$ionicActionSheet,LocalStorageService,$ionicViewSwitcher,YTService){var now=new Date;$scope.checkData=dailyCheckAddService.getCheckData(),$scope.checkData.checkDate=now.getFullYear()+"-"+dailyCheckAddService.prefixInteger(now.getMonth()+1,2)+"-"+dailyCheckAddService.prefixInteger(now.getDate(),2),dailyCheckAddService.setCheckDate($scope.checkData.checkDate),$scope.checkDataShow=dailyCheckAddService.getCheckDataShow(),$scope.contentList=dailyCheckAddService.getContent(),$scope.checkTypeFlag=!1,$scope.checkDate=YTM.initDatePicker({callback:function(){$scope.checkData.checkDate=$filter("date")($scope.checkDate.date,"yyyy-MM-dd"),dailyCheckAddService.setCheckDate($scope.checkData.checkDate),$scope.checkDatePopup.close()}}),$scope.openCheckDate=function(){$scope.checkDatePopup=$ionicPopup.show({templateUrl:"check-date.html",scope:$scope,cssClass:"customTimerPopover"}),$scope.checkDatePopup.then(function(res){console.log("Tapped!",res)})},dailyCheckAddService.setType($stateParams.type),$scope.url="safety/dailyCheck/dailyCheck-add",$scope.titleName="新增安全检查",$scope.$on("$ionicView.beforeEnter",function(){$stateParams.backUrl&&($scope.backUrl=$stateParams.backUrl),$scope.checkData=dailyCheckAddService.getCheckData(),$scope.checkDataShow=dailyCheckAddService.getCheckDataShow(),$scope.contentList=dailyCheckAddService.getContent(),$scope.checkDataShow.checker=dailyCheckAddService.getUserName(),dailyCheckAddService.setChecker($scope.checkDataShow.checker),dailyCheckAddService.queryCheckType(function(data){$scope.checkType=data}),$scope.checkContent($scope.contentList)}),$scope.checkContent=function(contents){for(var j=0;j<contents.length;j++){var items=contents[j].items,returnItems=[];if(void 0!=items)for(var i=0;i<items.length;i++){var problems=items[i].problems;void 0!=problems&&problems.length>0&&returnItems.push(items[i])}contents[j].items=returnItems}},$scope.close=function(){$scope.checkTypeFlag=!1},$scope.openCheckType=function(){$scope.checkTypeFlag=!0},$scope.closeCheckType=function(id,name){$scope.checkData.checkTypeId=id,dailyCheckAddService.setCheckTypeId($scope.checkData.checkTypeId),$scope.checkDataShow.checkTypeName=name,dailyCheckAddService.setCheckTypeName($scope.checkDataShow.checkTypeName),$scope.checkTypeFlag=!1},$scope.showConfirmDel=function(id){var confirmPopup=$ionicPopup.confirm({title:"提示",template:'<p class="text-center">确认删除？</p>',cancelText:"取消",okText:"确定"});confirmPopup.then(function(res){res&&(dailyCheckAddService.removeContent(id),$scope.contentList=dailyCheckAddService.getContent(),$ionicPopup.alert({title:"提示",template:'<p class="text-center">删除成功!</p>'}))})},$scope.back=function(){$ionicPopup.confirm({title:"提示",template:'<p class="text-center">您确定要退出新增页面？</p>',cancelText:"取消",okText:"确定"}).then(function(res){res&&(dailyCheckAddService.clearCachedData(),$state.go($scope.backUrl),$ionicViewSwitcher.nextDirection("back"))})},$scope.submit=function(){$ionicActionSheet.show({buttons:[{text:"提交"},{text:"保存服务器"},{text:"保存本地"}],cancelText:"取消",cancel:function(){return!0},buttonClicked:function(index){if($scope.checkSheet()){var data={};if(0==index&&(data=$scope.getData(1),data.addPosFlag?dailyCheckAddService.insertAddPosition(data.addPosition,function(positionId){data.data.checkPosId=positionId,1==data.data.hasProblem?dailyCheckAddService.insertDailyCheckData(data.data,data.slave,{status:"audit",pushUserId:data.data.solverId,condition:{"状态":"处理"},wId:150001,userId:dailyCheckAddService.getUserId(),orgId:dailyCheckAddService.getRootOrgId()},function(data){200==data.status&&$ionicPopup.alert({title:"验证",template:'<p class="text-center">提交成功!</p>'}).then(function(){dailyCheckAddService.clearCachedData(),$state.go($scope.backUrl),$ionicViewSwitcher.nextDirection("back")})}):0==data.data.hasProblem&&dailyCheckAddService.insertDailyCheckData(data.data,data.slave,{status:"audit",pushUserId:data.data.solverId,condition:{"状态":"通过"},wId:150001,userId:dailyCheckAddService.getUserId(),orgId:dailyCheckAddService.getRootOrgId()},function(data){200==data.status&&$ionicPopup.alert({title:"验证",template:'<p class="text-center">提交成功!</p>'}).then(function(){dailyCheckAddService.clearCachedData(),$state.go($scope.backUrl),$ionicViewSwitcher.nextDirection("back")})})}):1==data.data.hasProblem?dailyCheckAddService.insertDailyCheckData(data.data,data.slave,{status:"audit",pushUserId:data.data.solverId,condition:{"状态":"处理"},wId:150001,userId:dailyCheckAddService.getUserId(),orgId:dailyCheckAddService.getRootOrgId()},function(data){200==data.status&&$ionicPopup.alert({title:"验证",template:'<p class="text-center">提交成功!</p>'}).then(function(){dailyCheckAddService.clearCachedData(),$state.go($scope.backUrl),$ionicViewSwitcher.nextDirection("back")})}):0==data.data.hasProblem&&dailyCheckAddService.insertDailyCheckData(data.data,data.slave,{status:"audit",pushUserId:data.data.solverId,condition:{"状态":"通过"},wId:150001,userId:dailyCheckAddService.getUserId(),orgId:dailyCheckAddService.getRootOrgId()},function(data){200==data.status&&$ionicPopup.alert({title:"验证",template:'<p class="text-center">提交成功!</p>'}).then(function(){dailyCheckAddService.clearCachedData(),$state.go($scope.backUrl),$ionicViewSwitcher.nextDirection("back")})})),1==index&&(data=$scope.getData(0),data.addPosFlag?dailyCheckAddService.insertAddPosition(data.addPosition,function(positionId){data.data.checkPosId=positionId,dailyCheckAddService.insertDailyCheckData(data.data,data.slave,{status:"saved"},function(data){200==data.status&&$ionicPopup.alert({title:"验证",template:'<p class="text-center">保存成功!</p>'}).then(function(){dailyCheckAddService.clearCachedData(),$state.go($scope.backUrl),$ionicViewSwitcher.nextDirection("back")})})}):dailyCheckAddService.insertDailyCheckData(data.data,data.slave,{status:"saved"},function(data){200==data.status&&$ionicPopup.alert({title:"验证",template:'<p class="text-center">保存成功!</p>'}).then(function(){dailyCheckAddService.clearCachedData(),$state.go($scope.backUrl),$ionicViewSwitcher.nextDirection("back")})})),2==index){var problem=dailyCheckAddService.getProblems(),title="",checkDataShow=dailyCheckAddService.getCheckDataShow();if(1==checkDataShow.hasProblem){for(var i=0;i<problem.length-1;i++)title+=problem[i].name+"；";title+=problem[problem.length-1].name}else 0==checkDataShow.hasProblem&&(title=checkDataShow.checkTypeName);var localDataList=JSON.parse(LocalStorageService.get("dailyCheckList")),localData={title:title,checkData:dailyCheckAddService.getCheckData(),checkDataShow:checkDataShow,content:dailyCheckAddService.getContent(),problems:problem,attach:dailyCheckAddService.getImagList()};if(void 0==localDataList){var dataList=[];localData.id=1,dataList.push(localData),localDataList=dataList}else{for(var maxId=1,k=0;k<localDataList.length;k++)localDataList[k].id>maxId&&(maxId=localDataList[k].id);localData.id=maxId+1,localDataList.push(localData)}LocalStorageService.set("dailyCheckList",JSON.stringify(localDataList)),$ionicPopup.alert({title:"验证",template:'<p class="text-center">本地存储成功!</p>'}).then(function(){dailyCheckAddService.clearCachedData(),$state.go($scope.backUrl),$ionicViewSwitcher.nextDirection("back")})}}return!0}})},$scope.checkSheet=function(){var flag=!0,checkData=dailyCheckAddService.getCheckData(),checkDataShow=dailyCheckAddService.getCheckDataShow(),content=dailyCheckAddService.getContent(),problem=dailyCheckAddService.getProblems();checkData.solverId==-1&&(flag=!1,$ionicPopup.alert({title:"验证",template:'<p class="text-center">未选择处理人!</p>'})),checkData.checkTypeId==-1&&(flag=!1,$ionicPopup.alert({title:"验证",template:'<p class="text-center">未选择检查类型!</p>'})),checkData.checkPosId==-1&&""==checkDataShow.checkPositionName&&(flag=!1,$ionicPopup.alert({title:"验证",template:'<p class="text-center">未选择检查位置!</p>'})),checkDataShow.hasProblem&&problem.length<=0&&(flag=!1,$ionicPopup.alert({title:"验证",template:'<p class="text-center">需要设置检查内容和问题!</p>'})),dailyCheckAddService.getImagList().length<=0&&(flag=!1,$ionicPopup.alert({title:"验证",template:'<p class="text-center">需要上传检查照片!</p>'}));for(var contentFlag=!0,i=0;i<content.length;i++)(void 0==content[i].items||content[i].items.length<=0)&&(contentFlag=!1);return contentFlag||(flag=!1,$ionicPopup.alert({title:"验证",template:'<p class="text-center">有检查内容未设置问题!</p>'})),flag},$scope.getData=function(statusId){var checkData=dailyCheckAddService.getCheckData(),checkDataShow=dailyCheckAddService.getCheckDataShow(),problem=dailyCheckAddService.getProblems(),imagList=dailyCheckAddService.getImagList(),data={wid:150001,title:"",checkDate:checkData.checkDate,checkerId:dailyCheckAddService.getUserId(),solverId:checkData.solverId,checkTypeId:checkData.checkTypeId,hasProblem:checkDataShow.hasProblem?1:0,checkPosId:checkData.checkPosId,orgId:dailyCheckAddService.getRootOrgId(),statusId:statusId},position={},dataDetail=[],title="";if(1==data.hasProblem){for(var i=0;i<problem.length-1;i++)title+=problem[i].name+"；";title+=problem[problem.length-1].name,data.title=title;for(var j=0;j<problem.length;j++)dataDetail.push({t:"safety_dailycheck_detail",data:{checkContentId:problem[j].contentId,checkItemId:problem[j].pId,checkProblemId:problem[j].id},key:"id"})}else 0==data.hasProblem&&(data.title=checkDataShow.checkTypeName);if(imagList.length>0)for(var k=0;k<imagList.length;k++)dataDetail.push({t:"safety_dailycheck_attach",data:{name:imagList[k].data.name,url:imagList[k].data.url},key:"id"});var flag=!1;return checkData.checkPosId==-1&&""!=checkDataShow.checkPositionName&&(flag=!0,position={name:checkDataShow.checkPositionName,orgId:dailyCheckAddService.getRootOrgId()}),{data:data,slave:dataDetail,addPosFlag:flag,addPosition:position}},$scope.image_list=[],$scope.addAttachment=function(){YTService.addAttachment($scope,function(item){$scope.image_list.push(item),dailyCheckAddService.setImagList($scope.image_list)})},$scope.previewOrDelete=function(imgIndex){YTService.previewOrDelete(imgIndex,$scope.image_list,function(){$state.go("safety/dailyCheck/canvas",{image:$scope.image_list[imgIndex],index:imgIndex,backUrl:$scope.url}),$ionicViewSwitcher.nextDirection("forward")}),dailyCheckAddService.setImagList($scope.image_list)},$scope.toChoose=function(url,backUrl){$state.go(url,{backUrl:backUrl}),$ionicViewSwitcher.nextDirection("forward")},$scope.toChooseById=function(id,url,backUrl){$state.go(url,{id:id,backUrl:backUrl}),$ionicViewSwitcher.nextDirection("forward")}}]),angular.module("app.safety.dailyCheck").controller("dailyCheckCanvasController",["$scope","$state","$stateParams","$ionicViewSwitcher","$ionicPopup","dailyCheckAddService","YTService","UserService","env",function($scope,$state,$stateParams,$ionicViewSwitcher,$ionicPopup,dailyCheckAddService,YTService,userService,env){$scope.$on("$ionicView.beforeEnter",function(){$stateParams.backUrl&&($scope.backUrl=$stateParams.backUrl),null!=$stateParams.index&&($scope.index=$stateParams.index),$stateParams.image&&($scope.image=$stateParams.image,$scope.drawing=new Drawing({id:"canvas",src:$scope.image.src,fullScreen:!0}))}),$scope.back=function(){$state.go($scope.backUrl,{backUrl:"safety/dailyCheck/dailyCheck-list"}),$ionicViewSwitcher.nextDirection("back")},$scope.save=function(){$ionicPopup.confirm({title:"提示",template:'<p class="text-center">您确定要保存编辑的图片？</p>',cancelText:"取消",okText:"确定"}).then(function(res){if(res){$scope.data=$scope.drawing.getImage();var imgList=dailyCheckAddService.getImagList();YTService.uploadBase64Attach($scope.data,function(item){var ticket=userService.getTicket();item.src=item.data.url.replace("\\","/"),item.src=env.server+"download.action?rnd="+Math.random()+"&tkt="+ticket+"&fileName="+item.src,imgList[$scope.index]=item,dailyCheckAddService.setImagList(imgList),$ionicPopup.alert({title:"提示",template:'<p class="text-center">保存成功!</p>'}).then(function(){$state.go($scope.backUrl,{backUrl:"safety/dailyCheck/dailyCheck-list"}),$ionicViewSwitcher.nextDirection("back")})})}})}}]),angular.module("app.safety.dailyCheck").controller("dailyCheckContentController",["$scope","$state","$stateParams","$ionicPopup","dailyCheckAddService","$ionicViewSwitcher",function($scope,$state,$stateParams,$ionicPopup,dailyCheckAddService,$ionicViewSwitcher){$scope.content=[],$scope.$on("$ionicView.beforeEnter",function(){$stateParams.backUrl&&($scope.backUrl=$stateParams.backUrl),dailyCheckAddService.queryCheckContent(-1,1,function(data){$scope.content=data,$scope.checkContent($scope.content)})}),$scope.checkContent=function(){var contentList=dailyCheckAddService.getContent();if(void 0!=$scope.content)for(var j=0;j<$scope.content.length;j++){var flag=!1;if(void 0!=contentList)for(var i=0;i<contentList.length;i++)$scope.content[j].id==contentList[i].id&&(flag=!0);$scope.content[j].checked=flag}},$scope.chooseContent=function(list){for(var contentList=dailyCheckAddService.getContent(),i=0;i<list.length;i++)if(void 0!=list[i].checked&&""!=list[i].checked&&list[i].checked){
for(var flag=!1,j=0;j<contentList.length;j++)contentList[j].id==list[i].id&&(flag=!0);flag||dailyCheckAddService.pushContent(list[i])}for(var delIds=[],m=0;m<contentList.length;m++){for(var delFlag=!0,n=0;n<list.length;n++)void 0!=list[n].checked&&""!=list[n].checked&&list[n].checked&&contentList[m].id==list[n].id&&(delFlag=!1);delFlag&&delIds.push(contentList[m].id)}if(delIds.length>0)for(var k=0;k<delIds.length;k++)dailyCheckAddService.removeContent(delIds[k]);$state.go($scope.backUrl,{backUrl:"safety/dailyCheck/dailyCheck-list"}),$ionicViewSwitcher.nextDirection("back")},$scope.back=function(){$state.go($scope.backUrl,{backUrl:"safety/dailyCheck/dailyCheck-list"}),$ionicViewSwitcher.nextDirection("back")}}]),angular.module("app.safety.dailyCheck").controller("dailyCheckContentItemController",["$scope","$state","$stateParams","$ionicPopup","dailyCheckAddService","$ionicViewSwitcher",function($scope,$state,$stateParams,$ionicPopup,dailyCheckAddService,$ionicViewSwitcher){$scope.$on("$ionicView.beforeEnter",function(){$stateParams.backUrl&&($scope.backUrl=$stateParams.backUrl),dailyCheckAddService.queryCheckContent($stateParams.id,2,function(data){$scope.pId=$stateParams.id,$scope.items=data,$scope.checkItem($scope.items)})}),$scope.checkItem=function(items){var problems=dailyCheckAddService.getProblems();if(problems.length>0)for(var j=0;j<items.length;j++){for(var flag=!1,i=0;i<problems.length;i++)items[j].id==problems[i].pId&&(flag=!0);items[j].checked=flag,flag||dailyCheckAddService.removeItem(items[j].pid,items[j].id)}else if(void 0!=items)for(var k=0;k<items.length;k++)items[k].checked=!1},$scope.goProblem=function(pId,id,itemBackUrl,item){for(var content=dailyCheckAddService.getContent(),j=0;j<content.length;j++)if($stateParams.id==content[j].id){if(item.checked=!0,void 0!=content[j].items&&""!=content[j].items){for(var itemss=content[j].items,flag=!1,i=0;i<itemss.length;i++)itemss[i].id==id&&(flag=!0);flag||content[j].items.push(item)}else{var items=[];items.push(item),content[j].items=items}dailyCheckAddService.setContent(content),$state.go("safety/dailyCheck/dailyCheck-content-item-problem",{pId:pId,id:id,backUrl:itemBackUrl}),$ionicViewSwitcher.nextDirection("forward")}},$scope.back=function(){$state.go($scope.backUrl,{backUrl:"safety/dailyCheck/dailyCheck-list"}),$ionicViewSwitcher.nextDirection("back")}}]),angular.module("app.safety.dailyCheck").controller("dailyCheckContentItemProblemController",["$scope","$state","$stateParams","$ionicPopup","dailyCheckAddService","$ionicViewSwitcher",function($scope,$state,$stateParams,$ionicPopup,dailyCheckAddService,$ionicViewSwitcher){$scope.$on("$ionicView.beforeEnter",function(){$stateParams.backUrl&&($scope.backUrl=$stateParams.backUrl),dailyCheckAddService.queryCheckContent($stateParams.id,3,function(data){$scope.problems=data,$scope.checkProblem($scope.problems)});var type=dailyCheckAddService.getType();"add"==type?$scope.url="safety/dailyCheck/dailyCheck-add":"edit"==type?$scope.url="safety/dailyCheck/dailyCheck-edit":"draft"==type&&($scope.url="safety/dailyCheck/dailyCheck-drafts-edit")}),$scope.checkProblem=function(problemss){var problems=dailyCheckAddService.getProblems();if(problems.length>0)for(var j=0;j<problemss.length;j++){for(var flag=!1,i=0;i<problems.length;i++)problemss[j].id==problems[i].id&&(flag=!0);problemss[j].checked=flag}else for(var k=0;k<problemss.length;k++)problemss[k].checked=!1},$scope.chooseItem=function(list){for(var content=dailyCheckAddService.getContent(),j=0;j<content.length;j++)if($stateParams.pId==content[j].id)for(var items=content[j].items,k=0;k<items.length;k++)if($stateParams.id==items[k].id){dailyCheckAddService.removeItemProblems(items[k].id);for(var problems=[],i=0;i<list.length;i++)void 0!=list[i].checked&&""!=list[i].checked&&list[i].checked&&(problems.push(list[i]),list[i].contentId=$stateParams.pId,dailyCheckAddService.pushProblem(list[i]));items[k].problems=problems,dailyCheckAddService.setContent(content),$state.go($scope.backUrl,{id:$stateParams.pId,backUrl:$scope.url}),$ionicViewSwitcher.nextDirection("back")}},$scope.back=function(){$state.go($scope.backUrl,{id:$stateParams.pId,backUrl:$scope.url}),$ionicViewSwitcher.nextDirection("back")},$scope.showPrompt=function(){$ionicPopup.prompt({title:"新增问题",cancelText:"取消",okText:"确定"}).then(function(res){for(var problems=$scope.problems,flag=!1,index=-1,i=0;i<problems.length;i++)problems[i].name==res.trim()&&(flag=!0,index=i);if(flag)index!=-1&&($scope.problems[index].checked=!0);else{var problem={name:res.trim(),pid:$stateParams.id,level:3,orgId:dailyCheckAddService.getRootOrgId(),delFlag:0};dailyCheckAddService.insertCheckProblem(problem,function(data){problem.contentId=$stateParams.pId,problem.id=data,dailyCheckAddService.queryCheckContent(problem.pid,3,function(data){for(var list=dailyCheckAddService.deepClone($scope.problems),ids=[],j=0;j<list.length;j++)void 0!=list[j].checked&&""!=list[j].checked&&list[j].checked&&ids.push(list[j].id);$scope.problems=data;for(var i=0;i<$scope.problems.length;i++)if($scope.problems[i].id!=problem.id){for(var m=0;m<ids.length;m++)if($scope.problems[i].id==ids[m]){$scope.problems[i].checked=!0;break}}else $scope.problems[i].checked=!0})})}})}}]),angular.module("app.safety.dailyCheck").controller("dailyCheckListController",["$scope","$state","$ionicHistory","$ionicModal","$ionicPopup","dailyCheckService","$ionicScrollDelegate","$filter","LocalStorageService","$ionicViewSwitcher",function($scope,$state,$ionicHistory,$ionicModal,$ionicPopup,dailyCheckService,$ionicScrollDelegate,$filter,LocalStorageService,$ionicViewSwitcher){$scope.condition=dailyCheckService.getCondition(),$scope.$on("$ionicView.beforeEnter",function(){$scope.refreshListData(),$ionicScrollDelegate.scrollTop();var localData=JSON.parse(LocalStorageService.get("dailyCheckList"));void 0==localData||localData.length<=0?($scope.showDrafts=!1,$scope.localDataLength=0):($scope.showDrafts=!0,$scope.localDataLength=localData.length)}),$scope.loadListData=function(){dailyCheckService.loadListData(function(){$scope.fillData(),$scope.$broadcast("scroll.infiniteScrollComplete")})},$scope.refreshListData=function(){dailyCheckService.clearCachedData(),dailyCheckService.refreshListData(function(){$scope.fillData(),$scope.$broadcast("scroll.refreshComplete")})},$scope.fillData=function(){$scope.dailyCheckList=dailyCheckService.getServiceData(),$scope.hasNextPage=dailyCheckService.hasNextPage(),$scope.right=dailyCheckService.getRight()},$scope.searchData=function(){if($scope.modalQueryType.hide(),dailyCheckService.clearCachedData(),$ionicScrollDelegate.scrollTop(),$scope.condition.startTime&&$scope.condition.endTime){var beginTimes=$scope.condition.startTime.substring(0,10).split("-"),endTimes=$scope.condition.endTime.substring(0,10).split("-"),beginTime=beginTimes[1]+"-"+beginTimes[2]+"-"+beginTimes[0]+" "+$scope.condition.startTime.substring(10,19),endTime=endTimes[1]+"-"+endTimes[2]+"-"+endTimes[0]+" "+$scope.condition.endTime.substring(10,19),a=(Date.parse(endTime)-Date.parse(beginTime))/3600/1e3;a<0?$ionicPopup.alert({title:"警告消息",template:"开始时间不能大于结束时间！"}):($scope.modalQueryMore.hide(),$scope.loadListData())}else $scope.modalQueryMore.hide(),$scope.loadListData()},$scope.clearSearchText=function(){dailyCheckService.resetCondition(),$scope.condition=dailyCheckService.getCondition()},$scope.back=function(){dailyCheckService.clearCachedData(),dailyCheckService.resetCondition(),$state.go("menu"),$ionicViewSwitcher.nextDirection("back")},$scope.toAdd=function(){dailyCheckService.clearCachedData(),dailyCheckService.resetCondition(),$state.go("safety/dailyCheck/dailyCheck-add",{backUrl:"safety/dailyCheck/dailyCheck-list"}),$ionicViewSwitcher.nextDirection("forward")},$scope.toDraftsList=function(){dailyCheckService.clearCachedData(),dailyCheckService.resetCondition(),$state.go("safety/dailyCheck/dailyCheck-drafts-list"),$ionicViewSwitcher.nextDirection("forward")},$scope.toDetail=function(id,checkerId,solverId,nodeName){var right=dailyCheckService.getRight(),userId=dailyCheckService.getUserId();"草稿箱"==nodeName?$state.go("safety/dailyCheck/dailyCheck-edit",{id:id,backUrl:"safety/dailyCheck/dailyCheck-list"}):"处理人审核"==nodeName?right.solver&&solverId==userId?$state.go("safety/dailyCheck/dailyCheck-solve",{id:id}):$state.go("safety/dailyCheck/dailyCheck-detail",{id:id}):"复查人审核"==nodeName?right.rechecker?$state.go("safety/dailyCheck/dailyCheck-recheck",{id:id}):$state.go("safety/dailyCheck/dailyCheck-detail",{id:id}):"审批通过"==nodeName?$state.go("safety/dailyCheck/dailyCheck-detail",{id:id}):"审批不通过"==nodeName&&(right.solver&&solverId==userId?$state.go("safety/dailyCheck/dailyCheck-solve",{id:id}):$state.go("safety/dailyCheck/dailyCheck-detail",{id:id})),$ionicViewSwitcher.nextDirection("forward")},$scope.isqueryType=!1,$scope.isqueryMore=!1,$scope.isCheckType=!1,$scope.isProblem=!1,$scope.startTime=YTM.initDatePicker({callback:function(){$scope.condition.startTime=$filter("date")($scope.startTime.date,"yyyy-MM-dd"),dailyCheckService.setStartTime($scope.condition.startTime),$scope.startTimerPopup.close()}}),$scope.endTime=YTM.initDatePicker({callback:function(){$scope.condition.endTime=$filter("date")($scope.endTime.date,"yyyy-MM-dd"),dailyCheckService.setEndTime($scope.condition.endTime),$scope.endTimerPopup.close()}}),$scope.openStartTime=function(){$scope.startTimerPopup=$ionicPopup.show({templateUrl:"start-time.html",scope:$scope,cssClass:"customTimerPopover"}),$scope.startTimerPopup.then(function(res){console.log("Tapped!",res)})},$scope.openEndTime=function(){$scope.endTimerPopup=$ionicPopup.show({templateUrl:"end-time.html",scope:$scope,cssClass:"customTimerPopover"}),$scope.endTimerPopup.then(function(res){console.log("Tapped!",res)})},$scope.openQueryType=function(){$scope.modalQueryType.show(),$scope.isqueryType=!$scope.isqueryType,$scope.isqueryMore=!1},$scope.openQueryMore=function(){$scope.modalQueryMore.show(),$scope.isqueryMore=!$scope.isqueryMore,$scope.isqueryType=!1},$scope.closeQuery=function(){$scope.isqueryType=!1,$scope.isqueryMore=!1},$ionicModal.fromTemplateUrl("query-more.html",{scope:$scope,animation:"slide-in-up"}).then(function(modal){$scope.modalQueryMore=modal}),$ionicModal.fromTemplateUrl("query-type.html",{scope:$scope,animation:"slide-in-up"}).then(function(modal){$scope.modalQueryType=modal}),$scope.openCheckType=function(){$scope.isCheckType=!0},$scope.openProblem=function(){$scope.isProblem=!0},$scope.closeCheckType=function(name){$scope.isCheckType=!1,$scope.condition.checkTypeName=name},$scope.closeProblem=function(name){$scope.isProblem=!1,$scope.condition.hasProblemName=name}}]),angular.module("app.safety.dailyCheck").controller("dailyCheckDetailController",["$scope","$state","$stateParams","dailyCheckService","$ionicViewSwitcher","UserService","env","$ionicActionSheet",function($scope,$state,$stateParams,dailyCheckService,$ionicViewSwitcher,userService,env,$ionicActionSheet){$scope.$on("$ionicView.loaded",function(){dailyCheckService.queryDetail($stateParams.id,function(data){$scope.detailInfo=data}),dailyCheckService.queryDetailProblem($stateParams.id,function(data){$scope.contentList=dailyCheckService.getContent()}),dailyCheckService.queryDetailCheckAttach($stateParams.id,function(data){$scope.checkAttach=data,$scope.changeAttach($scope.checkAttach)}),dailyCheckService.queryDetailRecheckAttach($stateParams.id,function(data){$scope.recheckAttach=data,$scope.changeAttach($scope.recheckAttach)}),$scope.backUrl=$stateParams.backUrl||"safety/dailyCheck/dailyCheck-list"}),$scope.back=function(){$state.go($scope.backUrl),$ionicViewSwitcher.nextDirection("back")},$scope.changeAttach=function(list){if(list.length>0)for(var i=0;i<list.length;i++){var ticket=userService.getTicket();list[i].src=list[i].url.replace("\\","/"),list[i].src=env.server+"download.action?rnd="+Math.random()+"&tkt="+ticket+"&fileName="+list[i].src}},$scope.preview=function(imgIndex,arr){$ionicActionSheet.show({buttons:[{text:"预览"}],cancelText:"关闭",cancel:function(){return!0},buttonClicked:function(){return PhotoViewer.show(arr[imgIndex].src),!0}})}}]),angular.module("app.safety.dailyCheck").controller("dailyCheckDraftsEditController",["$scope","$state","$stateParams","$ionicPopup","dailyCheckAddService","$filter","$ionicHistory","$ionicActionSheet","LocalStorageService","$ionicViewSwitcher","YTService",function($scope,$state,$stateParams,$ionicPopup,dailyCheckAddService,$filter,$ionicHistory,$ionicActionSheet,LocalStorageService,$ionicViewSwitcher,YTService){$scope.checkData=dailyCheckAddService.getCheckData(),$scope.checkDataShow=dailyCheckAddService.getCheckDataShow(),$scope.contentList=dailyCheckAddService.getContent(),$scope.checkTypeFlag=!1,$scope.checkDate=YTM.initDatePicker({callback:function(){$scope.checkData.checkDate=$filter("date")($scope.checkDate.date,"yyyy-MM-dd"),dailyCheckAddService.setCheckDate($scope.checkData.checkDate),$scope.checkDatePopup.close()}}),$scope.openCheckDate=function(){$scope.checkDatePopup=$ionicPopup.show({templateUrl:"check-date.html",scope:$scope,cssClass:"customTimerPopover"}),$scope.checkDatePopup.then(function(res){console.log("Tapped!",res)})},dailyCheckAddService.setType($stateParams.type),$scope.url="safety/dailyCheck/dailyCheck-drafts-edit",$scope.titleName="编辑本地安全检查",$scope.$on("$ionicView.beforeEnter",function(){$scope.backUrl="safety/dailyCheck/dailyCheck-drafts-list",null!=$stateParams.id?dailyCheckAddService.getDraftData($stateParams.id,function(){$scope.checkData=dailyCheckAddService.getCheckData(),$scope.checkDataShow=dailyCheckAddService.getCheckDataShow(),$scope.contentList=dailyCheckAddService.getContent(),$scope.image_list=dailyCheckAddService.getImagList(),$scope.checkContent($scope.contentList)}):($scope.image_list=dailyCheckAddService.getImagList(),$scope.checkData=dailyCheckAddService.getCheckData(),$scope.checkDataShow=dailyCheckAddService.getCheckDataShow(),$scope.contentList=dailyCheckAddService.getContent(),$scope.checkContent($scope.contentList)),dailyCheckAddService.queryCheckType(function(data){$scope.checkType=data})}),$scope.checkContent=function(contents){for(var j=0;j<contents.length;j++){var items=contents[j].items,returnItems=[];if(void 0!=items)for(var i=0;i<items.length;i++){var problems=items[i].problems;void 0!=problems&&problems.length>0&&returnItems.push(items[i])}contents[j].items=returnItems}},$scope.close=function(){$scope.checkTypeFlag=!1},$scope.openCheckType=function(){$scope.checkTypeFlag=!0},$scope.closeCheckType=function(id,name){$scope.checkData.checkTypeId=id,dailyCheckAddService.setCheckTypeId($scope.checkData.checkTypeId),$scope.checkDataShow.checkTypeName=name,dailyCheckAddService.setCheckTypeName($scope.checkDataShow.checkTypeName),$scope.checkTypeFlag=!1},$scope.showConfirmDel=function(id){var confirmPopup=$ionicPopup.confirm({title:"提示",template:'<p class="text-center">确认删除？</p>',cancelText:"取消",okText:"确定"});confirmPopup.then(function(res){res&&(dailyCheckAddService.removeContent(id),$scope.contentList=dailyCheckAddService.getContent(),$ionicPopup.alert({title:"提示",template:'<p class="text-center">删除成功!</p>'}))})},$scope.back=function(){dailyCheckAddService.clearCachedData(),$state.go($scope.backUrl),$ionicViewSwitcher.nextDirection("back")},$scope.submit=function(){$ionicActionSheet.show({buttons:[{text:"提交"},{text:"保存服务器"},{text:"保存本地"}],cancelText:"取消",cancel:function(){return!0},buttonClicked:function(index){if($scope.checkSheet()){var data={};if(0==index&&(data=$scope.getData(1),data.addPosFlag?dailyCheckAddService.insertAddPosition(data.addPosition,function(positionId){data.data.checkPosId=positionId,1==data.data.hasProblem?dailyCheckAddService.insertDailyCheckData(data.data,data.slave,{status:"audit",pushUserId:data.data.solverId,condition:{"状态":"处理"},wId:150001,userId:dailyCheckAddService.getUserId(),orgId:dailyCheckAddService.getRootOrgId()},function(data){200==data.status&&$ionicPopup.alert({title:"验证",template:'<p class="text-center">提交成功!</p>'}).then(function(){$scope.delDraft(dailyCheckAddService.getId()),dailyCheckAddService.clearCachedData(),$state.go($scope.backUrl),$ionicViewSwitcher.nextDirection("back")})}):0==data.data.hasProblem&&dailyCheckAddService.insertDailyCheckData(data.data,data.slave,{status:"audit",pushUserId:data.data.solverId,condition:{"状态":"通过"},wId:150001,userId:dailyCheckAddService.getUserId(),orgId:dailyCheckAddService.getRootOrgId()},function(data){200==data.status&&$ionicPopup.alert({title:"验证",template:'<p class="text-center">提交成功!</p>'}).then(function(){$scope.delDraft(dailyCheckAddService.getId()),dailyCheckAddService.clearCachedData(),$state.go($scope.backUrl),$ionicViewSwitcher.nextDirection("back")})})}):1==data.data.hasProblem?dailyCheckAddService.insertDailyCheckData(data.data,data.slave,{status:"audit",pushUserId:data.data.solverId,condition:{"状态":"处理"},wId:150001,userId:dailyCheckAddService.getUserId(),orgId:dailyCheckAddService.getRootOrgId()},function(data){200==data.status&&$ionicPopup.alert({title:"验证",template:'<p class="text-center">提交成功!</p>'}).then(function(){$scope.delDraft(dailyCheckAddService.getId()),dailyCheckAddService.clearCachedData(),$state.go($scope.backUrl),$ionicViewSwitcher.nextDirection("back")})}):0==data.data.hasProblem&&dailyCheckAddService.insertDailyCheckData(data.data,data.slave,{status:"audit",pushUserId:data.data.solverId,condition:{"状态":"通过"},wId:150001,userId:dailyCheckAddService.getUserId(),orgId:dailyCheckAddService.getRootOrgId()},function(data){200==data.status&&$ionicPopup.alert({title:"验证",template:'<p class="text-center">提交成功!</p>'}).then(function(){$scope.delDraft(dailyCheckAddService.getId()),dailyCheckAddService.clearCachedData(),$state.go($scope.backUrl),$ionicViewSwitcher.nextDirection("back")})})),1==index&&(data=$scope.getData(0),data.addPosFlag?dailyCheckAddService.insertAddPosition(data.addPosition,function(positionId){data.data.checkPosId=positionId,dailyCheckAddService.insertDailyCheckData(data.data,data.slave,{status:"saved"},function(data){200==data.status&&$ionicPopup.alert({title:"验证",template:'<p class="text-center">保存成功!</p>'}).then(function(){$scope.delDraft(dailyCheckAddService.getId()),dailyCheckAddService.clearCachedData(),$state.go($scope.backUrl),$ionicViewSwitcher.nextDirection("back")})})}):dailyCheckAddService.insertDailyCheckData(data.data,data.slave,{status:"saved"},function(data){200==data.status&&$ionicPopup.alert({title:"验证",template:'<p class="text-center">保存成功!</p>'}).then(function(){$scope.delDraft(dailyCheckAddService.getId()),dailyCheckAddService.clearCachedData(),$state.go($scope.backUrl),$ionicViewSwitcher.nextDirection("back")})})),2==index){var problem=dailyCheckAddService.getProblems(),title="",checkDataShow=dailyCheckAddService.getCheckDataShow();if(1==checkDataShow.hasProblem){for(var i=0;i<problem.length-1;i++)title+=problem[i].name+"；";title+=problem[problem.length-1].name}else 0==checkDataShow.hasProblem&&(title=checkDataShow.checkTypeName);for(var localDataList=JSON.parse(LocalStorageService.get("dailyCheckList")),currentId=dailyCheckAddService.getId(),localData={id:currentId,title:title,checkData:dailyCheckAddService.getCheckData(),checkDataShow:checkDataShow,content:dailyCheckAddService.getContent(),problems:problem,attach:dailyCheckAddService.getImagList()},k=0;k<localDataList.length;k++)localDataList[k].id==currentId&&(localDataList[i]=localData);LocalStorageService.set("dailyCheckList",JSON.stringify(localDataList)),$ionicPopup.alert({title:"验证",template:'<p class="text-center">本地存储成功!</p>'}).then(function(){dailyCheckAddService.clearCachedData(),$state.go($scope.backUrl),$ionicViewSwitcher.nextDirection("back")})}}return!0}})},$scope.checkSheet=function(){var flag=!0,checkData=dailyCheckAddService.getCheckData(),checkDataShow=dailyCheckAddService.getCheckDataShow(),content=dailyCheckAddService.getContent(),problem=dailyCheckAddService.getProblems();checkData.solverId==-1&&(flag=!1,$ionicPopup.alert({title:"验证",template:'<p class="text-center">未选择处理人!</p>'})),checkData.checkTypeId==-1&&(flag=!1,$ionicPopup.alert({title:"验证",template:'<p class="text-center">未选择检查类型!</p>'})),checkData.checkPosId==-1&&""==checkDataShow.checkPositionName&&(flag=!1,$ionicPopup.alert({title:"验证",template:'<p class="text-center">未选择检查位置!</p>'})),checkDataShow.hasProblem&&problem.length<=0&&(flag=!1,$ionicPopup.alert({title:"验证",template:'<p class="text-center">需要设置检查内容和问题!</p>'})),dailyCheckAddService.getImagList().length<=0&&(flag=!1,$ionicPopup.alert({title:"验证",template:'<p class="text-center">需要上传检查照片!</p>'}));for(var contentFlag=!0,i=0;i<content.length;i++)(void 0==content[i].items||content[i].items.length<=0)&&(contentFlag=!1);return contentFlag||(flag=!1,$ionicPopup.alert({title:"验证",template:'<p class="text-center">有检查内容未设置问题!</p>'})),flag},$scope.getData=function(statusId){var checkData=dailyCheckAddService.getCheckData(),checkDataShow=dailyCheckAddService.getCheckDataShow(),problem=dailyCheckAddService.getProblems(),imagList=dailyCheckAddService.getImagList(),data={wid:150001,title:"",checkDate:checkData.checkDate,checkerId:dailyCheckAddService.getUserId(),solverId:checkData.solverId,checkTypeId:checkData.checkTypeId,hasProblem:checkDataShow.hasProblem?1:0,checkPosId:checkData.checkPosId,orgId:dailyCheckAddService.getRootOrgId(),statusId:statusId},position={},dataDetail=[],title="";if(1==data.hasProblem){for(var i=0;i<problem.length-1;i++)title+=problem[i].name+"；";title+=problem[problem.length-1].name,data.title=title;for(var j=0;j<problem.length;j++)dataDetail.push({t:"safety_dailycheck_detail",data:{checkContentId:problem[j].contentId,checkItemId:problem[j].pId,checkProblemId:problem[j].id},key:"id"})}else 0==data.hasProblem&&(data.title=checkDataShow.checkTypeName);if(imagList.length>0)for(var k=0;k<imagList.length;k++)dataDetail.push({t:"safety_dailycheck_attach",data:{name:imagList[k].data.name,url:imagList[k].data.url},key:"id"});var flag=!1;return checkData.checkPosId==-1&&""!=checkDataShow.checkPositionName&&(flag=!0,position={name:checkDataShow.checkPositionName,orgId:dailyCheckAddService.getRootOrgId()}),{data:data,slave:dataDetail,addPosFlag:flag,addPosition:position}},$scope.delDraft=function(id){for(var list=JSON.parse(LocalStorageService.get("dailyCheckList")),i=0;i<list.length;i++)if(list[i].id==id){list.splice(i,1);break}LocalStorageService.set("dailyCheckList",JSON.stringify(list))},$scope.addAttachment=function(){YTService.addAttachment($scope,function(item){$scope.image_list.push(item),dailyCheckAddService.setImagList($scope.image_list)})},$scope.previewOrDelete=function(imgIndex){YTService.previewOrDelete(imgIndex,$scope.image_list,function(){$state.go("safety/dailyCheck/canvas",{image:$scope.image_list[imgIndex],index:imgIndex,backUrl:$scope.url}),$ionicViewSwitcher.nextDirection("forward")}),dailyCheckAddService.setImagList($scope.image_list)},$scope.toChoose=function(url,backUrl){$state.go(url,{backUrl:backUrl}),$ionicViewSwitcher.nextDirection("forward")},$scope.toChooseById=function(id,url,backUrl){$state.go(url,{id:id,backUrl:backUrl}),$ionicViewSwitcher.nextDirection("forward")}}]),angular.module("app.safety.dailyCheck").controller("dailyCheckDraftsListController",["$scope","$state","LocalStorageService","$ionicViewSwitcher",function($scope,$state,LocalStorageService,$ionicViewSwitcher){$scope.$on("$ionicView.beforeEnter",function(){$scope.dailyCheckList=JSON.parse(LocalStorageService.get("dailyCheckList"))}),$scope.toEdit=function(id){$state.go("safety/dailyCheck/dailyCheck-drafts-edit",{id:id}),$ionicViewSwitcher.nextDirection("forward")},$scope.back=function(){$state.go("safety/dailyCheck/dailyCheck-list"),$ionicViewSwitcher.nextDirection("back")}}]),angular.module("app.safety.dailyCheck").controller("dailyCheckEditController",["$scope","$state","$stateParams","$ionicPopup","dailyCheckAddService","$filter","$ionicHistory","$ionicActionSheet","LocalStorageService","$ionicViewSwitcher","YTService",function($scope,$state,$stateParams,$ionicPopup,dailyCheckAddService,$filter,$ionicHistory,$ionicActionSheet,LocalStorageService,$ionicViewSwitcher,YTService){$scope.checkData=dailyCheckAddService.getCheckData(),$scope.checkDataShow=dailyCheckAddService.getCheckDataShow(),$scope.contentList=dailyCheckAddService.getContent(),$scope.checkTypeFlag=!1,$scope.checkDate=YTM.initDatePicker({callback:function(){$scope.checkData.checkDate=$filter("date")($scope.checkDate.date,"yyyy-MM-dd"),dailyCheckAddService.setCheckDate($scope.checkData.checkDate),$scope.checkDatePopup.close()}}),$scope.openCheckDate=function(){$scope.checkDatePopup=$ionicPopup.show({templateUrl:"check-date.html",scope:$scope,cssClass:"customTimerPopover"}),$scope.checkDatePopup.then(function(res){console.log("Tapped!",res)})},dailyCheckAddService.setType($stateParams.type),$scope.url="safety/dailyCheck/dailyCheck-edit",$scope.titleName="编辑安全检查",$scope.$on("$ionicView.beforeEnter",function(){$stateParams.backUrl&&($scope.backUrl=$stateParams.backUrl),$stateParams.id?(dailyCheckAddService.queryDetail($stateParams.id,function(){$scope.checkData=dailyCheckAddService.getCheckData(),$scope.checkDataShow=dailyCheckAddService.getCheckDataShow()}),dailyCheckAddService.queryDetailContent($stateParams.id,function(){$scope.contentList=dailyCheckAddService.getContent(),$stateParams.contentList&&($scope.contentList=$stateParams.contentList),$scope.checkContent($scope.contentList)}),dailyCheckAddService.queryAttach($stateParams.id,function(){$scope.image_list=dailyCheckAddService.getImagList()})):($scope.image_list=dailyCheckAddService.getImagList(),$scope.checkData=dailyCheckAddService.getCheckData(),$scope.checkDataShow=dailyCheckAddService.getCheckDataShow(),$scope.contentList=dailyCheckAddService.getContent(),$scope.checkContent($scope.contentList)),dailyCheckAddService.queryCheckType(function(data){$scope.checkType=data})}),$scope.checkContent=function(contents){for(var j=0;j<contents.length;j++){var items=contents[j].items,returnItems=[];if(void 0!=items)for(var i=0;i<items.length;i++){var problems=items[i].problems;void 0!=problems&&problems.length>0&&returnItems.push(items[i])}contents[j].items=returnItems}},$scope.close=function(){$scope.checkTypeFlag=!1},$scope.openCheckType=function(){$scope.checkTypeFlag=!0},$scope.closeCheckType=function(id,name){$scope.checkData.checkTypeId=id,dailyCheckAddService.setCheckTypeId($scope.checkData.checkTypeId),$scope.checkDataShow.checkTypeName=name,dailyCheckAddService.setCheckTypeName($scope.checkDataShow.checkTypeName),$scope.checkTypeFlag=!1},$scope.showConfirmDel=function(id){var confirmPopup=$ionicPopup.confirm({title:"提示",template:'<p class="text-center">确认删除？</p>',cancelText:"取消",okText:"确定"});confirmPopup.then(function(res){res&&(dailyCheckAddService.removeContent(id),$scope.contentList=dailyCheckAddService.getContent(),$ionicPopup.alert({title:"提示",template:'<p class="text-center">删除成功!</p>'}))})},$scope.back=function(){dailyCheckAddService.clearCachedData(),$state.go($scope.backUrl),$ionicViewSwitcher.nextDirection("back")},$scope.submit=function(){$ionicActionSheet.show({buttons:[{text:"提交"},{text:"保存"}],cancelText:"取消",cancel:function(){return!0},buttonClicked:function(index){if($scope.checkSheet()){var data={};0==index&&(data=$scope.getData(1),data.addPosFlag?dailyCheckAddService.insertAddPosition(data.addPosition,function(positionId){data.data.checkPosId=positionId,1==data.data.hasProblem?dailyCheckAddService.updateDailyCheckData(data.data,data.slave,{status:"audit",pushUserId:data.data.solverId,condition:{"状态":"处理"},wId:150001,userId:dailyCheckAddService.getUserId(),orgId:dailyCheckAddService.getRootOrgId()},function(data){200==data.status&&$ionicPopup.alert({title:"验证",template:'<p class="text-center">提交成功!</p>'}).then(function(){dailyCheckAddService.clearCachedData(),$state.go($scope.backUrl),$ionicViewSwitcher.nextDirection("back")})}):0==data.data.hasProblem&&dailyCheckAddService.updateDailyCheckData(data.data,data.slave,{status:"audit",pushUserId:data.data.solverId,condition:{"状态":"通过"},wId:150001,userId:dailyCheckAddService.getUserId(),orgId:dailyCheckAddService.getRootOrgId()},function(data){200==data.status&&$ionicPopup.alert({title:"验证",template:'<p class="text-center">提交成功!</p>'}).then(function(){dailyCheckAddService.clearCachedData(),$state.go($scope.backUrl),$ionicViewSwitcher.nextDirection("back")})})}):1==data.data.hasProblem?dailyCheckAddService.updateDailyCheckData(data.data,data.slave,{status:"audit",pushUserId:data.data.solverId,condition:{"状态":"处理"},wId:150001,userId:dailyCheckAddService.getUserId(),orgId:dailyCheckAddService.getRootOrgId()},function(data){200==data.status&&$ionicPopup.alert({title:"验证",template:'<p class="text-center">提交成功!</p>'}).then(function(){dailyCheckAddService.clearCachedData(),$state.go($scope.backUrl),$ionicViewSwitcher.nextDirection("back")})}):0==data.data.hasProblem&&dailyCheckAddService.updateDailyCheckData(data.data,data.slave,{status:"audit",pushUserId:data.data.solverId,condition:{"状态":"通过"},wId:150001,userId:dailyCheckAddService.getUserId(),orgId:dailyCheckAddService.getRootOrgId()},function(data){200==data.status&&$ionicPopup.alert({title:"验证",template:'<p class="text-center">提交成功!</p>'}).then(function(){dailyCheckAddService.clearCachedData(),$state.go($scope.backUrl),$ionicViewSwitcher.nextDirection("back")})})),1==index&&(data=$scope.getData(0),data.addPosFlag?dailyCheckAddService.insertAddPosition(data.addPosition,function(positionId){data.data.checkPosId=positionId,dailyCheckAddService.updateDailyCheckData(data.data,data.slave,{status:"saved"},function(data){200==data.status&&$ionicPopup.alert({title:"验证",template:'<p class="text-center">保存成功!</p>'}).then(function(){dailyCheckAddService.clearCachedData(),$state.go($scope.backUrl),$ionicViewSwitcher.nextDirection("back")})})}):dailyCheckAddService.updateDailyCheckData(data.data,data.slave,{status:"saved"},function(data){200==data.status&&$ionicPopup.alert({title:"验证",template:'<p class="text-center">保存成功!</p>'}).then(function(){dailyCheckAddService.clearCachedData(),$state.go($scope.backUrl),$ionicViewSwitcher.nextDirection("back")})}))}return!0}})},$scope.checkSheet=function(){var flag=!0,checkData=dailyCheckAddService.getCheckData(),checkDataShow=dailyCheckAddService.getCheckDataShow(),content=dailyCheckAddService.getContent(),problem=dailyCheckAddService.getProblems();checkData.solverId==-1&&(flag=!1,$ionicPopup.alert({title:"验证",template:'<p class="text-center">未选择处理人!</p>'})),checkData.checkTypeId==-1&&(flag=!1,$ionicPopup.alert({title:"验证",template:'<p class="text-center">未选择检查类型!</p>'})),checkData.checkPosId==-1&&""==checkDataShow.checkPositionName&&(flag=!1,$ionicPopup.alert({title:"验证",template:'<p class="text-center">未选择检查位置!</p>'})),checkDataShow.hasProblem&&problem.length<=0&&(flag=!1,$ionicPopup.alert({title:"验证",template:'<p class="text-center">需要设置检查内容和问题!</p>'})),dailyCheckAddService.getImagList().length<=0&&(flag=!1,$ionicPopup.alert({title:"验证",template:'<p class="text-center">需要上传检查照片!</p>'}));for(var contentFlag=!0,i=0;i<content.length;i++)(void 0==content[i].items||content[i].items.length<=0)&&(contentFlag=!1);return contentFlag||(flag=!1,$ionicPopup.alert({title:"验证",template:'<p class="text-center">有检查内容未设置问题!</p>'})),flag},$scope.getData=function(statusId){var checkData=dailyCheckAddService.getCheckData(),checkDataShow=dailyCheckAddService.getCheckDataShow(),problem=dailyCheckAddService.getProblems(),imagList=dailyCheckAddService.getImagList(),data={id:dailyCheckAddService.getId(),wid:150001,title:"",checkDate:checkData.checkDate,checkerId:dailyCheckAddService.getUserId(),solverId:checkData.solverId,checkTypeId:checkData.checkTypeId,hasProblem:checkDataShow.hasProblem?1:0,checkPosId:checkData.checkPosId,orgId:dailyCheckAddService.getRootOrgId(),statusId:statusId},position={},dataDetail=[],title="";if(1==data.hasProblem){for(var i=0;i<problem.length-1;i++)title+=problem[i].name+"；";title+=problem[problem.length-1].name,data.title=title;for(var j=0;j<problem.length;j++)dataDetail.push({
t:"safety_dailycheck_detail",data:{id:dailyCheckAddService.getId(),checkContentId:problem[j].contentId,checkItemId:problem[j].pId,checkProblemId:problem[j].id},key:"id"})}else 0==data.hasProblem&&(data.title=checkDataShow.checkTypeName);var flag=!1;if(checkData.checkPosId==-1&&""!=checkDataShow.checkPositionName&&(flag=!0,position={name:checkDataShow.checkPositionName,orgId:dailyCheckAddService.getRootOrgId()}),imagList.length>0)for(var k=0;k<imagList.length;k++)dataDetail.push({t:"safety_dailycheck_attach",data:{id:dailyCheckAddService.getId(),name:imagList[k].data.name,url:imagList[k].data.url},key:"id"});return{data:data,slave:dataDetail,addPosFlag:flag,addPosition:position}},$scope.addAttachment=function(){YTService.addAttachment($scope,function(item){$scope.image_list.push(item),dailyCheckAddService.setImagList($scope.image_list)})},$scope.previewOrDelete=function(imgIndex){YTService.previewOrDelete(imgIndex,$scope.image_list,function(){$state.go("safety/dailyCheck/canvas",{image:$scope.image_list[imgIndex],index:imgIndex,backUrl:$scope.url}),$ionicViewSwitcher.nextDirection("forward")}),dailyCheckAddService.setImagList($scope.image_list)},$scope.toChoose=function(url,backUrl){$state.go(url,{backUrl:backUrl}),$ionicViewSwitcher.nextDirection("forward")},$scope.toChooseById=function(id,url,backUrl){$state.go(url,{id:id,backUrl:backUrl}),$ionicViewSwitcher.nextDirection("forward")}}]),angular.module("app.safety.dailyCheck").controller("dailyCheckPositionController",["$scope","$state","$stateParams","$ionicPopup","dailyCheckAddService","$ionicViewSwitcher",function($scope,$state,$stateParams,$ionicPopup,dailyCheckAddService,$ionicViewSwitcher){$scope.showLocationAdd=!0,$scope.showLocation=!0,$scope.$on("$ionicView.beforeEnter",function(){$stateParams.backUrl&&($scope.backUrl=$stateParams.backUrl),dailyCheckAddService.getPositionList().length<=0?dailyCheckAddService.queryCheckPosition(function(data){$scope.checkPosition=data,dailyCheckAddService.setPositionList(data),$scope.showLocation=$scope.checkPosition.length>0}):($scope.checkPosition=dailyCheckAddService.getPositionList(),$scope.showLocation=$scope.checkPosition.length>0),$scope.checkDataShow=dailyCheckAddService.getCheckDataShow(),$scope.showLocationAdd=$scope.checkDataShow.addPositionName.length>0}),$scope.choosePosition=function(obj){void 0!=obj.id&&""!=obj.id||(obj.id=-1),$scope.setPosition(obj),$state.go($scope.backUrl,{backUrl:"safety/dailyCheck/dailyCheck-list"}),$ionicViewSwitcher.nextDirection("back")},$scope.showPrompt=function(){$ionicPopup.prompt({title:"新增位置",cancelText:"取消",okText:"确定"}).then(function(res){""==res||void 0==res||$scope.checkNewPosition(res.trim())||(dailyCheckAddService.pushAddPositionName({name:res.trim()}),$scope.checkDataShow=dailyCheckAddService.getCheckDataShow(),$scope.setPosition({id:-1,name:res.trim()}),$scope.showLocationAdd=!0)})},$scope.back=function(){$state.go($scope.backUrl,{backUrl:"safety/dailyCheck/dailyCheck-list"}),$ionicViewSwitcher.nextDirection("back")},$scope.checkNewPosition=function(name){for(var positionList=dailyCheckAddService.getPositionList(),flag=!1,i=0;i<positionList.length;i++)positionList[i].name.trim()==name.trim()&&(flag=!0,dailyCheckAddService.setCheckPosId(positionList[i].id),dailyCheckAddService.setCheckPositionName(positionList[i].name));return dailyCheckAddService.setPositionList(positionList),flag},$scope.setPosition=function(obj){for(var positionList=dailyCheckAddService.getPositionList(),flag=!1,i=0;i<positionList.length;i++)positionList[i].id==obj.id?(flag=flag||!0,dailyCheckAddService.setCheckPosId(positionList[i].id),dailyCheckAddService.setCheckPositionName(positionList[i].name)):flag=flag||!1;if(dailyCheckAddService.setPositionList(positionList),!flag){for(var positionAddList=dailyCheckAddService.getCheckDataShow().addPositionName,j=0;j<positionAddList.length;j++)positionAddList[j].name==obj.name&&(dailyCheckAddService.setCheckPosId(positionAddList[j].id),dailyCheckAddService.setCheckPositionName(positionAddList[j].name));dailyCheckAddService.setAddPosition(positionAddList)}}}]),angular.module("app.safety.dailyCheck").controller("dailyCheckRecheckController",["$scope","$state","$stateParams","dailyCheckService","$ionicPopup","$ionicViewSwitcher","$ionicActionSheet","$filter","UserService","env","YTService",function($scope,$state,$stateParams,dailyCheckService,$ionicPopup,$ionicViewSwitcher,$ionicActionSheet,$filter,userService,env,YTService){$scope.detailInfo={},$scope.$on("$ionicView.beforeEnter",function(){dailyCheckService.queryDetail($stateParams.id,function(data){$scope.detailInfo=data;var now=new Date;$scope.detailInfo.recheckDate=now.getFullYear()+"-"+dailyCheckService.prefixInteger(now.getMonth()+1,2)+"-"+dailyCheckService.prefixInteger(now.getDate(),2),$scope.detailInfo.recheckerName=dailyCheckService.getUserName()}),dailyCheckService.queryDetailProblem($stateParams.id,function(){$scope.contentList=dailyCheckService.getContent()}),dailyCheckService.queryDetailCheckAttach($stateParams.id,function(data){$scope.checkAttach=data,$scope.changeAttach($scope.checkAttach)}),$scope.backUrl=$stateParams.backUrl||"safety/dailyCheck/dailyCheck-list"}),$scope.recheckDate=YTM.initDatePicker({callback:function(){$scope.detailInfo.recheckDate=$filter("date")($scope.recheckDate.date,"yyyy-MM-dd"),$scope.recheckDatePopup.close()}}),$scope.openRecheckDate=function(){$scope.recheckDatePopup=$ionicPopup.show({templateUrl:"check-date.html",scope:$scope,cssClass:"customTimerPopover"}),$scope.recheckDatePopup.then(function(res){console.log("Tapped!",res)})},$scope.recheck=function(data){$ionicActionSheet.show({buttons:[{text:"通过"},{text:"不通过"}],cancelText:"取消",cancel:function(){return!0},buttonClicked:function(index){return $scope.check()&&(data.recheckerId=dailyCheckService.getUserId(),data.imagList=dailyCheckService.getImagList(),0==index?dailyCheckService.solveAndRecheckData(data,15001004,"通过",function(){$ionicPopup.alert({title:"提示",template:'<p class="text-center">您已通过该检查!</p>'}).then(function(){$state.go($scope.backUrl),$ionicViewSwitcher.nextDirection("back")})}):1==index&&dailyCheckService.solveAndRecheckData(data,15001004,"不通过",function(){$ionicPopup.alert({title:"提示",template:'<p class="text-center">您退回了该检查!</p>'}).then(function(){$state.go($scope.backUrl),$ionicViewSwitcher.nextDirection("back")})})),!0}})},$scope.check=function(){var flag=!0;return dailyCheckService.getImagList().length<=0&&(flag=!1,$ionicPopup.alert({title:"验证",template:'<p class="text-center">需要上传复查照片!</p>'})),flag},$scope.back=function(){$state.go($scope.backUrl),$ionicViewSwitcher.nextDirection("back")},$scope.changeAttach=function(list){if(list.length>0)for(var i=0;i<list.length;i++){var ticket=userService.getTicket();list[i].src=list[i].url.replace("\\","/"),list[i].src=env.server+"download.action?rnd="+Math.random()+"&tkt="+ticket+"&fileName="+list[i].src}},$scope.preview=function(imgIndex,arr){$ionicActionSheet.show({buttons:[{text:"预览"}],cancelText:"关闭",cancel:function(){return!0},buttonClicked:function(){return PhotoViewer.show(arr[imgIndex].src),!0}})},$scope.image_list=[],$scope.addAttachment=function(){YTService.addAttachment($scope,function(item){$scope.image_list.push(item),dailyCheckService.pushImagList(item)})},$scope.previewOrDelete=function(imgIndex){YTService.previewOrDelete(imgIndex,$scope.image_list,function(){$state.go("safety/dailyCheck/canvas",{image:$scope.image_list[imgIndex],index:imgIndex,backUrl:$scope.url}),$ionicViewSwitcher.nextDirection("forward")}),dailyCheckService.setImagList($scope.image_list)},$scope.preview=function(imgIndex,arr){dailyCheckService.preview(imgIndex,arr)}}]),angular.module("app.safety.dailyCheck").controller("dailyCheckSolveController",["$scope","$state","$stateParams","dailyCheckService","$ionicPopup","$ionicViewSwitcher","UserService","env","$ionicActionSheet",function($scope,$state,$stateParams,dailyCheckService,$ionicPopup,$ionicViewSwitcher,userService,env,$ionicActionSheet){$scope.$on("$ionicView.beforeEnter",function(){dailyCheckService.queryDetail($stateParams.id,function(data){$scope.detailInfo=data}),dailyCheckService.queryDetailProblem($stateParams.id,function(){$scope.contentList=dailyCheckService.getContent()}),dailyCheckService.queryDetailCheckAttach($stateParams.id,function(data){$scope.checkAttach=data,$scope.changeAttach($scope.checkAttach)}),dailyCheckService.queryDetailRecheckAttach($stateParams.id,function(data){$scope.recheckAttach=[],data.length>0&&($scope.recheckAttach=data,$scope.changeAttach($scope.recheckAttach))}),$scope.backUrl=$stateParams.backUrl||"safety/dailyCheck/dailyCheck-list"}),$scope.solve=function(data){dailyCheckService.solveAndRecheckData(data,15001003,"复查",function(){$ionicPopup.alert({title:"验证",template:'<p class="text-center">处理成功!</p>'}).then(function(){$state.go($scope.backUrl),$ionicViewSwitcher.nextDirection("back")})})},$scope.back=function(){$state.go($scope.backUrl),$ionicViewSwitcher.nextDirection("back")},$scope.changeAttach=function(list){if(list.length>0)for(var i=0;i<list.length;i++){var ticket=userService.getTicket();list[i].src=list[i].url.replace("\\","/"),list[i].src=env.server+"download.action?rnd="+Math.random()+"&tkt="+ticket+"&fileName="+list[i].src}},$scope.preview=function(imgIndex,arr){$ionicActionSheet.show({buttons:[{text:"预览"}],cancelText:"关闭",cancel:function(){return!0},buttonClicked:function(){return PhotoViewer.show(arr[imgIndex].src),!0}})}}]),angular.module("app.safety.dailyCheck").controller("dailyCheckSolverController",["$scope","$state","$stateParams","$ionicPopup","dailyCheckAddService","$ionicViewSwitcher",function($scope,$state,$stateParams,$ionicPopup,dailyCheckAddService,$ionicViewSwitcher){$scope.$on("$ionicView.beforeEnter",function(){$stateParams.backUrl&&($scope.backUrl=$stateParams.backUrl),dailyCheckAddService.querySolver(function(data){$scope.solver=data}),$scope.solverId=dailyCheckAddService.getCheckData().solverId}),$scope.chooseSolver=function(obj){dailyCheckAddService.setSolverId(obj.userId),dailyCheckAddService.setSolverName(obj.realName),$state.go($scope.backUrl,{backUrl:"safety/dailyCheck/dailyCheck-list"}),$ionicViewSwitcher.nextDirection("back")},$scope.back=function(){$state.go($scope.backUrl,{backUrl:"safety/dailyCheck/dailyCheck-list"}),$ionicViewSwitcher.nextDirection("back")}}]),angular.module("app.safety.dailyCheck").factory("dailyCheckAddService",["YTService","UserService","LocalStorageService","env",function(YT,userService,LocalStorageService,env){var checkData={title:"",checkDate:"",checkTypeId:-1,checkPosId:-1,solverId:-1,statusId:-1},checkDataShow={checker:"",checkTypeName:"",checkPositionName:"",solverName:"",addPositionName:[],hasProblem:!0},content=[],problems=[],position=[],solver=[],image_list=[],type="",id=-1;return{clearCachedData:function(){checkData={title:"",checkDate:"",checkTypeId:-1,checkPosId:-1,solverId:-1,statusId:-1},checkDataShow={checker:"",checkTypeName:"",checkPositionName:"",solverName:"",addPositionName:[],hasProblem:!0},content=[],problems=[],solver=[],image_list=[],position=[],type="",id=-1},queryDetail:function(id,successCallback){var self=this;self.setId(id);var data={m:15001002,t:"v_safety_dailycheck"},filter=[{field:"id",value:id,operator:"=",relation:"and"}];data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){var detail=data.object[0];checkData={title:detail.title,checkDate:detail.checkDate,checkTypeId:detail.checkTypeId,checkPosId:detail.checkPosId,solverId:detail.solverId,statusId:detail.statusId},checkDataShow={checker:detail.checkerName,checkTypeName:detail.checkTypeName,checkPositionName:detail.checkPosName,solverName:detail.solverName,addPositionName:[],hasProblem:0!=detail.hasProblem},self.setCheckData(checkData),self.setCheckDataShow(checkDataShow),successCallback.call()}})},queryDetailContent:function(id,successCallback){var self=this,data={m:15001002,t:"v_safety_dailycheck_detail"},filter=[{field:"id",value:id,operator:"=",relation:"and"}];data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){for(var contentData=data.object,contentList=[],problemList=[],contentMap={},itemMap={},problemMap={},i=0;i<contentData.length;i++)contentMap[contentData[i].checkContentId]={id:contentData[i].checkContentId,name:contentData[i].checkContentName,checked:!0},itemMap[contentData[i].checkItemId]={id:contentData[i].checkItemId,name:contentData[i].checkItemName,pId:contentData[i].checkContentId,checked:!0},problemMap[contentData[i].checkProblemId]={id:contentData[i].checkProblemId,name:contentData[i].checkProblemName,pId:contentData[i].checkItemId,contentId:contentData[i].checkContentId,checked:!0},problemList.push({id:contentData[i].checkProblemId,name:contentData[i].checkProblemName,pId:contentData[i].checkItemId,contentId:contentData[i].checkContentId,checked:!0});for(var key in problemMap){var problems=itemMap[problemMap[key].pId].problems;problems=problems||[],problems.push(problemMap[key]),itemMap[problemMap[key].pId].problems=problems}for(var key in itemMap){var items=contentMap[itemMap[key].pId].items;items=items||[],items.push(itemMap[key]),contentMap[itemMap[key].pId].items=items}for(var key in contentMap)contentList.push(contentMap[key]);self.setContent(contentList),self.setProblems(problemList),successCallback.call()}})},queryAttach:function(id,successCallback){var self=this,data={m:15001002,t:"safety_dailycheck_attach"},filter=[{field:"id",value:id,operator:"=",relation:"and"}];data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){self.changeAttach(data.object),successCallback.call()}})},queryCheckType:function(successCallback){var data={m:15001002,t:"safety_d_dailychecktype"};YT.query({data:data,successCallback:function(data){successCallback.call(this,data.object)}})},queryCheckPosition:function(successCallback){var data={m:15001002,t:"safety_d_checkposition"},filter=[{field:"orgId",value:userService.getRootOrgId(),operator:"=",relation:"and"}];data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){successCallback.call(this,data.object)}})},querySolver:function(successCallback){var data={m:15001002,t:"v_safety_projectperson"},filter=[];filter.push({field:"orgId",value:userService.getRootOrgId(),operator:"=",relation:"and"}),filter.push({field:"position",value:"处理人",operator:"=",relation:"and"}),data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){successCallback.call(this,data.object)}})},queryCheckContent:function(id,level,successCallback){var data={m:15001002,t:"v_safety_checkcontent",order:"id"},filter=[],oneFilter=[];oneFilter.push({field:"level",value:level,operator:"=",relation:"and"}),id!=-1&&oneFilter.push({field:"pId",value:id,operator:"=",relation:"and"}),oneFilter.push({field:"type",value:"通用",operator:"=",relation:"OR"});var twoFilter=[];twoFilter.push({field:"level",value:level,operator:"=",relation:"and"}),id!=-1&&twoFilter.push({field:"pId",value:id,operator:"=",relation:"and"}),twoFilter.push({field:"type",value:"项目部",operator:"=",relation:"and"}),twoFilter.push({field:"orgId",value:userService.getRootOrgId(),operator:"=",relation:""}),filter.push(oneFilter),filter.push(twoFilter),data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){successCallback.call(this,data.object)}})},insertCheckProblem:function(problem,successCallback){var data={m:15001002,t:"safety_d_checkcontent_extend",v:JSON.stringify([{t:"safety_d_checkcontent_extend",data:problem,ai:!0}])};YT.insert({data:data,successCallback:function(data){successCallback.call(this,data.object)}})},insertAddPosition:function(position,successCallback){var data={m:15001002,t:"safety_d_checkposition",v:JSON.stringify([{t:"safety_d_checkposition",data:position,ai:!0}])};YT.insert({data:data,successCallback:function(data){successCallback.call(this,data.object)}})},insertDailyCheckData:function(data,slave,params,successCallback){var postData={m:15001002,t:"safety_dailycheck",v:JSON.stringify([{t:"safety_dailycheck",data:data,ai:!0,slave:slave}]),params:JSON.stringify(params)};YT.insert({data:postData,successCallback:function(data){successCallback.call(this,data)}})},updateDailyCheckData:function(data,slave,params,successCallback){var filter=[{field:"id",value:data.id,operator:"=",relation:""}],postData={m:15001002,t:"safety_dailycheck",v:JSON.stringify([{t:"safety_dailycheck",data:data,slave:slave,filter:filter}]),params:JSON.stringify(params)};YT.update({data:postData,successCallback:function(data){successCallback.call(this,data)}})},getDraftData:function(id,successCallback){for(var self=this,draftDataList=JSON.parse(LocalStorageService.get("dailyCheckList")),i=0;i<draftDataList.length;i++)draftDataList[i].id==id&&(self.setId(id),self.setCheckData(draftDataList[i].checkData),self.setCheckDataShow(draftDataList[i].checkDataShow),self.setContent(draftDataList[i].content),self.setProblems(draftDataList[i].problems),self.setImagList(draftDataList[i].attach),successCallback.call())},getUserName:function(){return userService.getUserName()},getRootOrgId:function(){return userService.getRootOrgId()},getUserId:function(){return userService.getUserId()},prefixInteger:function(num,n){for(var len=num.toString().length;len<n;)num="0"+num,len++;return num},deepClone:function(obj){var o;switch(typeof obj){case"undefined":break;case"string":o=obj+"";break;case"number":o=obj-0;break;case"boolean":o=obj;break;case"object":if(null===obj)o=null;else if(obj instanceof Array){o=[];for(var i=0,len=obj.length;i<len;i++)o.push(this.deepClone(obj[i]))}else{o={};for(var k in obj)o[k]=this.deepClone(obj[k])}break;default:o=obj}return o},getType:function(){return type},setType:function(data){type=data},getCheckData:function(){return checkData},setCheckData:function(data){checkData=data},setTitle:function(data){checkData.title=data},getId:function(){return id},setId:function(data){id=data},setCheckDate:function(data){checkData.checkDate=data},setCheckTypeId:function(data){checkData.checkTypeId=data},setCheckPosId:function(data){checkData.checkPosId=data},setSolverId:function(data){checkData.solverId=data},getPositionList:function(){return position},setPositionList:function(data){position=data},getSolverList:function(){return solver},setSolverList:function(data){solver=data},setStatusId:function(data){checkData.statusId=data},getCheckDataShow:function(){return checkDataShow},setCheckDataShow:function(data){checkDataShow=data},setChecker:function(data){checkDataShow.checker=data},setCheckTypeName:function(data){checkDataShow.checkTypeName=data},setCheckPositionName:function(data){checkDataShow.checkPositionName=data},setSolverName:function(data){checkDataShow.solverName=data},pushAddPositionName:function(data){checkDataShow.addPositionName.push(data)},setAddPosition:function(data){checkDataShow.addPositionName=data},getContent:function(){return content},setContent:function(data){content=data},pushContent:function(data){content.push(data)},removeContent:function(id){for(var self=this,i=0;i<content.length;i++)content[i].id==id&&(content.splice(i,1),self.removeContentProblems(id))},setProblems:function(data){problems=data},getProblems:function(){return problems},getImagList:function(){return image_list},pushImagList:function(data){image_list.push(data)},setImagList:function(data){image_list=data},pushProblem:function(data){problems.push(data)},removeItemProblems:function(pId){for(var returnProblems=[],i=0;i<problems.length;i++)problems[i].pId!=pId&&returnProblems.push(problems[i]);problems=returnProblems},removeContentProblems:function(contentId){for(var temp=[],i=0;i<problems.length;i++)problems[i].contentId!=contentId&&temp.push(problems[i]);problems=temp},removeItem:function(contentId,itemId){for(var i=0;i<content.length;i++)if(contentId==content[i].id)for(var items=content[i].items,j=0;j<items.length;j++)(itemId=items[j].id)&&items.splice(j,1)},changeAttach:function(list){if(list.length>0)for(var i=0;i<list.length;i++){var ticket=userService.getTicket(),url=list[i].url.replace("\\","/");list[i].src=env.server+"download.action?rnd="+Math.random()+"&tkt="+ticket+"&fileName="+url;var item={src:list[i].src,data:{name:list[i].name,url:list[i].url}};image_list.push(item)}}}}]),angular.module("app.safety.dailyCheck").factory("dailyCheckService",["YTService","UserService","env","$ionicActionSheet",function(YT,userService,env,$ionicActionSheet){var serviceData=[],pageIndex=0,pageSize=10,hasNextPage=!0,right={checker:!1,solver:!1,rechecker:!1},condition={typeId:-1,checker:"",solver:"",checkType:-1,checkTypeName:"",problem:-1,hasProblemName:"",startTime:"",endTime:""},image_list=[],content=[];return{loadListData:function(successCallback){++pageIndex;var self=this;right.checker=YT.haveRight(15001002),right.solver=YT.haveRight(15001003),right.rechecker=YT.haveRight(15001004),YT.query({data:self.getSearchData(),successCallback:function(data){self.loadListDataCallback(data),successCallback.call()}})},loadListDataCallback:function(data){for(var pageInfo=data.object,i=0;i<pageInfo.items.length;i++)serviceData.push(pageInfo.items[i]);hasNextPage=!(pageIndex>=pageInfo.pageCount)},refreshListData:function(successCallBack){pageIndex=0,hasNextPage=!0,serviceData=[],right={checker:!1,solver:!1,rechecker:!1},this.loadListData(successCallBack)},clearCachedData:function(){pageIndex=0,hasNextPage=!0,serviceData=[],right={checker:!1,solver:!1,rechecker:!1},content=[],image_list=[]},getSearchData:function(){var data={m:15001001,t:"v_safety_dailycheck_processing",order:"id desc",page:pageIndex,rows:pageSize},filter=this.getSearchFilter();return data.filter=JSON.stringify(filter),data},getSearchFilter:function(){var self=this,rootId=(userService.getTypeId(),userService.getRootOrgId()),userId=userService.getUserId(),filter=[];filter.push({field:"orgId",value:rootId,operator:"=",relation:"AND"}),condition.typeId!=-1&&(0==condition.typeId?filter.push({field:"nodeName",value:"草稿箱",operator:"=",relation:"AND"}):1==condition.typeId?filter.push({field:"nodeName",value:"处理人审核",operator:"=",relation:"AND"}):2==condition.typeId?filter.push({field:"nodeName",value:"复查人审核",operator:"=",relation:"AND"}):3==condition.typeId?filter.push({field:"nodeName",value:"审批通过",operator:"=",relation:"AND"}):4==condition.typeId?filter.push({field:"nodeName",value:"审批不通过",operator:"=",relation:"AND"}):5==condition.typeId&&filter.push({field:"checkerId",value:userId,operator:"=",relation:"AND"})),condition.checkType!=-1&&(1==condition.checkType?filter.push({field:"checkTypeId",value:1,operator:"=",relation:"AND"}):2==condition.checkType&&filter.push({field:"checkTypeId",value:2,operator:"=",relation:"AND"})),condition.problem!=-1&&(1==condition.problem?filter.push({field:"hasProblem",value:1,operator:"=",relation:"AND"}):0==condition.problem&&filter.push({field:"hasProblem",value:0,operator:"=",relation:"AND"})),""!=condition.startTime&&""!=condition.endTime?filter.push({field:"checkDate",value:condition.startTime,operator:">=",relation:"AND"},{field:"checkDate",value:condition.endTime,operator:"<=",relation:"AND"}):""!=condition.startTime?filter.push({field:"checkDate",value:condition.startTime,operator:">=",relation:"AND"}):""!=condition.endTime&&filter.push({field:"checkDate",value:condition.endTime,operator:"<=",relation:"AND"}),""!=condition.checker&&filter.push({field:"checkerName",value:"%"+condition.checker+"%",operator:"like",relation:"AND"}),""!=condition.solver&&filter.push({field:"solverName",value:"%"+condition.solver+"%",operator:"like",relation:"AND"});var oneFilter=self.deepClone(filter),twoFilter=self.deepClone(filter),threeFilter=self.deepClone(filter);if(filter=[],right.checker||right.solver||right.rechecker){if(right.checker&&(oneFilter.push({field:"checkerId",value:userId,operator:"=",relation:"OR"}),filter.push(oneFilter)),right.solver){var twoOneFilter=self.deepClone(twoFilter),twoTwoFilter=self.deepClone(twoFilter),twoThreeFilter=self.deepClone(twoFilter);twoOneFilter.push({field:"solverId",value:userId,operator:"=",relation:"AND"}),twoOneFilter.push({field:"nodeName",value:"处理人审核",operator:"=",relation:"OR"}),twoTwoFilter.push({field:"solverId",value:userId,operator:"=",relation:"AND"}),twoTwoFilter.push({field:"nodeName",value:"审批通过",operator:"=",relation:"OR"}),twoThreeFilter.push({field:"solverId",value:userId,operator:"=",relation:"AND"}),twoThreeFilter.push({field:"nodeName",value:"审批不通过",operator:"=",relation:"OR"}),filter.push(twoOneFilter),filter.push(twoTwoFilter),filter.push(twoThreeFilter)}if(right.rechecker){var threeOneFilter=self.deepClone(threeFilter),threeTwoFilter=self.deepClone(threeFilter),threeThreeFilter=self.deepClone(threeFilter);threeOneFilter.push({field:"nodeName",value:"复查人审核",operator:"=",relation:"OR"}),threeTwoFilter.push({field:"operaterId",value:userId,operator:"=",relation:"AND"}),threeTwoFilter.push({field:"nodeName",value:"审批通过",operator:"=",relation:"OR"}),threeThreeFilter.push({field:"operaterId",value:userId,operator:"=",relation:"AND"}),threeThreeFilter.push({field:"nodeName",value:"审批不通过",operator:"=",relation:"OR"}),filter.push(threeOneFilter),filter.push(threeTwoFilter),filter.push(threeThreeFilter)}}else filter.push({field:"checkerId",value:-999,operator:"=",relation:""});return filter},queryDetail:function(id,successCallback){var data={m:15001001,t:"v_safety_dailycheck"},filter=[{field:"id",value:id,operator:"=",relation:"and"}];data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){successCallback.call(this,data.object[0])}})},queryDetailProblem:function(id,successCallback){var self=this,data={m:15001001,t:"v_safety_dailycheck_detail"},filter=[{field:"id",value:id,operator:"=",relation:"and"}];data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){for(var contentData=data.object,contentList=[],problemList=[],contentMap={},itemMap={},problemMap={},i=0;i<contentData.length;i++)contentMap[contentData[i].checkContentId]={id:contentData[i].checkContentId,name:contentData[i].checkContentName,checked:!0},itemMap[contentData[i].checkItemId]={id:contentData[i].checkItemId,name:contentData[i].checkItemName,pId:contentData[i].checkContentId,checked:!0},problemMap[contentData[i].checkProblemId]={id:contentData[i].checkProblemId,name:contentData[i].checkProblemName,pId:contentData[i].checkItemId,contentId:contentData[i].checkContentId,checked:!0},problemList.push({id:contentData[i].checkProblemId,name:contentData[i].checkProblemName,pId:contentData[i].checkItemId,contentId:contentData[i].checkContentId,checked:!0});for(var key in problemMap){var problems=itemMap[problemMap[key].pId].problems;problems=problems||[],problems.push(problemMap[key]),itemMap[problemMap[key].pId].problems=problems}for(var key in itemMap){var items=contentMap[itemMap[key].pId].items;items=items||[],items.push(itemMap[key]),contentMap[itemMap[key].pId].items=items}for(var key in contentMap)contentList.push(contentMap[key]);self.setContent(contentList),successCallback.call()}})},queryDetailCheckAttach:function(id,successCallback){var data={m:15001001,t:"safety_dailycheck_attach"},filter=[{field:"id",value:id,operator:"=",relation:"and"}];data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){successCallback.call(this,data.object)}})},queryDetailRecheckAttach:function(id,successCallback){var data={m:15001001,t:"safety_dailycheck_recheck_attach"},filter=[{field:"id",value:id,operator:"=",relation:"and"}];data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){successCallback.call(this,data.object)}})},solveAndRecheckData:function(obj,m,status,successCallback){var checkData={wId:obj.wid,dataId:obj.id,opinion:"",checkerOrgId:userService.getRootOrgId()},attach={};if(void 0!=obj.imagList&&obj.imagList.length>0){attach.data=[];for(var c=0;c<obj.imagList.length;c++){var innerData=obj.imagList[c].data;attach.data.push(innerData)}}var pushUserId=-1;"复查"==status?pushUserId=obj.checkerId:"通过"!=status&&"不通过"!=status||(pushUserId=obj.solverId);var params={condition:{"状态":status},wId:obj.wid,orgId:userService.getRootOrgId(),id:obj.id,recheckDate:obj.recheckDate,recheckerId:obj.recheckerId,pushUserId:pushUserId,attach:attach},data={m:m,t:"wf_check",v:JSON.stringify([{t:"wf_check",data:checkData,ai:!0}]),params:JSON.stringify(params)};YT.insert({data:data,successCallback:function(data){200==data.status&&successCallback.call()}})},deepClone:function(obj){var o;switch(typeof obj){case"undefined":break;case"string":o=obj+"";break;case"number":o=obj-0;break;case"boolean":o=obj;break;case"object":if(null===obj)o=null;else if(obj instanceof Array){o=[];for(var i=0,len=obj.length;i<len;i++)o.push(this.deepClone(obj[i]))}else{o={};for(var k in obj)o[k]=this.deepClone(obj[k])}break;default:o=obj}return o},resetCondition:function(){condition={typeId:-1,checker:"",solver:"",checkType:-1,checkTypeName:"",problem:-1,hasProblemName:"",startTime:"",endTime:""}},getServiceData:function(){return serviceData},hasNextPage:function(){return hasNextPage},getContent:function(){return content},setContent:function(data){content=data},getCondition:function(){return condition},setStartTime:function(data){condition.startTime=data},setEndTime:function(data){condition.endTime=data},getRight:function(){return right},getUserName:function(){return userService.getUserName()},getUserId:function(){return userService.getUserId()},prefixInteger:function(num,n){for(var len=num.toString().length;len<n;)num="0"+num,len++;return num},preview:function(imgIndex,arr){$ionicActionSheet.show({buttons:[{text:"预览"}],cancelText:"关闭",cancel:function(){return!0},buttonClicked:function(){return PhotoViewer.show(arr[imgIndex].src),!0}})},getImagList:function(){return image_list},pushImagList:function(data){image_list.push(data)},setImagList:function(data){image_list=data}}}]),angular.module("app.safety.safetyData").controller("SafetyDataDetailController",["$scope","$ionicHistory","SafetyDataService","$state","$stateParams",function($scope,$ionicHistory,safetyDataService,$state,$stateParams){$scope.safetyData=$stateParams.data,$scope.download=function(attach){safetyDataService.downloadAttach({url:attach.filePath,name:attach.fileName})}}]),angular.module("app.safety.safetyData").controller("SafetyDataKindsDetailController",["$scope","$ionicHistory","SafetyDataService","$state","$stateParams","$ionicPopup",function($scope,$ionicHistory,safetyDataService,$state,$stateParams,$ionicPopup){$scope.subs=$stateParams.subs,$scope.viewDetail=function(sub){safetyDataService.getSafetyDataDetail(sub.id,function(data){data.length>0?$state.go("safety/safetyData/safetyData-detail",{data:data}):$ionicPopup.alert({template:"该分类暂无数据！"})})}}]),angular.module("app.safety.safetyData").controller("SafetyDataListController",["$scope","$ionicHistory","$cordovaToast","SafetyDataService","$state","$ionicPopup",function($scope,$ionicHistory,$cordovaToast,safetyDataService,$state,$ionicPopup){$scope.undevelop=function(){$cordovaToast.showShortBottom("暂未开发")},$scope.refreshListData=function(){safetyDataService.getTreeData(function(data){$scope.dataList=data,$scope.$broadcast("scroll.refreshComplete")})},$scope.dataList||safetyDataService.getTreeData(function(data){$scope.dataList=data}),$scope.viewDetail=function(obj){0==obj.subs.length?safetyDataService.getSafetyDataDetail(obj.id,function(data){data.length>0?$state.go("safety/safetyData/safetyData-detail",{data:data}):$ionicPopup.alert({template:"该分类暂无数据！"})}):$state.go("safety/safetyData/safetyData-kinds-detail",{subs:obj.subs})},$scope.back=function(){$ionicHistory.goBack()}}]),angular.module("app.safety.safetyData").factory("SafetyDataService",["YTService","UserService",function(YT,userService){return{listToTree:function(data,pid){for(var temp,result=[],self=this,i=0;i<data.length;i++)if(data[i].pid==pid){var obj=data[i];temp=self.listToTree(data,data[i].id),temp.length>0?obj.subs=temp:obj.subs=[],result.push(obj)}return result;
},getTreeData:function(callback){var self=this;YT.query({data:{m:15003,t:"v_safety_d_filegroup",order:"id",filter:JSON.stringify([{field:"orgId",value:userService.getRootOrgId(),operator:"=",relation:"or"},{field:"orgId",value:"null",operator:"is",relation:"or"}])},successCallback:function(data){for(var tree=[],i=0;i<data.object.length;i++)0==data.object[i].pid&&(data.object[i].subs=self.listToTree(data.object,data.object[i].id),tree.push(data.object[i]));callback(tree)}})},getSafetyDataDetail:function(groupId,callback){var filter=[{field:"groupId",value:groupId,operator:"=",relation:"and"},{field:"orgId",value:userService.getRootOrgId(),operator:"=",relation:"and"}];YT.query({data:{m:15003,t:"v_safety_safetydata",order:"uploadTime desc",filter:JSON.stringify(filter)},successCallback:function(data){for(var order=[],i=0;i<data.object.length;i++)0==i?order.push([data.object[i]]):data.object[i].uploadTime!=data.object[i-1].uploadTime?order.push([data.object[i]]):order[order.length-1].push(data.object[i]);callback(order)}})},downloadAttach:function(attach){YT.download(attach)}}}]),angular.module("app.safety.multipleCheck").controller("multipleCheckAdviceTextController",["$scope","$state","$ionicPopup","multipleCheckItemAddService","$stateParams","$ionicViewSwitcher",function($scope,$state,$ionicPopup,multipleCheckItemAddService,$stateParams,$ionicViewSwitcher){$scope.$on("$ionicView.beforeEnter",function(){$stateParams.backUrl&&($scope.backUrl=$stateParams.backUrl),$scope.detail=multipleCheckItemAddService.getDetailData()||{}}),$scope.submit=function(){multipleCheckItemAddService.setAdvice({advice:$scope.detail.advice}),$scope.back()},$scope.back=function(){$state.go($scope.backUrl,{backUrl:"safety/multipleCheck/multipleCheck-item-list"}),$ionicViewSwitcher.nextDirection("back")}}]),angular.module("app.safety.dailyCheck").controller("multipleCheckCanvasController",["$scope","$state","$stateParams","$ionicViewSwitcher","$ionicPopup","multipleCheckItemAddService","YTService","UserService","env",function($scope,$state,$stateParams,$ionicViewSwitcher,$ionicPopup,multipleCheckItemAddService,YTService,userService,env){$scope.$on("$ionicView.beforeEnter",function(){$stateParams.backUrl&&($scope.backUrl=$stateParams.backUrl),null!=$stateParams.groupIndex&&($scope.groupIndex=$stateParams.groupIndex),null!=$stateParams.index&&($scope.index=$stateParams.index),null!=$stateParams.editId&&($scope.editId=$stateParams.editId),$stateParams.image&&($scope.image=$stateParams.image||{},$scope.drawing=new Drawing({id:"canvas",src:$scope.image.src,fullScreen:!0}))}),$scope.back=function(){$state.go($scope.backUrl,{backUrl:"safety/multipleCheck/multipleCheck-item-list"}),$ionicViewSwitcher.nextDirection("back")},$scope.save=function(){$ionicPopup.confirm({title:"提示",template:'<p class="text-center">您确定要保存编辑的图片？</p>',cancelText:"取消",okText:"确定"}).then(function(res){if(res){$scope.data=$scope.drawing.getImage();var imgList=multipleCheckItemAddService.getGroupDataList()[$scope.groupIndex].attachList;YTService.uploadBase64Attach($scope.data,function(item){var ticket=userService.getTicket();item.src=item.data.url.replace("\\","/"),item.src=env.server+"download.action?rnd="+Math.random()+"&tkt="+ticket+"&fileName="+item.src,imgList[$scope.index]=item,multipleCheckItemAddService.setImagList($scope.groupIndex,imgList),$ionicPopup.alert({title:"提示",template:'<p class="text-center">保存成功!</p>'}).then(function(){$scope.back()})})}})}}]),angular.module("app.safety.multipleCheck").controller("multipleCheckCheckerListController",["$scope","$state","$ionicPopup","multipleCheckItemAddService","$stateParams","$ionicViewSwitcher",function($scope,$state,$ionicPopup,multipleCheckItemAddService,$stateParams,$ionicViewSwitcher){$scope.$on("$ionicView.beforeEnter",function(){$stateParams.backUrl&&($scope.backUrl=$stateParams.backUrl),$scope.checkerName=multipleCheckItemAddService.getDetailData().checkerName||"",$scope.checkerList=multipleCheckItemAddService.getExtraCheckerName()||[]}),$scope.addChecker=function(){$ionicPopup.prompt({title:"新增检查人",cancelText:"取消",okText:"确定"}).then(function(res){for(var flag=!1,i=0;i<$scope.checkerList.length;i++)if($scope.checkerList[i].name==res.trim()){flag=!0;break}flag||$scope.checkerList.push({name:res.trim()})})},$scope.deleteChecker=function($index){$ionicPopup.confirm({title:"提示",template:'<p class="text-center">确认删除？</p>',cancelText:"取消",okText:"确定"}).then(function(res){res&&$scope.checkerList.splice($index,1)})},$scope.submit=function(){multipleCheckItemAddService.setExtraCheckerName($scope.checkerList),$scope.back()},$scope.back=function(){$state.go($scope.backUrl,{backUrl:"safety/multipleCheck/multipleCheck-item-list"}),$ionicViewSwitcher.nextDirection("back")}}]),angular.module("app.safety.dailyCheck").controller("multipleCheckContentController",["$scope","$state","$stateParams","$ionicPopup","multipleCheckItemAddService","$ionicViewSwitcher",function($scope,$state,$stateParams,$ionicPopup,multipleCheckItemAddService,$ionicViewSwitcher){$scope.content=[],$scope.$on("$ionicView.beforeEnter",function(){$stateParams.backUrl&&($scope.backUrl=$stateParams.backUrl),null!=$stateParams.index&&($scope.index=$stateParams.index),multipleCheckItemAddService.queryCheckContent(-1,1,function(data){$scope.content=data||[],$scope.checkContent()})}),$scope.checkContent=function(){var contentList=multipleCheckItemAddService.getGroupDataList()[$scope.index].content;if(contentList=contentList||[],$scope.content.length>0)for(var j=0;j<$scope.content.length;j++){var flag=!1;if(contentList.length>0)for(var i=0;i<contentList.length;i++)$scope.content[j].id==contentList[i].id&&(flag=!0);$scope.content[j].checked=flag}},$scope.chooseContent=function(list){for(var contentList=multipleCheckItemAddService.getGroupDataList()[$scope.index].content||[],returnContent=multipleCheckItemAddService.deepClone(contentList),i=0;i<list.length;i++)if(void 0!=list[i].checked&&""!=list[i].checked&&list[i].checked){for(var flag=!1,j=0;j<contentList.length;j++)contentList[j].id==list[i].id&&(flag=!0);flag||returnContent.push(list[i])}multipleCheckItemAddService.setContent($scope.index,returnContent);for(var delIds=[],m=0;m<returnContent.length;m++){for(var delFlag=!0,n=0;n<list.length;n++)void 0!=list[n].checked&&""!=list[n].checked&&list[n].checked&&returnContent[m].id==list[n].id&&(delFlag=!1);delFlag&&delIds.push(returnContent[m].id)}if(delIds.length>0)for(var k=0;k<delIds.length;k++)multipleCheckItemAddService.removeContent($scope.index,delIds[k]);$scope.back()},$scope.back=function(){$state.go($scope.backUrl,{backUrl:"safety/multipleCheck/multipleCheck-item-list"}),$ionicViewSwitcher.nextDirection("back")}}]),angular.module("app.safety.dailyCheck").controller("multipleCheckContentItemController",["$scope","$state","$stateParams","$ionicPopup","multipleCheckItemAddService","$ionicViewSwitcher",function($scope,$state,$stateParams,$ionicPopup,multipleCheckItemAddService,$ionicViewSwitcher){$scope.$on("$ionicView.beforeEnter",function(){$stateParams.backUrl&&($scope.backUrl=$stateParams.backUrl),null!=$stateParams.index&&($scope.index=$stateParams.index),null!=$stateParams.id&&($scope.pId=$stateParams.id),multipleCheckItemAddService.queryCheckContent($scope.pId,2,function(data){$scope.items=data||[],$scope.checkItem($scope.items)})}),$scope.checkItem=function(items){var problems=multipleCheckItemAddService.getGroupProblems($scope.index)||[];if(problems.length>0)for(var j=0;j<items.length;j++){for(var flag=!1,i=0;i<problems.length;i++)items[j].id==problems[i].pId&&(flag=!0);items[j].checked=flag,flag||multipleCheckItemAddService.removeItem($scope.index,items[j].pid,items[j].id)}else for(var k=0;k<items.length;k++)items[k].checked=!1},$scope.goProblem=function(pId,id,itemBackUrl,item){for(var content=multipleCheckItemAddService.getGroupDataList()[$scope.index].content||[],j=0;j<content.length;j++)if($scope.pId==content[j].id){if(item.checked=!0,content[j].items){for(var itemss=content[j].items||[],flag=!1,i=0;i<itemss.length;i++)itemss[i].id==id&&(flag=!0);flag||content[j].items.push(item)}else{var items=[];items.push(item),content[j].items=items}multipleCheckItemAddService.setContent($scope.index,content),$state.go("safety/multipleCheck/multipleCheck-content-item-problem",{index:$scope.index,pId:pId,id:id,backUrl:itemBackUrl}),$ionicViewSwitcher.nextDirection("forward")}},$scope.back=function(){$state.go($scope.backUrl,{backUrl:"safety/multipleCheck/multipleCheck-item-list"}),$ionicViewSwitcher.nextDirection("back")}}]),angular.module("app.safety.dailyCheck").controller("multipleCheckContentItemProblemController",["$scope","$state","$stateParams","$ionicPopup","multipleCheckItemAddService","$ionicViewSwitcher",function($scope,$state,$stateParams,$ionicPopup,multipleCheckItemAddService,$ionicViewSwitcher){$scope.$on("$ionicView.beforeEnter",function(){$stateParams.backUrl&&($scope.backUrl=$stateParams.backUrl||""),null!=$stateParams.index&&($scope.index=$stateParams.index),null!=$stateParams.id&&($scope.pId=$stateParams.id),null!=$stateParams.pId&&($scope.contentId=$stateParams.pId),multipleCheckItemAddService.queryCheckContent($stateParams.id,3,function(data){$scope.problems=data||[],$scope.checkProblem($scope.problems)});var type=multipleCheckItemAddService.getType();"add"==type?$scope.url="safety/multipleCheck/multipleCheck-item-add":"edit"==type?$scope.url="safety/multipleCheck/multipleCheck-item-edit":"storage"==type&&($scope.url="safety/multipleCheck/multipleCheck-storage-edit")}),$scope.checkProblem=function(problemss){var problems=multipleCheckItemAddService.getGroupProblems($scope.index)||[];if(problems.length>0)for(var j=0;j<problemss.length;j++){for(var flag=!1,i=0;i<problems.length;i++)problemss[j].id==problems[i].id&&(flag=!0);problemss[j].checked=flag}else for(var k=0;k<problemss.length;k++)problemss[k].checked=!1},$scope.chooseItem=function(list){for(var content=multipleCheckItemAddService.getGroupDataList()[$scope.index].content||[],j=0;j<content.length;j++)if($scope.contentId==content[j].id)for(var items=content[j].items||[],k=0;k<items.length;k++)if($scope.pId==items[k].id){multipleCheckItemAddService.removeItemProblems($scope.index,items[k].id);for(var problems=[],i=0;i<list.length;i++)void 0!=list[i].checked&&""!=list[i].checked&&list[i].checked&&(problems.push(list[i]),list[i].contentId=$scope.contentId,multipleCheckItemAddService.pushProblem($scope.index,list[i]));items[k].problems=problems,multipleCheckItemAddService.setContent($scope.index,content),$scope.back()}},$scope.back=function(){$state.go($scope.backUrl,{index:$scope.index,id:$stateParams.pId,backUrl:$scope.url}),$ionicViewSwitcher.nextDirection("back")},$scope.showPrompt=function(){$ionicPopup.prompt({title:"新增问题",cancelText:"取消",okText:"确定"}).then(function(res){for(var problems=$scope.problems||[],flag=!1,index=-1,i=0;i<problems.length;i++)problems[i].name==res.trim()&&(flag=!0,index=i);if(flag)index!=-1&&($scope.problems[index].checked=!0);else{var problem={name:res.trim(),pid:$stateParams.id,level:3,orgId:multipleCheckItemAddService.getRootOrgId(),delFlag:0};multipleCheckItemAddService.insertCheckProblem(problem,function(data){problem.contentId=$scope.contentId,problem.id=data,multipleCheckItemAddService.queryCheckContent(problem.pid,3,function(data){for(var list=multipleCheckItemAddService.deepClone($scope.problems),ids=[],j=0;j<list.length;j++)void 0!=list[j].checked&&""!=list[j].checked&&list[j].checked&&ids.push(list[j].id);$scope.problems=data||[];for(var i=0;i<$scope.problems.length;i++)if($scope.problems[i].id!=problem.id){for(var m=0;m<ids.length;m++)if($scope.problems[i].id==ids[m]){$scope.problems[i].checked=!0;break}}else $scope.problems[i].checked=!0})})}})}}]),angular.module("app.safety.multipleCheck").controller("multipleCheckDetailAdviceTextController",["$scope","$state","$ionicPopup","multipleCheckItemDetailService","$stateParams","$ionicViewSwitcher",function($scope,$state,$ionicPopup,multipleCheckItemDetailService,$stateParams,$ionicViewSwitcher){$scope.$on("$ionicView.beforeEnter",function(){$stateParams.backUrl&&($scope.backUrl=$stateParams.backUrl),$scope.detail=multipleCheckItemDetailService.getDetailData()}),$scope.back=function(){$state.go($scope.backUrl,{backUrl:"safety/multipleCheck/multipleCheck-item-list"}),$ionicViewSwitcher.nextDirection("back")}}]),angular.module("app.safety.multipleCheck").controller("multipleCheckDetailProjectStatusController",["$scope","$state","$ionicPopup","multipleCheckItemDetailService","$stateParams","$ionicViewSwitcher",function($scope,$state,$ionicPopup,multipleCheckItemDetailService,$stateParams,$ionicViewSwitcher){$scope.$on("$ionicView.beforeEnter",function(){$stateParams.backUrl&&($scope.backUrl=$stateParams.backUrl),$scope.detail=multipleCheckItemDetailService.getDetailData()}),$scope.back=function(){$state.go($scope.backUrl,{backUrl:"safety/multipleCheck/multipleCheck-item-list"}),$ionicViewSwitcher.nextDirection("back")}}]),angular.module("app.safety.multipleCheck").controller("multipleCheckItemAddController",["$scope","$state","$ionicPopup","multipleCheckItemAddService","$stateParams","$ionicViewSwitcher","$ionicActionSheet","$filter","YTService","LocalStorageService",function($scope,$state,$ionicPopup,multipleCheckItemAddService,$stateParams,$ionicViewSwitcher,$ionicActionSheet,$filter,YTService,LocalStorageService){$scope.openCheckDate=function(){$scope.checkDatePopup=$ionicPopup.show({templateUrl:"check-date.html",scope:$scope,cssClass:"customTimerPopover"}),$scope.checkDatePopup.then(function(res){console.log("Tapped!",res)})},$scope.openStartDate=function(){$scope.startDatePopup=$ionicPopup.show({templateUrl:"start-date.html",scope:$scope,cssClass:"customTimerPopover"}),$scope.startDatePopup.then(function(res){console.log("Tapped!",res)})},$scope.openEndDate=function(){$scope.endDatePopup=$ionicPopup.show({templateUrl:"end-date.html",scope:$scope,cssClass:"customTimerPopover"}),$scope.endDatePopup.then(function(res){console.log("Tapped!",res)})},$scope.$on("$ionicView.beforeEnter",function(){$stateParams.backUrl&&($scope.backUrl=$stateParams.backUrl),null!=$stateParams.editId&&null!=$stateParams.projectId?($scope.editId=$stateParams.editId,$scope.projectId=$stateParams.projectId,multipleCheckItemAddService.setEditId($scope.editId),multipleCheckItemAddService.setProjectId($stateParams.projectId),multipleCheckItemAddService.queryDetailData($scope.editId,$stateParams.projectId,function(){$scope.detail=multipleCheckItemAddService.getDetailData(),$scope.detail.projectStatus="",$scope.detail.spotCount=-1,$scope.detail.advice="",$scope.initDate()}),$scope.groupList=[],multipleCheckItemAddService.setGroupList($scope.groupList)):($scope.editId=multipleCheckItemAddService.getEditId(),$scope.projectId=multipleCheckItemAddService.getProjectId(),$scope.detail=multipleCheckItemAddService.getDetailData(),$scope.groupList=multipleCheckItemAddService.getGroupDataList(),$scope.initDate()),multipleCheckItemAddService.setType("add"),multipleCheckItemAddService.queryStructureType(),$scope.url="safety/multipleCheck/multipleCheck-item-add"}),$scope.initDate=function(){$scope.checkDate=YTM.initDatePicker({date:new Date($scope.detail.checkDate),callback:function(){$scope.detail.checkDate=$filter("date")($scope.checkDate.date,"yyyy-MM-dd"),multipleCheckItemAddService.setCheckDate($scope.detail.checkDate),$scope.checkDatePopup.close()}}),$scope.startDate=YTM.initDatePicker({date:new Date($scope.detail.actualBeginDate),callback:function(){$scope.detail.actualBeginDate=$filter("date")($scope.startDate.date,"yyyy-MM-dd"),multipleCheckItemAddService.setStartDate($scope.detail.actualBeginDate),$scope.startDatePopup.close()}}),$scope.endDate=YTM.initDatePicker({date:new Date($scope.detail.plannedEndDate),callback:function(){$scope.detail.plannedEndDate=$filter("date")($scope.endDate.date,"yyyy-MM-dd"),multipleCheckItemAddService.setEndDate($scope.detail.plannedEndDate),$scope.endDatePopup.close()}})},$scope.editPersonInfo=function(){$state.go("safety/multipleCheck/multipleCheck-person-info-edit",{backUrl:$scope.url}),$ionicViewSwitcher.nextDirection("forward")},$scope.editProjectInfo=function(){$state.go("safety/multipleCheck/multipleCheck-project-info-edit",{backUrl:$scope.url}),$ionicViewSwitcher.nextDirection("forward")},$scope.editProjectStatus=function(){$state.go("safety/multipleCheck/multipleCheck-project-status",{backUrl:$scope.url}),$ionicViewSwitcher.nextDirection("forward")},$scope.editAdviceText=function(){$state.go("safety/multipleCheck/multipleCheck-advice-text",{backUrl:$scope.url}),$ionicViewSwitcher.nextDirection("forward")},$scope.toCheckerList=function(){$state.go("safety/multipleCheck/multipleCheck-checker-list",{backUrl:$scope.url}),$ionicViewSwitcher.nextDirection("forward")},$scope.toRandomInfo=function(){$state.go("safety/multipleCheck/multipleCheck-item-add-random-info",{backUrl:$scope.url}),$ionicViewSwitcher.nextDirection("forward")},$scope.openPosition=function(){$state.go("safety/multipleCheck/multipleCheck-check-position",{backUrl:$scope.url}),$ionicViewSwitcher.nextDirection("forward")},$scope.toChoose=function(index,url){$state.go(url,{index:index,backUrl:$scope.url}),$ionicViewSwitcher.nextDirection("forward")},$scope.toChooseById=function(index,id,url){$state.go(url,{index:index,id:id,backUrl:$scope.url}),$ionicViewSwitcher.nextDirection("forward")},$scope.delGroup=function(index){$ionicPopup.confirm({title:"提示",template:'<p class="text-center">确认删除？</p>',cancelText:"取消",okText:"确定"}).then(function(res){res&&(multipleCheckItemAddService.delGroupData(index),$ionicPopup.alert({title:"提示",template:'<p class="text-center">删除成功!</p>'}))})},$scope.delContent=function(groupIndex,index){$ionicPopup.confirm({title:"提示",template:'<p class="text-center">确认删除？</p>',cancelText:"取消",okText:"确定"}).then(function(res){res&&(multipleCheckItemAddService.delContent(groupIndex,index),$ionicPopup.alert({title:"提示",template:'<p class="text-center">删除成功!</p>'}))})},$scope.image_list=[],$scope.addAttachment=function(index){YTService.addAttachment($scope,function(item){$scope.groupList[index].attachList.push(item),multipleCheckItemAddService.setImagList(index,$scope.groupList[index].attachList)})},$scope.previewOrDelete=function(index,imgIndex){YTService.previewOrDelete(imgIndex,$scope.groupList[index].attachList,function(){$state.go("safety/multipleCheck/canvas",{editId:$scope.editId,image:$scope.groupList[index].attachList[imgIndex],groupIndex:index,index:imgIndex,backUrl:$scope.url}),$ionicViewSwitcher.nextDirection("forward")}),multipleCheckItemAddService.setImagList(index,$scope.groupList[index].attachList)},$scope.submit=function(){$scope.validate()&&$ionicActionSheet.show({buttons:[{text:"提交"},{text:"保存服务器"},{text:"保存本地"}],cancelText:"取消",cancel:function(){return!0},buttonClicked:function(index){var data={};if(0==index&&(data=$scope.getData(1),$scope.getPostData(data,"提交成功!")),1==index&&(data=$scope.getData(0),$scope.getPostData(data,"保存成功!")),2==index){var detailData=multipleCheckItemAddService.getDetailData()||{},spot=multipleCheckItemAddService.getSpot()||[],position=multipleCheckItemAddService.getPosition()||[],tempDetail=multipleCheckItemAddService.getTempDetail()||{},groupDataList=multipleCheckItemAddService.getGroupDataList()||[],localDataList=JSON.parse(LocalStorageService.get("multipleCheckList")),localData={detailData:detailData,spot:spot,position:position,tempDetail:tempDetail,groupDataList:groupDataList};if(void 0==localDataList){var dataList=[];localData.id=1,dataList.push(localData),localDataList=dataList}else{for(var maxId=1,k=0;k<localDataList.length;k++)localDataList[k].id>maxId&&(maxId=localDataList[k].id);localData.id=maxId+1,localDataList.push(localData)}LocalStorageService.set("multipleCheckList",JSON.stringify(localDataList)),$ionicPopup.alert({title:"验证",template:'<p class="text-center">本地存储成功!</p>'}).then(function(){multipleCheckItemAddService.clearCachedData(),$state.go($scope.backUrl,{projectId:$scope.projectId,backUrl:"safety/multipleCheck/multipleCheck-list"}),$ionicViewSwitcher.nextDirection("back")})}return!0}})},$scope.getPostData=function(data,msg){data.position.length>0?multipleCheckItemAddService.insertAddPosition(data.position,function(){$scope.getPosition(data,function(){data.historyFlag?multipleCheckItemAddService.insertHistory(data.history,function(){$scope.postData(data,msg)}):$scope.postData(data,msg)})}):$scope.getPosition(data,function(){data.historyFlag?multipleCheckItemAddService.insertHistory(data.history,function(){$scope.postData(data,msg)}):$scope.postData(data,msg)})},$scope.getPosition=function(data,callBack){multipleCheckItemAddService.queryCheckPosition(function(pList){for(var positionList=pList,i=0;i<positionList.length;i++){var group0=$scope.getNewGroupData(positionList[i].id,positionList[i].name);if(group0.length>0)for(var m=0;m<group0.length;m++)data.slave.push(group0[m])}callBack()})},$scope.postData=function(data,msg){multipleCheckItemAddService.insertCheckData(data.mainData,data.slave,function(data){200==data.status&&$ionicPopup.alert({title:"验证",template:'<p class="text-center">'+msg+"!</p>"}).then(function(){multipleCheckItemAddService.clearCachedData(),$state.go($scope.backUrl,{projectId:$scope.projectId,backUrl:"safety/multipleCheck/multipleCheck-list"}),$ionicViewSwitcher.nextDirection("back")})})},$scope.validate=function(){var flag=!0,detail=multipleCheckItemAddService.getDetailData()||{},spot=multipleCheckItemAddService.getSpot()||[],groupList=multipleCheckItemAddService.getGroupDataList()||[];if(multipleCheckItemAddService.validateDate(detail.actualBeginDate,detail.plannedEndDate))if(spot.length<=0)flag=!1,$ionicPopup.alert({title:"提示",template:"请设置抽查情况!"});else if(groupList.length>0){var contentFlag=!0,itemsFlag=!0,attachFlag=!0;outerLoop:for(var i=0;i<groupList.length;i++){var content=groupList[i].content||[];if(content.length<=0){contentFlag=!1,flag=!1;break}for(var j=0;j<content.length;j++){var items=content[j].items||[];if(items<=0){itemsFlag=!1,flag=!1;break outerLoop}}var attachList=groupList[i].attachList||[];if(attachList.length<=0){flag=!1,attachFlag=!1;break}}contentFlag||$ionicPopup.alert({title:"提示",template:"存在检查问题未添加检查内容!"}),itemsFlag||$ionicPopup.alert({title:"提示",template:"存在检查内容未添加检查项目!"}),attachFlag||$ionicPopup.alert({title:"提示",template:"存在检查问题未上传照片!"})}else flag=!1,$ionicPopup.alert({title:"提示",template:"请添加相关问题!"});else flag=!1;return flag},$scope.getData=function(statusId){var detail=multipleCheckItemAddService.getDetailData()||{},spotList=multipleCheckItemAddService.getSpot()||[],positionList=multipleCheckItemAddService.getPosition()||[],tempDetail=multipleCheckItemAddService.getTempDetail()||{},mainData={projectId:detail.projectId,checkerId:detail.checkerId,checkDate:detail.checkDate,advice:detail.advice,projectStatus:detail.projectStatus,orgId:detail.orgId,statusId:statusId,extraCheckerName:detail.extraCheckerName},checkPosition=[];if(positionList.length>0)for(var i=0;i<positionList.length;i++)positionList[i].addFlag&&checkPosition.push({t:"safety_d_checkposition",data:{name:positionList[i].name,orgId:multipleCheckItemAddService.getRootOrgId()},ai:!0});var history={},historyFlag=!1;$scope.checkDetail(detail,tempDetail)&&(historyFlag=!0,history={projectName:detail.projectName,manager:detail.manager,managerTel:detail.managerTel,technician:detail.technician,technicianTel:detail.technicianTel,inspector:detail.inspector,inspectorTel:detail.inspectorTel,safetyOfficer:detail.safetyOfficer,safetyOfficerTel:detail.safetyOfficerTel,cost:detail.cost,groundLayer:detail.groundLayer,underGroundLayer:detail.underGroundLayer,areaOfStructure:detail.areaOfStructure,structureTypeId:detail.structureTypeId,personNumber:detail.personNumber,actualBeginDate:detail.actualBeginDate,plannedEndDate:detail.plannedEndDate,orgId:detail.projectId,companyId:detail.orgId});var slave=[];if(spotList.length>0)for(var j=0;j<spotList.length;j++)slave.push({t:"safety_multiplecheck_spot",data:{spotContentId:spotList[j].id==-1?0:spotList[j].id,spotCheckId:spotList[j].spotCheckId==-1?0:spotList[j].spotCheckId},key:"id"});return{mainData:mainData,position:checkPosition,historyFlag:historyFlag,history:history,slave:slave}},$scope.getNewGroupData=function(positionId,positionName){var groupList=multipleCheckItemAddService.getGroupDataList()||[],group=[];if(groupList.length>0)for(var i=0;i<groupList.length;i++)if(groupList[i].checkPosName==positionName){var slave=[];if(groupList[i].attachList.length>0)for(var j=0;j<groupList[i].attachList.length;j++)slave.push({t:"safety_multiplecheck_checkgroup_attach",data:{name:groupList[i].attachList[j].data.name,url:groupList[i].attachList[j].data.url},key:"id"});if(groupList[i].problems.length>0)for(var k=0;k<groupList[i].problems.length;k++)slave.push({t:"safety_multiplecheck_checkgroup_detail",data:{checkContentId:groupList[i].problems[k].contentId,checkItemId:groupList[i].problems[k].pId,checkProblemId:groupList[i].problems[k].id},key:"id"});group.push({t:"safety_multiplecheck_checkgroup",data:{checkPosId:positionId},key:"id",slave:slave,ai:!0});break}return group},$scope.checkDetail=function(detail,tempDetail){var historyFlag=!1;return detail.projectName!=tempDetail.projectName&&(historyFlag=!0),detail.manager!=tempDetail.manager&&(historyFlag=!0),detail.managerTel!=tempDetail.managerTel&&(historyFlag=!0),detail.technician!=tempDetail.technician&&(historyFlag=!0),detail.technicianTel!=tempDetail.technicianTel&&(historyFlag=!0),detail.inspector!=tempDetail.inspector&&(historyFlag=!0),detail.inspectorTel!=tempDetail.inspectorTel&&(historyFlag=!0),detail.safetyOfficer!=tempDetail.safetyOfficer&&(historyFlag=!0),detail.safetyOfficerTel!=tempDetail.safetyOfficerTel&&(historyFlag=!0),detail.cost!=tempDetail.cost&&(historyFlag=!0),detail.groundLayer!=tempDetail.groundLayer&&(historyFlag=!0),detail.underGroundLayer!=tempDetail.underGroundLayer&&(historyFlag=!0),detail.areaOfStructure!=tempDetail.areaOfStructure&&(historyFlag=!0),detail.structureTypeId!=tempDetail.structureTypeId&&(historyFlag=!0),detail.personNumber!=tempDetail.personNumber&&(historyFlag=!0),detail.actualBeginDate!=tempDetail.actualBeginDate&&(historyFlag=!0),detail.plannedEndDate!=tempDetail.plannedEndDate&&(historyFlag=!0),detail.orgId!=tempDetail.orgId&&(historyFlag=!0),detail.projectId!=tempDetail.projectId&&(historyFlag=!0),historyFlag},$scope.back=function(){$ionicPopup.confirm({title:"提示",template:'<p class="text-center">您确定要退出新增页面？</p>',cancelText:"取消",okText:"确定"}).then(function(res){res&&(multipleCheckItemAddService.clearCachedData(),$state.go($scope.backUrl,{projectId:$scope.projectId,backUrl:"safety/multipleCheck/multipleCheck-list"}),$ionicViewSwitcher.nextDirection("back"))})}}]),angular.module("app.safety.multipleCheck").controller("multipleCheckItemAddRandomInfoController",["$scope","$state","$ionicPopup","multipleCheckItemAddService","$stateParams","$ionicViewSwitcher","$ionicActionSheet",function($scope,$state,$ionicPopup,multipleCheckItemAddService,$stateParams,$ionicViewSwitcher,$ionicActionSheet){$scope.$on("$ionicView.beforeEnter",function(){$stateParams.backUrl&&($scope.backUrl=$stateParams.backUrl);var spotContentList=multipleCheckItemAddService.getSpot()||[];spotContentList.length<=0?("add"==multipleCheckItemAddService.getType()&&multipleCheckItemAddService.querySpotContent(function(data){$scope.spotContentList=data}),"edit"==multipleCheckItemAddService.getType()&&($scope.spotContentList=multipleCheckItemAddService.getSpot())):$scope.spotContentList=spotContentList,multipleCheckItemAddService.querySpotCheck(function(data){$scope.spotCheckList=data||[]})}),$scope.openCheckType=function($index){for(var btns=[],i=0;i<$scope.spotCheckList.length;i++)btns.push({text:$scope.spotCheckList[i].name});$ionicActionSheet.show({buttons:btns,cancelText:"取消",cancel:function(){return!0},buttonClicked:function(index){return $scope.spotContentList[$index].spotCheckId=$scope.spotCheckList[index].id,$scope.spotContentList[$index].spotCheckName=$scope.spotCheckList[index].name,!0}})},$scope.submit=function(){$scope.validate()&&(multipleCheckItemAddService.setSpot($scope.spotContentList),$scope.back())},$scope.validate=function(){for(var content=$scope.spotContentList||[],flag=!0,count=0,i=0;i<content.length;i++)content[i].rowspan>0&&(content[i].spotCheckId==-1?flag=!1:"无"!=content[i].spotCheckName&&"不齐全"!=content[i].spotCheckName||count++);return flag||$ionicPopup.alert({title:"提示",template:"请选择完整抽查情况!"}),flag&&multipleCheckItemAddService.setSpotCount(count),flag},$scope.back=function(){$state.go($scope.backUrl,{backUrl:"safety/multipleCheck/multipleCheck-item-list"}),$ionicViewSwitcher.nextDirection("back")}}]),angular.module("app.safety.multipleCheck").controller("multipleCheckItemDetailController",["$scope","$state","$ionicPopup","multipleCheckItemDetailService","$stateParams","$ionicViewSwitcher","$ionicActionSheet",function($scope,$state,$ionicPopup,multipleCheckItemDetailService,$stateParams,$ionicViewSwitcher,$ionicActionSheet){$scope.$on("$ionicView.beforeEnter",function(){$stateParams.backUrl&&($scope.backUrl=$stateParams.backUrl),null!=$stateParams.id?(multipleCheckItemDetailService.queryDetailData($stateParams.id,function(){$scope.detail=multipleCheckItemDetailService.getDetailData()||{}}),multipleCheckItemDetailService.queryDetailGroupData($stateParams.id,function(){$scope.groupList=multipleCheckItemDetailService.getGroupDataList()||[]})):($scope.detail=multipleCheckItemDetailService.getDetailData()||{},$scope.groupList=multipleCheckItemDetailService.getGroupDataList()||[])}),$scope.preview=function(imgIndex,arr){$ionicActionSheet.show({buttons:[{text:"预览"}],cancelText:"关闭",cancel:function(){return!0},buttonClicked:function(){return PhotoViewer.show(arr[imgIndex].src),!0}})},$scope.toProjectStatus=function(){$state.go("safety/multipleCheck/multipleCheck-detail-project-status",{backUrl:"safety/multipleCheck/multipleCheck-item-detail"}),$ionicViewSwitcher.nextDirection("forward")},$scope.toAdviceText=function(){$state.go("safety/multipleCheck/multipleCheck-detail-advice-text",{backUrl:"safety/multipleCheck/multipleCheck-item-detail"}),$ionicViewSwitcher.nextDirection("forward")},$scope.toRandomInfo=function(id,backUrl){$state.go("safety/multipleCheck/multipleCheck-item-detail-random-info",{id:id,backUrl:backUrl}),$ionicViewSwitcher.nextDirection("forward")},$scope.back=function(){multipleCheckItemDetailService.clearCachedData(),$state.go($scope.backUrl,{projectId:$scope.detail.projectId,backUrl:"safety/multipleCheck/multipleCheck-list"}),$ionicViewSwitcher.nextDirection("back")}}]),angular.module("app.safety.multipleCheck").controller("multipleCheckItemDetailRandomInfoController",["$scope","$state","$ionicPopup","multipleCheckItemDetailRandomInfoService","$stateParams","$ionicViewSwitcher",function($scope,$state,$ionicPopup,multipleCheckItemDetailRandomInfoService,$stateParams,$ionicViewSwitcher){$scope.$on("$ionicView.beforeEnter",function(){$stateParams.backUrl&&($scope.backUrl=$stateParams.backUrl),null!=$stateParams.id&&multipleCheckItemDetailRandomInfoService.queryInfoData($stateParams.id,function(){$scope.info=multipleCheckItemDetailRandomInfoService.getServiceData()||[]})}),$scope.back=function(){multipleCheckItemDetailRandomInfoService.clearCachedData(),$state.go($scope.backUrl,{backUrl:"safety/multipleCheck/multipleCheck-item-list"}),$ionicViewSwitcher.nextDirection("back")}}]),angular.module("app.safety.multipleCheck").controller("multipleCheckItemEditController",["$scope","$state","$ionicPopup","multipleCheckItemAddService","$stateParams","$ionicViewSwitcher","$ionicActionSheet","$filter","YTService",function($scope,$state,$ionicPopup,multipleCheckItemAddService,$stateParams,$ionicViewSwitcher,$ionicActionSheet,$filter,YTService){$scope.openCheckDate=function(){$scope.checkDatePopup=$ionicPopup.show({templateUrl:"check-date.html",scope:$scope,cssClass:"customTimerPopover"}),$scope.checkDatePopup.then(function(res){console.log("Tapped!",res);
})},$scope.openStartDate=function(){$scope.startDatePopup=$ionicPopup.show({templateUrl:"start-date.html",scope:$scope,cssClass:"customTimerPopover"}),$scope.startDatePopup.then(function(res){console.log("Tapped!",res)})},$scope.openEndDate=function(){$scope.endDatePopup=$ionicPopup.show({templateUrl:"end-date.html",scope:$scope,cssClass:"customTimerPopover"}),$scope.endDatePopup.then(function(res){console.log("Tapped!",res)})},$scope.$on("$ionicView.beforeEnter",function(){$stateParams.backUrl&&($scope.backUrl=$stateParams.backUrl),null!=$stateParams.id?($scope.editId=$stateParams.id,multipleCheckItemAddService.setEditId($scope.editId),multipleCheckItemAddService.queryEditDetailData($scope.editId,function(){$scope.detail=multipleCheckItemAddService.getDetailData(),$scope.projectId=$scope.detail.projectId,multipleCheckItemAddService.setProjectId($scope.projectId),$scope.initDate()}),multipleCheckItemAddService.queryGroupData($scope.editId,function(){$scope.groupList=multipleCheckItemAddService.getGroupDataList()}),multipleCheckItemAddService.queryEditSpotData($scope.editId)):($scope.editId=multipleCheckItemAddService.getEditId(),$scope.projectId=multipleCheckItemAddService.getProjectId(),$scope.detail=multipleCheckItemAddService.getDetailData(),$scope.groupList=multipleCheckItemAddService.getGroupDataList(),$scope.initDate()),multipleCheckItemAddService.setType("edit"),multipleCheckItemAddService.queryStructureType(),$scope.url="safety/multipleCheck/multipleCheck-item-edit"}),$scope.initDate=function(){$scope.checkDate=YTM.initDatePicker({date:new Date($scope.detail.checkDate),callback:function(){$scope.detail.checkDate=$filter("date")($scope.checkDate.date,"yyyy-MM-dd"),multipleCheckItemAddService.setCheckDate($scope.detail.checkDate),$scope.checkDatePopup.close()}}),$scope.startDate=YTM.initDatePicker({date:new Date($scope.detail.actualBeginDate),callback:function(){$scope.detail.actualBeginDate=$filter("date")($scope.startDate.date,"yyyy-MM-dd"),multipleCheckItemAddService.setStartDate($scope.detail.actualBeginDate),$scope.startDatePopup.close()}}),$scope.endDate=YTM.initDatePicker({date:new Date($scope.detail.plannedEndDate),callback:function(){$scope.detail.plannedEndDate=$filter("date")($scope.endDate.date,"yyyy-MM-dd"),multipleCheckItemAddService.setEndDate($scope.detail.plannedEndDate),$scope.endDatePopup.close()}})},$scope.editPersonInfo=function(){$state.go("safety/multipleCheck/multipleCheck-person-info-edit",{backUrl:$scope.url}),$ionicViewSwitcher.nextDirection("forward")},$scope.editProjectInfo=function(){$state.go("safety/multipleCheck/multipleCheck-project-info-edit",{backUrl:$scope.url}),$ionicViewSwitcher.nextDirection("forward")},$scope.editProjectStatus=function(){$state.go("safety/multipleCheck/multipleCheck-project-status",{backUrl:$scope.url}),$ionicViewSwitcher.nextDirection("forward")},$scope.editAdviceText=function(){$state.go("safety/multipleCheck/multipleCheck-advice-text",{backUrl:$scope.url}),$ionicViewSwitcher.nextDirection("forward")},$scope.toCheckerList=function(){$state.go("safety/multipleCheck/multipleCheck-checker-list",{backUrl:$scope.url}),$ionicViewSwitcher.nextDirection("forward")},$scope.toRandomInfo=function(){$state.go("safety/multipleCheck/multipleCheck-item-add-random-info",{backUrl:$scope.url}),$ionicViewSwitcher.nextDirection("forward")},$scope.openPosition=function(){$state.go("safety/multipleCheck/multipleCheck-check-position",{backUrl:$scope.url}),$ionicViewSwitcher.nextDirection("forward")},$scope.toChoose=function(index,url){$state.go(url,{index:index,backUrl:$scope.url}),$ionicViewSwitcher.nextDirection("forward")},$scope.toChooseById=function(index,id,url){$state.go(url,{index:index,id:id,backUrl:$scope.url}),$ionicViewSwitcher.nextDirection("forward")},$scope.delGroup=function(index){$ionicPopup.confirm({title:"提示",template:'<p class="text-center">确认删除？</p>',cancelText:"取消",okText:"确定"}).then(function(res){res&&(multipleCheckItemAddService.delGroupData(index),$ionicPopup.alert({title:"提示",template:'<p class="text-center">删除成功!</p>'}))})},$scope.delContent=function(groupIndex,index){$ionicPopup.confirm({title:"提示",template:'<p class="text-center">确认删除？</p>',cancelText:"取消",okText:"确定"}).then(function(res){res&&(multipleCheckItemAddService.delContent(groupIndex,index),$ionicPopup.alert({title:"提示",template:'<p class="text-center">删除成功!</p>'}))})},$scope.image_list=[],$scope.addAttachment=function(index){YTService.addAttachment($scope,function(item){$scope.groupList[index].attachList.push(item),multipleCheckItemAddService.setImagList(index,$scope.groupList[index].attachList)})},$scope.previewOrDelete=function(index,imgIndex){YTService.previewOrDelete(imgIndex,$scope.groupList[index].attachList,function(){$state.go("safety/multipleCheck/canvas",{editId:$scope.editId,image:$scope.groupList[index].attachList[imgIndex],groupIndex:index,index:imgIndex,backUrl:$scope.url}),$ionicViewSwitcher.nextDirection("forward")}),multipleCheckItemAddService.setImagList(index,$scope.groupList[index].attachList)},$scope.submit=function(){$scope.validate()&&$ionicActionSheet.show({buttons:[{text:"提交"},{text:"保存"}],cancelText:"取消",cancel:function(){return!0},buttonClicked:function(index){var data={};return 0==index&&(data=$scope.getData(1),$scope.getPostData(data,"提交成功!")),1==index&&(data=$scope.getData(0),$scope.getPostData(data,"保存成功!")),!0}})},$scope.getPostData=function(data,msg){data.position.length>0?multipleCheckItemAddService.insertAddPosition(data.position,function(){$scope.getPosition(data,function(){$scope.postData(data,msg)})}):$scope.getPosition(data,function(){$scope.postData(data,msg)})},$scope.getPosition=function(data,callBack){data.group=[],multipleCheckItemAddService.queryCheckPosition(function(pList){for(var positionList=pList,i=0;i<positionList.length;i++){var group0=$scope.getNewGroupData(positionList[i].id,positionList[i].name);if(group0.length>0)for(var m=0;m<group0.length;m++)data.group.push(group0[m])}callBack()})},$scope.postData=function(data,msg){var postData=$scope.changData(data);multipleCheckItemAddService.updateCheckData(postData,function(data){200==data.status&&$ionicPopup.alert({title:"验证",template:'<p class="text-center">'+msg+"!</p>"}).then(function(){$scope.back()})})},$scope.changData=function(data){for(var group=data.group||[],params={id:data.detail.id,orgId:data.detail.orgId,posData:[],prjBase:data.history||{}},i=0;i<group.length;i++)params.posData.push({t:"safety_multiplecheck_checkgroup",data:{id:data.detail.id,checkPosId:group[i].data.checkPosId},ai:!0,slave:group[i].slave,problems:[]});return data.historyFlag||(params.prjBase=null),{mainData:data.mainData,slave:data.slave,params:params}},$scope.validate=function(){var flag=!0,detail=multipleCheckItemAddService.getDetailData()||{},spot=multipleCheckItemAddService.getSpot()||[],groupList=multipleCheckItemAddService.getGroupDataList()||[];if(multipleCheckItemAddService.validateDate(detail.actualBeginDate,detail.plannedEndDate))if(spot.length<=0)flag=!1,$ionicPopup.alert({title:"提示",template:"请设置抽查情况!"});else if(groupList.length>0){var contentFlag=!0,itemsFlag=!0,attachFlag=!0;outerLoop:for(var i=0;i<groupList.length;i++){var content=groupList[i].content||[];if(content.length<=0){contentFlag=!1,flag=!1;break}for(var j=0;j<content.length;j++){var items=content[j].items||[];if(items<=0){itemsFlag=!1,flag=!1;break outerLoop}}var attachList=groupList[i].attachList||[];if(attachList.length<=0){flag=!1,attachFlag=!1;break}}contentFlag||$ionicPopup.alert({title:"提示",template:"存在检查问题未添加检查内容!"}),itemsFlag||$ionicPopup.alert({title:"提示",template:"存在检查内容未添加检查项目!"}),attachFlag||$ionicPopup.alert({title:"提示",template:"存在检查问题未上传照片!"})}else flag=!1,$ionicPopup.alert({title:"提示",template:"请添加相关问题!"});else flag=!1;return flag},$scope.getData=function(statusId){var detail=multipleCheckItemAddService.getDetailData()||{},spotList=multipleCheckItemAddService.getSpot()||[],positionList=multipleCheckItemAddService.getPosition()||[],tempDetail=multipleCheckItemAddService.getTempDetail()||{},mainData={id:detail.id,checkerId:detail.checkerId,checkDate:detail.checkDate,advice:detail.advice,projectStatus:detail.projectStatus,statusId:statusId,extraCheckerName:detail.extraCheckerName},checkPosition=[];if(positionList.length>0)for(var i=0;i<positionList.length;i++)positionList[i].addFlag&&checkPosition.push({t:"safety_d_checkposition",data:{name:positionList[i].name,orgId:multipleCheckItemAddService.getRootOrgId()},ai:!0});var history={},historyFlag=!1;$scope.checkDetail(detail,tempDetail)&&(historyFlag=!0,history={projectName:detail.projectName,manager:detail.manager,managerTel:detail.managerTel,technician:detail.technician,technicianTel:detail.technicianTel,inspector:detail.inspector,inspectorTel:detail.inspectorTel,safetyOfficer:detail.safetyOfficer,safetyOfficerTel:detail.safetyOfficerTel,cost:detail.cost,groundLayer:detail.groundLayer,underGroundLayer:detail.underGroundLayer,areaOfStructure:detail.areaOfStructure,structureTypeId:detail.structureTypeId,personNumber:detail.personNumber,actualBeginDate:detail.actualBeginDate,plannedEndDate:detail.plannedEndDate,orgId:detail.projectId,companyId:detail.orgId});var slave=[];if(spotList.length>0)for(var j=0;j<spotList.length;j++)slave.push({t:"safety_multiplecheck_spot",data:{id:detail.id,spotContentId:spotList[j].id==-1?0:spotList[j].id,spotCheckId:spotList[j].spotCheckId==-1?0:spotList[j].spotCheckId},key:"id"});return{detail:detail,mainData:mainData,position:checkPosition,historyFlag:historyFlag,history:history,slave:slave}},$scope.getNewGroupData=function(positionId,positionName){var groupList=multipleCheckItemAddService.getGroupDataList()||[],group=[];if(groupList.length>0)for(var i=0;i<groupList.length;i++)if(groupList[i].checkPosName==positionName){var slave=[];if(groupList[i].attachList.length>0)for(var j=0;j<groupList[i].attachList.length;j++)slave.push({t:"safety_multiplecheck_checkgroup_attach",data:{name:groupList[i].attachList[j].data.name,url:groupList[i].attachList[j].data.url},key:"id"});if(groupList[i].problems.length>0)for(var k=0;k<groupList[i].problems.length;k++)slave.push({t:"safety_multiplecheck_checkgroup_detail",data:{checkContentId:groupList[i].problems[k].contentId,checkItemId:groupList[i].problems[k].pId,checkProblemId:groupList[i].problems[k].id},key:"id"});group.push({t:"safety_multiplecheck_checkgroup",data:{checkPosId:positionId},key:"id",slave:slave,ai:!0});break}return group},$scope.checkDetail=function(detail,tempDetail){var historyFlag=!1;return detail.projectName!=tempDetail.projectName&&(historyFlag=!0),detail.manager!=tempDetail.manager&&(historyFlag=!0),detail.managerTel!=tempDetail.managerTel&&(historyFlag=!0),detail.technician!=tempDetail.technician&&(historyFlag=!0),detail.technicianTel!=tempDetail.technicianTel&&(historyFlag=!0),detail.inspector!=tempDetail.inspector&&(historyFlag=!0),detail.inspectorTel!=tempDetail.inspectorTel&&(historyFlag=!0),detail.safetyOfficer!=tempDetail.safetyOfficer&&(historyFlag=!0),detail.safetyOfficerTel!=tempDetail.safetyOfficerTel&&(historyFlag=!0),detail.cost!=tempDetail.cost&&(historyFlag=!0),detail.groundLayer!=tempDetail.groundLayer&&(historyFlag=!0),detail.underGroundLayer!=tempDetail.underGroundLayer&&(historyFlag=!0),detail.areaOfStructure!=tempDetail.areaOfStructure&&(historyFlag=!0),detail.structureTypeId!=tempDetail.structureTypeId&&(historyFlag=!0),detail.personNumber!=tempDetail.personNumber&&(historyFlag=!0),detail.actualBeginDate!=tempDetail.actualBeginDate&&(historyFlag=!0),detail.plannedEndDate!=tempDetail.plannedEndDate&&(historyFlag=!0),detail.orgId!=tempDetail.orgId&&(historyFlag=!0),detail.projectId!=tempDetail.projectId&&(historyFlag=!0),historyFlag},$scope.back=function(){multipleCheckItemAddService.clearCachedData(),$state.go($scope.backUrl,{projectId:$scope.projectId,backUrl:"safety/multipleCheck/multipleCheck-list"}),$ionicViewSwitcher.nextDirection("back")}}]),angular.module("app.safety.multipleCheck").controller("multipleCheckItemListController",["$scope","$state","$ionicPopup","multipleCheckItemListService","$ionicHistory","$stateParams","$ionicViewSwitcher",function($scope,$state,$ionicPopup,multipleCheckItemListService,$ionicHistory,$stateParams,$ionicViewSwitcher){$scope.$on("$ionicView.beforeEnter",function(){$stateParams.backUrl&&($scope.backUrl=$stateParams.backUrl),$stateParams.editId&&($scope.editId=$stateParams.editId,multipleCheckItemListService.setEditId($scope.editId)),null!=$stateParams.projectId&&($scope.projectId=$stateParams.projectId,multipleCheckItemListService.setProjectId($scope.projectId)),$scope.editId=multipleCheckItemListService.getEditId(),$scope.projectId=multipleCheckItemListService.getProjectId(),$scope.refreshListData($scope.projectId,$scope.editId);var localDataList=multipleCheckItemListService.getStorageList($scope.projectId)||[];$scope.localDataLength=localDataList.length}),$scope.loadListData=function(){multipleCheckItemListService.loadListData($scope.projectId,function(){$scope.fillData(),$scope.$broadcast("scroll.infiniteScrollComplete")})},$scope.fillData=function(){$scope.itemList=multipleCheckItemListService.getServiceData(),$scope.hasNextPage=multipleCheckItemListService.hasNextPage(),$scope.right=multipleCheckItemListService.getRight()},$scope.refreshListData=function(){multipleCheckItemListService.refreshListData($scope.projectId,function(){$scope.fillData(),$scope.$broadcast("scroll.refreshComplete")})},$scope.toItemDetail=function(id,statusId,backUrl){multipleCheckItemListService.clearCachedData(),0==statusId?($state.go("safety/multipleCheck/multipleCheck-item-edit",{id:id,backUrl:backUrl}),$ionicViewSwitcher.nextDirection("forward")):1==statusId&&($state.go("safety/multipleCheck/multipleCheck-item-detail",{id:id,backUrl:backUrl}),$ionicViewSwitcher.nextDirection("forward"))},$scope.toAdd=function(backUrl){multipleCheckItemListService.clearCachedData(),$state.go("safety/multipleCheck/multipleCheck-item-add",{projectId:$scope.projectId,backUrl:backUrl,editId:multipleCheckItemListService.getEditId()}),$ionicViewSwitcher.nextDirection("forward")},$scope.toStorage=function(backUrl){multipleCheckItemListService.clearCachedData(),$state.go("safety/multipleCheck/multipleCheck-storage-list",{projectId:$scope.projectId,backUrl:backUrl}),$ionicViewSwitcher.nextDirection("forward")},$scope.back=function(){multipleCheckItemListService.clearCachedData(),$state.go($scope.backUrl),$ionicViewSwitcher.nextDirection("back")}}]),angular.module("app.safety.multipleCheck").controller("multipleCheckListController",["$scope","$state","$ionicPopup","multipleCheckListService","$ionicHistory","$ionicViewSwitcher","UserService","$ionicModal","$ionicScrollDelegate",function($scope,$state,$ionicPopup,multipleCheckListService,$ionicHistory,$ionicViewSwitcher,userService,$ionicModal,$ionicScrollDelegate){$scope.$on("$ionicView.beforeEnter",function(){$scope.refreshListData()}),$scope.condition=multipleCheckListService.getCondition(),$scope.searchData=function(){$scope.modalQueryType.hide(),multipleCheckListService.clearCachedData(),$ionicScrollDelegate.scrollTop(),$scope.modalQueryMore.hide(),$scope.loadListData()},$scope.clearSearch=function(){multipleCheckListService.resetCondition(),$scope.condition=multipleCheckListService.getCondition()},$scope.isqueryType=!1,$scope.isqueryMore=!1,$scope.isTypeOne=!1,$ionicModal.fromTemplateUrl("query-more.html",{scope:$scope,animation:"slide-in-up"}).then(function(modal){$scope.modalQueryMore=modal}),$ionicModal.fromTemplateUrl("query-type.html",{scope:$scope,animation:"slide-in-up"}).then(function(modal){$scope.modalQueryType=modal}),$scope.openQueryType=function(){$scope.modalQueryType.show(),$scope.isqueryType=!$scope.isqueryType,$scope.isqueryMore=!1},$scope.openQueryMore=function(){$scope.modalQueryMore.show(),$scope.isqueryMore=!$scope.isqueryMore,$scope.isqueryType=!1},$scope.closeQuery=function(){$scope.isqueryType=!1,$scope.isqueryMore=!1},$scope.openType=function(){$scope.isTypeOne=!0},$scope.closeType=function(name){$scope.isTypeOne=!1,$scope.condition.statusName=name},$scope.fillData=function(){$scope.hasNextPage=multipleCheckListService.hasNextPage(),$scope.projectList=multipleCheckListService.getServiceData(),$scope.companyList=multipleCheckListService.getCompanyList(),$scope.typeId=userService.getTypeId(),$scope.searchText=""},$scope.loadListData=function(){multipleCheckListService.loadListData(function(){$scope.fillData(),$scope.$broadcast("scroll.infiniteScrollComplete")})},$scope.refreshListData=function(){multipleCheckListService.refreshListData(function(){$scope.fillData(),$scope.$broadcast("scroll.refreshComplete")})},$scope.back=function(){multipleCheckListService.clearCachedData(),multipleCheckListService.resetCondition(),$state.go("menu"),$ionicViewSwitcher.nextDirection("back")},$scope.toItemList=function(projectId,backUrl,editId){multipleCheckListService.clearCachedData(),multipleCheckListService.resetCondition(),$state.go("safety/multipleCheck/multipleCheck-item-list",{projectId:projectId,backUrl:backUrl,editId:editId}),$ionicViewSwitcher.nextDirection("forward")},$scope.searchFilter=function(project){return null==$scope.searchText||""==$scope.searchText||project.projectName.indexOf($scope.searchText)!=-1},$scope.clearSearchText=function(){$scope.searchText=""}}]),angular.module("app.safety.multipleCheck").controller("multipleCheckPersonInfoEditController",["$scope","$state","$ionicPopup","multipleCheckItemAddService","$stateParams","$ionicViewSwitcher",function($scope,$state,$ionicPopup,multipleCheckItemAddService,$stateParams,$ionicViewSwitcher){$scope.$on("$ionicView.beforeEnter",function(){$stateParams.backUrl&&($scope.backUrl=$stateParams.backUrl),$scope.detail=multipleCheckItemAddService.getDetailData()}),$scope.submit=function(){$scope.validateTel()&&(multipleCheckItemAddService.setPersonInfo($scope.detail),$scope.back())},$scope.validateTel=function(){if(""==$scope.detail.manager||null==$scope.detail.manager)return $ionicPopup.alert({title:"提示",template:"请输入项目经理姓名!"}),!1;if(""==$scope.detail.technician||null==$scope.detail.technician)return $ionicPopup.alert({title:"提示",template:"请输入技术负责人姓名!"}),!1;if(""==$scope.detail.inspector||null==$scope.detail.inspector)return $ionicPopup.alert({title:"提示",template:"请输入质检员姓名!"}),!1;if(""==$scope.detail.safetyOfficer||null==$scope.detail.safetyOfficer)return $ionicPopup.alert({title:"提示",template:"请输入安全员姓名!"}),!1;var re=/^1\d{10}$/;return void 0==$scope.detail.managerTel||null==$scope.detail.managerTel||""==$scope.detail.managerTel||re.test($scope.detail.managerTel)?void 0==$scope.detail.technicianTel||null==$scope.detail.technicianTel||""==$scope.detail.technicianTel||re.test($scope.detail.technicianTel)?void 0==$scope.detail.inspectorTel||null==$scope.detail.inspectorTel||""==$scope.detail.inspectorTel||re.test($scope.detail.inspectorTel)?!(void 0!=$scope.detail.safetyOfficerTel&&null!=$scope.detail.safetyOfficerTel&&""!=$scope.detail.safetyOfficerTel&&!re.test($scope.detail.safetyOfficerTel))||($ionicPopup.alert({title:"提示",template:"安全员手机号不正确,请输入正确的手机号!"}),!1):($ionicPopup.alert({title:"提示",template:"质检员手机号不正确,请输入正确的手机号!"}),!1):($ionicPopup.alert({title:"提示",template:"技术负责人手机号不正确,请输入正确的手机号!"}),!1):($ionicPopup.alert({title:"提示",template:"项目经理手机号不正确,请输入正确的手机号!"}),!1)},$scope.back=function(){$state.go($scope.backUrl,{backUrl:"safety/multipleCheck/multipleCheck-item-list"}),$ionicViewSwitcher.nextDirection("back")}}]),angular.module("app.safety.multipleCheck").controller("multipleCheckPositionController",["$scope","$state","$ionicPopup","multipleCheckItemAddService","$stateParams","$ionicViewSwitcher",function($scope,$state,$ionicPopup,multipleCheckItemAddService,$stateParams,$ionicViewSwitcher){$scope.$on("$ionicView.beforeEnter",function(){$stateParams.backUrl&&($scope.backUrl=$stateParams.backUrl);var positionList=multipleCheckItemAddService.getPositionList()||[];positionList.length<=0?multipleCheckItemAddService.queryCheckPosition(function(data){$scope.positionList=data||[]}):$scope.positionList=positionList,$scope.addPositionList=multipleCheckItemAddService.getAddPositionList()||[],$scope.groupList=multipleCheckItemAddService.getGroupDataList()||[],$scope.position={name:""}}),$scope.showPrompt=function(){$ionicPopup.prompt({title:"新增位置",cancelText:"取消",okText:"确定"}).then(function(res){""!=res&&void 0!=res&&res&&($scope.checkName(res.trim())||$scope.addPositionList.push({id:-1,name:res.trim()}))})},$scope.checkName=function(name){var flag=!1,id=-4,positionName="";$scope.positionList=$scope.positionList||[];for(var i=0;i<$scope.positionList.length;i++)if($scope.positionList[i].name==name){id=$scope.positionList[i].id,positionName=$scope.positionList[i].name,flag=!0;break}if($scope.addPositionList=$scope.addPositionList||[],!flag&&$scope.addPositionList.length>0)for(var j=0;j<$scope.addPositionList.length;j++)if($scope.addPositionList[j].name==name){id=-1,positionName=$scope.addPositionList[j].name,flag=!0;break}return $scope.position={id:id,name:positionName},flag},$scope.choosePosition=function(obj){for(var position=multipleCheckItemAddService.getPosition()||[],flag=!1,i=0;i<position.length;i++)if(position[i].name==obj.name){flag=!0;break}flag?$ionicPopup.alert({title:"提示",template:"该位置已存在!"}):(obj.addFlag=!1,void 0!=obj.id&&""!=obj.id&&obj.id!=-1||(obj.addFlag=!0,obj.id=-1),multipleCheckItemAddService.pushPosition(obj),multipleCheckItemAddService.pushGroupData(obj),$scope.back())},$scope.back=function(){$state.go($scope.backUrl,{backUrl:"safety/multipleCheck/multipleCheck-item-list"}),$ionicViewSwitcher.nextDirection("back")}}]),angular.module("app.safety.multipleCheck").controller("multipleCheckProjectInfoEditController",["$scope","$state","$ionicPopup","multipleCheckItemAddService","$stateParams","$ionicViewSwitcher",function($scope,$state,$ionicPopup,multipleCheckItemAddService,$stateParams,$ionicViewSwitcher){$scope.$on("$ionicView.beforeEnter",function(){$stateParams.backUrl&&($scope.backUrl=$stateParams.backUrl),$scope.detail=multipleCheckItemAddService.getDetailData()||{}}),$scope.toChooseStructureType=function(){$state.go("safety/multipleCheck/multipleCheck-structure-type",{backUrl:"safety/multipleCheck/multipleCheck-project-info-edit",preBackUrl:$scope.backUrl}),$ionicViewSwitcher.nextDirection("forward")},$scope.submit=function(){$scope.validateTel()&&(multipleCheckItemAddService.setProjectInfo($scope.detail),$scope.back())},$scope.validateTel=function(){var re1=/^[0-9]+(.[0-9]{2})?$/;if(!re1.test($scope.detail.areaOfStructure))return $ionicPopup.alert({title:"提示",template:"建筑面积格式不正确,请输入正确的建筑面积(2位小数)!"}),!1;if(!re1.test($scope.detail.cost))return $ionicPopup.alert({title:"提示",template:"造价格式不正确,请输入正确的造价(2位小数)!"}),!1;var re2=/^\+?[1-9][0-9]*$/;return re2.test($scope.detail.groundLayer)?re2.test($scope.detail.underGroundLayer)?!!re2.test($scope.detail.personNumber)||($ionicPopup.alert({title:"提示",template:"参建人数格式不正确,请输入正确的参建人数!"}),!1):($ionicPopup.alert({title:"提示",template:"地下层数格式不正确,请输入正确的地下层数!"}),!1):($ionicPopup.alert({title:"提示",template:"地上层数格式不正确,请输入正确的地上层数!"}),!1)},$scope.back=function(){$state.go($scope.backUrl,{backUrl:"safety/multipleCheck/multipleCheck-item-list"}),$ionicViewSwitcher.nextDirection("back")}}]),angular.module("app.safety.multipleCheck").controller("multipleCheckProjectStatusController",["$scope","$state","$ionicPopup","multipleCheckItemAddService","$stateParams","$ionicViewSwitcher",function($scope,$state,$ionicPopup,multipleCheckItemAddService,$stateParams,$ionicViewSwitcher){$scope.$on("$ionicView.beforeEnter",function(){$stateParams.backUrl&&($scope.backUrl=$stateParams.backUrl),$scope.detail=multipleCheckItemAddService.getDetailData()||{}}),$scope.submit=function(){multipleCheckItemAddService.setProjectStatus({projectStatus:$scope.detail.projectStatus}),$scope.back()},$scope.back=function(){$state.go($scope.backUrl,{backUrl:"safety/multipleCheck/multipleCheck-item-list"}),$ionicViewSwitcher.nextDirection("back")}}]),angular.module("app.safety.multipleCheck").controller("multipleCheckStorageEditController",["$scope","$state","$ionicPopup","multipleCheckItemAddService","$stateParams","$ionicViewSwitcher","$ionicActionSheet","$filter","YTService",function($scope,$state,$ionicPopup,multipleCheckItemAddService,$stateParams,$ionicViewSwitcher,$ionicActionSheet,$filter,YTService){$scope.openCheckDate=function(){$scope.checkDatePopup=$ionicPopup.show({templateUrl:"check-date.html",scope:$scope,cssClass:"customTimerPopover"}),$scope.checkDatePopup.then(function(res){console.log("Tapped!",res)})},$scope.openStartDate=function(){$scope.startDatePopup=$ionicPopup.show({templateUrl:"start-date.html",scope:$scope,cssClass:"customTimerPopover"}),$scope.startDatePopup.then(function(res){console.log("Tapped!",res)})},$scope.openEndDate=function(){$scope.endDatePopup=$ionicPopup.show({templateUrl:"end-date.html",scope:$scope,cssClass:"customTimerPopover"}),$scope.endDatePopup.then(function(res){console.log("Tapped!",res)})},$scope.$on("$ionicView.beforeEnter",function(){$stateParams.backUrl&&($scope.backUrl=$stateParams.backUrl),null!=$stateParams.id&&multipleCheckItemAddService.getStorageData($stateParams.id,function(data){multipleCheckItemAddService.setEditId($stateParams.id),multipleCheckItemAddService.setDetailData(data.detailData),multipleCheckItemAddService.getEditExtraCheckerName(data.detailData.extraCheckerName),multipleCheckItemAddService.setSpot(data.spot),multipleCheckItemAddService.setTempDetail(data.tempDetail),multipleCheckItemAddService.setPosition(data.position),multipleCheckItemAddService.setGroupList(data.groupDataList)}),$scope.detail=multipleCheckItemAddService.getDetailData()||{},$scope.groupList=multipleCheckItemAddService.getGroupDataList()||[],$scope.initDate(),multipleCheckItemAddService.setType("storage"),multipleCheckItemAddService.queryStructureType(),$scope.url="safety/multipleCheck/multipleCheck-storage-edit"}),$scope.initDate=function(){$scope.checkDate=YTM.initDatePicker({date:new Date($scope.detail.checkDate),callback:function(){$scope.detail.checkDate=$filter("date")($scope.checkDate.date,"yyyy-MM-dd"),multipleCheckItemAddService.setCheckDate($scope.detail.checkDate),$scope.checkDatePopup.close()}}),$scope.startDate=YTM.initDatePicker({date:new Date($scope.detail.actualBeginDate),callback:function(){$scope.detail.actualBeginDate=$filter("date")($scope.startDate.date,"yyyy-MM-dd"),multipleCheckItemAddService.setStartDate($scope.detail.actualBeginDate),$scope.startDatePopup.close()}}),$scope.endDate=YTM.initDatePicker({date:new Date($scope.detail.plannedEndDate),callback:function(){$scope.detail.plannedEndDate=$filter("date")($scope.endDate.date,"yyyy-MM-dd"),multipleCheckItemAddService.setEndDate($scope.detail.plannedEndDate),$scope.endDatePopup.close()}})},$scope.editPersonInfo=function(){$state.go("safety/multipleCheck/multipleCheck-person-info-edit",{backUrl:$scope.url}),$ionicViewSwitcher.nextDirection("forward")},$scope.editProjectInfo=function(){$state.go("safety/multipleCheck/multipleCheck-project-info-edit",{backUrl:$scope.url}),$ionicViewSwitcher.nextDirection("forward")},$scope.editProjectStatus=function(){$state.go("safety/multipleCheck/multipleCheck-project-status",{backUrl:$scope.url}),$ionicViewSwitcher.nextDirection("forward")},$scope.editAdviceText=function(){$state.go("safety/multipleCheck/multipleCheck-advice-text",{backUrl:$scope.url}),$ionicViewSwitcher.nextDirection("forward")},$scope.toCheckerList=function(){$state.go("safety/multipleCheck/multipleCheck-checker-list",{backUrl:$scope.url}),$ionicViewSwitcher.nextDirection("forward")},$scope.toRandomInfo=function(){$state.go("safety/multipleCheck/multipleCheck-item-add-random-info",{backUrl:$scope.url}),$ionicViewSwitcher.nextDirection("forward")},$scope.openPosition=function(){$state.go("safety/multipleCheck/multipleCheck-check-position",{backUrl:$scope.url}),$ionicViewSwitcher.nextDirection("forward")},$scope.toChoose=function(index,url){$state.go(url,{index:index,backUrl:$scope.url}),$ionicViewSwitcher.nextDirection("forward")},$scope.toChooseById=function(index,id,url){$state.go(url,{index:index,id:id,backUrl:$scope.url}),$ionicViewSwitcher.nextDirection("forward")},$scope.delGroup=function(index){$ionicPopup.confirm({title:"提示",template:'<p class="text-center">确认删除？</p>',cancelText:"取消",okText:"确定"}).then(function(res){res&&(multipleCheckItemAddService.delGroupData(index),$ionicPopup.alert({title:"提示",template:'<p class="text-center">删除成功!</p>'}))})},$scope.delContent=function(groupIndex,index){$ionicPopup.confirm({title:"提示",template:'<p class="text-center">确认删除？</p>',cancelText:"取消",okText:"确定"}).then(function(res){res&&(multipleCheckItemAddService.delContent(groupIndex,index),$ionicPopup.alert({title:"提示",template:'<p class="text-center">删除成功!</p>'}))})},$scope.image_list=[],$scope.addAttachment=function(index){YTService.addAttachment($scope,function(item){$scope.groupList[index].attachList.push(item),multipleCheckItemAddService.setImagList(index,$scope.groupList[index].attachList)})},$scope.previewOrDelete=function(index,imgIndex){YTService.previewOrDelete(imgIndex,$scope.groupList[index].attachList,function(){$state.go("safety/multipleCheck/canvas",{editId:$scope.editId,image:$scope.groupList[index].attachList[imgIndex],groupIndex:index,index:imgIndex,backUrl:$scope.url}),$ionicViewSwitcher.nextDirection("forward")}),multipleCheckItemAddService.setImagList(index,$scope.groupList[index].attachList)},$scope.submit=function(){$scope.validate()&&$ionicActionSheet.show({buttons:[{text:"提交"},{text:"保存服务器"},{text:"保存本地"}],cancelText:"取消",cancel:function(){return!0},buttonClicked:function(index){var data={};if(0==index&&(data=$scope.getData(1),$scope.getPostData(data,"提交成功!")),1==index&&(data=$scope.getData(0),$scope.getPostData(data,"保存成功!")),2==index){var detailData=multipleCheckItemAddService.getDetailData()||{},spot=multipleCheckItemAddService.getSpot()||[],position=multipleCheckItemAddService.getPosition()||[],tempDetail=multipleCheckItemAddService.getTempDetail()||{},groupDataList=multipleCheckItemAddService.getGroupDataList()||[],localData={id:multipleCheckItemAddService.getEditId(),detailData:detailData,spot:spot,position:position,tempDetail:tempDetail,groupDataList:groupDataList};multipleCheckItemAddService.setStorageData(localData,function(){$ionicPopup.alert({title:"提示",template:'<p class="text-center">本地存储成功!</p>'}).then(function(){$scope.back()})})}return!0}})},$scope.getPostData=function(data,msg){data.position.length>0?multipleCheckItemAddService.insertAddPosition(data.position,function(){$scope.getPosition(data,function(){data.historyFlag?multipleCheckItemAddService.insertHistory(data.history,function(){$scope.postData(data,msg)}):$scope.postData(data,msg)})}):$scope.getPosition(data,function(){data.historyFlag?multipleCheckItemAddService.insertHistory(data.history,function(){$scope.postData(data,msg)}):$scope.postData(data,msg)})},$scope.getPosition=function(data,callBack){multipleCheckItemAddService.queryCheckPosition(function(pList){for(var positionList=pList,i=0;i<positionList.length;i++){var group0=$scope.getNewGroupData(positionList[i].id,positionList[i].name);if(group0.length>0)for(var m=0;m<group0.length;m++)data.slave.push(group0[m])}callBack()})},$scope.postData=function(data,msg){multipleCheckItemAddService.insertCheckData(data.mainData,data.slave,function(data){200==data.status&&$ionicPopup.alert({title:"提示",template:'<p class="text-center">'+msg+"!</p>"}).then(function(){multipleCheckItemAddService.delStorageData(multipleCheckItemAddService.getEditId(),function(){$scope.back()})})})},$scope.validate=function(){var flag=!0,detail=multipleCheckItemAddService.getDetailData()||{},spot=multipleCheckItemAddService.getSpot()||[],groupList=multipleCheckItemAddService.getGroupDataList()||[];if(multipleCheckItemAddService.validateDate(detail.actualBeginDate,detail.plannedEndDate))if(spot.length<=0)flag=!1,$ionicPopup.alert({title:"提示",template:"请设置抽查情况!"});else if(groupList.length>0){
var contentFlag=!0,itemsFlag=!0,attachFlag=!0;outerLoop:for(var i=0;i<groupList.length;i++){var content=groupList[i].content||[];if(content.length<=0){contentFlag=!1,flag=!1;break}for(var j=0;j<content.length;j++){var items=content[j].items||[];if(items<=0){itemsFlag=!1,flag=!1;break outerLoop}}var attachList=groupList[i].attachList||[];if(attachList.length<=0){flag=!1,attachFlag=!1;break}}contentFlag||$ionicPopup.alert({title:"提示",template:"存在检查问题未添加检查内容!"}),itemsFlag||$ionicPopup.alert({title:"提示",template:"存在检查内容未添加检查项目!"}),attachFlag||$ionicPopup.alert({title:"提示",template:"存在检查问题未上传照片!"})}else flag=!1,$ionicPopup.alert({title:"提示",template:"请添加相关问题!"});else flag=!1;return flag},$scope.getData=function(statusId){var detail=multipleCheckItemAddService.getDetailData()||{},spotList=multipleCheckItemAddService.getSpot()||[],positionList=multipleCheckItemAddService.getPosition()||[],tempDetail=multipleCheckItemAddService.getTempDetail()||{},mainData={projectId:detail.projectId,checkerId:detail.checkerId,checkDate:detail.checkDate,advice:detail.advice,projectStatus:detail.projectStatus,orgId:detail.orgId,statusId:statusId,extraCheckerName:detail.extraCheckerName},checkPosition=[];if(positionList.length>0)for(var i=0;i<positionList.length;i++)positionList[i].addFlag&&checkPosition.push({t:"safety_d_checkposition",data:{name:positionList[i].name,orgId:multipleCheckItemAddService.getRootOrgId()},ai:!0});var history={},historyFlag=!1;$scope.checkDetail(detail,tempDetail)&&(historyFlag=!0,history={projectName:detail.projectName,manager:detail.manager,managerTel:detail.managerTel,technician:detail.technician,technicianTel:detail.technicianTel,inspector:detail.inspector,inspectorTel:detail.inspectorTel,safetyOfficer:detail.safetyOfficer,safetyOfficerTel:detail.safetyOfficerTel,cost:detail.cost,groundLayer:detail.groundLayer,underGroundLayer:detail.underGroundLayer,areaOfStructure:detail.areaOfStructure,structureTypeId:detail.structureTypeId,personNumber:detail.personNumber,actualBeginDate:detail.actualBeginDate,plannedEndDate:detail.plannedEndDate,orgId:detail.projectId,companyId:detail.orgId});var slave=[];if(spotList.length>0)for(var j=0;j<spotList.length;j++)slave.push({t:"safety_multiplecheck_spot",data:{spotContentId:spotList[j].id==-1?0:spotList[j].id,spotCheckId:spotList[j].spotCheckId==-1?0:spotList[j].spotCheckId},key:"id"});return{mainData:mainData,position:checkPosition,historyFlag:historyFlag,history:history,slave:slave}},$scope.getNewGroupData=function(positionId,positionName){var groupList=multipleCheckItemAddService.getGroupDataList()||[],group=[];if(groupList.length>0)for(var i=0;i<groupList.length;i++)if(groupList[i].checkPosName==positionName){var slave=[];if(groupList[i].attachList.length>0)for(var j=0;j<groupList[i].attachList.length;j++)slave.push({t:"safety_multiplecheck_checkgroup_attach",data:{name:groupList[i].attachList[j].data.name,url:groupList[i].attachList[j].data.url},key:"id"});if(groupList[i].problems.length>0)for(var k=0;k<groupList[i].problems.length;k++)slave.push({t:"safety_multiplecheck_checkgroup_detail",data:{checkContentId:groupList[i].problems[k].contentId,checkItemId:groupList[i].problems[k].pId,checkProblemId:groupList[i].problems[k].id},key:"id"});group.push({t:"safety_multiplecheck_checkgroup",data:{checkPosId:positionId},key:"id",slave:slave,ai:!0});break}return group},$scope.checkDetail=function(detail,tempDetail){var historyFlag=!1;return detail.projectName!=tempDetail.projectName&&(historyFlag=!0),detail.manager!=tempDetail.manager&&(historyFlag=!0),detail.managerTel!=tempDetail.managerTel&&(historyFlag=!0),detail.technician!=tempDetail.technician&&(historyFlag=!0),detail.technicianTel!=tempDetail.technicianTel&&(historyFlag=!0),detail.inspector!=tempDetail.inspector&&(historyFlag=!0),detail.inspectorTel!=tempDetail.inspectorTel&&(historyFlag=!0),detail.safetyOfficer!=tempDetail.safetyOfficer&&(historyFlag=!0),detail.safetyOfficerTel!=tempDetail.safetyOfficerTel&&(historyFlag=!0),detail.cost!=tempDetail.cost&&(historyFlag=!0),detail.groundLayer!=tempDetail.groundLayer&&(historyFlag=!0),detail.underGroundLayer!=tempDetail.underGroundLayer&&(historyFlag=!0),detail.areaOfStructure!=tempDetail.areaOfStructure&&(historyFlag=!0),detail.structureTypeId!=tempDetail.structureTypeId&&(historyFlag=!0),detail.personNumber!=tempDetail.personNumber&&(historyFlag=!0),detail.actualBeginDate!=tempDetail.actualBeginDate&&(historyFlag=!0),detail.plannedEndDate!=tempDetail.plannedEndDate&&(historyFlag=!0),detail.orgId!=tempDetail.orgId&&(historyFlag=!0),detail.projectId!=tempDetail.projectId&&(historyFlag=!0),historyFlag},$scope.back=function(){multipleCheckItemAddService.clearCachedData(),$state.go("safety/multipleCheck/multipleCheck-storage-list",{projectId:$scope.detail.projectId,backUrl:"safety/multipleCheck/multipleCheck-item-list"}),$ionicViewSwitcher.nextDirection("back")}}]),angular.module("app.safety.multipleCheck").controller("multipleCheckStorageListController",["$scope","$state","$ionicPopup","multipleCheckItemAddService","$ionicHistory","$stateParams","$ionicViewSwitcher","LocalStorageService",function($scope,$state,$ionicPopup,multipleCheckItemAddService,$ionicHistory,$stateParams,$ionicViewSwitcher,LocalStorageService){$scope.$on("$ionicView.beforeEnter",function(){$stateParams.backUrl&&($scope.backUrl=$stateParams.backUrl),null!=$stateParams.projectId&&($scope.projectId=$stateParams.projectId),$scope.localDataList=multipleCheckItemAddService.getStorageList($scope.projectId)||[]}),$scope.toEdit=function(id,backUrl){$state.go("safety/multipleCheck/multipleCheck-storage-edit",{id:id,backUrl:backUrl}),$ionicViewSwitcher.nextDirection("forward")},$scope.back=function(){multipleCheckItemAddService.clearCachedData(),$state.go($scope.backUrl,{projectId:$scope.projectId,backUrl:"safety/multipleCheck/multipleCheck-list"}),$ionicViewSwitcher.nextDirection("back")}}]),angular.module("app.safety.multipleCheck").controller("multipleCheckStructureTypeController",["$scope","$state","$ionicPopup","multipleCheckItemAddService","$stateParams","$ionicViewSwitcher",function($scope,$state,$ionicPopup,multipleCheckItemAddService,$stateParams,$ionicViewSwitcher){$scope.$on("$ionicView.beforeEnter",function(){$stateParams.backUrl&&($scope.backUrl=$stateParams.backUrl),$stateParams.preBackUrl&&($scope.preBackUrl=$stateParams.preBackUrl),$scope.detail=multipleCheckItemAddService.getDetailData()||{},$scope.structureTypeList=multipleCheckItemAddService.getStructureType()||[]}),$scope.chooseStructureType=function(item){multipleCheckItemAddService.setStructureType({structureTypeId:item.id,structureName:item.name}),$scope.back()},$scope.back=function(){$state.go($scope.backUrl,{backUrl:$scope.preBackUrl}),$ionicViewSwitcher.nextDirection("back")}}]),angular.module("app.safety.multipleCheck").factory("multipleCheckItemAddService",["YTService","UserService","env","$ionicActionSheet","LocalStorageService","$ionicPopup",function(YT,userService,env,$ionicActionSheet,LocalStorageService,$ionicPopup){var detailData={},tempDetail={},groupIdList=[],groupDataMap={},groupDataList=[],groupAttachMap={},structureType=[],extraCheckerName=[],spot=[],editSpot=[],positionList=[],addPositionList=[],position=[],type="",editId="",projectId="";return{clearCachedData:function(){detailData={},tempDetail={},groupIdList=[],groupDataMap={},groupDataList=[],groupAttachMap={},structureType=[],extraCheckerName=[],spot=[],editSpot=[],positionList=[],addPositionList=[],position=[],type="",editId="",projectId=""},queryDetailData:function(editId,projectId,successCallback){var self=this,data={};data=editId!=-1?{m:15004,t:"v_safety_multiplecheck_extend"}:{m:15004,t:"v_safety_multiplecheck_org_extend"};var filter=[{field:"projectId",value:projectId,operator:"=",relation:""}];data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){detailData=data.object[0],tempDetail=self.deepClone(data.object[0]),self.initChecker(),self.setNowAsCheckDate(),successCallback.call()}})},queryEditDetailData:function(id,successCallback){var self=this,data={m:15004,t:"v_safety_multiplecheck"},filter=[{field:"id",value:id,operator:"=",relation:"and"}];data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){detailData=data.object[0],self.getEditExtraCheckerName(detailData.extraCheckerName),tempDetail=self.deepClone(data.object[0]),successCallback.call()}})},queryGroupData:function(editId,successCallback){var self=this,data={m:15004,t:"v_safety_multiplecheck_checkgroup",order:"detailId"},filter=[{field:"id",value:editId,operator:"=",relation:"and"}];data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){self.setDataList(editId,data.object,function(){successCallback.call()})}})},queryDetailAttach:function(checkId,successCallback){var data={m:15004,t:"v_safety_multiplecheck_checkgroup_attach",order:"attachId"},filter=[{field:"checkId",value:checkId,operator:"=",relation:"and"}];data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){successCallback.call(this,data.object)}})},queryStructureType:function(){var data={m:15004,t:"dictionary_structure",order:"id"};YT.query({data:data,successCallback:function(data){structureType=data.object}})},querySpotContent:function(successCallback){var data={m:15004,t:"safety_d_spotcontent",order:"id"};YT.query({data:data,successCallback:function(data){if(data.object.length>0)for(var i=0;i<data.object.length;i++)data.object[i].spotCheckId=-1,data.object[i].spotCheckName="";successCallback.call(this,data.object)}})},queryEditSpotData:function(id){var self=this,data={m:15004,t:"v_safety_multiplecheck_spot",order:"spotContentId"},filter=[{field:"id",value:id,operator:"=",relation:"and"}];data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){editSpot=data.object,self.setEditSpot()}})},querySpotCheck:function(successCallback){var data={m:15004,t:"safety_d_spotcheck",order:"id"};YT.query({data:data,successCallback:function(data){successCallback.call(this,data.object)}})},queryCheckPosition:function(successCallback){var data={m:15004,t:"safety_d_checkposition",order:"id"},filter=[{field:"orgId",value:userService.getRootOrgId(),operator:"=",relation:"and"}];data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){positionList=data.object,successCallback.call(this,data.object)}})},queryCheckContent:function(id,level,successCallback){var data={m:15004,t:"v_safety_checkcontent",order:"id"},filter=[],oneFilter=[];oneFilter.push({field:"level",value:level,operator:"=",relation:"and"}),id!=-1&&oneFilter.push({field:"pId",value:id,operator:"=",relation:"and"}),oneFilter.push({field:"type",value:"通用",operator:"=",relation:"OR"});var twoFilter=[];twoFilter.push({field:"level",value:level,operator:"=",relation:"and"}),id!=-1&&twoFilter.push({field:"pId",value:id,operator:"=",relation:"and"}),twoFilter.push({field:"type",value:"项目部",operator:"=",relation:"and"}),twoFilter.push({field:"orgId",value:userService.getRootOrgId(),operator:"=",relation:""}),filter.push(oneFilter),filter.push(twoFilter),data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){successCallback.call(this,data.object)}})},insertCheckProblem:function(problem,successCallback){var data={m:15004,t:"safety_d_checkcontent_extend",v:JSON.stringify([{t:"safety_d_checkcontent_extend",data:problem,ai:!0}])};YT.insert({data:data,successCallback:function(data){successCallback.call(this,data.object)}})},insertAddPosition:function(positionList,successCallback){var data={m:15004,t:"safety_d_checkposition",v:JSON.stringify(positionList)};YT.insert({data:data,successCallback:function(data){successCallback.call()}})},insertHistory:function(history,successCallback){var data={m:15004,t:"safety_multiplecheck_history",v:JSON.stringify([{t:"safety_multiplecheck_history",data:history,ai:!0}])};YT.insert({data:data,successCallback:function(data){successCallback.call()}})},insertCheckData:function(data,slave,successCallback){var postData={m:15004,t:"safety_multiplecheck",v:JSON.stringify([{t:"safety_multiplecheck",data:data,ai:!0,slave:slave}])};YT.insert({data:postData,successCallback:function(data){successCallback.call(this,data)}})},updateCheckData:function(data,successCallback){var filter=[{field:"id",value:data.mainData.id,operator:"=",relation:""}],postData={m:15004,t:"safety_multiplecheck",v:JSON.stringify([{t:"safety_multiplecheck",data:data.mainData,slave:data.slave,filter:filter}]),params:JSON.stringify(data.params)};YT.update({data:postData,successCallback:function(data){successCallback.call(this,data)}})},checkGroupId:function(groupId){var flag=!1;if(groupIdList.length>0)for(var i=0;i<groupIdList.length;i++)if(groupIdList[i]==groupId){flag=!0;break}return flag},pushGroupId:function(groupId){var self=this;self.checkGroupId(groupId)||(groupIdList.push(groupId),self.sortGroupIdList())},sortGroupIdList:function(){groupIdList.sort(function(a,b){return a-b})},pushGroupItem:function(groupItem){var self=this,groupId=groupItem.groupId;self.pushGroupId(groupId);var items=groupDataMap[groupId];if(void 0!=items&&null!=items&&items.length>0)items.push(groupItem);else{var tempItems=[];tempItems.push(groupItem),groupDataMap[groupId]=tempItems}},setGroupAttachMap:function(attachList){var self=this;if(self.changeAttach(attachList),attachList.length>0)for(var j=0;j<attachList.length;j++){var temp=groupAttachMap[attachList[j].id];if(void 0!=temp&&null!=temp&&temp.length>0)temp.push(attachList[j]);else{var temps=[];temps.push(attachList[j]),temp=temps}groupAttachMap[attachList[j].id]=temp}},setDataList:function(id,groupData,callback){var self=this;self.queryDetailAttach(id,function(attachData){if(groupData.length>0)for(var i=0;i<groupData.length;i++)self.pushGroupItem(groupData[i]);if(self.setGroupAttachMap(attachData),groupIdList.length>0){groupDataList=[];for(var j=0;j<groupIdList.length;j++){var contentData=groupDataMap[groupIdList[j]],checkPosName=contentData[0].checkPosName,contentMap=self.getContent(contentData),content=contentMap.content,problems=contentMap.problems;groupDataList.push({groupId:groupIdList[j],checkPosName:checkPosName,attachList:void 0==groupAttachMap[groupIdList[j]]?[]:groupAttachMap[groupIdList[j]],content:content,problems:problems})}}callback()})},getContent:function(contentData){for(var problemList=[],contentList=[],contentMap={},itemMap={},problemMap={},i=0;i<contentData.length;i++)contentMap[contentData[i].checkContentId]={id:contentData[i].checkContentId,name:contentData[i].checkContentName,checked:!0},itemMap[contentData[i].checkItemId]={id:contentData[i].checkItemId,name:contentData[i].checkItemName,pId:contentData[i].checkContentId,checked:!0},problemMap[contentData[i].checkProblemId]={id:contentData[i].checkProblemId,name:contentData[i].checkProblemName,pId:contentData[i].checkItemId,contentId:contentData[i].checkContentId,checked:!0},problemList.push({id:contentData[i].checkProblemId,name:contentData[i].checkProblemName,pId:contentData[i].checkItemId,contentId:contentData[i].checkContentId,checked:!0});for(var key in problemMap){var problems=itemMap[problemMap[key].pId].problems;problems=problems||[],problems.push(problemMap[key]),itemMap[problemMap[key].pId].problems=problems}for(var key in itemMap){var items=contentMap[itemMap[key].pId].items;items=items||[],items.push(itemMap[key]),contentMap[itemMap[key].pId].items=items}for(var key in contentMap)contentList.push(contentMap[key]);return{content:contentList,problems:problemList}},changeAttach:function(list){if(list.length>0)for(var i=0;i<list.length;i++){var ticket=userService.getTicket();list[i].src=list[i].url.replace("\\","/"),list[i].src=env.server+"download.action?rnd="+Math.random()+"&tkt="+ticket+"&fileName="+list[i].src,list[i].data={name:list[i].name,url:list[i].url}}},prefixInteger:function(num,n){for(var len=num.toString().length;len<n;)num="0"+num,len++;return num},getStorageData:function(id,callBack){for(var list=JSON.parse(LocalStorageService.get("multipleCheckList"))||[],data={},i=0;i<list.length;i++)if(list[i].id==id){data=list[i];break}callBack(data)},setStorageData:function(data,callBack){for(var list=JSON.parse(LocalStorageService.get("multipleCheckList"))||[],i=0;i<list.length;i++)if(list[i].id==data.id){list[i]=data;break}LocalStorageService.set("multipleCheckList",JSON.stringify(list)),callBack()},delStorageData:function(id,callBack){for(var list=JSON.parse(LocalStorageService.get("multipleCheckList"))||[],i=0;i<list.length;i++)if(list[i].id==id){list.splice(i,1);break}LocalStorageService.set("multipleCheckList",JSON.stringify(list)),callBack()},getStorageList:function(projectId){for(var list=JSON.parse(LocalStorageService.get("multipleCheckList"))||[],data=[],i=0;i<list.length;i++)list[i].detailData.projectId==projectId&&data.push(list[i]);return data},getGroupDataList:function(){return groupDataList},getDetailData:function(){return detailData},getStructureType:function(){return structureType},getExtraCheckerName:function(){return extraCheckerName},getSpot:function(){return spot},getPositionList:function(){return positionList},getAddPositionList:function(){return addPositionList},getRootOrgId:function(){return userService.getRootOrgId()},getTempDetail:function(){return tempDetail},setDetailData:function(data){detailData=data},initChecker:function(){detailData.checkerId=userService.getUserId(),detailData.checkerName=userService.getUserName(),detailData.extraCheckerName="",detailData.allCheckerName=userService.getUserName()},setNowAsCheckDate:function(){var self=this,now=new Date;detailData.checkDate=now.getFullYear()+"-"+self.prefixInteger(now.getMonth()+1,2)+"-"+self.prefixInteger(now.getDate(),2)},setCheckDate:function(date){detailData.checkDate=date},setStartDate:function(date){detailData.actualBeginDate=date},setEndDate:function(date){detailData.plannedEndDate=date},setGroupList:function(data){groupDataList=data},setPersonInfo:function(data){detailData.manager=data.manager,detailData.managerTel=data.managerTel,detailData.technician=data.technician,detailData.technicianTel=data.technicianTel,detailData.inspector=data.inspector,detailData.inspectorTel=data.inspectorTel,detailData.safetyOfficer=data.safetyOfficer,detailData.safetyOfficerTel=data.safetyOfficerTel},setProjectInfo:function(data){detailData.areaOfStructure=data.areaOfStructure,detailData.cost=data.cost,detailData.groundLayer=data.groundLayer,detailData.underGroundLayer=data.underGroundLayer,detailData.personNumber=data.personNumber},setStructureType:function(data){detailData.structureTypeId=data.structureTypeId,detailData.structureName=data.structureName},setProjectStatus:function(data){detailData.projectStatus=data.projectStatus},setAdvice:function(data){detailData.advice=data.advice},setExtraCheckerName:function(data){extraCheckerName=data;var extraCheckerNameStr="";if(data.length>0){extraCheckerNameStr=data[0].name;for(var i=1;i<data.length;i++)extraCheckerNameStr+="，"+data[i].name}detailData.extraCheckerName=extraCheckerNameStr,""!=extraCheckerNameStr?detailData.allCheckerName=detailData.checkerName+"，"+extraCheckerNameStr:detailData.allCheckerName=detailData.checkerName},getEditExtraCheckerName:function(str){if(void 0!=str&&null!=str&&""!=str){var list=str.split("，");if(list.length>0)for(var i=0;i<list.length;i++)extraCheckerName.push({name:list[i]})}},setEditSpot:function(){if(editSpot.length>0)for(var i=0;i<editSpot.length;i++)spot.push({id:editSpot[i].spotContentId,code:editSpot[i].spotContentCode,name:editSpot[i].spotContentName,rowspan:editSpot[i].rowspan,spotCheckId:editSpot[i].spotCheckId,spotCheckName:editSpot[i].spotCheckName})},setSpot:function(data){spot=data},setSpotCount:function(data){detailData.spotCount=data},setType:function(data){type=data},setImagList:function(index,list){groupDataList[index].attachList=list},setTempDetail:function(data){tempDetail=data},setEditId:function(data){editId=data},getEditId:function(){return editId},setProjectId:function(data){projectId=data},getProjectId:function(){return projectId},getType:function(){return type},setGroupProblems:function(index,data){groupDataList[index].problems=data},getGroupProblems:function(index){return groupDataList[index].problems},pushPosition:function(data){position.push(data)},getPosition:function(){return position},setPosition:function(data){position=data},pushGroupData:function(position){groupDataList.push({positionId:position.id,checkPosName:position.name,attachList:[],content:[]})},delGroupData:function(index){if(position.length>0)for(var i=0;i<position.length;i++)position[i].name==groupDataList[index].checkPosName&&position.splice(i,1);groupDataList.splice(index,1)},delContent:function(groupIndex,index){var self=this;self.removeContentProblems(groupIndex,groupDataList[groupIndex].content[index].id),groupDataList[groupIndex].content.splice(index,1)},setContent:function(groupIndex,data){groupDataList[groupIndex].content=data},removeContent:function(groupIndex,id){for(var self=this,content=groupDataList[groupIndex].content||[],i=0;i<content.length;i++)if(content[i].id==id){self.delContent(groupIndex,i);break}},removeItem:function(groupIndex,contentId,itemId){for(var content=groupDataList[groupIndex].content||[],i=0;i<content.length;i++)if(contentId==content[i].id){for(var items=content[i].items||[],j=0;j<items.length;j++)(itemId=items[j].id)&&items.splice(j,1);groupDataList[groupIndex].content[i].items=items}},removeContentProblems:function(groupIndex,contentId){for(var problems=groupDataList[groupIndex].problems||[],tempProblems=[],i=0;i<problems.length;i++){var flag=!0;problems[i].contentId==contentId&&(flag=!1),flag&&tempProblems.push(problems[i])}groupDataList[groupIndex].problems=tempProblems},pushProblem:function(groupIndex,data){groupDataList[groupIndex].problems.push(data)},removeItemProblems:function(groupIndex,pId){for(var returnProblems=[],problems=groupDataList[groupIndex].problems||[],i=0;i<problems.length;i++)problems[i].pId!=pId&&returnProblems.push(problems[i]);groupDataList[groupIndex].problems=returnProblems},deepClone:function(obj){var o;switch(typeof obj){case"undefined":break;case"string":o=obj+"";break;case"number":o=obj-0;break;case"boolean":o=obj;break;case"object":if(null===obj)o=null;else if(obj instanceof Array){o=[];for(var i=0,len=obj.length;i<len;i++)o.push(this.deepClone(obj[i]))}else{o={};for(var k in obj)o[k]=this.deepClone(obj[k])}break;default:o=obj}return o},validateDate:function(startDate,endDate){var flag=!0;if(startDate&&endDate){var beginTimes=startDate.substring(0,10).split("-"),endTimes=endDate.substring(0,10).split("-"),beginTime=beginTimes[1]+"-"+beginTimes[2]+"-"+beginTimes[0]+" "+startDate.substring(10,19),endTime=endTimes[1]+"-"+endTimes[2]+"-"+endTimes[0]+" "+endDate.substring(10,19),a=(Date.parse(endTime)-Date.parse(beginTime))/3600/1e3;a<0&&(flag=!1,$ionicPopup.alert({title:"提示",template:"开工时间不能大于完工时间！"}))}else flag=!1;return flag}}}]).filter("cut",function(){return function(value,wordwise,max,tail){if(!value)return"";if(max=parseInt(max,10),!max)return value;if(value.length<=max)return value;if(value=value.substr(0,max),wordwise){var lastspace=value.lastIndexOf(" ");lastspace!=-1&&(value=value.substr(0,lastspace))}return value+(tail||" …")}}),angular.module("app.safety.multipleCheck").factory("multipleCheckItemDetailRandomInfoService",["YTService",function(YT){var serviceData=[];return{clearCachedData:function(){serviceData=[]},queryInfoData:function(id,successCallback){var data={m:15004,t:"v_safety_multiplecheck_spot",order:"spotContentId"},filter=[{field:"id",value:id,operator:"=",relation:"and"}];data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){serviceData=data.object,successCallback.call()}})},getServiceData:function(){return serviceData}}}]).filter("trustHtml",function($sce){return function(text){return $sce.trustAsHtml(text)}}),angular.module("app.safety.multipleCheck").factory("multipleCheckItemDetailService",["YTService","UserService","env",function(YT,userService,env){var detailData={},groupIdList=[],groupDataMap={},groupDataList=[],groupAttachMap={};return{clearCachedData:function(){detailData={},groupIdList=[],groupDataMap={},groupDataList=[],groupAttachMap={}},queryDetailData:function(id,successCallback){var data={m:15004,t:"v_safety_multiplecheck"},filter=[{field:"id",value:id,operator:"=",relation:"and"}];data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){detailData=data.object[0],successCallback.call()}})},queryDetailGroupData:function(id,successCallback){var self=this,data={m:15004,t:"v_safety_multiplecheck_checkgroup",order:"detailId"},filter=[{field:"id",value:id,operator:"=",relation:"and"}];data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){self.setDataList(id,data.object,function(){successCallback.call()})}})},queryDetailAttach:function(checkId,successCallback){var data={m:15004,t:"v_safety_multiplecheck_checkgroup_attach",order:"attachId"},filter=[{field:"checkId",value:checkId,operator:"=",relation:"and"}];data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){successCallback.call(this,data.object)}})},checkGroupId:function(groupId){var flag=!1;if(groupIdList.length>0)for(var i=0;i<groupIdList.length;i++)if(groupIdList[i]==groupId){flag=!0;break}return flag},pushGroupId:function(groupId){var self=this;self.checkGroupId(groupId)||(groupIdList.push(groupId),self.sortGroupIdList())},sortGroupIdList:function(){groupIdList.sort(function(a,b){return a-b})},pushGroupItem:function(groupItem){var self=this,groupId=groupItem.groupId;self.pushGroupId(groupId);var items=groupDataMap[groupId];if(void 0!=items&&null!=items&&items.length>0)items.push(groupItem);else{var tempItems=[];tempItems.push(groupItem),groupDataMap[groupId]=tempItems}},setGroupAttachMap:function(attachList){var self=this;if(self.changeAttach(attachList),attachList.length>0)for(var j=0;j<attachList.length;j++){var temp=groupAttachMap[attachList[j].id];if(void 0!=temp&&null!=temp&&temp.length>0)temp.push(attachList[j]);else{var temps=[];temps.push(attachList[j]),temp=temps}groupAttachMap[attachList[j].id]=temp}},setDataList:function(id,groupData,callback){var self=this;self.queryDetailAttach(id,function(attachData){if(groupData.length>0)for(var i=0;i<groupData.length;i++)self.pushGroupItem(groupData[i]);if(self.setGroupAttachMap(attachData),groupIdList.length>0){groupDataList=[];for(var j=0;j<groupIdList.length;j++){var contentData=groupDataMap[groupIdList[j]],checkPosName=contentData[0].checkPosName,content=self.getContent(contentData);groupDataList.push({groupId:groupIdList[j],checkPosName:checkPosName,attachList:void 0==groupAttachMap[groupIdList[j]]?[]:groupAttachMap[groupIdList[j]],content:content})}}callback()})},getContent:function(contentData){for(var contentList=[],contentMap={},itemMap={},problemMap={},i=0;i<contentData.length;i++)contentMap[contentData[i].checkContentId]={id:contentData[i].checkContentId,name:contentData[i].checkContentName},itemMap[contentData[i].checkItemId]={id:contentData[i].checkItemId,name:contentData[i].checkItemName,pId:contentData[i].checkContentId},problemMap[contentData[i].checkProblemId]={id:contentData[i].checkProblemId,name:contentData[i].checkProblemName,pId:contentData[i].checkItemId,contentId:contentData[i].checkContentId};for(var key in problemMap){var problems=itemMap[problemMap[key].pId].problems;problems=problems||[],problems.push(problemMap[key]),itemMap[problemMap[key].pId].problems=problems}for(var key in itemMap){var items=contentMap[itemMap[key].pId].items;items=items||[],items.push(itemMap[key]),contentMap[itemMap[key].pId].items=items}for(var key in contentMap)contentList.push(contentMap[key]);return contentList},changeAttach:function(list){if(list.length>0)for(var i=0;i<list.length;i++){var ticket=userService.getTicket();list[i].src=list[i].url.replace("\\","/"),list[i].src=env.server+"download.action?rnd="+Math.random()+"&tkt="+ticket+"&fileName="+list[i].src}},getGroupDataList:function(){return groupDataList},getDetailData:function(){return detailData}}}]),angular.module("app.safety.multipleCheck").factory("multipleCheckItemListService",["YTService","LocalStorageService",function(YT,LocalStorageService){var serviceData=[],pageIndex=0,pageSize=10,hasNextPage=!0,right={checker:!1},serviceDataMap={},months=[],editId="",projectId="";return{loadListData:function(projectId,successCallback){++pageIndex;var self=this;right.checker=YT.haveRight(15004),YT.query({data:self.getSearchData(projectId),successCallback:function(data){self.loadListDataCallback(data),successCallback.call()}})},loadListDataCallback:function(data){for(var self=this,pageInfo=data.object,i=0;i<pageInfo.items.length;i++){var temp=pageInfo.items[i].projectStatus;void 0!=temp&&null!=temp&&""!=temp||(pageInfo.items[i].projectStatus="未填写"),self.pushItem(pageInfo.items[i])}self.setServiceData(),hasNextPage=!(pageIndex>=pageInfo.pageCount)},refreshListData:function(projectId,successCallBack){this.clearCachedData(),this.loadListData(projectId,successCallBack)},clearCachedData:function(){pageIndex=0,hasNextPage=!0,serviceData=[],serviceDataMap={},months=[]},getSearchData:function(projectId){var data={m:15004,t:"v_safety_multiplecheck",order:"id desc",page:pageIndex,rows:pageSize},filter=this.getSearchFilter(projectId);return data.filter=JSON.stringify(filter),data},getSearchFilter:function(projectId){var filter=[];return filter.push({field:"projectId",value:projectId,operator:"=",relation:"AND"}),filter},deepClone:function(obj){var o;switch(typeof obj){case"undefined":break;case"string":o=obj+"";break;case"number":o=obj-0;break;case"boolean":o=obj;break;case"object":if(null===obj)o=null;else if(obj instanceof Array){o=[];for(var i=0,len=obj.length;i<len;i++)o.push(this.deepClone(obj[i]))}else{o={};for(var k in obj)o[k]=this.deepClone(obj[k])}break;default:o=obj}return o},getServiceData:function(){return serviceData},hasNextPage:function(){return hasNextPage},getRight:function(){return right},checkMonths:function(month){var flag=!1;if(months.length>0)for(var i=0;i<months.length;i++)if(months[i]==month){flag=!0;break}return flag},pushMonth:function(month){var self=this;self.checkMonths(month)||(months.push(month),self.sortMonths())},sortMonths:function(){months.sort(function(a,b){return b.localeCompare(a)})},pushItem:function(item){var self=this,month=item.checkDate.substr(0,7);self.pushMonth(month);var items=serviceDataMap[month];if(void 0!=items&&void 0!=items&&items.length>0)items.push(item);else{var tempItems=[];tempItems.push(item),serviceDataMap[month]=tempItems}},getStorageList:function(projectId){for(var list=JSON.parse(LocalStorageService.get("multipleCheckList"))||[],data=[],i=0;i<list.length;i++)list[i].detailData.projectId==projectId&&data.push(list[i]);return data},setServiceData:function(){if(serviceData=[],months.length>0)for(var i=0;i<months.length;i++)serviceData.push({checkMonth:months[i],items:serviceDataMap[months[i]]})},setEditId:function(data){editId=data},getEditId:function(){return editId},setProjectId:function(data){projectId=data},getProjectId:function(){return projectId}}}]).filter("changeDateToYearMonth",function(){return function(str){if(void 0!=str&&null!=str&&""!=str){var year=parseInt(str.substr(0,4)),month=parseInt(str.substr(5,2));return year+"年"+month+"月"}}}),angular.module("app.safety.multipleCheck").factory("multipleCheckListService",["YTService","UserService","YTService",function(YT,userService,YTService){var serviceData=[],pageIndex=0,pageSize=20,hasNextPage=!0,condition={projectName:"",companyName:"",companyId:-1,statusId:0,statusName:""},companyList=[];return{loadListData:function(successCallback){++pageIndex;var self=this;YT.query({data:self.getSearchData(),successCallback:function(data){self.loadListDataCallback(data),successCallback.call()}})},loadListDataCallback:function(data){for(var pageInfo=data.object,i=0;i<pageInfo.items.length;i++)serviceData.push(pageInfo.items[i]);
hasNextPage=!(pageIndex>=pageInfo.pageCount)},refreshListData:function(successCallBack){this.clearCachedData(),this.loadListData(successCallBack)},clearCachedData:function(){pageIndex=0,hasNextPage=!0,serviceData=[],companyList=[]},resetCondition:function(){condition={projectName:"",companyName:"",companyId:-1,statusId:0,statusName:""}},getSearchData:function(){var data={m:15004,t:"v_safety_multiplecheck_list",order:"projectId",page:pageIndex,rows:pageSize},filter=this.getSearchFilter();return data.filter=JSON.stringify(filter),data},getSearchFilter:function(){var filter=[],rootId=userService.getRootOrgId();return""!=condition.projectName&&filter.push({field:"projectName",value:"%"+condition.projectName+"%",operator:"like",relation:"AND"}),0!=condition.statusId&&(condition.statusId==-1?filter.push({field:"editId",value:condition.statusId,operator:"=",relation:"AND"}):1==condition.statusId&&filter.push({field:"editId",value:-1,operator:"<>",relation:"AND"})),condition.companyId!=-1&&filter.push({field:"orgId",value:condition.companyId,operator:"=",relation:"AND"}),1==userService.getTypeId()?YTService.getSubCompany(function(data){companyList=data||[];for(var innerFilter=[],i=0;i<companyList.length;i++)innerFilter.push({field:"orgId",value:companyList[i].id,operator:"=",relation:"OR"});innerFilter.length>0&&filter.push(innerFilter)}):2==userService.getTypeId()&&filter.push({field:"orgId",value:rootId,operator:"=",relation:"AND"}),filter},deepClone:function(obj){var o;switch(typeof obj){case"undefined":break;case"string":o=obj+"";break;case"number":o=obj-0;break;case"boolean":o=obj;break;case"object":if(null===obj)o=null;else if(obj instanceof Array){o=[];for(var i=0,len=obj.length;i<len;i++)o.push(this.deepClone(obj[i]))}else{o={};for(var k in obj)o[k]=this.deepClone(obj[k])}break;default:o=obj}return o},getServiceData:function(){return serviceData},getCompanyList:function(){return companyList},getCondition:function(){return condition},hasNextPage:function(){return hasNextPage}}}]),angular.module("app.subcontract.contract").controller("ContractListController",["$scope","$state","$stateParams","ContractListService","$ionicModal","SubContractCommonService","$ionicHistory","$ionicScrollDelegate",function($scope,$state,$stateParams,contractListService,$ionicModal,subContractCommonService,$ionicHistory,$ionicScrollDelegate){$scope.$on("$ionicView.loaded",function(){$scope.contractList=contractListService.getContractList(),$scope.hasNextPage=contractListService.hasNextPage(),$scope.searchText=""}),$scope.loadListData=function(){contractListService.loadListData(function(){$scope.fillData(),$scope.$broadcast("scroll.infiniteScrollComplete")})},$scope.fillData=function(){$scope.contractList=contractListService.getContractList(),$scope.hasNextPage=contractListService.hasNextPage()},$scope.refreshListData=function(){contractListService.refreshListData(function(){$scope.fillData(),$scope.$broadcast("scroll.refreshComplete")})},$scope.back=function(){contractListService.clearCachedData(),$ionicHistory.goBack()},$scope.searchFilter=function(contract){return null==$scope.searchText||""==$scope.searchText||contract.displayId.indexOf($scope.searchText)!=-1},$scope.clearSearchText=function(){$scope.searchText=""}}]),angular.module("app.subcontract.contract").factory("ContractListService",["YTService","UserService",function(YT,userService){var contractList=[],pageIndex=0,pageSize=10,hasNextPage=!0;return{getContractList:function(){return contractList},hasNextPage:function(){return hasNextPage},loadListData:function(successCallback){++pageIndex;var self=this;YT.query({data:self.getSearchData(),successCallback:function(data){self.loadListDataCallback(data),successCallback.call()}})},getSearchData:function(){var data={m:13003003,t:"v_subcontract_contract_mobile",order:"id",page:pageIndex,rows:pageSize},filter=this.getSearchFilter();return data.filter=JSON.stringify(filter),data},getSearchFilter:function(){var filter=[];return filter.push({field:"orgId",value:userService.getRootOrgId(),operator:"=",relation:"AND"}),filter},loadListDataCallback:function(data){for(var pageInfo=data.object,i=0;i<pageInfo.items.length;i++)contractList.push(pageInfo.items[i]);hasNextPage=!(pageIndex>=pageInfo.pageCount)},refreshListData:function(successCallBack){this.clearCachedData(),this.loadListData(successCallBack)},clearCachedData:function(){pageIndex=0,hasNextPage=!0,contractList=[]}}}]),angular.module("app.subcontract.merchant").controller("MerchantListController",["$scope","$state","$stateParams","MerchantListService","$ionicModal","SubContractCommonService","$ionicHistory","$ionicScrollDelegate",function($scope,$state,$stateParams,merchantListService,$ionicModal,subContractCommonService,$ionicHistory,$ionicScrollDelegate){$scope.$on("$ionicView.loaded",function(){$scope.merchantList=merchantListService.getMerchantList(),$scope.hasNextPage=merchantListService.hasNextPage(),$scope.searchText=""}),$scope.loadListData=function(){merchantListService.loadListData(function(){$scope.fillData(),$scope.$broadcast("scroll.infiniteScrollComplete")})},$scope.fillData=function(){$scope.merchantList=merchantListService.getMerchantList(),$scope.hasNextPage=merchantListService.hasNextPage()},$scope.refreshListData=function(){merchantListService.refreshListData(function(){$scope.fillData(),$scope.$broadcast("scroll.refreshComplete")})},$scope.back=function(){merchantListService.clearCachedData(),$ionicHistory.goBack()},$scope.searchFilter=function(merchant){return null==$scope.searchText||""==$scope.searchText||merchant.name.indexOf($scope.searchText)!=-1},$scope.clearSearchText=function(){$scope.searchText=""}}]),angular.module("app.subcontract.merchant").factory("MerchantListService",["YTService","UserService",function(YT,userService){var merchantList=[],pageIndex=0,pageSize=10,hasNextPage=!0;return{getMerchantList:function(){return merchantList},hasNextPage:function(){return hasNextPage},loadListData:function(successCallback){++pageIndex;var self=this;YT.query({data:self.getSearchData(),successCallback:function(data){self.loadListDataCallback(data),successCallback.call()}})},refreshListData:function(successCallBack){this.clearCachedData(),this.loadListData(successCallBack)},getSearchData:function(){var data={m:13003002,t:"v_subcontract_merchant_mobile",order:"id",page:pageIndex,rows:pageSize},filter=this.getSearchFilter();return data.filter=JSON.stringify(filter),data},getSearchFilter:function(){var filter=[];return filter.push({field:"orgId",value:userService.getRootOrgId(),operator:"=",relation:"AND"}),filter},loadListDataCallback:function(data){for(var pageInfo=data.object,i=0;i<pageInfo.items.length;i++)merchantList.push(pageInfo.items[i]);hasNextPage=!(pageIndex>=pageInfo.pageCount)},clearCachedData:function(){pageIndex=0,hasNextPage=!0,merchantList=[]}}}]),angular.module("app.subcontract.measure").controller("MeasureContractListController",["$scope","$state","$stateParams","MeasureContractListService",function($scope,$state,$stateParams,measureContractListService){$scope.merchantName=$stateParams.merchantName,$scope.$on("$ionicView.loaded",function(){measureContractListService.getMeasureContractDetail($stateParams.id,$stateParams.merchantId,function(data){$scope.measureContractDetails=data})})}]),angular.module("app.subcontract.measure").controller("MeasureDetailController",["$scope","$state","$stateParams","MeasureDetailService",function($scope,$state,$stateParams,measureDetailService){$scope.$on("$ionicView.loaded",function(){measureDetailService.getMeasure($stateParams.id,function(data){$scope.measure=data}),measureDetailService.getMeasureDetail($stateParams.id,function(data){$scope.measureDetail=data})})}]),angular.module("app.subcontract.measure").controller("MeasureListController",["$scope","$state","$stateParams","MeasureListService","$ionicModal","SubContractCommonService","$ionicHistory","$ionicScrollDelegate",function($scope,$state,$stateParams,measureListService,$ionicModal,subContractCommonService,$ionicHistory,$ionicScrollDelegate){$scope.$on("$ionicView.loaded",function(){$scope.measureList=measureListService.getMeasureList(),$scope.hasNextPage=measureListService.hasNextPage()}),$scope.loadListData=function(){measureListService.loadListData(function(){$scope.fillData(),$scope.total=measureListService.getTotal(),$scope.$broadcast("scroll.infiniteScrollComplete")})},$scope.fillData=function(){$scope.measureList=measureListService.getMeasureList(),$scope.hasNextPage=measureListService.hasNextPage()},$scope.refreshListData=function(){measureListService.refreshListData(function(){$scope.fillData(),$scope.total=measureListService.getTotal(),$scope.$broadcast("scroll.refreshComplete")})},$scope.back=function(){measureListService.clearCachedData(),$ionicHistory.goBack()}}]),angular.module("app.subcontract.measure").controller("MeasureTeamListController",["$scope","$state","$stateParams","MeasureTeamListService",function($scope,$state,$stateParams,measureTeamListService){$scope.contractName=$stateParams.contractName,$scope.$on("$ionicView.loaded",function(){console.info($stateParams.contractId),measureTeamListService.getMeasureTeamDetail($stateParams.id,$stateParams.contractId,function(data){$scope.measureTeamDetails=data})})}]),angular.module("app.subcontract.measure").factory("MeasureContractListService",["YTService","UserService",function(YT,userService){return{getMeasureContractDetail:function(measureId,merchantId,successCallback){var data={m:13003002,t:"v_subcontract_measure_statistics_contract",order:"contractId"},filter=[{field:"id",value:measureId,operator:"=",relation:"and"},{field:"merchantId",value:merchantId,operator:"=",relation:"and"}];data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){successCallback(data.object)}})}}}]),angular.module("app.subcontract.measure").factory("MeasureDetailService",["YTService","UserService",function(YT,userService){return{getMeasure:function(measureId,successCallback){var data={m:13003002,t:"v_subcontract_measure"},filter=[{field:"id",value:measureId,operator:"=",relation:"and"}];data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){successCallback(data.object[0])}})},getMeasureDetail:function(measureId,successCallback){var data={m:13003002,t:"v_subcontract_measure_statistics_merchant"},filter=[{field:"id",value:measureId,operator:"=",relation:"and"}];data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){successCallback(data.object)}})}}}]),angular.module("app.subcontract.measure").factory("MeasureListService",["YTService","UserService",function(YT,userService){var measureList=[],pageIndex=0,pageSize=10,total=0,hasNextPage=!0;return{getMeasureList:function(){return measureList},hasNextPage:function(){return hasNextPage},loadListData:function(successCallback){++pageIndex;var self=this;YT.query({data:self.getSearchData(),successCallback:function(data){self.loadListDataCallback(data),successCallback.call()}})},refreshListData:function(successCallBack){this.clearCachedData(),this.loadListData(successCallBack)},getSearchData:function(){var data={m:13003002,t:"v_subcontract_measure_statistics_time_mobile",order:"year desc,month desc",page:pageIndex,rows:pageSize},filter=this.getSearchFilter();return data.filter=JSON.stringify(filter),data},getSearchFilter:function(){var filter=[];return filter.push({field:"orgId",value:userService.getRootOrgId(),operator:"=",relation:"AND"}),filter},loadListDataCallback:function(data){for(var pageInfo=data.object,i=0;i<pageInfo.items.length;i++)total=(parseFloat(total)+parseFloat(pageInfo.items[i].amount)).toFixed(2),measureList.push(pageInfo.items[i]);hasNextPage=!(pageIndex>=pageInfo.pageCount)},clearCachedData:function(){pageIndex=0,total=0,hasNextPage=!0,measureList=[]},getTotal:function(){return total}}}]),angular.module("app.subcontract.measure").factory("MeasureTeamListService",["YTService","UserService",function(YT,userService){return{getMeasureTeamDetail:function(measureId,contractId,successCallback){var data={m:13003002,t:"v_subcontract_measure_statistics_team",order:"teamId"},filter=[{field:"id",value:measureId,operator:"=",relation:"and"},{field:"contractId",value:contractId,operator:"=",relation:"and"}];data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){successCallback(data.object)}})}}}]),angular.module("app.subcontract.person").controller("PersonDetailController",["$scope","$state","$stateParams","PersonDetailService","YTService",function($scope,$state,$stateParams,personDetailService,YTService){$scope.$on("$ionicView.loaded",function(){$scope.attachment=!1,personDetailService.getPersonDetail($stateParams.personId,function(data){$scope.personDetail=data,1==$scope.personDetail.special?$scope.attachment=!0:$scope.attachment=!1}),personDetailService.getPersonAttach($stateParams.personId,function(normalAttach,specialAttach){$scope.normalAttach=normalAttach,$scope.specialAttach=specialAttach}),personDetailService.getPersonWorkDays($stateParams.personId,function(result){$scope.workDays=result}),personDetailService.getPersonWorkHours($stateParams.personId,function(result){$scope.workHours=result})}),$scope.download=function(attach){YTService.download(attach)}}]),angular.module("app.subcontract.person").controller("PersonListController",["$scope","$state","$stateParams","PersonListService","$ionicModal","SubContractCommonService","$ionicHistory","$ionicScrollDelegate","YTService","$ionicPopup","$filter",function($scope,$state,$stateParams,personListService,$ionicModal,subContractCommonService,$ionicHistory,$ionicScrollDelegate,ytService,$ionicPopup,$filter){$scope.$on("$ionicView.loaded",function(){$scope.personList=personListService.getPersonList(),$scope.hasNextPage=personListService.hasNextPage(),subContractCommonService.queryMerchantList(13002001,function(result){$scope.merchantList=result}),subContractCommonService.queryTeamList(13002001,function(result){$scope.teamList=result}),subContractCommonService.queryWorkTypeList(13002001,function(result){$scope.workTypeList=result}),$scope.condition=personListService.getCondition()}),$scope.loadListData=function(){personListService.loadListData(function(){$scope.fillData(),$scope.recordCount=personListService.getRecordCount(),$scope.$broadcast("scroll.infiniteScrollComplete")})},$scope.fillData=function(){$scope.personList=personListService.getPersonList(),$scope.hasNextPage=personListService.hasNextPage()},$scope.refreshListData=function(){personListService.refreshListData(function(){$scope.fillData(),$scope.$broadcast("scroll.refreshComplete")})},$scope.getClassName=function(worktypeId){return worktypeId<=7?"smart-mark royal-bg":worktypeId<=15?"smart-mark assertive-bg":"smart-mark balanced-bg"},$scope.search=function(){personListService.clearCachedData(),$ionicScrollDelegate.scrollTop(),$scope.loadListData()},$scope.clearSearchText=function(){$scope.condition.merchantId=-1,$scope.condition.name="",$scope.condition.telphone="",$scope.condition.idcard="",$scope.condition.nativeplace="",$scope.condition.age="",$scope.condition.worktypeId=-1,$scope.condition.special=-1,$scope.condition.id=-1,$scope.condition.name="",$scope.condition.inTimeBegin="",$scope.condition.inTimeEnd="",$scope.condition.outTimeBegin="",$scope.condition.outTimeEnd="",$scope.condition.workTypeName="全部",$scope.condition.teamName="全部",$scope.condition.isspecial="不限"},$scope.back=function(){personListService.clearCachedData(),personListService.resetCondition(),$ionicHistory.goBack()},$scope.openQueryMerchant=function(){$scope.modalQueryMerchant.show()},$ionicModal.fromTemplateUrl("query-merchant.html",{scope:$scope,animation:"slide-in-up"}).then(function(modal){$scope.modalQueryMerchant=modal}),$scope.hideQueryMerchant=function(merchantId){$scope.condition.merchantId=merchantId,$scope.search(),$scope.modalQueryMerchant.hide()},$scope.openQueryMore=function(){$scope.modalQueryMore.show()},$ionicModal.fromTemplateUrl("query-more.html",{scope:$scope,animation:"slide-in-up"}).then(function(modal){$scope.modalQueryMore=modal}),$scope.hideQueryMore=function(){$scope.search(),$scope.modalQueryMore.hide()},$scope.openKinds=function(){$scope.modalKinds.show()},$ionicModal.fromTemplateUrl("kinds.html",{scope:$scope,animation:"slide-in-right"}).then(function(modal){$scope.modalKinds=modal}),$scope.hideKinds=function(worktypeId,workTypeName){$scope.condition.worktypeId=worktypeId,$scope.condition.workTypeName=workTypeName,$scope.modalKinds.hide()},$scope.openGroup=function(){$scope.modalGroup.show()},$ionicModal.fromTemplateUrl("group.html",{scope:$scope,animation:"slide-in-right"}).then(function(modal){$scope.modalGroup=modal}),$scope.hideGroup=function(teamId,teamName){$scope.condition.id=teamId,$scope.condition.teamName=teamName,$scope.modalGroup.hide()},$scope.openIsSpecial=function(){$scope.isSpecial=!0},$scope.closeIsSpecial=function(isspecial){$scope.condition.special=isspecial,isspecial==-1?$scope.condition.isspecial="不限":0==isspecial?$scope.condition.isspecial="否":$scope.condition.isspecial="是",$scope.isSpecial=!1},$scope.close=function(){$scope.isSpecial=!1},$scope.inTimeBegin=YTM.initDatePicker({callback:function(){$scope.condition.inTimeBegin=$filter("date")($scope.inTimeBegin.date,"yyyy-MM-dd"),$scope.inTimerPopup.close()}}),$scope.openInTimeBegin=function(){$scope.inTimerPopup=$ionicPopup.show({templateUrl:"inTimeBegin.html",scope:$scope,cssClass:"customTimerPopover"}),$scope.inTimerPopup.then(function(res){})},$scope.inTimeEnd=YTM.initDatePicker({callback:function(){$scope.condition.inTimeEnd=$filter("date")($scope.inTimeEnd.date,"yyyy-MM-dd"),$scope.inTimerPopup.close()}}),$scope.openInTimeEnd=function(){$scope.inTimerPopup=$ionicPopup.show({templateUrl:"inTimeEnd.html",scope:$scope,cssClass:"customTimerPopover"}),$scope.inTimerPopup.then(function(res){})},$scope.outTimeBegin=YTM.initDatePicker({callback:function(){$scope.condition.outTimeBegin=$filter("date")($scope.outTimeBegin.date,"yyyy-MM-dd"),$scope.outimerPopup.close()}}),$scope.openOutTimeBegin=function(){$scope.outimerPopup=$ionicPopup.show({templateUrl:"outTimeBegin.html",scope:$scope,cssClass:"customTimerPopover"}),$scope.outimerPopup.then(function(res){})},$scope.outTimeEnd=YTM.initDatePicker({callback:function(){$scope.condition.outTimeEnd=$filter("date")($scope.outTimeEnd.date,"yyyy-MM-dd"),$scope.outimerPopup.close()}}),$scope.openOutTimeEnd=function(){$scope.outimerPopup=$ionicPopup.show({templateUrl:"outTimeEnd.html",scope:$scope,cssClass:"customTimerPopover"}),$scope.outimerPopup.then(function(res){console.log("Tapped!",res)})}}]),angular.module("app.subcontract.person").factory("PersonDetailService",["YTService","UserService","env",function(YT,userService,env){return{getPersonDetail:function(personId,successCallback){var data={m:13002001,t:"v_subcontract_person"},filter=[{field:"personId",value:personId,operator:"=",relation:"and"}];data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){var obj=data.object[0],ticket=userService.getTicket();null==obj.photourl||""==obj.photourl?obj.photourl="modules/subcontract/person/img/photo.png":(obj.photourl=obj.photourl.replace("\\","/"),obj.photourl=env.server+"/download.action?rnd="+Math.random()+"&tkt="+ticket+"&fileName="+obj.photourl),successCallback(obj)}})},getPersonAttach:function(personId,successCallback){var data={m:13002001,t:"subcontract_person_attach"},filter=[{field:"id",value:personId,operator:"=",relation:"and"}];data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){for(var normalAttach=[],specialAttach=[],i=0;i<data.object.length;i++){var obj=data.object[i];0==obj.typeId?normalAttach.push(obj):specialAttach.push(obj)}successCallback(normalAttach,specialAttach)}})},getPersonWorkDays:function(personId,successCallback){var self=this,data={m:13002002,t:"v_subcontract_person_attendance_workdays_statistics_personal"},filter=[{field:"personId",value:personId,operator:"=",relation:"and"},{field:"year",value:(new Date).getFullYear(),operator:"=",relation:"and"}];data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){successCallback(0==data.object.length?0:self.getMonthData(data.object[0]))}})},getPersonWorkHours:function(personId,successCallback){var self=this,data={m:13002002,t:"v_subcontract_person_attendance_workhours_statistics_personal"},filter=[{field:"personId",value:personId,operator:"=",relation:"and"},{field:"year",value:(new Date).getFullYear(),operator:"=",relation:"and"}];data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){successCallback(0==data.object.length?0:self.getMonthData(data.object[0]))}})},getMonthData:function(data){var month=(new Date).getMonth()+1;switch(month){case 1:return data.Jan;case 2:return data.Feb;case 3:return data.Mar;case 4:return data.Apr;case 5:return data.May;case 6:return data.Jun;case 7:return data.Jul;case 8:return data.Aug;case 9:return data.Sept;case 10:return data.Oct;case 11:return data.Nov;default:return data.Dec}}}}]),angular.module("app.subcontract.person").factory("PersonListService",["YTService","UserService","env",function(YT,userService,env){var personList=[],pageIndex=0,pageSize=10,recordCount=0,hasNextPage=!0,condition={merchantId:-1,name:"",telphone:"",idcard:"",nativeplace:"",age:"",worktypeId:-1,special:-1,id:-1,inTimeBegin:"",inTimeEnd:"",outTimeBegin:"",outTimeEnd:"",workTypeName:"全部",teamName:"全部",isspecial:"不限"};return{getPersonList:function(){return personList},hasNextPage:function(){return hasNextPage},getCondition:function(){return condition},loadListData:function(successCallback){++pageIndex;var self=this;YT.query({data:self.getSearchData(),successCallback:function(data){self.loadListDataCallback(data),successCallback.call()}})},refreshListData:function(successCallBack){this.clearCachedData(),this.loadListData(successCallBack)},getSearchData:function(){var data={m:13002001,t:"v_subcontract_person",order:"id,personId",page:pageIndex,rows:pageSize},filter=this.getSearchFilter();return data.filter=JSON.stringify(filter),data},loadListDataCallback:function(data){var pageInfo=data.object;recordCount=data.object.recordCount;for(var ticket=userService.getTicket(),i=0;i<pageInfo.items.length;i++){var person=pageInfo.items[i];null!=person.photourl&&""!=person.photourl?(person.photourl=person.photourl.replace("\\","/"),person.photourl=env.server+"/download.action?rnd="+Math.random()+"&tkt="+ticket+"&fileName="+person.photourl):person.photourl="modules/subcontract/person/img/photo.png",personList.push(person)}hasNextPage=!(pageIndex>=pageInfo.pageCount)},getSearchFilter:function(){var filter=[];return filter.push({field:"orgId",value:userService.getRootOrgId(),operator:"=",relation:"AND"}),condition.merchantId!=-1&&filter.push({field:"merchantId",value:condition.merchantId,operator:"=",relation:"AND"}),""!=condition.name&&filter.push({field:"name",value:"%"+condition.name+"%",operator:"like",relation:"AND"}),""!=condition.nativeplace&&filter.push({field:"nativeplace",value:"%"+condition.nativeplace+"%",operator:"like",relation:"AND"}),""!=condition.telphone&&filter.push({field:"telphone",value:"%"+condition.telphone+"%",operator:"like",relation:"AND"}),""!=condition.idcard&&filter.push({field:"idcard",value:"%"+condition.idcard+"%",operator:"like",relation:"AND"}),""!=condition.age&&filter.push({field:"age",value:condition.age,operator:"=",relation:"AND"}),condition.worktypeId!=-1&&filter.push({field:"worktypeId",value:condition.worktypeId,operator:"=",relation:"AND"}),condition.special!=-1&&filter.push({field:"special",value:condition.special,operator:"=",relation:"AND"}),condition.id!=-1&&filter.push({field:"id",value:condition.id,operator:"=",relation:"AND"}),""!=condition.inTimeBegin&&""!=condition.inTimeEnd?filter.push([{field:"inTime",value:condition.inTimeBegin,operator:">=",relation:"AND"},{field:"inTime",value:condition.inTimeEnd,operator:"<=",relation:"AND"}]):""!=condition.inTimeBegin?filter.push({field:"inTime",value:condition.inTimeBegin,operator:">=",relation:"AND"}):""!=condition.inTimeEnd&&filter.push({field:"inTime",value:condition.inTimeEnd,operator:"<=",relation:"AND"}),""!=condition.outTimeBegin&&""!=condition.outTimeEnd?filter.push([{field:"outTime",value:condition.outTimeBegin,operator:">=",relation:"AND"},{field:"outTime",value:condition.outTimeEnd,operator:"<=",relation:"AND"}]):""!=condition.outTimeBegin?filter.push({field:"outTime",value:condition.outTimeBegin,operator:">=",relation:"AND"}):""!=condition.inTimeEnd&&filter.push({field:"outTime",value:condition.outTimeEnd,operator:"<=",relation:"AND"}),filter},clearCachedData:function(){pageIndex=0,hasNextPage=!0,personList=[]},resetCondition:function(){condition={merchantId:-1,name:"",telphone:"",idcard:"",nativeplace:"",age:"",worktypeId:-1,special:-1,id:-1,inTimeBegin:"",inTimeEnd:"",outTimeBegin:"",outTimeEnd:"",workTypeName:"全部",teamName:"全部",isspecial:"不限"}},getRecordCount:function(){return recordCount}}}]),angular.module("app.subcontract.salary").controller("SalaryDetailController",["$scope","$state","$stateParams","SalaryDetailService","UserService","PersonDetailService",function($scope,$state,$stateParams,salaryDetailService,userService,personDetailService){$scope.$on("$ionicView.loaded",function(){personDetailService.getPersonDetail($stateParams.personId,function(data){$scope.personDetail=data}),salaryDetailService.getSalaryDetail($stateParams.personId,function(data){$scope.salaryDetails=data})})}]),angular.module("app.subcontract.salary").controller("SalaryListController",["$scope","$state","$stateParams","SalaryListService","$ionicModal","SubContractCommonService","$ionicHistory","$ionicScrollDelegate",function($scope,$state,$stateParams,salaryListService,$ionicModal,subContractCommonService,$ionicHistory,$ionicScrollDelegate){$scope.$on("$ionicView.loaded",function(){$scope.salaryList=salaryListService.getSalaryList(),$scope.hasNextPage=salaryListService.hasNextPage(),subContractCommonService.queryTeamList(13002001,function(result){$scope.teamList=result}),subContractCommonService.queryWorkTypeList(13002001,function(result){$scope.workTypeList=result}),$scope.condition=salaryListService.getCondition()}),$scope.loadListData=function(){salaryListService.loadListData(function(){$scope.fillData(),$scope.total=salaryListService.getTotal(),$scope.$broadcast("scroll.infiniteScrollComplete")})},$scope.fillData=function(){$scope.salaryList=salaryListService.getSalaryList(),$scope.hasNextPage=salaryListService.hasNextPage()},$scope.refreshListData=function(){salaryListService.refreshListData(function(){$scope.fillData(),$scope.$broadcast("scroll.refreshComplete")})},$scope.getClassName=function(worktypeId){return worktypeId<=7?"smart-mark royal-bg":worktypeId<=15?"smart-mark assertive-bg":"smart-mark balanced-bg"},$scope.back=function(){salaryListService.clearCachedData(),salaryListService.resetCondition(),$ionicHistory.goBack()},$scope.search=function(){salaryListService.clearCachedData(),$ionicScrollDelegate.scrollTop(),$scope.loadListData()},$scope.clearSearchText=function(){$scope.condition.teamId=-1,$scope.condition.personName="",$scope.condition.telphone="",$scope.condition.idcard="",$scope.condition.nativeplace="",$scope.condition.age="",$scope.condition.worktypeId=-1,$scope.condition.calcTypeId=-1,$scope.condition.worktypeName="不限",$scope.condition.calcTypeName="不限"},$scope.openTeam=function(){$scope.modalTeams.show()},$ionicModal.fromTemplateUrl("query-team.html",{scope:$scope,animation:"slide-in-right"}).then(function(modal){$scope.modalTeams=modal}),$scope.hideQueryTeam=function(teamId){$scope.condition.teamId=teamId,$scope.search(),$scope.modalTeams.hide()},$ionicModal.fromTemplateUrl("kinds.html",{scope:$scope,animation:"slide-in-right"}).then(function(modal){$scope.modalKinds=modal}),$scope.openKinds=function(){$scope.modalKinds.show()},$ionicModal.fromTemplateUrl("kinds.html",{scope:$scope,animation:"slide-in-right"}).then(function(modal){$scope.modalKinds=modal}),$scope.hideKinds=function(worktypeId,workTypeName){$scope.condition.worktypeId=worktypeId,$scope.condition.worktypeName=workTypeName,$scope.modalKinds.hide()},$scope.openCalcType=function(){$scope.calcType=!0},$scope.closeCalc=function(calcTypeId,calcTypeName){$scope.condition.calcTypeId=calcTypeId,$scope.condition.calcTypeName=calcTypeName,$scope.calcType=!1},$scope.close=function(){$scope.calcType=!1},$scope.openQueryMore=function(){$scope.modalQueryMore.show()},$ionicModal.fromTemplateUrl("query-more.html",{scope:$scope,animation:"slide-in-up"}).then(function(modal){$scope.modalQueryMore=modal}),$scope.hideQueryMore=function(){$scope.search(),$scope.modalQueryMore.hide()}}]),angular.module("app.subcontract.salary").factory("SalaryDetailService",["YTService","UserService","env",function(YT,userService,env){return{getSalaryDetail:function(personId,successCallback){var data={m:13002003,t:"v_subcontract_person_salarystatistics_personal",order:"recordYear desc,recordMonth desc"},filter=[{field:"personId",value:personId,operator:"=",relation:"and"}];data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){successCallback(data.object)}})}}}]),angular.module("app.subcontract.salary").factory("SalaryListService",["YTService","UserService","env",function(YT,userService,env){var salaryList=[],pageIndex=0,pageSize=10,hasNextPage=!0,total=0,condition={teamId:-1,personName:"",telphone:"",idcard:"",nativeplace:"",age:"",worktypeId:-1,worktypeName:"不限",calcTypeId:-1,calcTypeName:"不限"};return{getSalaryList:function(){return salaryList},hasNextPage:function(){return hasNextPage},getCondition:function(){return condition},loadListData:function(successCallback){++pageIndex;var self=this;YT.query({data:self.getSearchData(),successCallback:function(data){self.loadListDataCallback(data),successCallback.call()}})},refreshListData:function(successCallBack){this.clearCachedData(),this.loadListData(successCallBack)},getSearchData:function(){var data={m:13002003,t:"v_subcontract_person_salarystatistics_personal_month",order:"teamId,personId",page:pageIndex,rows:pageSize},filter=this.getSearchFilter();return data.filter=JSON.stringify(filter),data},getSearchFilter:function(){var filter=[];return filter.push({field:"orgId",value:userService.getRootOrgId(),operator:"=",relation:"AND"}),condition.teamId!=-1&&filter.push({field:"teamId",value:condition.teamId,operator:"=",relation:"AND"}),""!=condition.personName&&filter.push({field:"personName",value:"%"+condition.personName+"%",operator:"like",relation:"AND"}),""!=condition.nativeplace&&filter.push({field:"nativeplace",value:"%"+condition.nativeplace+"%",operator:"like",relation:"AND"}),""!=condition.telphone&&filter.push({field:"telphone",value:"%"+condition.telphone+"%",operator:"like",relation:"AND"}),""!=condition.idcard&&filter.push({field:"idcard",value:"%"+condition.idcard+"%",operator:"like",relation:"AND"}),""!=condition.age&&filter.push({field:"age",value:condition.age,operator:"=",relation:"AND"}),condition.worktypeId!=-1&&filter.push({field:"worktypeId",value:condition.worktypeId,operator:"=",relation:"AND"}),condition.calcTypeId!=-1&&filter.push({field:"calculationId",value:condition.calcTypeId,operator:"=",relation:"AND"}),filter},loadListDataCallback:function(data){for(var pageInfo=data.object,ticket=userService.getTicket(),i=0;i<pageInfo.items.length;i++){var person=pageInfo.items[i];null!=person.photourl&&""!=person.photourl?(person.photourl=person.photourl.replace("\\","/"),person.photourl=env.server+"/download.action?rnd="+Math.random()+"&tkt="+ticket+"&fileName="+person.photourl):person.photourl="modules/subcontract/person/img/photo.png",person.nowMonthSalary=this.getMonthData(person),total=(parseFloat(total)+parseFloat(person.nowMonthSalary)).toFixed(2),salaryList.push(person)}hasNextPage=!(pageIndex>=pageInfo.pageCount)},resetCondition:function(){condition={teamId:-1,personName:"",
telphone:"",idcard:"",nativeplace:"",age:"",worktypeId:-1,worktypeName:"不限",calcTypeName:"不限",calcTypeId:-1}},clearCachedData:function(){total=0,pageIndex=0,hasNextPage=!0,salaryList=[]},getMonthData:function(data){var month=(new Date).getMonth()+1;switch(month){case 1:return data.Jan;case 2:return data.Feb;case 3:return data.Mar;case 4:return data.Apr;case 5:return data.May;case 6:return data.Jun;case 7:return data.Jul;case 8:return data.Aug;case 9:return data.Sept;case 10:return data.Oct;case 11:return data.Nov;default:return data.Dec}},getTotal:function(){return total}}}]),angular.module("app.subcontract.settlement").controller("SettlementDetailController",["$scope","$state","$stateParams","SettlementDetailService","YTService","$ionicHistory","UserService","env","$cordovaToast","$ionicPopup","LocalStorageService","$injector",function($scope,$state,$stateParams,settlementDetailService,YTService,$ionicHistory,userService,env,$cordovaToast,$ionicPopup,localStorageService,$injector){$scope.$on("$ionicView.loaded",function(){settlementDetailService.getSettlement($stateParams.settlementId,function(data){$scope.settlement=data}),settlementDetailService.getSettlementDetail($stateParams.settlementId,"合同内",function(data){$scope.settlementInDetails=data,0==$scope.settlementInDetails.length?$scope.hasInside=!1:($scope.settlementInTotal=settlementDetailService.getSettlementInTotal(),$scope.hasInside=!0)}),settlementDetailService.getSettlementDetail($stateParams.settlementId,"合同外",function(data){$scope.settlementOutDetails=data,0==$scope.settlementOutDetails.length?$scope.hasOutside=!1:($scope.settlementOutTotal=settlementDetailService.getSettlementOutTotal(),$scope.hasOutside=!0)}),settlementDetailService.getSettlementMaterialDeduction($stateParams.settlementId,function(data){$scope.settlementMaterialDeductions=data,0==$scope.settlementMaterialDeductions.length?$scope.hasMaterialDeduction=!1:($scope.deductionTotal=settlementDetailService.getDeductionTotal(),$scope.hasMaterialDeduction=!0)}),settlementDetailService.getSettlementOtherExpenses($stateParams.settlementId,function(data){$scope.settlementOtherExpenses=data,0==$scope.settlementOtherExpenses.length?$scope.hasOtherExpense=!1:($scope.chargedTotal=settlementDetailService.getChargedTotal(),$scope.sumTotal=settlementDetailService.getSumTotal(),$scope.otherTotal=settlementDetailService.getOtherTotal(),$scope.hasOtherExpense=!0)})}),$scope.download=function(attach){var url=attach.attachUrl.toLocaleLowerCase(),ticket=userService.getTicket();if(url.indexOf(".jpg")>=0||url.indexOf(".jpeg")>=0||url.indexOf(".png")>=0||url.indexOf(".bmp")>=0||url.indexOf(".gif")>=0)url=attach.url.replace("\\","/"),url=env.server+"download.action?rnd="+Math.random()+"&tkt="+ticket+"&fileName="+url,PhotoViewer.show(url);else{var confirmPopup=$ionicPopup.confirm({title:"提示",template:"该附件必须下载才能查看,确定下载么?",cancelText:"取消",okText:"确定"});confirmPopup.then(function(res){if(res){var obj=[{name:attach.attachName,url:attach.attachUrl}];downloadTool.init({attachList:obj,server:env.server,injector:$injector,open:!0,ticket:ticket,storageService:localStorageService,joinQueue:function(item){},startDownload:function(){$cordovaToast.showShortBottom("文件下载中,请稍后")},success:function(item,fileEntry){},fail:function(item){$ionicPopup.alert({title:"提示",template:item.name+"下载失败,请稍后再试!"})}}),downloadTool.download(obj[0])}})}},$scope.back=function(){settlementDetailService.clearTotal(),$ionicHistory.goBack()}}]),angular.module("app.subcontract.settlement").controller("SettlementListController",["$scope","$state","$stateParams","SettlementListService","$ionicModal","SubContractCommonService","$ionicHistory","$ionicScrollDelegate","$filter","$ionicPopup",function($scope,$state,$stateParams,settlementListService,$ionicModal,subContractCommonService,$ionicHistory,$ionicScrollDelegate,$filter,$ionicPopup){$scope.$on("$ionicView.loaded",function(){$scope.settlementList=settlementListService.getSettlementList(),$scope.hasNextPage=settlementListService.hasNextPage(),subContractCommonService.queryContractList(13003003,function(result){$scope.contractList=result}),subContractCommonService.queryMerchantList(13002001,function(result){$scope.merchantList=result}),$scope.condition=settlementListService.getCondition()}),$scope.loadListData=function(){console.info(1),settlementListService.loadListData(function(){$scope.fillData(),$scope.total=settlementListService.getTotal(),$scope.$broadcast("scroll.infiniteScrollComplete")})},$scope.fillData=function(){$scope.settlementList=settlementListService.getSettlementList(),$scope.hasNextPage=settlementListService.hasNextPage()},$scope.refreshListData=function(){settlementListService.refreshListData(function(){$scope.fillData(),$scope.$broadcast("scroll.refreshComplete")})},$scope.search=function(){settlementListService.clearCachedData(),$ionicScrollDelegate.scrollTop(),$scope.loadListData()},$scope.clearSearchText=function(){$scope.condition.merchantId=-1,$scope.condition.contractId=-1,$scope.condition.settlementTimeBegin="",$scope.condition.settlementTimeEnd="",$scope.condition.merchantName="不限"},$scope.back=function(){settlementListService.clearCachedData(),settlementListService.resetCondition(),$ionicHistory.goBack()},$scope.openQueryContract=function(){$scope.modalQueryContract.show()},$ionicModal.fromTemplateUrl("query-contract.html",{scope:$scope,animation:"slide-in-up"}).then(function(modal){$scope.modalQueryContract=modal}),$scope.hideQueryContract=function(contractId){$scope.condition.contractId=contractId,$scope.search(),$scope.modalQueryContract.hide()},$scope.openMerchant=function(){$scope.modalMerchant.show()},$ionicModal.fromTemplateUrl("merchant.html",{scope:$scope,animation:"slide-in-right"}).then(function(modal){$scope.modalMerchant=modal}),$scope.hideMerchant=function(merchantId,merchantName){$scope.condition.merchantId=merchantId,$scope.condition.merchantName=merchantName,$scope.modalMerchant.hide()},$scope.openQueryMore=function(){$scope.modalQueryMore.show()},$ionicModal.fromTemplateUrl("query-more.html",{scope:$scope,animation:"slide-in-up"}).then(function(modal){$scope.modalQueryMore=modal}),$scope.hideQueryMore=function(){$scope.search(),$scope.modalQueryMore.hide()},$scope.settlementTimeBegin=YTM.initDatePicker({callback:function(){$scope.condition.settlementTimeBegin=$filter("date")($scope.settlementTimeBegin.date,"yyyy-MM-dd"),$scope.settlementTimerPopup.close()}}),$scope.openInTimeBegin=function(){$scope.settlementTimerPopup=$ionicPopup.show({templateUrl:"settlementTimeBegin.html",scope:$scope,cssClass:"customTimerPopover"}),$scope.settlementTimerPopup.then(function(res){})},$scope.settlementTimeEnd=YTM.initDatePicker({callback:function(){$scope.condition.settlementTimeEnd=$filter("date")($scope.settlementTimeEnd.date,"yyyy-MM-dd"),$scope.settlementTimerPopup.close()}}),$scope.openInTimeEnd=function(){$scope.settlementTimerPopup=$ionicPopup.show({templateUrl:"settlementTimeEnd.html",scope:$scope,cssClass:"customTimerPopover"}),$scope.settlementTimerPopup.then(function(res){})}}]),angular.module("app.subcontract.settlement").factory("SettlementDetailService",["YTService","UserService",function(YT,userService){var settlementInTotal=0,settlementOutTotal=0,deductionTotal=0,chargedTotal=0,sumTotal=0,otherTotal=0;return{getSettlement:function(settlementId,successCallback){var data={m:13003003,t:"v_subcontract_settlement"},filter=[{field:"id",value:settlementId,operator:"=",relation:"and"}];data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){var obj=data.object[0];successCallback(obj)}})},getSettlementDetail:function(settlementId,scope,successCallback){var data={m:13003003,t:"subcontract_settlement_detail"},filter=[{field:"id",value:settlementId,operator:"=",relation:"and"},{field:"scope",value:scope,operator:"=",relation:"and"}];data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){for(var obj=data.object,i=0;i<obj.length;i++)"合同内"==scope?(console.info(settlementInTotal+"-"+obj[i].total),settlementInTotal=(parseFloat(settlementInTotal)+parseFloat(obj[i].total)).toFixed(2)):settlementOutTotal=(parseFloat(settlementOutTotal)+parseFloat(obj[i].total)).toFixed(2);successCallback(obj)}})},getSettlementMaterialDeduction:function(settlementId,successCallback){var data={m:13003003,t:"subcontract_settlement_materialdeduction"},filter=[{field:"id",value:settlementId,operator:"=",relation:"and"}];data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){for(var obj=data.object,i=0;i<obj.length;i++)deductionTotal=(parseFloat(deductionTotal)+parseFloat(obj[i].deductAmount)).toFixed(2);successCallback(obj)}})},getSettlementOtherExpenses:function(settlementId,successCallback){var data={m:13003003,t:"subcontract_settlement_otherexpenses"},filter=[{field:"id",value:settlementId,operator:"=",relation:"and"}];data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){for(var obj=data.object,i=0;i<obj.length;i++)1==obj[i].chargeTypeId?chargedTotal=(parseFloat(chargedTotal)+parseFloat(obj[i].amount)).toFixed(2):sumTotal=(parseFloat(sumTotal)+parseFloat(obj[i].amount)).toFixed(2);otherTotal=sumTotal-chargedTotal,successCallback(obj)}})},getSettlementInTotal:function(){return settlementInTotal},getSettlementOutTotal:function(){return settlementOutTotal},getDeductionTotal:function(){return deductionTotal},getChargedTotal:function(){return chargedTotal},getSumTotal:function(){return sumTotal},getOtherTotal:function(){return otherTotal},clearTotal:function(){settlementInTotal=0,settlementOutTotal=0,deductionTotal=0,chargedTotal=0,sumTotal=0,otherTotal=0}}}]),angular.module("app.subcontract.settlement").factory("SettlementListService",["YTService","UserService",function(YT,userService){var settlementList=[],pageIndex=0,pageSize=10,hasNextPage=!0,total=0,condition={merchantId:-1,contractId:-1,settlementTimeBegin:"",settlementTimeEnd:"",merchantName:"不限"};return{getSettlementList:function(){return settlementList},hasNextPage:function(){return hasNextPage},getCondition:function(){return condition},loadListData:function(successCallback){++pageIndex;var self=this;YT.query({data:self.getSearchData(),successCallback:function(data){self.loadListDataCallback(data),successCallback.call()}})},refreshListData:function(successCallBack){this.clearCachedData(),this.loadListData(successCallBack)},getSearchData:function(){var data={m:13003003,t:"v_subcontract_settlement",order:"id",page:pageIndex,rows:pageSize},filter=this.getSearchFilter();return data.filter=JSON.stringify(filter),data},loadListDataCallback:function(data){for(var pageInfo=data.object,i=0;i<pageInfo.items.length;i++){var settlement=pageInfo.items[i];total=(parseFloat(total)+parseFloat(settlement.subcontractCumulativeAmount)).toFixed(2),settlementList.push(settlement)}hasNextPage=!(pageIndex>=pageInfo.pageCount)},getSearchFilter:function(){var filter=[];return filter.push({field:"orgId",value:userService.getRootOrgId(),operator:"=",relation:"AND"}),condition.merchantId!=-1&&filter.push({field:"merchantId",value:condition.merchantId,operator:"=",relation:"AND"}),condition.contractId!=-1&&filter.push({field:"contractId",value:condition.contractId,operator:"=",relation:"AND"}),""!=condition.settlementTimeBegin&&""!=condition.settlementTimeEnd?filter.push([{field:"settlementDate",value:condition.settlementTimeBegin,operator:">=",relation:"AND"},{field:"settlementDate",value:condition.settlementTimeEnd,operator:"<=",relation:"AND"}]):""!=condition.settlementTimeBegin?filter.push({field:"settlementDate",value:condition.settlementTimeBegin,operator:">=",relation:"AND"}):""!=condition.settlementTimeEnd&&filter.push({field:"settlementDate",value:condition.settlementTimeEnd,operator:"<=",relation:"AND"}),filter},clearCachedData:function(){pageIndex=0,total=0,hasNextPage=!0,settlementList=[]},resetCondition:function(){condition={merchantId:-1,contractId:-1,settlementTimeBegin:"",settlementTimeEnd:"",merchantName:"不限"}},getTotal:function(){return total}}}]),angular.module("app.subcontract.team").controller("TeamDetailController",["$scope","$state","$stateParams","TeamDetailService",function($scope,$state,$stateParams,teamDetailService){$scope.$on("$ionicView.loaded",function(){teamDetailService.getTeamDetail($stateParams.id,function(data){$scope.teamDetail=data}),teamDetailService.getTeamWorkContentDetail($stateParams.id,function(data){$scope.teamWorkContentDetail=data})})}]),angular.module("app.subcontract.team").controller("TeamListController",["$scope","$state","$stateParams","TeamListService","$ionicModal","SubContractCommonService","$ionicHistory","$ionicScrollDelegate",function($scope,$state,$stateParams,teamListService,$ionicModal,subContractCommonService,$ionicHistory,$ionicScrollDelegate){$scope.$on("$ionicView.loaded",function(){$scope.teamList=teamListService.getTeamList(),$scope.hasNextPage=teamListService.hasNextPage(),subContractCommonService.queryMerchantList(13002001,function(result){$scope.merchantList=result}),$scope.condition=teamListService.getCondition(),$scope.searchText=""}),$scope.loadListData=function(){teamListService.loadListData(function(){$scope.fillData(),$scope.$broadcast("scroll.infiniteScrollComplete")})},$scope.fillData=function(){$scope.teamList=teamListService.getTeamList(),$scope.hasNextPage=teamListService.hasNextPage()},$scope.refreshListData=function(){teamListService.refreshListData(function(){$scope.fillData(),$scope.$broadcast("scroll.refreshComplete")})},$scope.getClassName=function(worktypeId){return worktypeId<=7?"smart-mark royal-bg":worktypeId<=15?"smart-mark assertive-bg":"smart-mark balanced-bg"},$scope.back=function(){teamListService.clearCachedData(),teamListService.resetCondition(),$ionicHistory.goBack()},$scope.searchFilter=function(merchant){return null==$scope.searchText||""==$scope.searchText||merchant.name.indexOf($scope.searchText)!=-1},$scope.clearCondition=function(){$scope.condition.name="",$scope.condition.leaderName="",$scope.condition.number="",$scope.condition.merchantId=-1},$scope.clearSearchText=function(){$scope.searchText=""},$scope.openQueryMerchant=function(){$scope.modalQueryMerchant.show()},$scope.openQueryMore=function(){$scope.modalQueryMore.show()},$scope.hideQueryMerchant=function(merchantId){$scope.condition.merchantId=merchantId,$scope.search(),$scope.modalQueryMerchant.hide()},$scope.hideQueryMore=function(){$scope.search(),$scope.modalQueryMore.hide()},$scope.search=function(){teamListService.clearCachedData(),$ionicScrollDelegate.scrollTop(),$scope.loadListData()},$ionicModal.fromTemplateUrl("query-merchant.html",{scope:$scope,animation:"slide-in-up"}).then(function(modal){$scope.modalQueryMerchant=modal}),$ionicModal.fromTemplateUrl("query-more.html",{scope:$scope,animation:"slide-in-up"}).then(function(modal){$scope.modalQueryMore=modal})}]),angular.module("app.subcontract.team").factory("TeamDetailService",["YTService","UserService",function(YT,userService){return{getTeamDetail:function(teamId,successCallback){var data={m:13002001,t:"v_subcontract_team"},filter=[{field:"id",value:teamId,operator:"=",relation:"and"}];data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){successCallback(data.object[0])}})},getTeamWorkContentDetail:function(teamId,successCallback){var data={m:13002001,t:"v_subcontract_team_workcontent_mobile"},filter=[{field:"id",value:teamId,operator:"=",relation:"and"}];data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){successCallback(data.object)}})}}}]),angular.module("app.subcontract.team").factory("TeamListService",["YTService","UserService",function(YT,userService){var teamList=[],pageIndex=0,pageSize=10,hasNextPage=!0,condition={merchantId:-1,name:"",number:"",leaderName:""};return{loadListData:function(successCallback){++pageIndex;var self=this;YT.query({data:self.getSearchData(),successCallback:function(data){self.loadListDataCallback(data),successCallback.call()}})},getSearchData:function(){var data={m:13002001,t:"v_subcontract_team_mobile",order:"id",page:pageIndex,rows:pageSize},filter=this.getSearchFilter();return data.filter=JSON.stringify(filter),data},loadListDataCallback:function(data){for(var pageInfo=data.object,i=0;i<pageInfo.items.length;i++)teamList.push(pageInfo.items[i]);hasNextPage=!(pageIndex>=pageInfo.pageCount)},getSearchFilter:function(){var filter=[];return filter.push({field:"orgId",value:userService.getRootOrgId(),operator:"=",relation:"AND"}),condition.merchantId!=-1&&filter.push({field:"merchantId",value:condition.merchantId,operator:"=",relation:"AND"}),""!=condition.name&&filter.push({field:"name",value:"%"+condition.name+"%",operator:"like",relation:"AND"}),""!=condition.number&&filter.push({field:"number",value:"%"+condition.number+"%",operator:"like",relation:"AND"}),""!=condition.leaderName&&filter.push({field:"leaderName",value:"%"+condition.leaderName+"%",operator:"like",relation:"AND"}),filter},refreshListData:function(successCallBack){this.clearCachedData(),this.loadListData(successCallBack)},clearCachedData:function(){pageIndex=0,hasNextPage=!0,teamList=[]},getTeamList:function(){return teamList},hasNextPage:function(){return hasNextPage},getCondition:function(){return condition},resetCondition:function(){condition={merchantId:-1,name:"",number:"",leaderName:""}}}}]),angular.module("app.contract.equipment.lease").controller("EquipmentLeaseChargesController",["$scope","$state","$stateParams","EquipmentLeaseService",function($scope,$state,$stateParams,EquipmentLeaseService){$scope.$on("$ionicView.loaded",function(){$scope.chargesInfo=EquipmentLeaseService.getCharges();for(var chargesInfo=EquipmentLeaseService.getCharges(),sum=0,i=0;i<chargesInfo.length;i++)sum+=parseFloat(chargesInfo[i].money);$scope.chargesSum=sum})}]),angular.module("app.contract.equipment.lease").controller("EquipmentLeaseDetailController",["$scope","$state","$stateParams","EquipmentLeaseService","$sce",function($scope,$state,$stateParams,EquipmentLeaseService,$sce){$scope.projectInfo=!0,$scope.workmoney=!0,$scope.leaseDetail=!0,$scope.quality=!0,$scope.remark=!0,$scope.attachment=!0,$scope.bill=!0,$scope.projectInfoShow=function(){$scope.projectInfo=!$scope.projectInfo},$scope.workmoneyShow=function(){$scope.workmoney=!$scope.workmoney},$scope.leaseDetailShow=function(){$scope.leaseDetail=!$scope.leaseDetail},$scope.qualityShow=function(){$scope.quality=!$scope.quality},$scope.remarkShow=function(){$scope.remark=!$scope.remark},$scope.attachmentShow=function(){$scope.attachment=!$scope.attachment},$scope.billShow=function(){$scope.bill=!$scope.bill},$scope.$on("$ionicView.loaded",function(){EquipmentLeaseService.queryDetail($stateParams.id,function(data){$scope.leaseInfo=data;var beginTime=new Date(data.beginDate.replace(/-/g,"/")),endTime=new Date(data.endDate.replace(/-/g,"/"));$scope.totalDays=(endTime.getTime()-beginTime.getTime())/36e5/24,$scope.formatMoney=YTM.tool.money.numberToChineseCurrency(data.cost),$scope.memo=$sce.trustAsHtml(data.memo)}),EquipmentLeaseService.queryMaterial($stateParams.id,function(data){$scope.equipmentLength=data.length}),EquipmentLeaseService.queryCharges($stateParams.id,function(data){$scope.chargesLength=data.length}),EquipmentLeaseService.queryInvoice($stateParams.id,function(data){$scope.invoiceLength=data.length}),EquipmentLeaseService.queryAttach($stateParams.id,function(data){$scope.attachInfo=data})}),$scope.downloadAttach=function(attach){EquipmentLeaseService.downloadAttach(attach)}}]),angular.module("app.contract.equipment.lease").controller("EquipmentLeaseEquipmentController",["$scope","$state","$stateParams","EquipmentLeaseService",function($scope,$state,$stateParams,EquipmentLeaseService){$scope.$on("$ionicView.loaded",function(){$scope.equipmentInfo=EquipmentLeaseService.getEquipment();for(var equipmentInfo=EquipmentLeaseService.getEquipment(),sum=0,i=0;i<equipmentInfo.length;i++)sum+=parseFloat(equipmentInfo[i].rentPrice*equipmentInfo[i].quantity);$scope.equipmentSum=sum})}]),angular.module("app.contract.equipment.lease").controller("EquipmentLeaseInvoiceController",["$scope","$state","$stateParams","EquipmentLeaseService",function($scope,$state,$stateParams,EquipmentLeaseService){$scope.$on("$ionicView.loaded",function(){$scope.invoiceInfo=EquipmentLeaseService.getInvoice()})}]),angular.module("app.contract.equipment.lease").controller("EquipmentLeaseListController",["$scope","$state","$ionicHistory","$ionicModal","$ionicScrollDelegate","EquipmentLeaseService","$ionicViewSwitcher",function($scope,$state,$ionicHistory,$ionicModal,$ionicScrollDelegate,EquipmentLeaseService,$ionicViewSwitcher){$scope.condition=EquipmentLeaseService.getCondition(),$scope.$on("$ionicView.loaded",function(){$scope.leaseList=EquipmentLeaseService.getServiceData(),$scope.hasNextPage=EquipmentLeaseService.hasNextPage()}),$scope.loadListData=function(){EquipmentLeaseService.loadListData(function(){$scope.fillData(),$scope.$broadcast("scroll.infiniteScrollComplete")})},$scope.refreshListData=function(){EquipmentLeaseService.refreshListData(function(){$scope.fillData(),$scope.$broadcast("scroll.refreshComplete")})},$scope.fillData=function(){$scope.leaseList=EquipmentLeaseService.getServiceData(),$scope.hasNextPage=EquipmentLeaseService.hasNextPage()},$scope.searchData=function(){$scope.modalQueryMore.hide(),$scope.modal.hide(),EquipmentLeaseService.clearCachedData(),$ionicScrollDelegate.scrollTop(),$scope.loadListData()},$scope.back=function(){EquipmentLeaseService.clearCachedData(),EquipmentLeaseService.resetCondition(),$state.go("menu"),$ionicViewSwitcher.nextDirection("back")},$ionicModal.fromTemplateUrl("contract-status.html",{scope:$scope,animation:"slide-in-up"}).then(function(modal){$scope.modal=modal}),$scope.openContractStatus=function(){$scope.modal.show()},$scope.hideContractStatus=function(){$scope.modal.hide()},$ionicModal.fromTemplateUrl("query-more.html",{scope:$scope,animation:"slide-in-up"}).then(function(modal){$scope.modalQueryMore=modal}),$scope.openQueryMore=function(){$scope.modalQueryMore.show()},$scope.hideQueryMore=function(){$scope.modalQueryMore.hide()},$scope.clearSearchText=function(){EquipmentLeaseService.clearSearchText(),$scope.condition=EquipmentLeaseService.getCondition()},$scope.startTime=YTM.initDatePicker({callback:function(){$scope.condition.startTime=$filter("date")($scope.startTime.date,"yyyy-MM-dd"),$scope.startTimerPopup.close()}}),$scope.endTime=YTM.initDatePicker({callback:function(){$scope.condition.endTime=$filter("date")($scope.endTime.date,"yyyy-MM-dd"),$scope.endTimerPopup.close()}}),$scope.openStartTime=function(){$scope.startTimerPopup=$ionicPopup.show({templateUrl:"start-time.html",scope:$scope,cssClass:"customTimerPopover"}),$scope.startTimerPopup.then(function(res){console.log("Tapped!",res)})},$scope.openEndTime=function(){$scope.endTimerPopup=$ionicPopup.show({templateUrl:"end-time.html",scope:$scope,cssClass:"customTimerPopover"}),$scope.endTimerPopup.then(function(res){console.log("Tapped!",res)})}}]),angular.module("app.contract.equipment.lease").factory("EquipmentLeaseService",["YTService","UserService",function(YT,userService){var serviceData=[],pageIndex=0,pageSize=10,hasNextPage=!0,condition={statusId:-1,displayId:"",projectName:"",rentName:"",hireName:"",startTime:"",endTime:""},equipmentInfo=[],chargesInfo=[],invoiceInfo=[];return{clearSearchText:function(){condition={statusId:-1,displayId:"",projectName:"",hireName:"",rentName:"",startTime:"",endTime:""}},loadListData:function(successCallback){++pageIndex;var self=this;YT.query({data:self.getSearchData(),successCallback:function(data){self.loadListDataCallback(data),successCallback.call()}})},loadListDataCallback:function(data){for(var pageInfo=data.object,i=0;i<pageInfo.items.length;i++)serviceData.push(pageInfo.items[i]);hasNextPage=!(pageIndex>=pageInfo.pageCount)},refreshListData:function(successCallBack){this.clearCachedData(),this.loadListData(successCallBack)},clearCachedData:function(){pageIndex=0,hasNextPage=!0,serviceData=[]},getSearchData:function(){var data={m:6001006,t:"v_contract_equipmentleasing",order:"id desc",page:pageIndex,rows:pageSize},filter=this.getSearchFilter();return data.filter=JSON.stringify(filter),data},getSearchFilter:function(){var typeId=userService.getTypeId(),rootId=userService.getRootOrgId(),filter=[];return condition.statusId!=-1&&filter.push({field:"statusId",value:condition.statusId,operator:"=",relation:"AND"}),""!=condition.displayId&&"请输入合同编号"!=condition.displayId&&filter.push({field:"displayId",value:"%"+condition.displayId+"%",operator:"like",relation:"and"}),""!=condition.projectName&&"请输入工程名称"!=condition.projectName&&filter.push({field:"projectName",value:"%"+condition.projectName+"%",operator:"like",relation:"and"}),""!=condition.hireName&&"请输入租用单位"!=condition.hireName&&filter.push({field:"hireName",value:"%"+condition.hireName+"%",operator:"like",relation:"and"}),""!=condition.rentName&&"请输入出租单位"!=condition.rentName&&filter.push({field:"rentName",value:"%"+condition.rentName+"%",operator:"like",relation:"and"}),""!=condition.startTime&&""!=condition.endTime?filter.push([{field:"beginDate",value:condition.startTime,operator:">=",relation:"AND"},{field:"endDate",value:condition.endTime,operator:"<=",relation:"AND"}]):""!=condition.startTime?filter.push({field:"beginDate",value:condition.startTime,operator:">=",relation:"AND"}):""!=condition.endTime&&filter.push({field:"endDate",value:condition.endTime,operator:"<=",relation:"AND"}),filter.push({field:"statusId",value:2,operator:"<>",relation:"And"}),1==typeId?filter.push({field:"groupId",value:rootId,operator:"=",relation:""}):2==typeId?filter.push({field:"companyId",value:rootId,operator:"=",relation:""}):3==typeId&&filter.push({field:"orgId",value:rootId,operator:"=",relation:""}),filter},queryDetail:function(id,successCallback){var data={m:6001006,t:"v_contract_equipmentleasing"},filter=[{field:"id",value:id,operator:"=",relation:"and"}];data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){successCallback.call(this,data.object[0])}})},queryMaterial:function(id,successCallback){var data={m:6001006,t:"v_contract_equipmentleasing_info"},filter=[{field:"id",value:id,operator:"=",relation:"and"}];data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){equipmentInfo=data.object,successCallback.call(this,data.object)}})},queryCharges:function(id,successCallback){var data={m:6001006,t:"v_contract_equipmentleasing_charges"},filter=[{field:"id",value:id,operator:"=",relation:"and"}];data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){chargesInfo=data.object,successCallback.call(this,data.object)}})},queryInvoice:function(id,successCallback){var data={m:6001006,t:"v_contract_equipmentleasing_taxinvoice"},filter=[{field:"id",value:id,operator:"=",relation:"and"}];data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){invoiceInfo=data.object,successCallback.call(this,data.object)}})},queryAttach:function(id,successCallback){var data={m:6001006,t:"contract_equipmentleasing_attach"},filter=[{field:"id",value:id,operator:"=",relation:"and"}];data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){successCallback.call(this,data.object)}})},downloadAttach:function(attach){YT.download(attach)},resetCondition:function(){condition={statusId:-1,displayId:"",projectName:"",hireName:"",rentName:"",startTime:"",endTime:""}},getServiceData:function(){return serviceData},hasNextPage:function(){return hasNextPage},getCondition:function(){return condition},getEquipment:function(){return equipmentInfo},setEquipment:function(data){equipmentInfo=data},getCharges:function(){return chargesInfo},setCharges:function(data){chargesInfo=data},getInvoice:function(){return invoiceInfo},setInvoice:function(data){invoiceInfo=data}}}]),angular.module("app.contract.equipment.purchase").controller("EquipmentPurchaseChargesController",["$scope","$state","$stateParams","EquipmentPurchaseService",function($scope,$state,$stateParams,EquipmentPurchaseService){$scope.$on("$ionicView.loaded",function(){$scope.chargesInfo=EquipmentPurchaseService.getCharges();for(var chargesInfo=EquipmentPurchaseService.getCharges(),sum=0,i=0;i<chargesInfo.length;i++)sum+=parseFloat(chargesInfo[i].money);$scope.chargesSum=sum})}]),angular.module("app.contract.equipment.purchase").controller("EquipmentPurchaseDetailController",["$scope","$state","$stateParams","EquipmentPurchaseService","$sce",function($scope,$state,$stateParams,EquipmentPurchaseService,$sce){$scope.projectInfo=!0,$scope.workmoney=!0,$scope.purchaseDetail=!0,$scope.quality=!0,$scope.remark=!0,$scope.attachment=!0,$scope.bill=!0,$scope.projectInfoShow=function(){$scope.projectInfo=!$scope.projectInfo},$scope.workmoneyShow=function(){$scope.workmoney=!$scope.workmoney},$scope.purchaseDetailShow=function(){$scope.purchaseDetail=!$scope.purchaseDetail},$scope.qualityShow=function(){$scope.quality=!$scope.quality},$scope.remarkShow=function(){$scope.remark=!$scope.remark},$scope.attachmentShow=function(){$scope.attachment=!$scope.attachment},$scope.billShow=function(){$scope.bill=!$scope.bill},$scope.$on("$ionicView.loaded",function(){EquipmentPurchaseService.queryDetail($stateParams.id,function(data){$scope.purchaseInfo=data,$scope.formatMoney=YTM.tool.money.numberToChineseCurrency(data.cost),$scope.equipmentQualityText=$sce.trustAsHtml(data.equipmentQualityText),$scope.memo=$sce.trustAsHtml(data.memo)}),EquipmentPurchaseService.queryMaterial($stateParams.id,function(data){$scope.materialLength=data.length}),EquipmentPurchaseService.queryCharges($stateParams.id,function(data){$scope.chargesLength=data.length}),EquipmentPurchaseService.queryInvoice($stateParams.id,function(data){$scope.invoiceLength=data.length}),EquipmentPurchaseService.queryAttach($stateParams.id,function(data){$scope.attachInfo=data})}),$scope.downloadAttach=function(attach){EquipmentPurchaseService.downloadAttach(attach)}}]),angular.module("app.contract.equipment.purchase").controller("EquipmentPurchaseEquipmentController",["$scope","$state","$stateParams","EquipmentPurchaseService",function($scope,$state,$stateParams,EquipmentPurchaseService){$scope.$on("$ionicView.loaded",function(){$scope.equipmentInfo=EquipmentPurchaseService.getEquipment();for(var equipmentInfo=EquipmentPurchaseService.getEquipment(),sum=0,i=0;i<equipmentInfo.length;i++)sum+=parseFloat(equipmentInfo[i].total);$scope.equipmentSum=sum})}]),angular.module("app.contract.equipment.purchase").controller("EquipmentPurchaseInvoiceController",["$scope","$state","$stateParams","EquipmentPurchaseService",function($scope,$state,$stateParams,EquipmentPurchaseService){$scope.$on("$ionicView.loaded",function(){$scope.invoiceInfo=EquipmentPurchaseService.getInvoice()})}]),angular.module("app.contract.equipment.purchase").controller("EquipmentPurchaseListController",["$scope","$state","$ionicHistory","$ionicModal","$ionicScrollDelegate","EquipmentPurchaseService","$ionicViewSwitcher",function($scope,$state,$ionicHistory,$ionicModal,$ionicScrollDelegate,EquipmentPurchaseService,$ionicViewSwitcher){$scope.condition=EquipmentPurchaseService.getCondition(),$scope.$on("$ionicView.loaded",function(){$scope.purchaseList=EquipmentPurchaseService.getServiceData(),$scope.hasNextPage=EquipmentPurchaseService.hasNextPage()}),$scope.loadListData=function(){EquipmentPurchaseService.loadListData(function(){$scope.fillData(),$scope.$broadcast("scroll.infiniteScrollComplete")})},$scope.refreshListData=function(){EquipmentPurchaseService.refreshListData(function(){$scope.fillData(),$scope.$broadcast("scroll.refreshComplete")})},$scope.fillData=function(){$scope.purchaseList=EquipmentPurchaseService.getServiceData(),$scope.hasNextPage=EquipmentPurchaseService.hasNextPage()},$scope.searchData=function(){$scope.modalQueryMore.hide(),$scope.modal.hide(),
EquipmentPurchaseService.clearCachedData(),$ionicScrollDelegate.scrollTop(),$scope.loadListData()},$scope.back=function(){EquipmentPurchaseService.clearCachedData(),EquipmentPurchaseService.resetCondition(),$state.go("menu"),$ionicViewSwitcher.nextDirection("back")},$ionicModal.fromTemplateUrl("contract-status.html",{scope:$scope,animation:"slide-in-up"}).then(function(modal){$scope.modal=modal}),$scope.openContractStatus=function(){$scope.modal.show()},$scope.hideContractStatus=function(){$scope.modal.hide()},$ionicModal.fromTemplateUrl("query-more.html",{scope:$scope,animation:"slide-in-up"}).then(function(modal){$scope.modalQueryMore=modal}),$scope.openQueryMore=function(){$scope.modalQueryMore.show()},$scope.hideQueryMore=function(){$scope.modalQueryMore.hide()},$scope.clearSearchText=function(){EquipmentPurchaseService.clearSearchText(),$scope.condition=EquipmentPurchaseService.getCondition()}}]),angular.module("app.contract.equipment.purchase").factory("EquipmentPurchaseService",["YTService","UserService",function(YT,userService){var serviceData=[],pageIndex=0,pageSize=10,hasNextPage=!0,condition={statusId:-1,displayId:"",projectName:"",purchaseName:"",supplyName:""},equipmentInfo=[],chargesInfo=[],invoiceInfo=[];return{clearSearchText:function(){condition={statusId:-1,displayId:"",projectName:"",purchaseName:"",supplyName:""}},loadListData:function(successCallback){++pageIndex;var self=this;YT.query({data:self.getSearchData(),successCallback:function(data){self.loadListDataCallback(data),successCallback.call()}})},loadListDataCallback:function(data){for(var pageInfo=data.object,i=0;i<pageInfo.items.length;i++)serviceData.push(pageInfo.items[i]);hasNextPage=!(pageIndex>=pageInfo.pageCount)},refreshListData:function(successCallBack){this.clearCachedData(),this.loadListData(successCallBack)},clearCachedData:function(){pageIndex=0,hasNextPage=!0,serviceData=[]},getSearchData:function(){var data={m:6001005,t:"v_contract_equipmentpurchase",order:"id desc",page:pageIndex,rows:pageSize},filter=this.getSearchFilter();return data.filter=JSON.stringify(filter),data},getSearchFilter:function(){var typeId=userService.getTypeId(),rootId=userService.getRootOrgId(),filter=[];return condition.statusId!=-1&&filter.push({field:"statusId",value:condition.statusId,operator:"=",relation:"AND"}),""!=condition.displayId&&"请输入合同编号"!=condition.displayId&&filter.push({field:"displayId",value:"%"+condition.displayId+"%",operator:"like",relation:"and"}),""!=condition.projectName&&"请输入工程名称"!=condition.projectName&&filter.push({field:"projectName",value:"%"+condition.projectName+"%",operator:"like",relation:"and"}),""!=condition.supplyName&&"请输入供货单位"!=condition.supplyName&&filter.push({field:"supplyName",value:"%"+condition.supplyName+"%",operator:"like",relation:"and"}),""!=condition.purchaseName&&"请输入购货单位"!=condition.purchaseName&&filter.push({field:"purchaseName",value:"%"+condition.purchaseName+"%",operator:"like",relation:"and"}),filter.push({field:"statusId",value:2,operator:"<>",relation:"And"}),1==typeId?filter.push({field:"groupId",value:rootId,operator:"=",relation:""}):2==typeId?filter.push({field:"companyId",value:rootId,operator:"=",relation:""}):3==typeId&&filter.push({field:"orgId",value:rootId,operator:"=",relation:""}),filter},queryDetail:function(id,successCallback){var data={m:6001005,t:"v_contract_equipmentpurchase"},filter=[{field:"id",value:id,operator:"=",relation:"and"}];data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){successCallback.call(this,data.object[0])}})},queryMaterial:function(id,successCallback){var data={m:6001005,t:"v_contract_equipmentpurchase_info"},filter=[{field:"id",value:id,operator:"=",relation:"and"}];data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){equipmentInfo=data.object,successCallback.call(this,data.object)}})},queryCharges:function(id,successCallback){var data={m:6001005,t:"v_contract_equipmentpurchase_charges"},filter=[{field:"id",value:id,operator:"=",relation:"and"}];data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){chargesInfo=data.object,successCallback.call(this,data.object)}})},queryInvoice:function(id,successCallback){var data={m:6001005,t:"v_contract_equipmentpurchase_taxinvoice"},filter=[{field:"id",value:id,operator:"=",relation:"and"}];data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){invoiceInfo=data.object,successCallback.call(this,data.object)}})},queryAttach:function(id,successCallback){var data={m:6001005,t:"contract_equipmentpurchase_attach"},filter=[{field:"id",value:id,operator:"=",relation:"and"}];data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){successCallback.call(this,data.object)}})},resetCondition:function(){condition={statusId:-1,displayId:"",projectName:"",purchaseName:"",supplyName:""}},downloadAttach:function(attach){YT.download(attach)},getServiceData:function(){return serviceData},hasNextPage:function(){return hasNextPage},getCondition:function(){return condition},getEquipment:function(){return equipmentInfo},setEquipment:function(data){equipmentInfo=data},getCharges:function(){return chargesInfo},setCharges:function(data){chargesInfo=data},getInvoice:function(){return invoiceInfo},setInvoice:function(data){invoiceInfo=data}}}]),angular.module("app.contract.material.lease").controller("MaterialLeaseChargesController",["$scope","$state","$stateParams","MaterialLeaseService",function($scope,$state,$stateParams,MaterialLeaseService){$scope.$on("$ionicView.loaded",function(){$scope.chargesInfo=MaterialLeaseService.getCharges();for(var chargesInfo=MaterialLeaseService.getCharges(),sum=0,i=0;i<chargesInfo.length;i++)sum+=parseFloat(chargesInfo[i].money);$scope.chargesSum=sum})}]),angular.module("app.contract.material.lease").controller("MaterialLeaseDetailController",["$scope","$state","$stateParams","MaterialLeaseService","$sce",function($scope,$state,$stateParams,MaterialLeaseService,$sce){$scope.projectInfo=!0,$scope.workmoney=!0,$scope.leaseDetail=!0,$scope.quality=!0,$scope.remark=!0,$scope.attachment=!0,$scope.bill=!0,$scope.projectInfoShow=function(){$scope.projectInfo=!$scope.projectInfo},$scope.workmoneyShow=function(){$scope.workmoney=!$scope.workmoney},$scope.leaseDetailShow=function(){$scope.leaseDetail=!$scope.leaseDetail},$scope.qualityShow=function(){$scope.quality=!$scope.quality},$scope.remarkShow=function(){$scope.remark=!$scope.remark},$scope.attachmentShow=function(){$scope.attachment=!$scope.attachment},$scope.billShow=function(){$scope.bill=!$scope.bill},$scope.$on("$ionicView.loaded",function(){MaterialLeaseService.queryDetail($stateParams.id,function(data){$scope.leaseInfo=data;var beginTime=new Date(data.beginDate.replace(/-/g,"/")),endTime=new Date(data.endDate.replace(/-/g,"/"));$scope.totalDays=(endTime.getTime()-beginTime.getTime())/36e5/24,$scope.formatMoney=YTM.tool.money.numberToChineseCurrency(data.cost),$scope.memo=$sce.trustAsHtml(data.memo)}),MaterialLeaseService.queryMaterial($stateParams.id,function(data){$scope.materialLength=data.length}),MaterialLeaseService.queryCharges($stateParams.id,function(data){$scope.chargesLength=data.length}),MaterialLeaseService.queryInvoice($stateParams.id,function(data){$scope.invoiceLength=data.length}),MaterialLeaseService.queryAttach($stateParams.id,function(data){$scope.attachInfo=data})}),$scope.downloadAttach=function(attach){MaterialLeaseService.downloadAttach(attach)}}]),angular.module("app.contract.material.lease").controller("MaterialLeaseInvoiceController",["$scope","$state","$stateParams","MaterialLeaseService",function($scope,$state,$stateParams,MaterialLeaseService){$scope.$on("$ionicView.loaded",function(){$scope.invoiceInfo=MaterialLeaseService.getInvoice()})}]),angular.module("app.contract.material.lease").controller("MaterialLeaseListController",["$scope","$state","$filter","$ionicHistory","$ionicPopup","$ionicModal","$ionicScrollDelegate","MaterialLeaseService","$ionicViewSwitcher",function($scope,$state,$filter,$ionicHistory,$ionicPopup,$ionicModal,$ionicScrollDelegate,MaterialLeaseService,$ionicViewSwitcher){$scope.condition=MaterialLeaseService.getCondition(),$scope.$on("$ionicView.loaded",function(){$scope.leaseList=MaterialLeaseService.getServiceData(),$scope.hasNextPage=MaterialLeaseService.hasNextPage()}),$scope.loadListData=function(){MaterialLeaseService.loadListData(function(){$scope.fillData(),$scope.$broadcast("scroll.infiniteScrollComplete")})},$scope.refreshListData=function(){MaterialLeaseService.refreshListData(function(){$scope.fillData(),$scope.$broadcast("scroll.refreshComplete")})},$scope.fillData=function(){$scope.leaseList=MaterialLeaseService.getServiceData(),$scope.hasNextPage=MaterialLeaseService.hasNextPage()},$scope.searchData=function(){$scope.modalQueryMore.hide(),$scope.modal.hide(),MaterialLeaseService.clearCachedData(),$ionicScrollDelegate.scrollTop(),$scope.loadListData()},$scope.back=function(){MaterialLeaseService.clearCachedData(),MaterialLeaseService.resetCondition(),$state.go("menu"),$ionicViewSwitcher.nextDirection("back")},$ionicModal.fromTemplateUrl("contract-status.html",{scope:$scope,animation:"slide-in-up"}).then(function(modal){$scope.modal=modal}),$scope.openContractStatus=function(){$scope.modal.show()},$scope.hideContractStatus=function(){$scope.modal.hide()},$ionicModal.fromTemplateUrl("query-more.html",{scope:$scope,animation:"slide-in-up"}).then(function(modal){$scope.modalQueryMore=modal}),$scope.openQueryMore=function(){$scope.modalQueryMore.show()},$scope.hideQueryMore=function(){$scope.modalQueryMore.hide()},$scope.clearSearchText=function(){MaterialLeaseService.clearSearchText(),$scope.condition=MaterialLeaseService.getCondition()},$scope.startTime=YTM.initDatePicker({callback:function(){$scope.condition.startTime=$filter("date")($scope.startTime.date,"yyyy-MM-dd"),$scope.startTimerPopup.close()}}),$scope.endTime=YTM.initDatePicker({callback:function(){$scope.condition.endTime=$filter("date")($scope.endTime.date,"yyyy-MM-dd"),$scope.endTimerPopup.close()}}),$scope.openStartTime=function(){$scope.startTimerPopup=$ionicPopup.show({templateUrl:"start-time.html",scope:$scope,cssClass:"customTimerPopover"}),$scope.startTimerPopup.then(function(res){console.log("Tapped!",res)})},$scope.openEndTime=function(){$scope.endTimerPopup=$ionicPopup.show({templateUrl:"end-time.html",scope:$scope,cssClass:"customTimerPopover"}),$scope.endTimerPopup.then(function(res){console.log("Tapped!",res)})}}]),angular.module("app.contract.material.lease").controller("MaterialLeaseMaterialController",["$scope","$state","$stateParams","MaterialLeaseService",function($scope,$state,$stateParams,MaterialLeaseService){$scope.$on("$ionicView.loaded",function(){$scope.materialInfo=MaterialLeaseService.getMaterial();for(var materialInfo=MaterialLeaseService.getMaterial(),sum=0,i=0;i<materialInfo.length;i++)sum+=parseFloat(materialInfo[i].quantity*materialInfo[i].rentPrice);$scope.materialSum=sum,console.log($scope.materialSum)})}]),angular.module("app.contract.material.lease").factory("MaterialLeaseService",["YTService","UserService",function(YT,userService){var serviceData=[],pageIndex=0,pageSize=10,hasNextPage=!0,condition={statusId:-1,displayId:"",projectName:"",rentName:"",hireName:"",startTime:"",endTime:""},materialInfo=[],chargesInfo=[],invoiceInfo=[];return{clearSearchText:function(){condition={statusId:-1,displayId:"",projectName:"",hireName:"",rentName:"",startTime:"",endTime:""}},loadListData:function(successCallback){++pageIndex;var self=this;YT.query({data:self.getSearchData(),successCallback:function(data){self.loadListDataCallback(data),successCallback.call()}})},loadListDataCallback:function(data){for(var pageInfo=data.object,i=0;i<pageInfo.items.length;i++)serviceData.push(pageInfo.items[i]);hasNextPage=!(pageIndex>=pageInfo.pageCount)},refreshListData:function(successCallBack){this.clearCachedData(),this.loadListData(successCallBack)},clearCachedData:function(){pageIndex=0,hasNextPage=!0,serviceData=[]},getSearchData:function(){var data={m:6001004,t:"v_contract_materialleasing",order:"id desc",page:pageIndex,rows:pageSize},filter=this.getSearchFilter();return data.filter=JSON.stringify(filter),data},getSearchFilter:function(){var typeId=userService.getTypeId(),rootId=userService.getRootOrgId(),filter=[];return condition.statusId!=-1&&filter.push({field:"statusId",value:condition.statusId,operator:"=",relation:"AND"}),""!=condition.displayId&&"请输入合同编号"!=condition.displayId&&filter.push({field:"displayId",value:"%"+condition.displayId+"%",operator:"like",relation:"and"}),""!=condition.projectName&&"请输入工程名称"!=condition.projectName&&filter.push({field:"projectName",value:"%"+condition.projectName+"%",operator:"like",relation:"and"}),""!=condition.hireName&&"请输入租用单位"!=condition.hireName&&filter.push({field:"hireName",value:"%"+condition.hireName+"%",operator:"like",relation:"and"}),""!=condition.rentName&&"请输入出租单位"!=condition.rentName&&filter.push({field:"rentName",value:"%"+condition.rentName+"%",operator:"like",relation:"and"}),""!=condition.startTime&&""!=condition.endTime?filter.push([{field:"beginDate",value:condition.startTime,operator:">=",relation:"AND"},{field:"endDate",value:condition.endTime,operator:"<=",relation:"AND"}]):""!=condition.startTime?filter.push({field:"beginDate",value:condition.startTime,operator:">=",relation:"AND"}):""!=condition.endTime&&filter.push({field:"endDate",value:condition.endTime,operator:"<=",relation:"AND"}),filter.push({field:"statusId",value:2,operator:"<>",relation:"And"}),1==typeId?filter.push({field:"groupId",value:rootId,operator:"=",relation:""}):2==typeId?filter.push({field:"companyId",value:rootId,operator:"=",relation:""}):3==typeId&&filter.push({field:"orgId",value:rootId,operator:"=",relation:""}),filter},queryDetail:function(id,successCallback){var data={m:6001004,t:"v_contract_materialleasing"},filter=[{field:"id",value:id,operator:"=",relation:"and"}];data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){successCallback.call(this,data.object[0])}})},queryMaterial:function(id,successCallback){var data={m:6001004,t:"contract_materialleasing_info"},filter=[{field:"id",value:id,operator:"=",relation:"and"}];data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){materialInfo=data.object,successCallback.call(this,data.object)}})},queryCharges:function(id,successCallback){var data={m:6001004,t:"v_contract_materialleasing_charges"},filter=[{field:"id",value:id,operator:"=",relation:"and"}];data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){chargesInfo=data.object,successCallback.call(this,data.object)}})},queryInvoice:function(id,successCallback){var data={m:6001004,t:"v_contract_materialleasing_taxinvoice"},filter=[{field:"id",value:id,operator:"=",relation:"and"}];data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){invoiceInfo=data.object,successCallback.call(this,data.object)}})},queryAttach:function(id,successCallback){var data={m:6001004,t:"contract_materialleasing_attach"},filter=[{field:"id",value:id,operator:"=",relation:"and"}];data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){successCallback.call(this,data.object)}})},downloadAttach:function(attach){YT.download(attach)},resetCondition:function(){condition={statusId:-1,displayId:"",projectName:"",hireName:"",rentName:"",startTime:"",endTime:""}},getServiceData:function(){return serviceData},hasNextPage:function(){return hasNextPage},getCondition:function(){return condition},getMaterial:function(){return materialInfo},setMaterial:function(data){materialInfo=data},getCharges:function(){return chargesInfo},setCharges:function(data){chargesInfo=data},getInvoice:function(){return invoiceInfo},setInvoice:function(data){invoiceInfo=data}}}]),angular.module("app.contract.material.purchase").controller("MaterialPurchaseChargesController",["$scope","$state","$stateParams","MaterialPurchaseService",function($scope,$state,$stateParams,MaterialPurchaseService){$scope.$on("$ionicView.loaded",function(){$scope.chargesInfo=MaterialPurchaseService.getCharges();for(var chargesInfo=MaterialPurchaseService.getCharges(),sum=0,i=0;i<chargesInfo.length;i++)sum+=parseFloat(chargesInfo[i].money);$scope.chargesSum=sum})}]),angular.module("app.contract.material.purchase").controller("MaterialPurchaseDetailController",["$scope","$state","$stateParams","MaterialPurchaseService","$sce",function($scope,$state,$stateParams,MaterialPurchaseService,$sce){$scope.projectInfo=!0,$scope.workmoney=!0,$scope.purchaseDetail=!0,$scope.quality=!0,$scope.remark=!0,$scope.attachment=!0,$scope.bill=!0,$scope.projectInfoShow=function(){$scope.projectInfo=!$scope.projectInfo},$scope.workmoneyShow=function(){$scope.workmoney=!$scope.workmoney},$scope.purchaseDetailShow=function(){$scope.purchaseDetail=!$scope.purchaseDetail},$scope.qualityShow=function(){$scope.quality=!$scope.quality},$scope.remarkShow=function(){$scope.remark=!$scope.remark},$scope.attachmentShow=function(){$scope.attachment=!$scope.attachment},$scope.billShow=function(){$scope.bill=!$scope.bill},$scope.$on("$ionicView.loaded",function(){MaterialPurchaseService.queryDetail($stateParams.id,function(data){$scope.purchaseInfo=data,$scope.formatMoney=YTM.tool.money.numberToChineseCurrency(data.cost),$scope.materialQualityText=$sce.trustAsHtml(data.materialQualityText),$scope.memo=$sce.trustAsHtml(data.memo)}),MaterialPurchaseService.queryMaterial($stateParams.id,function(data){$scope.materialLength=data.length}),MaterialPurchaseService.queryCharges($stateParams.id,function(data){$scope.chargesLength=data.length}),MaterialPurchaseService.queryInvoice($stateParams.id,function(data){$scope.invoiceLength=data.length}),MaterialPurchaseService.queryAttach($stateParams.id,function(data){$scope.attachInfo=data})}),$scope.downloadAttach=function(attach){MaterialPurchaseService.downloadAttach(attach)}}]),angular.module("app.contract.material.purchase").controller("MaterialPurchaseInvoiceController",["$scope","$state","$stateParams","MaterialPurchaseService",function($scope,$state,$stateParams,MaterialPurchaseService){$scope.$on("$ionicView.loaded",function(){$scope.invoiceInfo=MaterialPurchaseService.getInvoice()})}]),angular.module("app.contract.material.purchase").controller("MaterialPurchaseListController",["$scope","$state","$ionicHistory","$ionicModal","$ionicScrollDelegate","MaterialPurchaseService","$ionicViewSwitcher",function($scope,$state,$ionicHistory,$ionicModal,$ionicScrollDelegate,MaterialPurchaseService,$ionicViewSwitcher){$scope.condition=MaterialPurchaseService.getCondition(),$scope.$on("$ionicView.loaded",function(){$scope.purchaseList=MaterialPurchaseService.getServiceData(),$scope.hasNextPage=MaterialPurchaseService.hasNextPage()}),$scope.loadListData=function(){MaterialPurchaseService.loadListData(function(){$scope.fillData(),$scope.$broadcast("scroll.infiniteScrollComplete")})},$scope.refreshListData=function(){MaterialPurchaseService.clearCachedData(),MaterialPurchaseService.refreshListData(function(){$scope.fillData(),$scope.$broadcast("scroll.refreshComplete")})},$scope.fillData=function(){$scope.purchaseList=MaterialPurchaseService.getServiceData(),$scope.hasNextPage=MaterialPurchaseService.hasNextPage()},$scope.searchData=function(){$scope.modalQueryMore.hide(),$scope.modal.hide(),MaterialPurchaseService.clearCachedData(),$ionicScrollDelegate.scrollTop(),$scope.loadListData()},$scope.back=function(){MaterialPurchaseService.clearCachedData(),MaterialPurchaseService.resetCondition(),$state.go("menu"),$ionicViewSwitcher.nextDirection("back")},$ionicModal.fromTemplateUrl("contract-status.html",{scope:$scope,animation:"slide-in-up"}).then(function(modal){$scope.modal=modal}),$scope.openContractStatus=function(){$scope.modal.show()},$scope.hideContractStatus=function(){$scope.modal.hide()},$ionicModal.fromTemplateUrl("query-more.html",{scope:$scope,animation:"slide-in-up"}).then(function(modal){$scope.modalQueryMore=modal}),$scope.openQueryMore=function(){$scope.modalQueryMore.show()},$scope.hideQueryMore=function(){$scope.modalQueryMore.hide()},$scope.clearSearchText=function(){MaterialPurchaseService.resetCondition(),$scope.condition=MaterialPurchaseService.getCondition()}}]),angular.module("app.contract.material.purchase").controller("MaterialPurchaseMaterialController",["$scope","$state","$stateParams","MaterialPurchaseService",function($scope,$state,$stateParams,MaterialPurchaseService){$scope.$on("$ionicView.loaded",function(){$scope.materialInfo=MaterialPurchaseService.getMaterial();for(var materialInfo=MaterialPurchaseService.getMaterial(),sum=0,i=0;i<materialInfo.length;i++)sum+=parseFloat(materialInfo[i].total);$scope.materialSum=sum})}]),angular.module("app.contract.material.purchase").factory("MaterialPurchaseService",["YTService","UserService",function(YT,userService){var serviceData=[],pageIndex=0,pageSize=10,hasNextPage=!0,condition={statusId:-1,displayId:"",projectName:"",purchaseName:"",supplyName:""},materialInfo=[],chargesInfo=[],invoiceInfo=[];return{clearSearchText:function(){condition={statusId:-1,displayId:"",projectName:"",purchaseName:"",supplyName:""}},loadListData:function(successCallback){++pageIndex;var self=this;YT.query({data:self.getSearchData(),successCallback:function(data){self.loadListDataCallback(data),successCallback.call()}})},loadListDataCallback:function(data){for(var pageInfo=data.object,i=0;i<pageInfo.items.length;i++)serviceData.push(pageInfo.items[i]);hasNextPage=!(pageIndex>=pageInfo.pageCount)},refreshListData:function(successCallBack){this.clearCachedData(),this.loadListData(successCallBack)},clearCachedData:function(){pageIndex=0,hasNextPage=!0,serviceData=[]},getSearchData:function(){var data={m:6001003,t:"v_contract_materialpurchase",order:"id desc",page:pageIndex,rows:pageSize},filter=this.getSearchFilter();return data.filter=JSON.stringify(filter),data},getSearchFilter:function(){var typeId=userService.getTypeId(),rootId=userService.getRootOrgId(),filter=[];return condition.statusId!=-1&&filter.push({field:"statusId",value:condition.statusId,operator:"=",relation:"AND"}),""!=condition.displayId&&"请输入合同编号"!=condition.displayId&&filter.push({field:"displayId",value:"%"+condition.displayId+"%",operator:"like",relation:"and"}),""!=condition.projectName&&"请输入工程名称"!=condition.projectName&&filter.push({field:"projectName",value:"%"+condition.projectName+"%",operator:"like",relation:"and"}),""!=condition.supplyName&&"请输入供货单位"!=condition.supplyName&&filter.push({field:"supplyName",value:"%"+condition.supplyName+"%",operator:"like",relation:"and"}),""!=condition.purchaseName&&"请输入购货单位"!=condition.purchaseName&&filter.push({field:"purchaseName",value:"%"+condition.purchaseName+"%",operator:"like",relation:"and"}),1==typeId?filter.push({field:"groupId",value:rootId,operator:"=",relation:""}):2==typeId?filter.push({field:"companyId",value:rootId,operator:"=",relation:""}):3==typeId&&filter.push({field:"orgId",value:rootId,operator:"=",relation:""}),filter},queryDetail:function(id,successCallback){var data={m:6001003,t:"v_contract_materialpurchase"},filter=[{field:"id",value:id,operator:"=",relation:"and"}];data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){successCallback.call(this,data.object[0])}})},queryMaterial:function(id,successCallback){var data={m:6001003,t:"contract_materialpurchase_info"},filter=[{field:"id",value:id,operator:"=",relation:"and"}];data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){materialInfo=data.object,successCallback.call(this,data.object)}})},queryCharges:function(id,successCallback){var data={m:6001003,t:"v_contract_materialpurchase_charges"},filter=[{field:"id",value:id,operator:"=",relation:"and"}];data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){chargesInfo=data.object,successCallback.call(this,data.object)}})},queryInvoice:function(id,successCallback){var data={m:6001003,t:"v_contract_materialpurchase_taxinvoice"},filter=[{field:"id",value:id,operator:"=",relation:"and"}];data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){invoiceInfo=data.object,successCallback.call(this,data.object)}})},queryAttach:function(id,successCallback){var data={m:6001003,t:"contract_materialpurchase_attach"},filter=[{field:"id",value:id,operator:"=",relation:"and"}];data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){successCallback.call(this,data.object)}})},downloadAttach:function(attach){YT.download(attach)},resetCondition:function(){condition={statusId:-1,displayId:"",projectName:"",purchaseName:"",supplyName:""}},getServiceData:function(){return serviceData},hasNextPage:function(){return hasNextPage},getCondition:function(){return condition},getMaterial:function(){return materialInfo},setMaterial:function(data){materialInfo=data},getCharges:function(){return chargesInfo},setCharges:function(data){chargesInfo=data},getInvoice:function(){return invoiceInfo},setInvoice:function(data){invoiceInfo=data}}}]),angular.module("app.device.maintain.maintain-record").controller("MaintainRecordDetailController",["$scope","$state","$stateParams","MaintainRecordService","YTService",function($scope,$state,$stateParams,maintainRecordService,YT){$scope.$on("$ionicView.loaded",function(){maintainRecordService.getDeviceRecordDetail($stateParams.id,function(data){maintainRecordService.getAttaches(data.maintainId,function(attaches){$scope.attaches=attaches}),$scope.deviceRecordInfo=data})}),$scope.download=function(attach){YT.download(attach)}}]),angular.module("app.device.maintain.maintain-record").controller("MaintainRecordListController",["$scope","$state","$ionicHistory","$ionicModal","$ionicScrollDelegate","MaintainRecordService","$stateParams",function($scope,$state,$ionicHistory,$ionicModal,$ionicScrollDelegate,maintainRecordService,$stateParams){$scope.condition=maintainRecordService.getCondition(),$scope.loadListData=function(){maintainRecordService.loadListData(function(){$scope.fillData(),$scope.$broadcast("scroll.infiniteScrollComplete")})},$scope.fillData=function(){$scope.recordList=maintainRecordService.getRecordList(),$scope.hasNextPage=maintainRecordService.hasNextPage()},$scope.filterRecordList=function(value){if($scope.cloneRecordList=$scope.recordList.concat([]),void 0!=value)for(var i=$scope.cloneRecordList.length-1;i>=0;i--)$scope.cloneRecordList[i].number.indexOf(value)==-1&&$scope.cloneRecordList.splice(i,1)},$scope.$on("$ionicView.loaded",function(){$scope.recordList=maintainRecordService.getRecordList(),$scope.hasNextPage=maintainRecordService.hasNextPage(),$stateParams.success&&$scope.refreshListData()}),$scope.refreshListData=function(){maintainRecordService.refreshListData(function(){$scope.fillData(),$scope.$broadcast("scroll.refreshComplete")})},$scope.back=function(){maintainRecordService.clearCachedData(),maintainRecordService.resetCondition(),$ionicHistory.goBack()},$scope.searchData=function(){maintainRecordService.clearCachedData(),$ionicScrollDelegate.scrollTop()}}]),angular.module("app.device.maintain.maintain-record").factory("MaintainRecordService",["YTService","UserService",function(YT,userService){var recordList=[],pageIndex=0,pageSize=10,hasNextPage=!0,condition={};return{loadListData:function(successCallback){++pageIndex;var self=this;YT.query({data:self.getSearchData(),successCallback:function(data){self.loadListDataCallback(data),successCallback.call()}})},loadListDataCallback:function(data){for(var pageInfo=data.object,i=0;i<pageInfo.items.length;i++)recordList.push(pageInfo.items[i]);hasNextPage=!(pageIndex>=pageInfo.pageCount)},refreshListData:function(successCallBack){this.clearCachedData(),this.loadListData(successCallBack)},clearCachedData:function(){pageIndex=0,hasNextPage=!0,recordList=[]},getSearchData:function(){var data={m:12003002003,t:"v_device_maintain_record",page:pageIndex,rows:pageSize},filter=this.getSearchFilter();return data.filter=JSON.stringify(filter),data},getSearchFilter:function(){var filter=[{field:"orgId",value:userService.getRootOrgId(),operator:"=",relation:"AND"}];return filter},getDeviceRecordDetail:function(id,successCallback){var data={m:12003002003,t:"v_device_maintain_record"},filter=[{field:"id",value:id,operator:"=",relation:"and"}];data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){successCallback.call(this,data.object[0])}})},getAttaches:function(id,callback){var filter=[{field:"id",value:id,operator:"=",relation:"and"}];YT.query({data:{m:12003002002,t:"device_maintain_attach",order:"typeId",filter:JSON.stringify(filter)},successCallback:function(data){callback(data.object)}})},resetCondition:function(){condition={}},getRecordList:function(){return recordList},hasNextPage:function(){return hasNextPage},getCondition:function(){return condition}}}]),angular.module("app.device.maintain.maintain-remind").controller("DeviceBreakdownDealController",["$scope","$state","$stateParams","$ionicHistory","$ionicModal","$ionicScrollDelegate","MaintainRemindService",function($scope,$state,$stateParams,$ionicHistory,$ionicModal,$ionicScrollDelegate,addRemindService){$scope.condition=addRemindService.getCondition(),$ionicModal.fromTemplateUrl("breakdown-deal.html",{scope:$scope,animation:"slide-in-up"}).then(function(modal){$scope.modalBreakdownDeal=modal}),$scope.openBreakdownDeal=function(){$scope.modalBreakdownDeal.show()},$scope.hideBreakdownDeal=function(){$scope.modalBreakdownDeal.hide()},$scope.addBreakdownDeal=function(){addRemindService.addBreakdownDeal(function(){$scope.hideBreakdownDeal(),addRemindService.getBreakdownDeal(function(data){$scope.breakdownDeal=data})})},$scope.onItemDelete=function(item){$scope.items.splice($scope.items.indexOf(item),1)},addRemindService.getBreakdownDeal(function(data){$scope.breakdownDeal=data}),$scope.chooseBreakDown=function(item){if(item.name.length<15)$scope.condition.breakdownName=item.name;else{var name=item.name=item.name.substring(0,15);name+="...",$scope.condition.breakdownName=name}$state.go("device/maintain/maintain-remind/maintain-device-detail",{id:$stateParams.id})}}]),angular.module("app.device.maintain.maintain-remind").controller("MaintainRemindDetailController",["$scope","$state","$stateParams","MaintainRemindService","$ionicPopup","$filter","YTService",function($scope,$state,$stateParams,maintainRemindService,$ionicPopup,$filter,YTService){$scope.$on("$ionicView.loaded",function(){maintainRemindService.resetCondition(),$scope.condition=maintainRemindService.getCondition(),$scope.image_list=[{item:!1},{item:!1}],maintainRemindService.getDeviceRemindDetail($stateParams.id,function(data){$scope.deviceRemindInfo=data})}),$scope.startTime=YTM.initDatePicker({callback:function(){$scope.condition.startTime=$filter("date")($scope.startTime.date,"yyyy-MM-dd"),$scope.startTimerPopup.close()}}),maintainRemindService.getConclusion(function(data){$scope.conclusions=data}),$scope.openStartTime=function(){$scope.startTimerPopup=$ionicPopup.show({templateUrl:"start-time.html",scope:$scope,cssClass:"customTimerPopover"}),$scope.startTimerPopup.then(function(res){})},$scope.openCheckResult=function(){$scope.isCheckResult=!0},$scope.closeCheckResult=function(item){$scope.isCheckResult=!1,1==item.id&&($scope.condition.breakdownName="",$scope.condition.breakdownId=0),$scope.condition.conclusionName=item.name},$scope.toBreakDown=function(){1==$scope.condition.conclusionId?$ionicPopup.alert({template:"设备不存在故障，无须填写！"}):$state.go("device/maintain/maintain-remind/device-breakdown-deal",{id:$stateParams.id})},$scope.showConfirm=function(){var confirmPopup=$ionicPopup.confirm({title:"提示",template:'<p class="text-center">您确定该设备已维保？</p>',cancelText:"取消",okText:"确定"});confirmPopup.then(function(res){
res&&maintainRemindService.deviceMaintain($scope.deviceRemindInfo,function(){$state.go("device/maintain/maintain-record/maintain-record-list",{success:!0})})})},$scope.maximumImagesCount=1,$scope.addAttachment=function(type){YTService.addAttachment($scope,function(item){item.typeId=type,$scope.image_list[type].item=item,maintainRemindService.pushImageList(item)})},$scope.previewOrDelete=function(index){maintainRemindService.previewOrDelete(index,function(){$scope.image_list[index].item=!1})}}]),angular.module("app.device.maintain.maintain-remind").controller("MaintainRemindListController",["$scope","$state","$ionicHistory","$ionicModal","$ionicScrollDelegate","MaintainRemindService",function($scope,$state,$ionicHistory,$ionicModal,$ionicScrollDelegate,maintainRemindService){$scope.condition=maintainRemindService.getCondition(),$scope.$on("$ionicView.loaded",function(){$scope.remindList=maintainRemindService.getRemindList(),$scope.hasNextPage=maintainRemindService.hasNextPage()}),$scope.fillData=function(){$scope.remindList=maintainRemindService.getRemindList(),$scope.hasNextPage=maintainRemindService.hasNextPage()},$scope.filterRemindList=function(value){if($scope.cloneRemindList=$scope.remindList.concat([]),void 0!=value)for(var i=$scope.cloneRemindList.length-1;i>=0;i--)$scope.cloneRemindList[i].number.indexOf(value)==-1&&$scope.cloneRemindList.splice(i,1)},$scope.refreshListData=function(){maintainRemindService.refreshListData(function(){$scope.fillData(),$scope.$broadcast("scroll.refreshComplete")})},$scope.loadListData=function(){maintainRemindService.loadListData(function(){$scope.fillData(),$scope.$broadcast("scroll.infiniteScrollComplete")})},$scope.back=function(){maintainRemindService.clearCachedData(),maintainRemindService.resetCondition(),$ionicHistory.goBack()},$scope.searchData=function(){maintainRemindService.clearCachedData(),$ionicScrollDelegate.scrollTop()}}]),angular.module("app.device.maintain.maintain-remind").factory("MaintainRemindService",["YTService","UserService","RemindService","$ionicPopup","$filter","$ionicActionSheet",function(YT,userService,remindService,$ionicPopup,$filter,$ionicActionSheet){var remindList=[],imgList=[],pageIndex=0,pageSize=10,hasNextPage=!0,condition={};return{loadListData:function(successCallback){++pageIndex;var self=this;YT.query({data:self.getSearchData(),successCallback:function(data){self.loadListDataCallback(data),successCallback.call()}})},loadListDataCallback:function(data){for(var pageInfo=data.object,i=0;i<pageInfo.items.length;i++)pageInfo.items[i].remindText=remindService.getRemindText(pageInfo.items[i].nextmaintainTime,2),remindList.push(pageInfo.items[i]);hasNextPage=!(pageIndex>=pageInfo.pageCount)},refreshListData:function(successCallBack){this.clearCachedData(),this.loadListData(successCallBack)},clearCachedData:function(){pageIndex=0,hasNextPage=!0,remindList=[]},getSearchData:function(){var data={m:12003002002,t:"v_device_maintain_remind",page:pageIndex,rows:pageSize},filter=this.getSearchFilter();return data.filter=JSON.stringify(filter),data},getSearchFilter:function(){var filter=[{field:"orgId",value:userService.getRootOrgId(),operator:"=",relation:"AND"}],now=new Date,date=$filter("date")(new Date(now.getTime()+432e6),"yyyy-MM-dd");return filter.push({field:"nextmaintainTime",value:date,operator:"<=",relation:"AND"}),filter},getBreakdownDeal:function(callback){YT.query({data:{m:12003002002,t:"v_device_breakdown",filter:JSON.stringify([{field:"orgId",value:userService.getRootOrgId(),operator:"=",relation:"AND"}])},successCallback:function(data){callback(data.object)}})},addBreakdownDeal:function(callback){var data={name:condition.name,orgId:userService.getRootOrgId()},v={t:"device_d_breakdown",data:data,ai:!0};YT.query({data:{m:12003002002,t:"device_d_breakdown",filter:JSON.stringify([{field:"name",value:data.name,operator:"=",relation:"and"}])},successCallback:function(result){0==result.object.length?YT.insert({data:{m:12003002002,t:"device_d_breakdown",v:JSON.stringify([v])},successCallback:function(data){200==data.status?callback():$ionicPopup.alert({template:data.message})}}):$ionicPopup.alert({template:"该故障分析已存在！"})}})},getDeviceRemindDetail:function(id,successCallback){var data={m:12003002002,t:"v_device_maintain_remind"},filter=[{field:"id",value:id,operator:"=",relation:"and"}];data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){data.object[0].remindText=remindService.getRemindText(data.object[0].nextmaintainTime,2),successCallback.call(this,data.object[0])}})},getConclusion:function(callback){YT.query({data:{m:12003002002,t:"device_d_maintainconclusion"},successCallback:function(data){callback(data.object)}})},deviceMaintain:function(device,callback){var check=device.maintainInterval,checkUnit=device.maintainIntervalunit;if(!condition.startTime)return void $ionicPopup.alert({template:"维保时间必须填写！"});if(!condition.unit)return void $ionicPopup.alert({template:"维保单位必须填写！"});if(!condition.cost)return void $ionicPopup.alert({template:"维保费用必须填写！"});if(!(condition.conclusionId>0))return void $ionicPopup.alert({template:"检验结论必须填写！"});if(2==condition.conclusionId&&!(condition.breakdownId>0))return void $ionicPopup.alert({template:"设备有故障，故障分析必须填写！"});for(var nextMaintainTime=remindService.getDate(checkUnit,check,condition.startTime),filter=[{field:"id",value:device.id,operator:"=",relation:"and"}],inspectionData={maintainId:device.maintainId,maintainTime:condition.startTime,lastmaintainTime:condition.startTime,cost:condition.cost,unit:condition.unit,conclusionId:condition.conclusionId,nextmaintainTime:nextMaintainTime,breakdownId:condition.breakdownId},slave=[],i=0;i<imgList.length;i++)slave.push({key:"maintainId:id",t:"device_maintain_attach",data:{url:imgList[i].data.url,name:imgList[i].data.name,typeId:imgList[i].typeId,id:device.maintainId}});var data={m:12003002002,t:"device_maintain",v:JSON.stringify([{t:"device_maintain",data:inspectionData,filter:filter,slave:slave}])};YT.update({data:data,successCallback:function(result){200==result.status?($ionicPopup.alert({template:"维保设备成功！"}),callback&&callback()):$ionicPopup.alert({template:"维保设备失败！"})}})},resetCondition:function(){imgList=[],condition={}},getRemindList:function(){return remindList},hasNextPage:function(){return hasNextPage},getCondition:function(){return condition},pushImageList:function(item){for(var i=0;i<imgList.length;i++)imgList[i].typeId==item.typeId&&imgList.splice(i,1);imgList.push(item)},previewOrDelete:function(imgIndex,callback){var buttons=[{text:"预览"}];$ionicActionSheet.show({buttons:buttons,destructiveText:"删除",cancelText:"关闭",cancel:function(){return!0},buttonClicked:function(index){return 0==index&&PhotoViewer.show(imgList[imgIndex].src),!0},destructiveButtonClicked:function(){return imgList.splice(imgIndex,1),callback(),!0}})}}}]),angular.module("app.device.inspection.inspection-record").controller("InspectionRecordDetailController",["$scope","$state","$stateParams","RecordService","YTService",function($scope,$state,$stateParams,recordService,YT){$scope.$on("$ionicView.loaded",function(){recordService.getDeviceRecordDetail($stateParams.id,function(data){recordService.getAttaches(data.inspectionId,function(attaches){$scope.attaches=attaches}),$scope.deviceRecordInfo=data})}),$scope.download=function(attach){YT.download(attach)}}]),angular.module("app.device.inspection.inspection-record").controller("InspectionRecordListController",["$scope","$state","$ionicHistory","$ionicModal","$ionicScrollDelegate","RecordService","$stateParams",function($scope,$state,$ionicHistory,$ionicModal,$ionicScrollDelegate,recordService,$stateParams){$scope.condition=recordService.getCondition(),$scope.loadListData=function(){recordService.loadListData(function(){$scope.fillData(),$scope.$broadcast("scroll.infiniteScrollComplete")})},$scope.fillData=function(){$scope.recordList=recordService.getRecordList(),$scope.hasNextPage=recordService.hasNextPage()},$scope.filterRecordList=function(value){if($scope.cloneRecordList=$scope.recordList.concat([]),void 0!=value)for(var i=$scope.cloneRecordList.length-1;i>=0;i--)$scope.cloneRecordList[i].number.indexOf(value)==-1&&$scope.cloneRecordList.splice(i,1)},$scope.$on("$ionicView.loaded",function(){$scope.recordList=recordService.getRecordList(),$scope.hasNextPage=recordService.hasNextPage(),$stateParams.success&&$scope.refreshListData()}),$scope.refreshListData=function(){recordService.refreshListData(function(){$scope.fillData(),$scope.$broadcast("scroll.refreshComplete")})},$scope.back=function(){recordService.clearCachedData(),recordService.resetCondition(),$ionicHistory.goBack()},$scope.searchData=function(){recordService.clearCachedData(),$ionicScrollDelegate.scrollTop()}}]),angular.module("app.device.inspection.inspection-remind").controller("InspectionRemindDetailController",["$scope","$state","$stateParams","RemindService","$ionicPopup","$filter","YTService",function($scope,$state,$stateParams,remindService,$ionicPopup,$filter,YTService){$scope.isCheckResult=!1,$scope.$on("$ionicView.loaded",function(){remindService.resetCondition(),$scope.condition=remindService.getCondition(),$scope.image_list=[{item:!1},{item:!1},{item:!1}],remindService.getDeviceRemindDetail($stateParams.id,function(data){$scope.deviceRemindInfo=data})}),$scope.startTime=YTM.initDatePicker({callback:function(){$scope.condition.inspectionTime=$filter("date")($scope.startTime.date,"yyyy-MM-dd"),$scope.startTimerPopup.close()}}),$scope.openStartTime=function(){$scope.startTimerPopup=$ionicPopup.show({templateUrl:"start-time.html",scope:$scope,cssClass:"customTimerPopover"}),$scope.startTimerPopup.then(function(res){})},$scope.openCheckResult=function(){$scope.isCheckResult=!0},$scope.closeCheckResult=function(name){$scope.isCheckResult=!1,$scope.condition.conclusionName=name},remindService.getConclusion(function(data){$scope.conclusions=data}),$scope.showConfirm=function(){var confirmPopup=$ionicPopup.confirm({title:"提示",template:'<p class="text-center">您确定该设备已检验？</p>',cancelText:"取消",okText:"确定"});confirmPopup.then(function(res){res&&remindService.deviceRemind($stateParams.id,$scope.deviceRemindInfo,function(){$state.go("device/inspection/inspection-record/inspection-record-list",{success:!0})})})},$scope.maximumImagesCount=1,$scope.addAttachment=function(type){YTService.addAttachment($scope,function(item){item.typeId=type,$scope.image_list[type].item=item,remindService.pushImageList(item)})},$scope.previewOrDelete=function(index){remindService.previewOrDelete(index,function(){$scope.image_list[index].item=!1})}}]),angular.module("app.device.inspection.inspection-remind").controller("InspectionRemindListController",["$scope","$state","$ionicHistory","$ionicModal","$ionicScrollDelegate","RemindService",function($scope,$state,$ionicHistory,$ionicModal,$ionicScrollDelegate,remindService){$scope.condition=remindService.getCondition(),$scope.$on("$ionicView.loaded",function(){$scope.remindList=remindService.getRemindList(),$scope.hasNextPage=remindService.hasNextPage()}),$scope.fillData=function(){$scope.remindList=remindService.getRemindList(),$scope.hasNextPage=remindService.hasNextPage()},$scope.filterRemindList=function(value){if($scope.cloneRemindList=$scope.remindList.concat([]),void 0!=value)for(var i=$scope.cloneRemindList.length-1;i>=0;i--)$scope.cloneRemindList[i].number.indexOf(value)==-1&&$scope.cloneRemindList.splice(i,1)},$scope.refreshListData=function(){remindService.refreshListData(function(){$scope.fillData(),$scope.$broadcast("scroll.refreshComplete")})},$scope.loadListData=function(){remindService.loadListData(function(){$scope.fillData(),$scope.$broadcast("scroll.infiniteScrollComplete")})},$scope.back=function(){remindService.clearCachedData(),remindService.resetCondition(),$ionicHistory.goBack()},$scope.searchData=function(){remindService.clearCachedData(),$ionicScrollDelegate.scrollTop()}}]),angular.module("app.device.inspection.inspection-record").factory("RecordService",["YTService","UserService",function(YT,userService){var recordList=[],pageIndex=0,pageSize=10,hasNextPage=!0,condition={startTime:""};return{loadListData:function(successCallback){++pageIndex;var self=this;YT.query({data:self.getSearchData(),successCallback:function(data){self.loadListDataCallback(data),successCallback.call()}})},loadListDataCallback:function(data){for(var pageInfo=data.object,i=0;i<pageInfo.items.length;i++)recordList.push(pageInfo.items[i]);hasNextPage=!(pageIndex>=pageInfo.pageCount)},refreshListData:function(successCallBack){this.clearCachedData(),this.loadListData(successCallBack)},clearCachedData:function(){pageIndex=0,hasNextPage=!0,recordList=[]},getSearchData:function(){var data={m:12003001003,t:"v_device_inspection_record",page:pageIndex,rows:pageSize},filter=this.getSearchFilter();return data.filter=JSON.stringify(filter),data},getSearchFilter:function(){var filter=[{field:"orgId",value:userService.getRootOrgId(),operator:"=",relation:"AND"}];return filter},getDeviceRecordDetail:function(id,successCallback){var data={m:12003001003,t:"v_device_inspection_record"},filter=[{field:"id",value:id,operator:"=",relation:"and"}];data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){successCallback.call(this,data.object[0])}})},getAttaches:function(id,callback){var filter=[{field:"id",value:id,operator:"=",relation:""}];YT.query({data:{m:12003001003,t:"device_inspection_attach",order:"typeId",filter:JSON.stringify(filter)},successCallback:function(data){callback(data.object)}})},resetCondition:function(){condition={}},getRecordList:function(){return recordList},hasNextPage:function(){return hasNextPage},getCondition:function(){return condition}}}]),angular.module("app.device.inspection.inspection-remind").factory("RemindService",["YTService","UserService","$filter","$ionicPopup","$ionicActionSheet",function(YT,userService,$filter,$ionicPopup,$ionicActionSheet){var remindList=[],pageIndex=0,pageSize=10,hasNextPage=!0,imgList=[],condition={inspectionTime:null,unit:"",cost:"",conclusionId:0};return{loadListData:function(successCallback){++pageIndex;var self=this;YT.query({data:self.getSearchData(),successCallback:function(data){self.loadListDataCallback(data),successCallback.call()}})},getRemindText:function(next,typeId){var nextTime=new Date(next),sec=nextTime.getTime()-(new Date).getTime(),days=parseInt(sec/864e5)+1,type=1==typeId?"检验":"维保",text="";return text=days>0?"距下次"+type+"还有"+days+"天":days<0?"已过期"+type+-days+"天":"请"+type+"设备"},loadListDataCallback:function(data){for(var pageInfo=data.object,i=0;i<pageInfo.items.length;i++)pageInfo.items[i].remindText=this.getRemindText(pageInfo.items[i].nextInspectionTime,1),remindList.push(pageInfo.items[i]);hasNextPage=!(pageIndex>=pageInfo.pageCount)},refreshListData:function(successCallBack){this.clearCachedData(),this.loadListData(successCallBack)},clearCachedData:function(){pageIndex=0,hasNextPage=!0,remindList=[]},getSearchData:function(){var data={m:12003001002,t:"v_device_inspection_remind",page:pageIndex,rows:pageSize},filter=this.getSearchFilter();return data.filter=JSON.stringify(filter),data},getSearchFilter:function(){var filter=[{field:"orgId",value:userService.getRootOrgId(),operator:"=",relation:"AND"}],now=new Date,date=$filter("date")(new Date(now.getTime()+6048e5),"yyyy-MM-dd");return filter.push({field:"nextInspectionTime",value:date,operator:"<=",relation:"AND"}),filter},getDeviceRemindDetail:function(id,successCallback){var self=this,data={m:12003001002,t:"v_device_inspection_remind"},filter=[{field:"id",value:id,operator:"=",relation:"and"}];data.filter=JSON.stringify(filter),YT.query({data:data,successCallback:function(data){data.object[0].remindText=self.getRemindText(data.object[0].nextInspectionTime,1),successCallback.call(this,data.object[0])}})},getDate:function(checkIntervalunit,checkInterval,intime){var date=new Date(intime);if(checkInterval>0){if(0==checkIntervalunit)return date.setYear(date.getFullYear()+parseInt(checkInterval)),date.setMonth(date.getMonth()+1),date.getFullYear()+"-"+date.getMonth()+"-"+date.getDate();if(1==checkIntervalunit){var oldDays=date.getDate();date.setMonth(date.getMonth()+1+parseInt(checkInterval));var newDays=new Date(date.getFullYear(),date.getMonth(),0).getDate();return oldDays>newDays&&date.setDate(newDays),date.getFullYear()+"-"+date.getMonth()+"-"+date.getDate()}return 2==checkIntervalunit?(date.setDate(date.getDate()+parseInt(checkInterval)),date.setMonth(date.getMonth()+1),date.getFullYear()+"-"+date.getMonth()+"-"+date.getDate()):null}return null},deviceRemind:function(id,deviceRemindInfo,callback){var self=this,check=deviceRemindInfo.checkInterval,checkUnit=deviceRemindInfo.checkIntervalunit;if(null==condition.inspectionTime)return void $ionicPopup.alert({template:"检验时间必须填写！"});if(""==condition.unit)return void $ionicPopup.alert({template:"检验单位必须填写！"});if(""==condition.cost)return void $ionicPopup.alert({template:"检验费用必须填写！"});if(!(condition.conclusionId>0))return void $ionicPopup.alert({template:"检验结论必须填写！"});if(imgList.length<3)return void $ionicPopup.alert({template:"附件必须上传！"});if(YT.validateAttachs(imgList)){for(var nextInspectionTime=self.getDate(checkUnit,check,condition.inspectionTime),inspectionData={inspectionId:deviceRemindInfo.inspectionId,inspectionTime:condition.inspectionTime,lastInspectionTime:condition.inspectionTime,cost:condition.cost,unit:condition.unit,conclusionId:condition.conclusionId,nextInspectionTime:nextInspectionTime},filter=[{field:"id",value:id,operator:"=",relation:"and"}],slave=[],i=0;i<imgList.length;i++)slave.push({key:"inspectionId:id",t:"device_inspection_attach",data:{url:imgList[i].data.url,name:imgList[i].data.name,typeId:imgList[i].typeId,id:deviceRemindInfo.inspectionId}});var data={m:12003001002,t:"device_inspection",v:JSON.stringify([{t:"device_inspection",data:inspectionData,filter:filter,slave:slave}])};YT.update({data:data,successCallback:function(data){200==data.status?($ionicPopup.alert({template:"检验设备成功！"}),self.resetCondition(),callback&&callback()):$ionicPopup.alert({template:"检验设备失败！"})}})}},getConclusion:function(callback){YT.query({data:{m:12003001002,t:"device_d_inspectionconclusion"},successCallback:function(data){callback(data.object)}})},resetCondition:function(){imgList=[],condition={inspectionTime:null,unit:"",cost:"",conclusionId:0}},getRemindList:function(){return remindList},hasNextPage:function(){return hasNextPage},getCondition:function(){return condition},pushImageList:function(item){for(var i=0;i<imgList.length;i++)imgList[i].typeId==item.typeId&&imgList.splice(i,1);imgList.push(item)},previewOrDelete:function(imgIndex,callback){var buttons=[{text:"预览"}];$ionicActionSheet.show({buttons:buttons,destructiveText:"删除",cancelText:"关闭",cancel:function(){return!0},buttonClicked:function(index){return 0==index&&PhotoViewer.show(imgList[imgIndex].src),!0},destructiveButtonClicked:function(){return imgList.splice(imgIndex,1),callback(),!0}})}}}]),angular.module("app.market.ep.employee").controller("EmployeeAttachDetailController",["$scope","EmployeeService","$stateParams",function($scope,employeeService,$stateParams){$scope.attaches=$stateParams.attaches,$scope.download=function(attach){employeeService.downloadAttach(attach)}}]),angular.module("app.market.ep.employee").controller("EmployeeCertificateDetailController",["$scope","$stateParams","EmployeeService",function($scope,$stateParams,employeeService,YT){$scope.attachment=!0,$scope.attachmentShow=function(){$scope.attachment=!$scope.attachment},$scope.certificate=$stateParams.certificate,employeeService.getCertificateAttach($stateParams.certificate.certificateid,function(data){$scope.attaches=data}),$scope.download=function(attach){employeeService.downloadAttach(attach)}}]),angular.module("app.market.ep.employee").controller("EmployeeDetailController",["$scope","EmployeeService","$stateParams","$state",function($scope,employeeService,$stateParams,$state){$scope.baseInfo=!0,$scope.baseInfoShow=function(){$scope.baseInfo=!$scope.baseInfo},$scope.workInfo=!0,$scope.workInfoShow=function(){$scope.workInfo=!$scope.workInfo},$scope.qualification=!0,$scope.qualificationShow=function(){$scope.qualification=!$scope.qualification},$scope.technicalTitle=!0,$scope.technicalTitleShow=function(){$scope.technicalTitle=!$scope.technicalTitle},$scope.project=!0,$scope.projectShow=function(){$scope.project=!$scope.project},employeeService.getEmployeeAttatch($stateParams.dataId,function(data){$scope.attaches=data}),employeeService.loadEmpDetail($stateParams.dataId,function(data){$scope.emp=data}),employeeService.getTitle($stateParams.dataId,function(data){$scope.titles=data}),employeeService.getCertificate($stateParams.dataId,function(data){$scope.certificates=data}),employeeService.getProjects($stateParams.dataId,function(data){$scope.projects=data}),$scope.viewCertificateDetail=function(obj){$state.go("market/ep/employee/employee-certificate-detail",{certificate:obj})},$scope.viewTitleDetail=function(obj){$state.go("market/ep/employee/employee-title-detail",{title:obj})},$scope.viewAttachDetail=function(){$scope.attaches.length>0&&$state.go("market/ep/employee/employee-attach-detail",{attaches:$scope.attaches})},$scope.viewPrjDetail=function(id){$state.go("market/ep/project/project-detail",{dataId:id})}}]),angular.module("app.market.ep.employee").controller("EmployeeListController",["$scope","$ionicModal","EmployeeService","$stateParams","$state",function($scope,$ionicModal,employeeService,$stateParams,$state){$ionicModal.fromTemplateUrl("query-type.html",{scope:$scope,animation:"slide-in-up"}).then(function(modal){$scope.modalQueryTypeUp=modal}),$scope.openQueryTypeUp=function(){$scope.fillDataFlag=!0,$scope.modalQueryTypeUp.show()},$ionicModal.fromTemplateUrl("query-type.html",{scope:$scope,animation:"slide-in-left"}).then(function(modal){$scope.modalQueryTypeLeft=modal}),$scope.openQueryTypeLeft=function(){$scope.fillDataFlag=!1,$scope.modalQueryTypeLeft.show()},$scope.hideQueryType=function(org){$scope.modalQueryTypeLeft.hide(),$scope.modalQueryTypeUp.hide(),org&&($scope.condition.org={orgId:org.id,orgName:org.name},$scope.fillDataFlag&&$scope.reloadData())},$scope.reloadData=function(){employeeService.reloadData(function(){$scope.fillData()})},$ionicModal.fromTemplateUrl("query-more.html",{scope:$scope,animation:"slide-in-up"}).then(function(modal){$scope.modalQueryMore=modal}),$scope.openQueryMore=function(){$scope.modalQueryMore.show()},$scope.opensex=function(){$scope.sex=!0},$scope.openInsure=function(){$scope.insure=!0},$scope.close=function(){$scope.sex=!1,$scope.insure=!1},$scope.refreshListData=function(){employeeService.refreshListData(function(){$scope.fillData(),$scope.$broadcast("scroll.refreshComplete")})},$scope.hasNextPage=!0,$scope.back=function(){employeeService.resetCondition(),employeeService.resetCachedData(),$state.go("market-management")},$scope.loadListData=function(){employeeService.loadEmployeeList(function(){$scope.fillData(),$scope.$broadcast("scroll.infiniteScrollComplete")})},$scope.fillData=function(){$scope.employeeList=employeeService.getEmployeeList(),$scope.hasNextPage=employeeService.hasNextPage()},$scope.condition=employeeService.getCondition(),$scope.viewDetail=function(id){$state.go("market/ep/employee/employee-detail",{dataId:id})},employeeService.getSubCompany(function(data){$scope.companies=data}),$scope.doSearch=function(){$scope.modalQueryMore.hide(),$scope.reloadData()},$scope.resetCondition=function(){$scope.condition=employeeService.resetCondition()},$scope.selectSex=function(){$scope.close()},$scope.selectInsure=function(){$scope.close()}}]),angular.module("app.market.ep.employee").controller("EmployeeTitleDetailController",["$scope","$stateParams","EmployeeService",function($scope,$stateParams,employeeService){$scope.attachment=!0,$scope.attachmentShow=function(){$scope.attachment=!$scope.attachment},$scope.title=$stateParams.title,employeeService.getTitleAttach($stateParams.title.titleid,function(data){$scope.attaches=data}),$scope.download=function(attach){employeeService.downloadAttach(attach)}}]),angular.module("app.market.ep.employee").factory("EmployeeService",["YTService","UserService",function(YT,userService){var employeeList=[],pageIndex=0,pageSize=10,condition={isInsured:-1,sex:-1,realName:"",org:{orgId:0,orgName:"不限"},orgId:0,telephone:""},hasNextPage=!0;return{loadEmployeeList:function(successCallBack){++pageIndex;var self=this;self.getSearchData(function(data1){YT.query({data:data1,successCallback:function(data){self.loadEmployeeListCallBack(data),successCallBack()}})})},getSearchData:function(callback){var self=this;self.getTopOrgId(function(id){var filter=[{field:"topOrgId",value:id,operator:"=",relation:"and"}];filter=self.getSearchFilter(filter);var data={m:5001002,t:"v_market_ep_employee",order:"id desc",page:pageIndex,rows:pageSize,filter:JSON.stringify(filter)};callback(data)})},getTopOrgId:function(callback){var typeId=userService.getTypeId(),rootId=userService.getRootOrgId();1==typeId?callback(rootId-1):2==typeId&&YT.query({data:{m:5001002,t:"org_org",filter:JSON.stringify([{field:"id",operator:"=",value:rootId,relation:""}])},successCallback:function(data){callback(data.object[0].pid)}})},getEmployeeList:function(){return employeeList},getCondition:function(){return condition},getSearchFilter:function(filter){var isInsured=condition.isInsured,sex=condition.sex,realName=condition.realName,orgId=condition.org.orgId,telephone=condition.telephone;return orgId>0&&filter.push({field:"orgId",value:orgId,operator:"=",relation:"and"}),realName&&filter.push({field:"realName",value:"%"+realName+"%",operator:"like",relation:"and"}),telephone&&filter.push({field:"telephone",value:"%"+telephone+"%",operator:"like",relation:"and"}),sex>-1&&filter.push({field:"sexType",value:sex,operator:"=",relation:"and"}),isInsured>-1&&filter.push({field:"isinsured",value:isInsured,operator:"=",relation:"and"}),filter},loadEmpDetail:function(empid,callback){var self=this;YT.query({data:{m:5001002,t:"v_market_ep_employee",filter:JSON.stringify([{field:"id",operator:"=",value:empid,relation:""}])},successCallback:function(data){data.object[0].photourl=self.getPhotoUrl(data.object[0].photourl),callback(data.object[0])}})},getPageIndex:function(){return pageIndex},hasNextPage:function(){return hasNextPage},loadEmployeeListCallBack:function(data){for(var _employeeList=data.object.items,i=0;i<_employeeList.length;i++)_employeeList[i].photoUrl&&(_employeeList[i].photoUrl=env.server+""+_employeeList[i].photoUrl),employeeList.push({id:_employeeList[i].id,name:_employeeList[i].realName,orgName:_employeeList[i].orgName,telephone:_employeeList[i].telephone,photoUrl:_employeeList[i].photoUrl,orgType:_employeeList[i].orgType});hasNextPage=!(pageIndex>=data.object.pageCount)},setEmployeeList:function(_employeeList){employeeList=_employeeList},refreshListData:function(successCallBack){this.resetCondition(),this.reloadData(successCallBack)},reloadData:function(successCallBack){this.resetCachedData(),this.loadEmployeeList(successCallBack)},resetCachedData:function(){this.setPageIndex(0),this.setHasNextPage(!0),this.setEmployeeList([])},resetCondition:function(){return condition.isInsured=-1,condition.sex=-1,condition.realName="",condition.org={orgId:0,orgName:"不限"},condition.telephone="",condition},setPageIndex:function(_pageIndex){pageIndex=_pageIndex},setHasNextPage:function(_pageIndex){hasNextPage=_pageIndex},getEmployeeAttatch:function(empid,callback){YT.query({data:{m:5001002,t:"market_ep_employee_attach",filter:JSON.stringify([{field:"id",operator:"=",value:empid,relation:""}])},successCallback:function(data){callback(data.object)}})},getTitle:function(id,callback){YT.query({data:{m:5001002,t:"v_market_ep_employee_title",filter:JSON.stringify([{field:"id",operator:"=",value:id,relation:""}])},successCallback:function(data){callback(data.object)}})},getCertificate:function(id,callback){YT.query({data:{m:5001002,t:"v_market_ep_employee_certificate",filter:JSON.stringify([{field:"id",operator:"=",value:id,relation:""}])},successCallback:function(data){callback(data.object)}})},getTitleAttach:function(id,callback){YT.query({data:{m:5001002,t:"market_ep_employee_title_attach",filter:JSON.stringify([{field:"id",operator:"=",value:id,relation:""}])},successCallback:function(data){callback(data.object)}})},getCertificateAttach:function(id,callback){YT.query({data:{m:5001002,t:"market_ep_employee_certificate_attach",filter:JSON.stringify([{field:"id",operator:"=",value:id,relation:""}])},successCallback:function(data){callback(data.object)}})},getProjects:function(dataId,callback){YT.query({data:{m:5001002,t:"v_market_ep_project",filter:JSON.stringify([{field:"managerid",value:dataId,operator:"=",relation:"or"},{field:"technicaldirectorid",value:dataId,operator:"=",relation:"or"},{field:"constructioncrewid",value:dataId,operator:"=",relation:"or"},{field:"qualityinspectorid",value:dataId,operator:"=",relation:"or"},{field:"safetysupervisorid",value:dataId,operator:"=",relation:"or"},{field:"materialstaffid",value:dataId,operator:"=",relation:"or"},{field:"dataprocessorid",value:dataId,operator:"=",relation:"or"},{field:"costestimatorid",value:dataId,operator:"=",relation:""}])},successCallback:function(result){var projects=result.object;callback(projects)}})},getSubCompany:function(callback){YT.query({data:{m:5001002,t:"org_org",filter:JSON.stringify([{field:"id",value:userService.getRootOrgId(),operator:"=",relation:"and"}])},successCallback:function(result){if(200==result.status){var filter=[[{field:"type",value:2,operator:"=",relation:"or"},{field:"type",value:1,operator:"=",relation:"and"}],{field:"pid",value:result.object[0].pid,operator:"=",relation:""}];YT.query({data:{m:5001002,t:"org_org",filter:JSON.stringify(filter)},successCallback:function(data){callback(data.object)}})}else $.alert(result.message)}})},getPhotoUrl:function(url){var fileUrl="";if(url){var urls=url.split(",");2==urls.length&&void 0!=urls[0]&&(fileUrl=YT.getFileUrl(urls[0],urls[1]))}return fileUrl},downloadAttach:function(attach){YT.download(attach)}}}]),angular.module("app.market.ep.project").controller("ProjectAttachDetailController",["$scope","$stateParams","ProjectService",function($scope,$stateParams,projectService){$scope.attachment=!0,$scope.attachmentShow=function(){$scope.attachment=!$scope.attachment},$scope.attaches=$stateParams.attaches,$scope.download=function(attach){projectService.downloadAttach(attach)}}]),angular.module("app.market.ep.project").controller("ProjectAwardDetailController",["$scope","$stateParams","ProjectService",function($scope,$stateParams,projectService){$scope.attachment=!0,$scope.attachmentShow=function(){$scope.attachment=!$scope.attachment},$scope.award=$stateParams.award,projectService.getAwardAttach($stateParams.award.awardid,function(data){$scope.attaches=data}),$scope.download=function(attach){projectService.downloadAttach(attach)}}]),angular.module("app.market.ep.project").controller("ProjectDetailController",["$scope","$stateParams","$state","ProjectService",function($scope,$stateParams,$state,projectService){$scope.projectInfo=!0,$scope.projectInfoShow=function(){$scope.projectInfo=!$scope.projectInfo},$scope.companyInfo=!0,$scope.companyInfoShow=function(){$scope.companyInfo=!$scope.companyInfo},$scope.projectOption=!0,$scope.projectOptionShow=function(){$scope.projectOption=!$scope.projectOption},$scope.attachment=!0,$scope.attachmentShow=function(){$scope.attachment=!$scope.attachment},$scope.employee=!0,$scope.employeeShow=function(){$scope.employee=!$scope.employee},$scope.award=!0,$scope.awardShow=function(){$scope.award=!$scope.award},$scope.punish=!0,$scope.punishShow=function(){$scope.punish=!$scope.punish},projectService.loadPrjDetail($stateParams.dataId,function(data){$scope.project=data}),projectService.getAward($stateParams.dataId,function(data){$scope.awards=data}),projectService.getPunish($stateParams.dataId,function(data){
$scope.punishes=data}),$scope.viewEmpDetail=function(id){$state.go("market/ep/employee/employee-detail",{dataId:id})},projectService.getParam($stateParams.dataId,function(data){$scope.params=data}),$scope.attaches=[[],[],[],[],[],[]],projectService.getProjectAttach($stateParams.dataId,function(data){for(var i=0;i<data.length;i++){var attach=data[i];(""!=attach.url||""!=attach.name||attach.orgId>0)&&$scope.attaches[attach.typeId-1].push(attach)}}),$scope.viewAttachDetail=function(attaches){attaches.length>0&&$state.go("market/ep/project/project-attach-detail",{attaches:attaches})},$scope.viewAwardDetail=function(obj){$state.go("market/ep/project/project-award-detail",{award:obj})},$scope.viewPunishDetail=function(obj){$state.go("market/ep/project/project-punish-detail",{punish:obj})}}]),angular.module("app.market.ep.project").controller("ProjectListController",["$scope","$ionicModal","$ionicPopup","$stateParams","$state","ProjectService","$filter",function($scope,$ionicModal,$ionicPopup,$stateParams,$state,projectService,$filter){$ionicModal.fromTemplateUrl("query-type.html",{scope:$scope,animation:"slide-in-up"}).then(function(modal){$scope.modalQueryTypeUp=modal}),$scope.openQueryTypeUp=function(){$scope.fillDataFlag=!0,$scope.modalQueryTypeUp.show()},$ionicModal.fromTemplateUrl("query-type.html",{scope:$scope,animation:"slide-in-right"}).then(function(modal){$scope.modalQueryTypeLeft=modal}),$scope.openQueryTypeLeft=function(){$scope.fillDataFlag=!1,$scope.modalQueryTypeLeft.show()},$scope.hideQueryType=function(org){$scope.modalQueryTypeLeft.hide(),$scope.modalQueryTypeUp.hide(),org&&($scope.condition.org.orgName=org.name,$scope.fillDataFlag&&$scope.reloadData())},$ionicModal.fromTemplateUrl("query-more.html",{scope:$scope,animation:"slide-in-up"}).then(function(modal){$scope.modalQueryMore=modal}),$scope.openQueryMore=function(){$scope.modalQueryMore.show()},$ionicModal.fromTemplateUrl("project-property.html",{scope:$scope,animation:"slide-in-right"}).then(function(modal){$scope.projectProperty=modal}),$scope.openProjectProperty=function(){$scope.projectProperties?$scope.projectProperty.show():projectService.getProjectProperties(function(data){$scope.projectProperties=data,$scope.projectProperty.show()})},$ionicModal.fromTemplateUrl("manager.html",{scope:$scope,animation:"slide-in-right"}).then(function(modal){$scope.manager=modal}),$scope.openManager=function(){$scope.manager.show()},$ionicModal.fromTemplateUrl("technical-director.html",{scope:$scope,animation:"slide-in-right"}).then(function(modal){$scope.technicalDirector=modal}),$scope.openTechnicalDirector=function(){$scope.technicalDirector.show()},$scope.openIsComplete=function(){$scope.isComplete=!0},$scope.close=function(){$scope.isComplete=!1},$scope.startTime1=projectService.getDatePickerTime(function(date){$scope.condition.startTime.min=$filter("date")(date,"yyyy-MM-dd"),$scope.startTime2.startDate=date,$scope.startTimerPopup.close()}),$scope.startTime2=projectService.getDatePickerTime(function(date){$scope.condition.startTime.max=$filter("date")(date,"yyyy-MM-dd"),$scope.startTime1.endDate=date,$scope.startTimerPopup.close()}),$scope.endTime1=projectService.getDatePickerTime(function(date){$scope.condition.endTime.min=$filter("date")(date,"yyyy-MM-dd"),$scope.endTime2.startDate=date,$scope.startTimerPopup.close()}),$scope.endTime2=projectService.getDatePickerTime(function(date){$scope.condition.endTime.max=$filter("date")(date,"yyyy-MM-dd"),$scope.endTime1.endDate=date,$scope.startTimerPopup.close()}),$scope.openTime=function(url){$scope.startTimerPopup=$ionicPopup.show({templateUrl:url,scope:$scope,cssClass:"customTimerPopover"}),$scope.startTimerPopup.then(function(res){})},$scope.refreshListData=function(){projectService.refreshListData(function(){$scope.fillData(),$scope.$broadcast("scroll.refreshComplete")})},$scope.hasNextPage=!0,$scope.back=function(){projectService.resetCondition(),projectService.resetCachedData(),$state.go("market-management")},$scope.loadListData=function(){projectService.loadProjectList(function(){$scope.fillData(),$scope.$broadcast("scroll.infiniteScrollComplete")})},$scope.fillData=function(){$scope.projectList=projectService.getProjectList(),$scope.hasNextPage=projectService.hasNextPage()},$scope.reloadData=function(){projectService.reloadData(function(){$scope.fillData()})},$scope.viewDetail=function(id){$state.go("market/ep/project/project-detail",{dataId:id})},projectService.getSubCompany(function(data){$scope.companyList=data}),$scope.condition=projectService.getCondition(),projectService.getEmps(function(data){$scope.emps=data}),$scope.selectDirector=function(emp){emp?($scope.condition.director.name=emp.realName,$scope.condition.director.id=emp.id):($scope.condition.director.name="不限",$scope.condition.director.id=0),$scope.technicalDirector.hide()},$scope.selectManager=function(emp){emp?($scope.condition.manager.name=emp.realName,$scope.condition.manager.id=emp.id):($scope.condition.manager.name="不限",$scope.condition.manager.id=0),$scope.manager.hide()},$ionicModal.fromTemplateUrl("contract-form.html",{scope:$scope,animation:"slide-in-right"}).then(function(modal){$scope.contractForm=modal}),$scope.openContractForm=function(){$scope.contractModes?$scope.contractForm.show():projectService.getContractMode(function(data){$scope.contractModes=data,$scope.contractForm.show()})},$ionicModal.fromTemplateUrl("contract-form-detail.html",{scope:$scope,animation:"slide-in-right"}).then(function(modal){$scope.contractFormDetail=modal}),$scope.selectContractModeA=function(mode){$scope.condition.contractMode.Aid=mode.id,mode.subs.length>0?($scope.contractModesB=mode.subs,$scope.contractFormDetail.show(),$scope.condition.contractMode.AName=mode.name):($scope.contractForm.hide(),$scope.condition.contractMode.name=mode.name)},$scope.selectContractModeB=function(mode){$scope.condition.contractMode.name=mode.name,$scope.contractFormDetail.hide(),$scope.contractForm.hide()},$scope.selectProperty=function(property){$scope.condition.property.name=property.name,$scope.projectProperty.hide()},$ionicModal.fromTemplateUrl("funds-provided.html",{scope:$scope,animation:"slide-in-right"}).then(function(modal){$scope.fundsProvided=modal}),$scope.openFundsProvided=function(){$scope.fundingSources?$scope.fundsProvided.show():projectService.getFundingSources(function(data){$scope.fundingSources=data,$scope.fundsProvided.show()})},$scope.selectFundSource=function(property){$scope.condition.fundingSources.name=property.name,$scope.fundsProvided.hide()},$ionicModal.fromTemplateUrl("structural.html",{scope:$scope,animation:"slide-in-right"}).then(function(modal){$scope.structural=modal}),$scope.openStructural=function(){$scope.structuralForms?$scope.structural.show():projectService.getStructuralForm(function(data){$scope.structuralForms=data,$scope.structural.show()})},$ionicModal.fromTemplateUrl("structural-detail.html",{scope:$scope,animation:"slide-in-right"}).then(function(modal){$scope.structuralDetail=modal}),$scope.selectStructuralFormA=function(mode){$scope.condition.structuralForm.Aid=mode.id,mode.subs.length>0?($scope.structuralFormsB=mode.subs,$scope.structuralDetail.show(),$scope.condition.structuralForm.AName=mode.name):($scope.structural.hide(),$scope.condition.structuralForm.name=mode.name)},$scope.selectStructuralFormB=function(mode){$scope.condition.structuralForm.name=mode.name,$scope.structuralDetail.hide(),$scope.structural.hide()},$ionicModal.fromTemplateUrl("build-type.html",{scope:$scope,animation:"slide-in-right"}).then(function(modal){$scope.buildType=modal}),$scope.openBuildType=function(){$scope.buildingTypes?$scope.buildType.show():projectService.getBuildingType(function(data){$scope.buildingTypes=data,$scope.buildType.show()})},$ionicModal.fromTemplateUrl("build-type-detail.html",{scope:$scope,animation:"slide-in-right"}).then(function(modal){$scope.buildTypeDetail=modal}),$scope.openBuildTypeDetail=function(){$scope.buildTypeDetail.show()},$ionicModal.fromTemplateUrl("build-type-detail-detail.html",{scope:$scope,animation:"slide-in-right"}).then(function(modal){$scope.buildTypeDetailDetail=modal}),$scope.selectBuildingTypeA=function(buildType){$scope.condition.buildingType.Aid=buildType.id,buildType.subs.length>0?($scope.buildingTypesB=buildType.subs,$scope.buildTypeDetail.show(),$scope.condition.buildingType.AName=buildType.name):($scope.buildType.hide(),$scope.condition.buildingType.name=buildType.name)},$scope.selectBuildingTypeB=function(buildType){$scope.condition.buildingType.Bid=buildType.id,$scope.condition.buildingType.BName=buildType.name,buildType.subs.length>0?($scope.buildingTypesC=buildType.subs,$scope.buildTypeDetailDetail.show()):($scope.buildType.hide(),$scope.buildTypeDetail.hide(),$scope.condition.buildingType.name=buildType.name)},$scope.selectBuildingTypeC=function(buildType){$scope.condition.buildingType.Cid=buildType.id,$scope.buildType.hide(),$scope.buildTypeDetail.hide(),$scope.buildTypeDetailDetail.hide(),$scope.condition.buildingType.name=buildType.name},$scope.doPrjSearch=function(){$scope.reloadData(),$scope.modalQueryMore.hide()},$scope.resetCondition=function(){$scope.condition=projectService.resetCondition()},$ionicModal.fromTemplateUrl("province.html",{scope:$scope,animation:"slide-in-right"}).then(function(modal){$scope.modalProvince=modal}),$scope.openProvince=function(){0==$scope.condition.provinces.length?projectService.getAreas(function(data){$scope.condition.provinces=data,$scope.modalProvince.show()},[{field:"level",value:2,operator:"=",relation:""}]):$scope.modalProvince.show()},$ionicModal.fromTemplateUrl("city.html",{scope:$scope,animation:"slide-in-right"}).then(function(modal){$scope.modalCity=modal}),$scope.selectProvince=function(obj){if($scope.condition.provinceText=projectService.getProvinceText($scope.condition.provinces),obj.checked)projectService.getAreas(function(data){data.unshift({id:0,name:"全部",checked:!1}),$scope.province=obj,$scope.cities=data,$scope.modalCity.show()},[{field:"pId",value:obj.id,operator:"=",relation:""}]);else{var index=projectService.getIndex($scope.condition.provinces,obj.id,"id");$scope.condition.provinces[index].cityText="",projectService.clearCityData($scope.condition.cities,obj.id)}},$scope.selectCity=function(){projectService.clearCityData($scope.condition.cities,$scope.cities[0].pId,function(){for(var checkAllFlag=!1,i=0;i<$scope.cities.length;i++){var city=$scope.cities[i];city.checked&&0==city.id&&(checkAllFlag=!0)}for(var cities=[],j=0;j<$scope.cities.length;j++){var flag=checkAllFlag?$scope.cities[j].id>0:$scope.cities[j].checked;flag&&($scope.condition.cities.push($scope.cities[j].id),cities.push({id:$scope.cities[j].id,name:$scope.cities[j].name}))}var text=projectService.getCityText(cities),index=projectService.getIndex($scope.condition.provinces,$scope.cities[1].pId,"id");$scope.condition.provinces[index].cityText=text,$scope.modalCity.hide()})}}]),angular.module("app.market.ep.project").controller("ProjectPunishDetailController",["$scope","$stateParams","ProjectService",function($scope,$stateParams,projectService){$scope.attachment=!0,$scope.attachmentShow=function(){$scope.attachment=!$scope.attachment},$scope.punish=$stateParams.punish,projectService.getPunishAttach($stateParams.punish.punishid,function(data){$scope.attaches=data}),$scope.download=function(attach){projectService.downloadAttach(attach)}}]),angular.module("app.market.ep.project").factory("ProjectService",["YTService","UserService",function(YT,userService){var projectList=[],pageIndex=0,pageSize=10,condition={org:{orgId:0,orgName:"不限"},provinces:[],cities:[],contractMode:{Aid:0,name:"不限",Bid:0,AName:""},buildingType:{Aid:0,name:"不限",Bid:0,Cid:0,AName:"",BName:""},structuralForm:{Aid:0,name:"不限",Bid:0,AName:""},amount:{max:null,min:null},manager:{id:0,name:"不限"},director:{id:0,name:"不限"},isCompleted:-1,fundingSources:{id:0,name:"不限"},property:{id:0,name:"不限"},startTime:{max:"",min:""},endTime:{max:"",min:""},managerText:"",directorText:"",provinceText:"不限"},hasNextPage=!0;return{loadProjectList:function(successCallBack){++pageIndex;var self=this;self.getSearchData(function(data1){YT.query({data:data1,successCallback:function(data){self.loadProjectListCallBack(data),successCallBack()}})})},getSearchData:function(callback){var self=this;self.getTopOrgId(function(id){var filter=[{field:"topOrgId",value:id,operator:"=",relation:"and"}];filter=self.getSearchFilter(filter);var data={m:5001002,t:"v_market_ep_project",order:"id desc",page:pageIndex,rows:pageSize,filter:JSON.stringify(filter)};callback(data)})},getTopOrgId:function(callback){var typeId=userService.getTypeId(),rootId=userService.getRootOrgId();1==typeId?callback(rootId-1):2==typeId&&YT.query({data:{m:5001002,t:"org_org",filter:JSON.stringify([{field:"id",operator:"=",value:rootId,relation:""}])},successCallback:function(data){callback(data.object[0].pid)}})},getProjectList:function(){return projectList},getCondition:function(){return condition},getSearchFilter:function(filter){if(condition.org.orgId>0&&filter.push({field:"orgId",value:condition.org.orgId,operator:"=",relation:"and"}),condition.amount.max&&filter.push({field:"contractamount",value:condition.amount.max,operator:"<=",relation:"and"}),condition.amount.min&&filter.push({field:"contractamount",value:condition.amount.min,operator:">=",relation:"and"}),condition.manager.id>0&&filter.push({field:"managerid",value:condition.manager.id,operator:"=",relation:"and"}),condition.director.id>0&&filter.push({field:"technicaldirectorid",value:condition.director.id,operator:"=",relation:"and"}),condition.startTime.max&&filter.push({field:"starttime",value:condition.startTime.max,operator:"<=",relation:"and"}),condition.startTime.min&&filter.push({field:"starttime",value:condition.startTime.min,operator:">=",relation:"and"}),condition.endTime.max&&filter.push({field:"endTime",value:condition.endTime.max,operator:"<=",relation:"and"}),condition.endTime.min&&filter.push({field:"endTime",value:condition.endTime.min,operator:">=",relation:"and"}),condition.isCompleted>-1&&filter.push({field:"isCompleted",value:condition.isCompleted,operator:"=",relation:"and"}),condition.contractMode.Bid>0&&filter.push({field:"contractmodeBid",value:condition.contractMode.Bid,operator:"=",relation:"and"}),condition.contractMode.Aid>0&&filter.push({field:"contractmodeAid",value:condition.contractMode.Aid,operator:"=",relation:"and"}),condition.buildingType.Cid>0&&filter.push({field:"buildingtypeCid",value:condition.buildingType.Cid,operator:"=",relation:"and"}),condition.buildingType.Bid>0&&filter.push({field:"buildingtypeBid",value:condition.buildingType.Bid,operator:"=",relation:"and"}),condition.buildingType.Aid>0&&filter.push({field:"buildingtypeAid",value:condition.buildingType.Aid,operator:"=",relation:"and"}),condition.structuralForm.Aid>0&&filter.push({field:"structuralformsAid",value:condition.structuralForm.Aid,operator:"=",relation:"and"}),condition.structuralForm.Bid>0&&filter.push({field:"structuralformsBid",value:condition.structuralForm.Bid,operator:"=",relation:"and"}),condition.property.id>0&&filter.push({field:"projectpropertyid",value:condition.property.id,operator:"=",relation:"and"}),condition.fundingSources.id>0&&filter.push({field:"fundingsourceid",value:condition.fundingSources.id,operator:"=",relation:"and"}),condition.cities.length>0){for(var subFilter=[],i=0;i<condition.cities.length;i++){var city=condition.cities[i];subFilter.push({field:"cityId",value:city,operator:"=",relation:"or"})}filter.push(subFilter)}return filter},loadPrjDetail:function(empid,callback){YT.query({data:{m:5001001,t:"v_market_ep_project",filter:JSON.stringify([{field:"id",operator:"=",value:empid,relation:""}])},successCallback:function(data){callback(data.object[0])}})},getPageIndex:function(){return pageIndex},hasNextPage:function(){return hasNextPage},loadProjectListCallBack:function(data){for(var _projectList=data.object.items,i=0;i<_projectList.length;i++)projectList.push(_projectList[i]);hasNextPage=!(pageIndex>=data.object.pageCount)},setProjectList:function(_projectList){projectList=_projectList},refreshListData:function(successCallBack){this.resetCondition(),this.reloadData(successCallBack)},reloadData:function(successCallBack){this.resetCachedData(),this.loadProjectList(successCallBack)},resetCachedData:function(){this.setPageIndex(0),this.setHasNextPage(!0),this.setProjectList([])},resetCondition:function(){return condition.org={orgId:0,orgName:"不限"},condition.cities=[],condition.provinces=[],condition.provinceText="不限",condition.contractMode={Aid:0,name:"不限",Bid:0,AName:""},condition.buildingType={Aid:0,name:"不限",Bid:0,Cid:0,AName:"",BName:""},condition.structuralForm={Aid:0,name:"不限",Bid:0,AName:""},condition.amount={max:null,min:null},condition.manager={id:0,name:"不限"},condition.director={id:0,name:"不限"},condition.isCompleted=-1,condition.fundingSources={id:0,name:"不限"},condition.property={id:0,name:"不限"},condition.startTime={max:"",min:""},condition.endTime={max:"",min:""},condition.directorText="",condition.managerText="",condition},setPageIndex:function(_pageIndex){pageIndex=_pageIndex},setHasNextPage:function(_pageIndex){hasNextPage=_pageIndex},getProjectAttach:function(empid,callback){YT.query({data:{m:5001001,t:"v_market_ep_project_attach",filter:JSON.stringify([{field:"id",operator:"=",value:empid,relation:""}])},successCallback:function(data){callback(data.object)}})},getAward:function(id,callback){YT.query({data:{m:5001001,t:"v_market_ep_project_award",filter:JSON.stringify([{field:"id",operator:"=",value:id,relation:""}])},successCallback:function(data){callback(data.object)}})},getPunish:function(id,callback){YT.query({data:{m:5001001,t:"market_ep_project_punish",filter:JSON.stringify([{field:"id",operator:"=",value:id,relation:""}])},successCallback:function(data){callback(data.object)}})},getParam:function(id,callback){YT.query({data:{m:5001001,t:"v_market_ep_project_parameter",filter:JSON.stringify([{field:"id",operator:"=",value:id,relation:""}])},successCallback:function(data){for(var paramMap=[],unit=[],i=0;i<data.object.length;i++){var param=data.object[i];"unit"==param.paramKey?unit.push(param.paramValue):"quantityUnit"==param.paramKey?unit.push(param.paramValue):paramMap.push(param)}if(unit.length>0)for(var j=0;j<paramMap.length;j++)"quantity"==paramMap[j].paramKey?paramMap[j].paramUnit=unit[1]:"bussinessScale"==paramMap[j].paramKey&&(paramMap[j].paramUnit=unit[0]);callback(paramMap)}})},getAwardAttach:function(id,callback){YT.query({data:{m:5001001,t:"market_ep_project_award_attach",filter:JSON.stringify([{field:"id",operator:"=",value:id,relation:""}])},successCallback:function(data){callback(data.object)}})},getPunishAttach:function(id,callback){YT.query({data:{m:5001001,t:"market_ep_project_punish_attach",filter:JSON.stringify([{field:"id",operator:"=",value:id,relation:""}])},successCallback:function(data){callback(data.object)}})},getSubCompany:function(callback){YT.query({data:{m:5001002,t:"org_org",filter:JSON.stringify([{field:"id",value:userService.getRootOrgId(),operator:"=",relation:"and"}])},successCallback:function(result){if(200==result.status){var filter=[[{field:"type",value:2,operator:"=",relation:"or"},{field:"type",value:1,operator:"=",relation:"and"}],{field:"pid",value:result.object[0].pid,operator:"=",relation:""}];YT.query({data:{m:5001002,t:"org_org",filter:JSON.stringify(filter)},successCallback:function(data){callback(data.object)}})}else $.alert(result.message)}})},downloadAttach:function(attach){YT.download(attach)},getEmps:function(callback){this.getTopOrgId(function(id){YT.query({data:{m:5001002,t:"v_market_ep_employee",filter:JSON.stringify([{field:"topOrgId",value:id,operator:"=",relation:""}])},successCallback:function(data){callback(data.object)}})})},getDatePickerTime:function(success){var currentDate=new Date,date=new Date(currentDate.getFullYear(),currentDate.getMonth(),currentDate.getDate()),time={date:date,mondayFirst:!1,months:["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"],daysOfTheWeek:["日","一","二","三","四","五","六"],startDate:new Date(1989,1,26),endDate:new Date(2024,1,26),disablePastDays:!1,disableSwipe:!1,disableWeekend:!1,disableDates:"",showDatepicker:!1,showTodayButton:!1,calendarMode:!1,hideCancelButton:!0,hideSetButton:!0,callback:success};return time},getTreeData:function(callback,table){var self=this;YT.query({data:{m:5002001,t:table},successCallback:function(data){for(var tree=[],i=0;i<data.object.length;i++)if(0==data.object[i].pId){var result=self.listToTree(data.object,data.object[i].id);data.object[i].subs=result,tree.push(data.object[i])}callback(tree)}})},listToTree:function(data,pid){for(var temp,result=[],self=this,i=0;i<data.length;i++)if(data[i].pId==pid){var obj=data[i];temp=self.listToTree(data,data[i].id),temp.length>0?obj.subs=temp:obj.subs=[],result.push(obj)}return result},getBuildingType:function(callback){this.getTreeData(callback,"market_d_buildingtype")},getStructuralForm:function(callback){this.getTreeData(callback,"market_d_structuralforms")},getContractMode:function(callback){this.getTreeData(callback,"market_d_contractmode")},getProjectProperties:function(callback){YT.query({data:{m:5002001,t:"market_d_projectproperty"},successCallback:function(data){callback(data.object)}})},getFundingSources:function(callback){YT.query({data:{m:5002001,t:"market_d_fundingsource"},successCallback:function(data){callback(data.object)}})},getAreas:function(callback,filter){YT.query({data:{m:5002001,t:"dictionary_area",filter:JSON.stringify(filter)},successCallback:function(data){for(var i=0;i<data.object.length;i++)data.object[i].checked=!1,data.object[i].cityText="";callback(data.object)}})},getProvinceText:function(array){for(var checked=[],i=0;i<array.length;i++)array[i].checked&&checked.push(array[i]);var text="不限";return 1==checked.length?text=checked[0].name:checked.length>=2&&(text=checked[0].name+"等"),text},getCityText:function(arr){var text="";return 1==arr.length?text=arr[0].name:2==arr.length&&(text=arr[0].name+"等"),text},getIndex:function(arr,value,key){for(var index=-1,i=0;i<arr.length;i++)key?arr[i][key]==value&&(index=i):arr[i]==value&&(index=i);return index},clearCityData:function(arr,id,callback){this.getAreas(function(data){for(var i=0;i<data.length;i++){var index=arr.indexOf(data[i].id);index>-1&&arr.splice(index,1)}callback&&callback()},[{field:"pId",value:id,operator:"=",relation:""}])}}}]);