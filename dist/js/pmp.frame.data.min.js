angular.module("app.frame.dashboard").controller("BusinessManagementController",["$scope","$state","SubscribeModuleService","BusinessManagementService","ContractService","ResponserService",function($scope,$state,subscribeModuleService,businessManagementService,contractService,responserService){$scope.$on("$ionicView.beforeEnter",function(){$scope.selectedModules=businessManagementService.getSelectedModules(),$scope.slideHasChanged($scope.selectedModules[0].moduleId,$scope.selectedModules[0].moduleName,$scope.selectedModules[0].shortName)}),$scope.getUrl=function(module){return module.url},$scope.back=function(){$state.go("tabs.dashboard")},$scope.slideHasChanged=function(moduleId,moduleName,shortName){$scope.nowYear=contractService.getNowYear()+"",$scope.yearList=contractService.getYearList(),18==moduleId?responserService.getResponserList("1",$scope.nowYear,function(basis,data){$scope.responserList=data}):6==moduleId&&"合同"==shortName&&contractService.getContractList("1",$scope.nowYear,function(name,basis,data){$scope.cellName=name,$scope.basis=basis,$scope.contractList=data})}}]),angular.module("app.frame.dashboard").controller("ContractController",["$scope","ContractService",function($scope,ContractService){$scope.refreshListData=function(){$scope.fillData(),$scope.$broadcast("scroll.refreshComplete")},$scope.showDetailByYear=function(){$scope.fillData()},$scope.showDetailByType=function(){$scope.fillData()},$scope.fillData=function(){ContractService.getContractList($scope.statisticType,$scope.nowYear,function(name,basis,data){$scope.cellName=name,$scope.basis=basis,$scope.contractList=data})}}]),angular.module("app.frame.dashboard").controller("DashboardController",["$scope","$ionicModal","DashboardService","$state","$stateParams","SubscribeModuleService","ContractService","ResponserService","ContractProjectService","UserService","LocalStorageService","LoginService","OfficeService","CommonService",function($scope,$ionicModal,dashboardService,$state,$stateParams,subscribeModuleService,contractService,responserService,contractProjectService,userService,localStorageService,loginService,officeService,commonService){$scope.getUrl=function(module){return module.url},$scope.slideHasChanged=function(moduleId,moduleName,shortName){$scope.nowYear=contractService.getNowYear()+"",$scope.yearList=contractService.getYearList(),18==moduleId?responserService.getResponserList("1",$scope.nowYear,function(basis,data){$scope.responserList=data}):10==moduleId?$scope.loadDataByM():12==moduleId?$scope.loadDataByD():13==moduleId?$scope.loadDataBySubContract():6==moduleId&&"合同-项目部"==shortName?$scope.loadDataByC():6==moduleId&&"合同"==shortName&&contractService.getContractList("1",$scope.nowYear,function(name,basis,data){$scope.cellName=name,$scope.basis=basis,$scope.contractList=data})},$scope.$on("$ionicView.beforeEnter",function(){$scope.news=dashboardService.getNewsList(),$scope.hasNextPage=dashboardService.hasNextPage(),$scope.selectedModules=subscribeModuleService.getSelectedModules(),subscribeModuleService.setSelectedProjects(),$scope.selectProjects=subscribeModuleService.getSelectedProjects();for(var businessModules=[],i=0;i<$scope.selectedModules.length;i++)null==$scope.selectedModules[i].projects&&businessModules.push($scope.selectedModules[i]);3==subscribeModuleService.getMaxTypeObj().type?$scope.slideBoxTemp=3:$scope.selectProjects.length>0&&subscribeModuleService.getMaxTypeObj().type<3&&businessModules.length>0?($scope.slideBoxTemp=1,$scope.tempModules=[{moduleName:"企业管理",url:"businessManagement"},{moduleName:"项目管理",url:"projectManagement"}],$scope.tempModules.unshift({moduleId:0,moduleName:"最新动态",shortName:"最新动态",url:"modules/frame/dashboard/news.html"})):0==$scope.selectProjects.length&&subscribeModuleService.getMaxTypeObj().type<3&&businessModules.length>0?$scope.slideBoxTemp=2:$scope.selectProjects.length>0&&subscribeModuleService.getMaxTypeObj().type<3&&0==businessModules.length?$scope.slideBoxTemp=4:$scope.slideBoxTemp=3,1!=$scope.slideBoxTemp&&$scope.selectedModules.unshift({moduleId:0,moduleName:"最新动态",shortName:"最新动态",url:"modules/frame/dashboard/news.html"}),commonService.bindScope($scope)}),$scope.handleProblem=function(newsId,url,id){dashboardService.queryNewsWithId(newsId,function(result){dashboardService.clearCachedData(),localStorageService.setObject("currentOrgId",result.orgId),loginService.cacheCurrentUserInfo(function(){officeService.setOrgName(result.orgName),dashboardService.queryNewsNum(function(){}),$state.go(url,{id:id,backUrl:"tabs.dashboard"})})})},$scope.goSubscribeModule=function(){$state.go("subscribeModule")},$scope.loadListData=function(){dashboardService.loadListData(function(){$scope.fillData(),$scope.$broadcast("scroll.infiniteScrollComplete")})},$scope.fillData=function(){$scope.news=dashboardService.getNewsList(),$scope.hasNextPage=dashboardService.hasNextPage()},$scope.refreshListData=function(){dashboardService.refreshListData(function(){$scope.fillData(),$scope.$broadcast("scroll.refreshComplete")})},$scope.$on("$ionicView.beforeLeave",function(){dashboardService.clearCached()})}]),angular.module("app.frame.dashboard").controller("ModuleController",["$scope","ModuleService","$ionicPopup","UserService","$state",function($scope,moduleService,$ionicPopup,userService,$state){$scope.showCheckbox=function(){$state.go("/news/projectList")}}]),angular.module("app.frame.dashboard").controller("ProjectController",["$scope","SubscribeModuleService","$state",function($scope,subscribeModuleService,$state){$scope.$on("$ionicView.beforeEnter",function(){$scope.searchText="",$scope.nowChooseSubModule=subscribeModuleService.getNowChooseSubModule(),$scope.projects=subscribeModuleService.getProjects(),$scope.hasNextPage=subscribeModuleService.hasNextPage()}),$scope.clearSearchText=function(){$scope.searchText=""},$scope.goBack=function(){subscribeModuleService.setModuleChecked(),subscribeModuleService.clearCachedData(),$state.go("subscribeModule")},$scope.confirmChoose=function(){subscribeModuleService.setChooseOrg($scope.projects),subscribeModuleService.clearCachedData(),$state.go("subscribeModule")},$scope.setProjectsChecked=function(){for(var i=0;i<$scope.projects.length;i++)for(var j=0;j<$scope.nowChooseSubModule.projects.length;j++)if($scope.nowChooseSubModule.projects[j].id==$scope.projects[i].id){$scope.nowChooseSubModule.projects[j].checked&&($scope.projects[i].checked=!0);break}},$scope.loadListData=function(){subscribeModuleService.loadProjectListData($scope.searchText,function(){$scope.fillData(),$scope.$broadcast("scroll.infiniteScrollComplete")})},$scope.refreshListData=function(){$scope.searchText="",subscribeModuleService.refreshProjectListData($scope.searchText,function(){$scope.fillData(),$scope.$broadcast("scroll.refreshComplete")})},$scope.search=function(){subscribeModuleService.clearCachedData(),$scope.loadListData()},$scope.fillData=function(){$scope.projects=subscribeModuleService.getProjects(),$scope.hasNextPage=subscribeModuleService.hasNextPage(),$scope.setProjectsChecked()}}]),angular.module("app.frame.dashboard").controller("ProjectManagementController",["$scope","$state","SubscribeModuleService","ProjectManagementService","ContractService","CommonService",function($scope,$state,subscribeModuleService,projectManagementService,contractService,commonService){$scope.$on("$ionicView.beforeEnter",function(){commonService.bindScope($scope),$scope.selectedModules=projectManagementService.getSelectedModules(),$scope.slideHasChanged($scope.selectedModules[0].moduleId,$scope.selectedModules[0].moduleName,$scope.selectedModules[0].shortName)}),$scope.getUrl=function(module){return module.url},$scope.back=function(){$state.go("tabs.dashboard")},$scope.slideHasChanged=function(moduleId,moduleName,shortName){$scope.nowYear=contractService.getNowYear()+"",$scope.yearList=contractService.getYearList(),10==moduleId?$scope.loadDataByM():12==moduleId?$scope.loadDataByD():13==moduleId?$scope.loadDataBySubContract():6==moduleId&&"合同-项目部"==shortName&&$scope.loadDataByC()}}]),angular.module("app.frame.dashboard").controller("ResponserController",["$scope","ResponserService",function($scope,ResponserService){$scope.refreshListData=function(){$scope.fillData(),$scope.$broadcast("scroll.refreshComplete")},$scope.showDetailByYear=function(){$scope.fillData()},$scope.showDetailByType=function(){$scope.fillData()},$scope.fillData=function(){ResponserService.getResponserList($scope.statisticType,$scope.nowYear,function(basis,data){$scope.basis=basis,$scope.responserList=data})}}]),angular.module("app.frame.dashboard").controller("SubscribeModuleController",["$scope","$state","UserService","YTService","$ionicPopup","SubscribeModuleService",function($scope,$state,userService,ytService,$ionicPopup,subscribeModuleService){$scope.$on("$ionicView.beforeEnter",function(){$scope.getModules()}),$scope.getModules=function(){$scope.type=subscribeModuleService.getMaxTypeObj().type,$scope.businessModules=subscribeModuleService.getCloneBusinessModules(),$scope.projectModules=subscribeModuleService.getCloneProjectModules()},$scope.goBack=function(){subscribeModuleService.cloneModules(),$state.go("tabs.dashboard")},$scope.closeModal=function(){subscribeModuleService.cloneModules(),$state.go("tabs.dashboard")},$scope.save=function(){subscribeModuleService.save($scope,function(){$state.go("tabs.dashboard")})},$scope.clickWrapModule=function(wrapModule,moduleStr){if("businessModules"==moduleStr)for(var i=0;i<$scope.businessModules.length;i++){var businessModule=$scope.businessModules[i];if(businessModule.moduleId==wrapModule.moduleId){for(var j=0;j<businessModule.subModules.length;j++)for(var subModule=businessModule.subModules[j],k=0;k<subModule.length;k++)subModule[k].checked=businessModule.checked;break}}else{for(var i=0;i<$scope.projectModules.length;i++){var projectModule=$scope.projectModules[i];if(projectModule.moduleId==wrapModule.moduleId){for(var j=0;j<projectModule.subModules.length;j++)for(var projectSubModule=projectModule.subModules[j],k=0;k<projectSubModule.length;k++)projectSubModule[k].checked=projectModule.checked;break}}subscribeModuleService.setNowChooseSubModule(wrapModule),$scope.type<3&&$state.go("chooseProject")}},$scope.clickSubModule=function(wrapModule,moduleStr,subModule){if("businessModules"==moduleStr)for(var i=0;i<$scope.businessModules.length;i++){var businessModule=$scope.businessModules[i];if(businessModule.moduleId==wrapModule.moduleId){for(var uncheckedCount=0,j=0;j<businessModule.subModules.length;j++)for(var subModule=businessModule.subModules[j],k=0;k<subModule.length;k++)subModule[k].checked||uncheckedCount++;businessModule.checked=!uncheckedCount>0;break}}else{for(var i=0;i<$scope.projectModules.length;i++){var projectModule=$scope.projectModules[i];if(projectModule.moduleId==wrapModule.moduleId){for(var uncheckedCount=0,j=0;j<projectModule.subModules.length;j++)for(var projectSubModule=projectModule.subModules[j],k=0;k<projectSubModule.length;k++)projectSubModule[k].checked||uncheckedCount++;projectModule.checked=!uncheckedCount>0;break}}subscribeModuleService.setNowChooseSubModule(subModule),$scope.type<3&&$state.go("chooseProject")}}}]),angular.module("app.frame.dashboard").factory("BusinessManagementService",["SubscribeModuleService",function(subscribeModuleService){return{getSelectedModules:function(){for(var selectedModules=subscribeModuleService.getSelectedModules(),businessModules=subscribeModuleService.getBusinessModules(),modules=[],i=0;i<selectedModules.length;i++)for(var j=0;j<businessModules.length;j++)if(selectedModules[i].moduleId==businessModules[j].moduleId&&null==selectedModules[i].projects){modules.push(selectedModules[i]);break}return modules}}}]),angular.module("app.frame.dashboard").factory("CommonService",["ContractProjectService","SubscribeModuleService","MaterialService","DeviceService","DashBoardSubcontractService",function(contractProjectService,subscribeModuleService,materialService,deviceService,subcontractService){return{bindScope:function($scope){$scope.showOrgListByC=!1,$scope.showOrgListByM=!1,$scope.showOrgListByD=!1,subscribeModuleService.getOrgAndModule(),$scope.switchOrgListByC=function(){$scope.showOrgListByC=!$scope.showOrgListByC},$scope.changeOrgByC=function(orgId){$scope.showOrgListByC=!1,contractProjectService.setOrgId(orgId),$scope.loadDataByC()},$scope.refreshListDataByC=function(){$scope.loadDataByC(),$scope.$broadcast("scroll.refreshComplete")},$scope.loadDataByC=function(){var orgIdByC=contractProjectService.getOrgId(),objByC=subscribeModuleService.getObjByC(),orgListByC=subscribeModuleService.getOrgListByC(),orgNameByC="",moduleListByC=[];if(orgIdByC)orgNameByC=objByC[orgIdByC].name,moduleListByC=objByC[orgIdByC].moduleListByC;else{var obj=objByC[orgListByC[0].id];obj&&(contractProjectService.setOrgId(obj.id),subcontractService.setOrgId(obj.id),orgNameByC=obj.name,moduleListByC=obj.moduleListByC)}$scope.moduleByC={orgListByC:orgListByC,orgNameByC:orgNameByC,m60102:moduleListByC[60102]||!1,m60103:moduleListByC[60103]||!1,m60104:moduleListByC[60104]||!1,m60105:moduleListByC[60105]||!1,m60106:moduleListByC[60106]||!1,m60107:moduleListByC[60107]||!1},$scope.fillDataByC()},$scope.fillDataByC=function(){contractProjectService.loadData(function(){$scope.contractInfo=contractProjectService.getContractInfo(),$scope.meterAmount=contractProjectService.getSubMeterAmount()}),subcontractService.loadPersonCount(function(){$scope.personCount=subcontractService.getPersonCount()}),subcontractService.loadSalaryTotal(function(){$scope.salaryTotal=subcontractService.getSalaryTotal()}),subcontractService.loadSettlementTotal(function(){$scope.settlementTotal=subcontractService.getSettlementTotal()})},$scope.switchOrgListByM=function(){$scope.showOrgListByM=!$scope.showOrgListByM},$scope.changeOrgByM=function(orgId){$scope.showOrgListByM=!1,materialService.setOrgId(orgId),$scope.loadDataByM()},$scope.refreshListDataByM=function(){$scope.loadDataByM(),$scope.$broadcast("scroll.refreshComplete")},$scope.loadDataByM=function(){var orgIdByM=materialService.getOrgId(),objByM=subscribeModuleService.getObjByM(),orgListByM=subscribeModuleService.getOrgListByM(),orgNameByM="",moduleListByM=[];if(orgIdByM)orgNameByM=objByM[orgIdByM].name,moduleListByM=objByM[orgIdByM].moduleListByM;else{var obj=objByM[orgListByM[0].id];obj&&(materialService.setOrgId(obj.id),orgNameByM=obj.name,moduleListByM=obj.moduleListByM)}$scope.moduleByM={orgListByM:orgListByM,orgNameByM:orgNameByM,m100301:moduleListByM[100301]||!1,m100302:moduleListByM[100302]||!1,m100303:moduleListByM[100303]||!1,m100304:moduleListByM[100304]||!1,m100305:moduleListByM[100305]||!1,m100306:moduleListByM[100306]||!1},materialService.getMaterial(function(){$scope.fillDataByM()})},$scope.fillDataByM=function(){$scope.amount1=materialService.getAmount1(),$scope.balanceAmount1=materialService.getBalanceAmount1(),$scope.list1=materialService.getList1(),$scope.amount2=materialService.getAmount2(),$scope.balanceAmount2=materialService.getBalanceAmount2(),$scope.list2=materialService.getList2(),$scope.amount3=materialService.getAmount3(),$scope.list3=materialService.getList3(),$scope.amount4=materialService.getAmount4(),$scope.list4=materialService.getList4(),$scope.amount5=materialService.getAmount5(),$scope.list5=materialService.getList5(),$scope.amount6=materialService.getAmount6(),$scope.list6=materialService.getList6()},$scope.switchOrgListByD=function(){$scope.showOrgListByD=!$scope.showOrgListByD},$scope.changeOrgByD=function(orgId){$scope.showOrgListByD=!1,deviceService.setOrgId(orgId),$scope.loadDataByD()},$scope.supplierByRent=[],$scope.supplierByPur=[],$scope.supplierByCom=[],$scope.chooseSupplierByRent=function(n){$scope.supplierByRent[n]=!$scope.supplierByRent[n]},$scope.chooseSupplierByPur=function(n){$scope.supplierByPur[n]=!$scope.supplierByPur[n]},$scope.chooseSupplierByCom=function(n){$scope.supplierByCom[n]=!$scope.supplierByCom[n]},$scope.refreshListDataByD=function(){$scope.loadDataByD(),$scope.$broadcast("scroll.refreshComplete")},$scope.loadDataByD=function(){var orgIdByD=deviceService.getOrgId(),objByD=subscribeModuleService.getObjByD(),orgListByD=subscribeModuleService.getOrgListByD(),orgNameByD="",moduleListByD=[];if(orgIdByD)orgNameByD=objByD[orgIdByD].name,moduleListByD=objByD[orgIdByD].moduleListByD;else{var obj=objByD[orgListByD[0].id];obj&&(deviceService.setOrgId(objByD[orgListByD[0].id].id),orgNameByD=objByD[orgListByD[0].id].name,moduleListByD=objByD[orgListByD[0].id].moduleListByD)}$scope.moduleByD={orgListByD:orgListByD,orgNameByD:orgNameByD,m12001:moduleListByD[12001]||!1},deviceService.loadData(function(){$scope.fillDataByD()})},$scope.fillDataByD=function(){$scope.ownDLsit=deviceService.getOwnDevice(),$scope.rentDLsit=deviceService.getRentDevice(),$scope.purchaseDLsit=deviceService.getPurchaseDevice(),$scope.outCompanyDLsit=deviceService.getOutCompanyDevice()},$scope.loadDataBySubContract=function(){var orgNameBySubContract,moduleListBySubContract,orgId=subcontractService.getOrgId(),objBySubContract=subscribeModuleService.getObjBySubContract(),orgListBySubContract=subscribeModuleService.getOrgListBySubContract();orgId?(orgNameBySubContract=objBySubContract[orgId].name,moduleListBySubContract=objBySubContract[orgId].moduleListBySubContract):(subcontractService.setOrgId(objBySubContract[orgListBySubContract[0].id].id),orgNameBySubContract=objBySubContract[orgListBySubContract[0].id].name,moduleListBySubContract=objBySubContract[orgListBySubContract[0].id].moduleListBySubContract),$scope.moduleBySubContract={orgListBySubContract:orgListBySubContract,orgNameBySubContract:orgNameBySubContract,m13002001:moduleListBySubContract[13002001]||!1,m13002003:moduleListBySubContract[13002003]||!1,m13003002:moduleListBySubContract[13003002]||!1,m13003003:moduleListBySubContract[13003003]||!1},$scope.fillDataBySubContract()},$scope.fillDataBySubContract=function(){subcontractService.loadTeamCount(function(){$scope.teamCount=subcontractService.getTeamCount()}),subcontractService.loadPersonCount(function(){$scope.personCount=subcontractService.getPersonCount()}),subcontractService.loadSalaryTotal(function(){$scope.salaryTotal=subcontractService.getSalaryTotal()}),subcontractService.loadSettlementTotal(function(){$scope.settlementTotal=subcontractService.getSettlementTotal()}),subcontractService.loadTeamList(function(){$scope.teamList=subcontractService.getTeamList()})},$scope.refreshListDataBySubContract=function(){$scope.loadDataBySubContract(),$scope.$broadcast("scroll.refreshComplete")},$scope.changeOrgBySubContract=function(orgId,orgName){$scope.showOrgListByM=!1,subcontractService.setOrgId(orgId),$scope.loadDataBySubContract()},$scope.switchOrgListBySubContract=function(){$scope.showOrgListByM=!$scope.showOrgListByM}}}}]),angular.module("app.frame.dashboard").factory("ContractService",["YTService","UserService",function(YT,userService){var yearList=[],nowYear=(new Date).getFullYear(),cellName="";return{getNowYear:function(){return nowYear},getYearList:function(){yearList.length=0;for(var i=2013;i<=(new Date).getFullYear();i++)yearList.push({year:i});return yearList.reverse()},getBasisData:function(callback){var params={t:"v_dashboard_contract_summary",order:"groupId asc"};this.ajax(params,function(data){callback(data[0])})},getContractList:function(statisticType,year,callback){var self=this;nowYear=year,self.getBasisData(function(basis){switch(statisticType){case"1":self.getContractByOrg(function(data){cellName="公司名称",callback(cellName,basis,data)});break;case"2":self.getContractByArea(function(data){cellName="地域名称",callback(cellName,basis,data)});break;case"3":self.getContractByWorkCategory(1,function(data){cellName="房屋建筑工程",callback(cellName,basis,data)});break;case"4":self.getContractByWorkCategory(2,function(data){cellName="交通运输工程",callback(cellName,basis,data)});break;case"5":break;case"6":}})},getContractByOrg:function(callback){var params={t:"v_dashboard_contract_org",order:"orgId asc"};this.ajax(params,function(data){for(var contractList=[],i=0;i<data.length;i++){var obj=data[i];contractList.push({name:obj.orgName,amount:obj.newSignAmount,ratio:obj.ratio,reportAmount:obj.reportAmount})}callback(contractList)})},getContractByArea:function(callback){var params={t:"v_dashboard_contract_area",order:"provinceId asc"};this.ajax(params,function(data){for(var contractList=[],i=0;i<data.length;i++){var obj=data[i];contractList.push({name:obj.provinceName,amount:obj.amount,ratio:obj.ratio})}callback(contractList)})},getContractByWorkCategory:function(workCategoryId,callback){var params={filter:{field:"WorkCategoryId",value:workCategoryId,operator:"=",relation:"AND"},t:"v_dashboard_contract_workcategory",order:"subWorkCategoryId asc"};this.ajax(params,function(data){for(var contractList=[],i=0;i<data.length;i++){var obj=data[i];contractList.push({name:obj.subWorkCategoryName,amount:obj.amount,ratio:obj.ratio})}callback(contractList)})},ajax:function(params,callback){var filter=[{field:"groupId",value:userService.getRootOrgId(),operator:"=",relation:"AND"},{field:"year",value:nowYear,operator:"=",relation:"AND"}];void 0!=params.filter&&filter.push(params.filter);var data={m:1005,t:params.t,filter:JSON.stringify(filter),order:params.order};YT.query({data:data,successCallback:function(data){200==data.status&&callback(data.object)}})}}}]),angular.module("app.frame.dashboard").factory("ContractProjectService",["YTService","UserService","MaterialService",function(YT,userService){var orgId=0,contractInfo=[],subMeterAmount=0;return{loadData:function(callback){var self=this;contractInfo.length=0,subMeterAmount=0,self.setContractInfo(function(){self.setSubMeterAmount(function(){callback.call()})})},setContractInfo:function(callback){var filter=[{field:"projectId",value:orgId,operator:"=",relation:"AND"}],data={m:1005,t:"v_dashboard_contract_info",filter:JSON.stringify(filter)};YT.query({data:data,successCallback:function(data){200==data.status&&(contractInfo=data.object,callback())}})},setSubMeterAmount:function(callback){var filter=[{field:"orgId",value:orgId,operator:"=",relation:"AND"}],data={m:1005,t:"v_dashboard_subcontract_measure",filter:JSON.stringify(filter)};YT.query({data:data,successCallback:function(data){200==data.status&&(subMeterAmount=data.object[0].amount,callback())}})},getContractInfo:function(){return contractInfo},getSubMeterAmount:function(){return subMeterAmount},getOrgId:function(){return orgId},setOrgId:function(val){orgId=val}}}]),angular.module("app.frame.dashboard").factory("DashboardService",["YTService","LocalStorageService","UserService","$sce",function(YT,localStorageService,userService,$sce){var resultNews=[],news=[],pageIndex=0,pageSize=10,hasNextPage=!0,newsBadge={};return{getNewsList:function(){return news},loadListData:function(successCallback){resultNews.length=0,++pageIndex;var self=this;YT.query({data:self.getSearchData(),successCallback:function(data){self.loadListDataCallback(data),successCallback.call()}})},getSearchData:function(){var data={m:1005,t:"v_dashboard_news",order:"datetime desc",page:pageIndex,rows:pageSize},filter=this.getSearchFilter();return data.filter=JSON.stringify(filter),data.params=JSON.stringify({isMobile:!0}),data},getSearchFilter:function(){var filter=[];return filter.push([{field:"userId",value:0,operator:"=",relation:"OR"},{field:"userId",value:userService.getUserId(),operator:"=",relation:"AND"}]),filter},loadListDataCallback:function(data){for(var pageInfo=data.object,i=0;i<pageInfo.items.length;i++)resultNews.push(pageInfo.items[i]);this.structureNews(),hasNextPage=!(pageIndex>=pageInfo.pageCount)},refreshListData:function(successCallBack){this.clearCachedData(),this.loadListData(successCallBack)},clearCached:function(){pageIndex=0,hasNextPage=!0,news=[],resultNews=[]},clearCachedData:function(){pageIndex=0,hasNextPage=!0,news=[],resultNews=[],newsBadge={}},hasNextPage:function(){return hasNextPage},structureNews:function(){for(var tempObj={pushTime:resultNews[0].pushTime,details:[]},i=0;i<resultNews.length;i++){var resultNew=resultNews[i];resultNew.content=$sce.trustAsHtml(resultNew.content+resultNew.url),null==resultNew.moduleId?resultNew.imgSrc="modules/frame/dashboard/img/gg.svg":15001==resultNew.moduleId?resultNew.imgSrc="modules/frame/dashboard/img/safety.svg":16001==resultNew.moduleId?resultNew.imgSrc="modules/frame/dashboard/img/quality.svg":resultNew.moduleId.indexOf("1300")!=-1?resultNew.imgSrc="modules/frame/dashboard/img/subcontract.svg":resultNew.moduleId.indexOf("6001")!=-1||resultNew.moduleId.indexOf("6002")!=-1||resultNew.moduleId.indexOf("6003")!=-1?resultNew.imgSrc="modules/frame/dashboard/img/contract.svg":resultNew.moduleId.indexOf("18001")!=-1||resultNew.moduleId.indexOf("18002")!=-1?resultNew.imgSrc="modules/frame/dashboard/img/responsible.svg":resultNew.moduleId.indexOf("10001")!=-1||resultNew.moduleId.indexOf("10003")!=-1||resultNew.moduleId.indexOf("10004")!=-1||resultNew.moduleId.indexOf("10005")!=-1||resultNew.moduleId.indexOf("10007")!=-1||resultNew.moduleId.indexOf("10008")!=-1?resultNew.imgSrc="modules/frame/dashboard/img/material.svg":resultNew.moduleId.indexOf("12001")==-1&&resultNew.moduleId.indexOf("12002")==-1&&resultNew.moduleId.indexOf("12003")==-1||(resultNew.imgSrc="modules/frame/dashboard/img/device.svg"),resultNew.pushTime==tempObj.pushTime?tempObj.details.push(resultNew):(news.push(tempObj),tempObj={pushTime:resultNew.pushTime,details:[]},tempObj.details.push(resultNew))}news.push(tempObj)},queryNewsNum:function(callback){YT.query({data:{m:1005,t:"v_dashboard_newscount",filter:JSON.stringify([{field:"userId",value:userService.getUserId(),operator:"=",relation:"AND"},{field:"type",value:2,operator:"=",relation:"AND"},{field:"state",value:0,operator:"=",relation:"AND"}])},successCallback:function(data){0==data.object.length?newsBadge={}:newsBadge.num=data.object[0].num,callback()}})},getPageIndex:function(){return pageIndex},queryNewsWithId:function(newsId,callback){YT.query({data:{m:1005,t:"v_dashboard_news",filter:JSON.stringify([{field:"id",value:newsId,operator:"=",relation:"AND"}])},successCallback:function(data){200==data.status&&callback(data.object[0])}})},getNewsBadge:function(){return newsBadge}}}]),angular.module("app.frame.dashboard").factory("DeviceService",["YTService","UserService",function(YT,userService){var orgId=0,ownDetailList=[],rentList=[],purchaseList=[],outCompanyList=[];return{loadData:function(callback){var self=this;self.clearData(),self.setOwnDevice(function(){self.setRentDevice(function(){self.setPurchaseDevice(function(){self.setOutCompanyDevice(function(){callback.call()})})})})},clearData:function(){ownDetailList.length=0,rentList.length=0,purchaseList.length=0,outCompanyList.length=0},setOwnDevice:function(callback){var params={sourceId:1,order:"id asc"};this.ajax(params,function(data){for(var i=0;i<data.length;i++){var deviceName=data[i].number;ownDetailList.push({deviceName:deviceName})}callback()})},setRentDevice:function(callback){var params={sourceId:2,order:"supplierId asc"};this.ajax(params,function(data){for(var rentDetailList=[],i=0;i<data.length;i++){var rentId=data[i].supplierId,rentName=data[i].supplierName,deviceName=data[i].number;if(0==i)rentDetailList.push({deviceName:deviceName}),rentList.push({rentId:rentId,rentName:rentName,detail:rentDetailList});else{var rentIdBef=data[i-1].supplierId;rentId!=rentIdBef&&(rentList[rentList.length-1].detail=rentDetailList,rentDetailList=[],rentList.push({rentId:rentId,rentName:rentName})),rentDetailList.push({deviceName:deviceName}),i==data.length-1&&(rentList[rentList.length-1].detail=rentDetailList)}}callback()})},setPurchaseDevice:function(callback){var params={sourceId:4,order:"supplierId asc"};this.ajax(params,function(data){for(var purchaseDetailList=[],i=0;i<data.length;i++){var purchaseId=data[i].supplierId,purchaseName=data[i].supplierName,deviceName=data[i].number;if(0==i)purchaseDetailList.push({deviceName:deviceName}),purchaseList.push({rentId:purchaseId,rentName:purchaseName,detail:purchaseDetailList});else{var purchaseIdBef=data[i-1].supplierId;purchaseId!=purchaseIdBef&&(purchaseList[purchaseList.length-1].detail=purchaseDetailList,purchaseDetailList=[],purchaseList.push({rentId:purchaseId,rentName:purchaseName})),purchaseDetailList.push({deviceName:deviceName}),i==data.length-1&&(purchaseList[purchaseList.length-1].detail=purchaseDetailList)}}callback()})},setOutCompanyDevice:function(callback){var params={sourceId:6,order:"merchantId asc"};this.ajax(params,function(data){for(var outCompanyDetailList=[],i=0;i<data.length;i++){var merchantId=data[i].merchantId,merchantName=data[i].merchantName,deviceName=data[i].number;if(0==i)outCompanyDetailList.push({deviceName:deviceName}),outCompanyList.push({rentId:merchantId,rentName:merchantName,detail:outCompanyDetailList});else{var merchantIdBef=data[i-1].merchantId;merchantId!=merchantIdBef&&(outCompanyList[outCompanyList.length-1].detail=outCompanyDetailList,outCompanyDetailList=[],outCompanyList.push({rentId:merchantId,rentName:merchantName})),outCompanyDetailList.push({deviceName:deviceName}),i==data.length-1&&(outCompanyList[outCompanyList.length-1].detail=outCompanyDetailList)}}callback()})},ajax:function(params,callback){var filter=[{field:"orgId",value:orgId,operator:"=",relation:"AND"},{field:"sourceId",value:params.sourceId,operator:"=",relation:"AND"},{field:"outtime",value:"null",operator:"is",relation:"AND"}],data={m:1005,t:"v_deviceinfo_list",filter:JSON.stringify(filter),order:params.order};YT.query({data:data,successCallback:function(data){200==data.status&&callback(data.object)}})},getOrgId:function(){return orgId},setOrgId:function(val){orgId=val},getOwnDevice:function(){return ownDetailList},getRentDevice:function(){return rentList},getPurchaseDevice:function(){return purchaseList},getOutCompanyDevice:function(){return outCompanyList}}}]),angular.module("app.frame.dashboard").factory("MaterialService",["YTService","UserService",function(YT,userService){var amount1=0,balanceAmount1=0,amount2=0,balanceAmount2=0,amount3=0,amount4=0,amount5=0,amount6=0,list1=[],list2=[],list3=[],list4=[],list5=[],list6=[],orgId=0;return{getMaterial:function(callback){var self=this;self.clearMaterialData(),self.getPurchase(function(){self.getLease(function(){self.getReimburse(function(){self.getReturn(function(){self.getBroken(function(){self.getRecipients(function(){callback.call()})})})})})})},getPurchase:function(callback){var params={t:"v_dashboard_material_purchase",order:"merchantId asc"};this.ajax(params,function(data){for(var i=0;i<data.length;i++){var obj=data[i];list1.push(obj),amount1+=+obj.purchaseAmount,balanceAmount1+=+obj.balanceAmout}callback()})},getLease:function(callback){var params={t:"v_dashboard_material_lease",order:"merchantId asc"};this.ajax(params,function(data){for(var i=0;i<data.length;i++){var obj=data[i];list2.push(obj),amount2+=+obj.purchaseAmount,balanceAmount2+=+obj.balanceAmout}callback()})},getReimburse:function(callback){var params={t:"v_dashboard_material_reimburse",order:"teamName asc"};this.ajax(params,function(data){for(var i=0;i<data.length;i++){var obj=data[i];list4.push(obj),amount4+=+obj.amount}callback()})},getReturn:function(callback){var params={t:"v_dashboard_material_return",order:"projectId asc"};this.ajax(params,function(data){for(var i=0;i<data.length;i++){var obj=data[i];list5.push(obj),amount5+=+obj.amount}}),callback()},getBroken:function(callback){var params={t:"v_dashboard_material_broken",order:"projectId asc"};this.ajax(params,function(data){for(var i=0;i<data.length;i++){var obj=data[i];list6.push(obj),amount6+=+obj.amount}callback()})},getRecipients:function(callback){var filter=[{field:"orgId",value:orgId,operator:"=",relation:"AND"}],data={m:1005,t:"v_material_money_summary",filter:JSON.stringify(filter)};YT.query({data:data,successCallback:function(data){if(200==data.status){for(var i=0;i<data.object.length;i++){var obj=data.object[i];list3.push(obj),amount3+=+obj.deliveryAmounts;
}callback()}}})},ajax:function(params,callback){var filter=[{field:"projectId",value:orgId,operator:"=",relation:"AND"}],data={m:1005,t:params.t,filter:JSON.stringify(filter),order:params.order};YT.query({data:data,successCallback:function(data){200==data.status&&callback(data.object)}})},clearMaterialData:function(){amount1=0,balanceAmount1=0,amount2=0,balanceAmount2=0,amount3=0,amount4=0,amount5=0,amount6=0,list1.length=0,list2.length=0,list3.length=0,list4.length=0,list5.length=0,list6.length=0},getAmount1:function(){return amount1/1e4},getList1:function(){return list1},getBalanceAmount1:function(){return balanceAmount1/1e4},getAmount2:function(){return amount2/1e4},getList2:function(){return list2},getBalanceAmount2:function(){return balanceAmount2/1e4},getAmount3:function(){return amount3/1e4},getList3:function(){return list3},getAmount4:function(){return amount4/1e4},getList4:function(){return list4},getAmount5:function(){return amount5/1e4},getList5:function(){return list5},getAmount6:function(){return amount6/1e4},getList6:function(){return list6},getOrgId:function(){return orgId},setOrgId:function(val){orgId=val}}}]),angular.module("app.frame.dashboard").factory("ModuleService",function(){return{}}),angular.module("app.frame.dashboard").factory("ProjectManagementService",["SubscribeModuleService",function(subscribeModuleService){return{getSelectedModules:function(){for(var selectedModules=subscribeModuleService.getSelectedModules(),projectModules=subscribeModuleService.getProjectModules(),modules=[],i=0;i<selectedModules.length;i++)for(var j=0;j<projectModules.length;j++)if(selectedModules[i].moduleId==projectModules[j].moduleId&&null!=selectedModules[i].projects){modules.push(selectedModules[i]);break}return modules}}}]),angular.module("app.frame.dashboard").factory("ResponserService",["YTService","UserService","ContractService",function(YT,userService,ContractService){var nowYear=(new Date).getFullYear();return{getResponserList:function(statisticType,year,callback){var self=this;nowYear=year,ContractService.getBasisData(function(basis){switch(statisticType){case"1":var params={t:"v_org_responser_orginfo",param:{year:nowYear,groupId:userService.getRootOrgId()}};self.ajax(params,function(data){callback(basis,data)});break;case"2":var params={t:"v_org_responser_operation_org_year",filter:[{field:"groupId",value:userService.getRootOrgId(),operator:"=",relation:"AND"},{field:"year",value:nowYear,operator:"=",relation:"AND"}]};self.ajax(params,function(data){callback(basis,data)})}})},ajax:function(params,callback){var data={m:1005,t:params.t};params.filter&&(data.filter=JSON.stringify([params.filter])),params.param&&(data.params=JSON.stringify(params.param)),YT.query({data:data,successCallback:function(data){200==data.status&&(data.object.splice(0,1),callback(data.object))}})}}}]),angular.module("app.frame.dashboard").factory("DashBoardSubcontractService",["YTService","UserService",function(YT,userService){var orgId=0,teamCount=0,personCount=0,salaryTotal=0,settlementTotal=0,teamList=[];return{getOrgId:function(){return orgId},setOrgId:function(id){orgId=id},loadTeamCount:function(callback){var filter=[{field:"orgId",value:orgId,operator:"=",relation:"AND"}],data={m:"1005",t:"v_subcontract_team",filter:JSON.stringify(filter)};YT.query({data:data,successCallback:function(data){200==data.status&&(teamCount=data.object.length,callback())}})},loadPersonCount:function(callback){var filter=[{field:"orgId",value:orgId,operator:"=",relation:"AND"}],data={m:"1005",t:"v_subcontract_person",filter:JSON.stringify(filter)};YT.query({data:data,successCallback:function(data){200==data.status&&(personCount=data.object.length,callback())}})},loadSalaryTotal:function(callback){var filter=[{field:"orgId",value:orgId,operator:"=",relation:"AND"}],data={m:"1005",t:"v_dashboard_subcontract_salarytotal",filter:JSON.stringify(filter)};YT.query({data:data,successCallback:function(data){200==data.status&&(salaryTotal=data.object[0].salaryTotal,callback())}})},loadSettlementTotal:function(callback){var filter=[{field:"orgId",value:orgId,operator:"=",relation:"AND"}],data={m:"1005",t:"v_dashboard_subcontract_settlementtotal",filter:JSON.stringify(filter)};YT.query({data:data,successCallback:function(data){200==data.status&&(settlementTotal=data.object[0].settlementTotal,callback())}})},loadTeamList:function(callback){var filter=[{field:"orgId",value:orgId,operator:"=",relation:"AND"}],data={m:"1005",t:"v_dashboard_subcontract_team",filter:JSON.stringify(filter)};YT.query({data:data,successCallback:function(data){200==data.status&&(teamList=data.object,callback())}})},getTeamCount:function(){return teamCount},getPersonCount:function(){return personCount},getSalaryTotal:function(){return salaryTotal},getSettlementTotal:function(){return settlementTotal},getTeamList:function(){return teamList}}}]),angular.module("app.frame.dashboard").factory("SubscribeModuleService",["YTService","UserService","$ionicPopup",function(YT,userService,$ionicPopup){var businessModules=[],projectModules=[],cloneBusinessModules=[],cloneProjectModules=[],nowChooseSubModule=null,maxTypeObj=null,selectProjects=[],objByC=[],objByM=[],objByD=[],objBySubContract=[],orgListByC=[],orgListByM=[],orgListByD=[],orgListBySubContract=[],projects=[],pageIndex=0,pageSize=10,hasNextPage=!0;return businessModules.push({moduleName:"合同管理",url:"modules/frame/dashboard/contract.html",shortName:"合同",moduleId:6,checked:!1,subModules:[[{moduleName:"总承包合同",url:"",moduleId:6001001,checked:!1,subModules:[]},{moduleName:"分包合同",url:"",moduleId:6001002,checked:!1,subModules:[]}],[{moduleName:"材料采购合同",url:"",moduleId:6001003,checked:!1,subModules:[]},{moduleName:"材料租赁合同",url:"",moduleId:6001004,checked:!1,subModules:[]}],[{moduleName:"设备采购合同",url:"",moduleId:6001005,checked:!1,subModules:[]},{moduleName:"设备租赁合同",url:"",moduleId:6001006,checked:!1,subModules:[]}],[{moduleName:"其他合同",url:"",moduleId:6001007,checked:!1,subModules:[]}]]},{moduleName:"责任人管理",url:"modules/frame/dashboard/responser.html",shortName:"责任人",moduleId:18,checked:!1,subModules:[[{moduleName:"责任人动态",url:"",moduleId:18001,checked:!1,subModules:[]},{moduleName:"内部经营协议",url:"",moduleId:18002,checked:!1,subModules:[]}]]}),projectModules.push({moduleName:"合同管理",url:"modules/frame/dashboard/contract-project.html",shortName:"合同-项目部",moduleId:6,checked:!1,projects:[],subModules:[[{moduleName:"分包合同",url:"",moduleId:6001002,parentModuleId:6,checked:!1,subModules:[],projects:[]},{moduleName:"材料采购合同",url:"",moduleId:6001003,parentModuleId:6,checked:!1,subModules:[],projects:[]}],[{moduleName:"材料租赁合同",url:"",moduleId:6001004,parentModuleId:6,checked:!1,subModules:[],projects:[]},{moduleName:"设备采购合同",url:"",moduleId:6001005,parentModuleId:6,checked:!1,subModules:[],projects:[]}],[{moduleName:"设备租赁合同",url:"",moduleId:6001006,parentModuleId:6,checked:!1,subModules:[],projects:[]},{moduleName:"其他合同",url:"",moduleId:6001007,parentModuleId:6,checked:!1,subModules:[],projects:[]}]]},{moduleName:"材料管理",url:"modules/frame/dashboard/material.html",shortName:"材料",moduleId:10,checked:!1,projects:[],subModules:[[{moduleName:"材料入库",url:"",moduleId:10003001001,parentModuleId:10,checked:!1,subModules:[],projects:[]},{moduleName:"材料出库",url:"",moduleId:10003001002,parentModuleId:10,checked:!1,subModules:[],projects:[]}],[{moduleName:"材料退库",url:"",moduleId:10003001003,parentModuleId:10,checked:!1,subModules:[],projects:[]},{moduleName:"材料报废",url:"",moduleId:10003001004,parentModuleId:10,checked:!1,subModules:[],projects:[]}],[{moduleName:"材料结算",url:"",moduleId:10003001005,parentModuleId:10,checked:!1,subModules:[],projects:[]},{moduleName:"材料退货",url:"",moduleId:10003001006,parentModuleId:10,checked:!1,subModules:[],projects:[]}]]},{moduleName:"设备管理",url:"modules/frame/dashboard/device.html",shortName:"设备",moduleId:12,checked:!1,projects:[],subModules:[[{moduleName:"设备信息",url:"",moduleId:12001,parentModuleId:12,checked:!1,subModules:[],projects:[]}]]},{moduleName:"分包管理",url:"modules/frame/dashboard/subcontract.html",shortName:"分包",moduleId:13,checked:!1,projects:[],subModules:[[{moduleName:"劳务进退场",url:"",moduleId:13002001,parentModuleId:13,checked:!1,subModules:[],projects:[]},{moduleName:"劳务工资",url:"",moduleId:13002003,parentModuleId:13,checked:!1,subModules:[],projects:[]}],[{moduleName:"分包计量",url:"",moduleId:13003002,parentModuleId:13,checked:!1,subModules:[],projects:[]},{moduleName:"分包结算",url:"",moduleId:13003003,parentModuleId:13,checked:!1,subModules:[],projects:[]}]]}),{getBusinessModules:function(){return businessModules},getProjectModules:function(){return projectModules},getCloneBusinessModules:function(){return cloneBusinessModules},getCloneProjectModules:function(){return cloneProjectModules},cloneModules:function(){cloneBusinessModules=YT.clone(businessModules),cloneProjectModules=YT.clone(projectModules)},getUserTypeInfo:function(callback){YT.query({data:{m:1005,t:"v_frame_org_user",filter:JSON.stringify([{field:"userId",value:userService.getUserId(),operator:"=",relation:"AND"}])},successCallback:function(data){if(200==data.status){for(var maxType=data.object[0].type,obj=data.object[0],i=1;i<data.object.length;i++)data.object[i].type<maxType&&(maxType=data.object[i].type,obj=data.object[i]);callback(obj)}}})},getSearchData:function(searchText){var filter=[{field:"type",value:3,operator:"=",relation:"and"}];1==maxTypeObj.type?filter.push({field:"groupId",value:maxTypeObj.rootId,operator:"=",relation:"and"}):2==maxTypeObj.type&&filter.push({field:"pid",value:maxTypeObj.rootId,operator:"=",relation:"and"}),void 0!=searchText&&""!=searchText&&filter.push({field:"name",value:"%"+searchText+"%",operator:"like",relation:"and"});var data={m:1003,t:"v_org_org_extend",filter:JSON.stringify(filter),page:pageIndex,rows:pageSize};return data},setProjectModulesOrg:function(data){for(var i=0;i<projectModules.length;i++){var projectModule=projectModules[i];projectModule.projects.length=0,angular.forEach(data,function(data,index){projectModule.projects.push({id:data.id,name:data.name,checked:!1})});for(var j=0;j<projectModule.subModules.length;j++)for(var projectSubModule=projectModule.subModules[j],k=0;k<projectSubModule.length;k++)projectSubModule[k].projects.length=0,angular.forEach(data,function(data,index){projectSubModule[k].projects.push({id:data.id,name:data.name,checked:!1})})}},getSubscribeModules:function(callback){var filter=[{field:"userId",value:userService.getUserId(),operator:"=",relation:"and"}],data={m:1005,t:"dashboard_modules_subscribe",filter:JSON.stringify(filter)};YT.query({data:data,successCallback:function(data){200==data.status&&callback(data.object)}})},setSubscribeModules:function(){this.getSubscribeModules(function(data){if(maxTypeObj.type<3)for(var i=0;i<businessModules.length;i++){for(var businessModule=businessModules[i],uncheckedCount=0,j=0;j<businessModule.subModules.length;j++)for(var subModule=businessModule.subModules[j],k=0;k<subModule.length;k++){for(var u=0;u<data.length;u++){var subscribeOrgId=userService.getRootOrgId();if(3==userService.getTypeId()&&(subscribeOrgId=maxTypeObj.rootId),data[u].subscribeOrgId==subscribeOrgId&&data[u].moduleId==subModule[k].moduleId){subModule[k].checked=!0;break}}subModule[k].checked||uncheckedCount++}businessModule.checked=0==uncheckedCount}for(var i=0;i<projectModules.length;i++){for(var projectModule=projectModules[i],uncheckedCount=0,j=0;j<projectModule.subModules.length;j++)for(var subModule=projectModule.subModules[j],z=0;z<subModule.length;z++){if(maxTypeObj.type<3){for(var k=0;k<subModule[z].projects.length;k++)for(var module=subModule[z].projects[k],u=0;u<data.length;u++)if(data[u].subscribeOrgId==module.id&&data[u].moduleId==subModule[z].moduleId){subModule[z].projects[k].checked=!0,subModule[z].checked=!0;break}}else for(var u=0;u<data.length;u++)if(subModule[z].moduleId==data[u].moduleId){subModule[z].checked=!0;break}subModule[z].checked||uncheckedCount++}projectModule.checked=0==uncheckedCount}cloneBusinessModules=YT.clone(businessModules),cloneProjectModules=YT.clone(projectModules)})},getSubProject:function(pid,callback,searchText){var filter=[{field:"type",value:3,operator:"=",relation:"and"},{field:"pid",value:pid,operator:"=",relation:""}];void 0!=searchText&&""!=searchText&&filter.push({field:"name",value:"%"+searchText+"%",operator:"like",relation:"and"});var data={m:1003,t:"v_org_org_extend",filter:JSON.stringify(filter)};YT.query({data:data,successCallback:function(data){200==data.status&&callback(data.object)}})},getGroupProject:function(groupId,callback,searchText){var filter=[{field:"type",value:3,operator:"=",relation:"and"},{field:"groupId",value:groupId,operator:"=",relation:""}];void 0!=searchText&&""!=searchText&&filter.push({field:"name",value:"%"+searchText+"%",operator:"like",relation:"and"});var data={m:1003,t:"v_org_org_extend",filter:JSON.stringify(filter)};YT.query({data:data,successCallback:function(data){200==data.status&&callback(data.object)}})},setNowChooseSubModule:function(subModule){nowChooseSubModule=subModule},getNowChooseSubModule:function(){return nowChooseSubModule},setChooseOrg:function(projects){if(nowChooseSubModule.hasOwnProperty("shortName")){for(var flag=!1,k=0;k<nowChooseSubModule.projects.length;k++)for(var g=0;g<projects.length;g++)if(projects[g].id==nowChooseSubModule.projects[k].id){nowChooseSubModule.projects[k].checked=projects[g].checked,nowChooseSubModule.projects[k].checked&&(flag=!0);break}nowChooseSubModule.checked=flag;for(var j=0;j<nowChooseSubModule.subModules.length;j++)for(var subModule=nowChooseSubModule.subModules[j],z=0;z<subModule.length;z++){subModule[z].checked=flag;for(var o=0;o<subModule[z].projects.length;o++)subModule[z].projects[o].checked=nowChooseSubModule.projects[o].checked}}else{for(var flag=!1,k=0;k<nowChooseSubModule.projects.length;k++)for(var g=0;g<projects.length;g++)if(projects[g].id==nowChooseSubModule.projects[k].id){nowChooseSubModule.projects[k].checked=projects[g].checked,nowChooseSubModule.projects[k].checked&&(flag=!0);break}nowChooseSubModule.checked=flag,flag=!1;for(var i=0;i<cloneProjectModules.length;i++){for(var projectModule=cloneProjectModules[i],j=0;j<projectModule.projects.length;j++)projectModule.projects[j].checked=!1;if(projectModule.moduleId==nowChooseSubModule.parentModuleId){for(var j=0;j<projectModule.subModules.length;j++)for(var subModule=projectModule.subModules[j],z=0;z<subModule.length;z++)subModule[z].checked||(flag=!0);projectModule.checked=!flag;break}}}},setModuleChecked:function(){if(nowChooseSubModule.hasOwnProperty("shortName")){for(var flag=!1,k=0;k<nowChooseSubModule.projects.length;k++)if(nowChooseSubModule.projects[k].checked){nowChooseSubModule.checked=!0,flag=!0;break}flag||(nowChooseSubModule.checked=!1);for(var selectCount=0,j=0;j<nowChooseSubModule.subModules.length;j++)for(var subModule=nowChooseSubModule.subModules[j],z=0;z<subModule.length;z++){for(var k=0;k<subModule[z].projects.length;k++)if(subModule[z].projects[k].checked){subModule[z].checked=!0,selectCount++,flag=!0;break}flag||(subModule[z].checked=!1),flag=!1}for(var moduleCount=0,i=0;i<nowChooseSubModule.subModules.length;i++)for(var subModule=nowChooseSubModule.subModules[i],z=0;z<subModule.length;z++)moduleCount++;selectCount==moduleCount&&(nowChooseSubModule.checked=!0)}else{for(var flag=!1,k=0;k<nowChooseSubModule.projects.length;k++)if(nowChooseSubModule.projects[k].checked){nowChooseSubModule.checked=!0,flag=!0;break}flag||(nowChooseSubModule.checked=!1);for(var moduleCount=0,selectCount=0,i=0;i<cloneProjectModules.length;i++){var projectModule=cloneProjectModules[i];if(projectModule.moduleId==nowChooseSubModule.parentModuleId){for(var j=0;j<projectModule.subModules.length;j++)for(var subModule=projectModule.subModules[j],z=0;z<subModule.length;z++)moduleCount++,subModule[z].checked&&selectCount++;projectModule.checked=selectCount==moduleCount;break}}}},save:function($scope,callback){var datas=[],type=$scope.type;if(type<3){for(var i=0;i<cloneProjectModules.length;i++)for(var projectModule=cloneProjectModules[i],j=0;j<projectModule.subModules.length;j++)for(var subModule=projectModule.subModules[j],z=0;z<subModule.length;z++)if(subModule[z].checked)for(var k=0;k<subModule[z].projects.length;k++){var module=subModule[z].projects[k];module.checked&&datas.push({userId:userService.getUserId(),moduleId:subModule[z].moduleId,subscribeOrgId:module.id})}for(var i=0;i<cloneBusinessModules.length;i++)for(var businessModule=cloneBusinessModules[i],j=0;j<businessModule.subModules.length;j++)for(var subModule=businessModule.subModules[j],k=0;k<subModule.length;k++)if(subModule[k].checked){var subscribeOrgId=userService.getRootOrgId();3==userService.getTypeId()&&(subscribeOrgId=maxTypeObj.rootId),datas.push({userId:userService.getUserId(),moduleId:subModule[k].moduleId,subscribeOrgId:subscribeOrgId})}}else for(var i=0;i<cloneProjectModules.length;i++)for(var projectModule=cloneProjectModules[i],j=0;j<projectModule.subModules.length;j++)for(var subModule=projectModule.subModules[j],z=0;z<subModule.length;z++)subModule[z].checked&&datas.push({userId:userService.getUserId(),moduleId:subModule[z].moduleId,subscribeOrgId:userService.getRootOrgId()});YT.delete({data:{m:1005,t:"dashboard_modules_subscribe",filter:JSON.stringify([{field:"userId",value:userService.getUserId(),operator:"=",relation:"AND"}]),params:JSON.stringify({datas:datas})},successCallback:function(data){if(200==data.status){var alertPopup=$ionicPopup.alert({title:"提示",template:"订阅成功！"});alertPopup.then(function(res){businessModules=YT.clone(cloneBusinessModules),projectModules=YT.clone(cloneProjectModules),callback()})}}})},setSelectedProjects:function(){if(maxTypeObj.type<3){selectProjects.length=0;for(var i=0;i<projectModules.length;i++)for(var projectModule=projectModules[i],j=0;j<projectModule.subModules.length;j++)for(var subModule=projectModule.subModules[j],z=0;z<subModule.length;z++)for(var k=0;k<subModule[z].projects.length;k++)if(subModule[z].projects[k].checked){for(var flag=!1,b=0;b<selectProjects.length;b++)if(selectProjects[b].id==subModule[z].projects[k].id){flag=!0,selectProjects[b].modules.push({moduleId:subModule[z].moduleId,parentModuleId:projectModule.moduleId});break}flag||selectProjects.push({id:subModule[z].projects[k].id,name:subModule[z].projects[k].name,checked:!0,modules:[{moduleId:subModule[z].moduleId,parentModuleId:projectModule.moduleId}]})}}},getSelectedModules:function(){var selectedModules=[];if(maxTypeObj.type<3)for(var i=0;i<businessModules.length;i++){for(var businessModule=businessModules[i],flag=!1,j=0;j<businessModule.subModules.length&&!flag;j++)for(var subModule=businessModule.subModules[j],k=0;k<subModule.length&&!flag;k++)if(subModule[k].checked){flag=!0;break}flag&&selectedModules.push(businessModule)}for(var i=0;i<projectModules.length;i++){for(var projectModule=projectModules[i],flag=!1,j=0;j<projectModule.subModules.length&&!flag;j++)for(var subModule=projectModule.subModules[j],z=0;z<subModule.length&&!flag;z++)if(subModule[z].checked){flag=!0;break}flag&&selectedModules.push(projectModule)}return selectedModules},loadProjectListData:function(searchText,successCallback){++pageIndex;var self=this;YT.query({data:self.getSearchData(searchText),successCallback:function(data){self.loadListDataCallback(data),successCallback.call()}})},loadListDataCallback:function(data){for(var pageInfo=data.object,i=0;i<pageInfo.items.length;i++)projects.push(pageInfo.items[i]);hasNextPage=!(pageIndex>=pageInfo.pageCount)},refreshProjectListData:function(searchText,successCallBack){this.clearCachedData(),this.loadProjectListData(searchText,successCallBack)},clearCachedData:function(){pageIndex=0,hasNextPage=!0,projects=[]},hasNextPage:function(){return hasNextPage},getProjects:function(){return projects},setMaxTypeObj:function(data){return maxTypeObj=data},getMaxTypeObj:function(){return maxTypeObj},getSelectedProjects:function(){return selectProjects},getOrgAndModule:function(){var self=this;orgListByC.length=0,orgListByM.length=0,orgListByD.length=0,orgListBySubContract.length=0;for(var i=0;i<selectProjects.length;i++){for(var moduleListByC=[],moduleListByM=[],moduleListByD=[],moduleListBySubContract=[],pModuleByC=0,pModuleByM=0,pModuleByD=0,pModuleBySubContract=0,org=selectProjects[i],id=org.id,name=org.name,modules=org.modules,j=0;j<modules.length;j++){var module=modules[j],moduleId=module.moduleId,parentModuleId=module.parentModuleId;6==parentModuleId&&(pModuleByC=6,6001002==moduleId&&(moduleListByC[60102]=!0),6001003==moduleId&&(moduleListByC[60103]=!0),6001004==moduleId&&(moduleListByC[60104]=!0),6001005==moduleId&&(moduleListByC[60105]=!0),6001006==moduleId&&(moduleListByC[60106]=!0),6001007==moduleId&&(moduleListByC[60107]=!0)),10==parentModuleId&&(pModuleByM=10,10003001001==moduleId&&(moduleListByM[100301]=!0),10003001002==moduleId&&(moduleListByM[100302]=!0),10003001003==moduleId&&(moduleListByM[100303]=!0),10003001004==moduleId&&(moduleListByM[100304]=!0),10003001005==moduleId&&(moduleListByM[100305]=!0),10003001006==moduleId&&(moduleListByM[100306]=!0)),12==parentModuleId&&(pModuleByD=12,12001==moduleId&&(moduleListByD[12001]=!0)),13==parentModuleId&&(pModuleBySubContract=13,13002001==moduleId&&(moduleListBySubContract[13002001]=!0),13002003==moduleId&&(moduleListBySubContract[13002003]=!0),13003002==moduleId&&(moduleListBySubContract[13003002]=!0),13003003==moduleId&&(moduleListBySubContract[13003003]=!0))}pModuleByC&&(orgListByC.push({id:id,name:name}),objByC[id]={id:id,name:name,moduleListByC:moduleListByC}),pModuleByM&&(orgListByM.push({id:id,name:name}),objByM[id]={id:id,name:name,moduleListByM:moduleListByM}),pModuleByD&&(orgListByD.push({id:id,name:name}),objByD[id]={id:id,name:name,moduleListByD:moduleListByD}),pModuleBySubContract&&(orgListBySubContract.push({id:id,name:name}),objBySubContract[id]={id:id,name:name,moduleListBySubContract:moduleListBySubContract})}if(3==maxTypeObj.type){var rootOrgId=userService.getRootOrgId(),orgName=userService.getRootOrgName(),moduleListByC=[],moduleListByM=[],moduleListByD=[],moduleListBySubContract=[];orgListByC.length=0,orgListByM.length=0,orgListByD.length=0,orgListBySubContract.length=0,orgListByC.push({id:rootOrgId,name:orgName}),orgListByM.push({id:rootOrgId,name:orgName}),orgListByD.push({id:rootOrgId,name:orgName}),orgListBySubContract.push({id:rootOrgId,name:orgName});for(var modules=self.getSelectedModules(),i=0;i<modules.length;i++)for(var j=0;j<modules[i].subModules.length;j++)for(var subModule=modules[i].subModules[j],k=0;k<subModule.length;k++){var module=subModule[k],moduleId=module.moduleId;6==modules[i].moduleId?(6001002==moduleId&&(moduleListByC[60102]=!0),6001003==moduleId&&(moduleListByC[60103]=!0),6001004==moduleId&&(moduleListByC[60104]=!0),6001005==moduleId&&(moduleListByC[60105]=!0),6001006==moduleId&&(moduleListByC[60106]=!0),6001007==moduleId&&(moduleListByC[60107]=!0)):10==modules[i].moduleId?(10003001001==moduleId&&(moduleListByM[100301]=!0),10003001002==moduleId&&(moduleListByM[100302]=!0),10003001003==moduleId&&(moduleListByM[100303]=!0),10003001004==moduleId&&(moduleListByM[100304]=!0),10003001005==moduleId&&(moduleListByM[100305]=!0),10003001006==moduleId&&(moduleListByM[100306]=!0)):12==modules[i].moduleId?12001==moduleId&&(moduleListByD[12001]=!0):13==modules[i].moduleId&&(13002001==moduleId&&(moduleListBySubContract[13002001]=!0),13002003==moduleId&&(moduleListBySubContract[13002003]=!0),13003002==moduleId&&(moduleListBySubContract[13003002]=!0),13003003==moduleId&&(moduleListBySubContract[13003003]=!0))}objByC[rootOrgId]={id:rootOrgId,name:orgName,moduleListByC:moduleListByC},objByD[rootOrgId]={id:rootOrgId,name:orgName,moduleListByD:moduleListByD},objByM[rootOrgId]={id:rootOrgId,name:orgName,moduleListByM:moduleListByM},objBySubContract[rootOrgId]={id:rootOrgId,name:orgName,moduleListBySubContract:moduleListBySubContract}}},getOrgListByC:function(){return orgListByC},getOrgListByM:function(){return orgListByM},getOrgListByD:function(){return orgListByD},getObjByC:function(){return objByC},getObjByM:function(){return objByM},getObjByD:function(){return objByD},getOrgListBySubContract:function(){return orgListBySubContract},getObjBySubContract:function(){return objBySubContract}}}]),angular.module("app.frame.login").factory("LoginService",["$http","env","LocalStorageService","UserService","YTService",function($http,env,localStorageService,userService,YT){return{loginCheck:function(username,password){return $http({method:"POST",url:env.server+"login",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:{userName:username,password:password,platform:2}})},cacheUserInfo:function(data){for(var rootOrgId=localStorageService.getObject("currentOrgId"),length=data.orgList.length,hasOrg=!1,i=0;i<length;i++)if(data.orgList[i].rootOrgId==rootOrgId){hasOrg=!0;break}hasOrg||localStorageService.setObject("currentOrgId",data.orgList[0].rootOrgId),localStorageService.setObject("orgList",data.orgList),localStorageService.setObject("moduleList",data.moduleList)},cacheCurrentUserInfo:function(success){var filter=[{field:"rootId",value:userService.getRootOrgId(),operator:"=",relation:""}],data={m:0,t:"v_frame_org_user",filter:JSON.stringify(filter)};YT.query({data:data,successCallback:function(data){200==data.status&&(localStorageService.setObject("userInfo",data.object[0]),success())}})}}}]),angular.module("app.frame.office").controller("MenuController",["$scope","$state","$stateParams","MenuService","PrimaryService",function($scope,$state,$stateParams,menuService,primaryService){null!=$stateParams.menuList&&menuService.setMenuList($stateParams.menuList),$scope.menu=menuService.getMenuList(),$scope.goContractDetail=function(){primaryService.goContractDetail()},$scope.goBack=function(){$state.go("tabs.office")}}]),angular.module("app.frame.office").factory("MenuService",["YTService","UserService",function(YT,userService){var menuList=null;return{setMenuList:function(list){menuList=list},getMenuList:function(){return menuList}}}]),angular.module("app.frame.login").factory("OfficeService",["YTService","UserService","LocalStorageService",function(YT,userService,localStorageService){var menuTree=null,orgName=null;return{getMenuList:function(success,change){if(null!=menuTree&&1!=change)return success(menuTree);var filter=[{field:"rootOrgId",value:userService.getRootOrgId(),operator:"=",relation:""}],data={m:0,t:"v_frame_menu_mobile",filter:JSON.stringify(filter)};YT.query({data:data,successCallback:function(data){return menuTree=new YTM.Util.Tree({data:data.object,sortField:"dispOrder"}),success(menuTree)}})},getRootOrgName:function(){return null==orgName?userService.getRootOrgName():orgName},setOrgName:function(name){orgName=name},clearAll:function(){menuTree=null,orgName=null}}}]),angular.module("app.frame.setting").controller("ChangeEmailController",["$scope","SettingService","$stateParams","$ionicPopup","$state",function($scope,settingService,$stateParams,$ionicPopup,$state){$scope.$on("$ionicView.beforeEnter",function(){settingService.getUserDetail(function(data){$scope.modifyUser=data})}),$scope.updateEmail=function(){settingService.upDateUser({email:$scope.modifyUser.email},function(result){200==result.status?$ionicPopup.alert({template:"修改成功！"}).then(function(res){$state.go("tabs.setting")}):$ionicPopup.alert({template:"修改失败,请稍后再试！"})})}}]),angular.module("app.frame.setting").controller("ChangePasswordController",["$scope","SettingService","$stateParams","$ionicPopup","$state",function($scope,settingService,$stateParams,$ionicPopup,$state){$scope.$on("$ionicView.beforeEnter",function(){$scope.pd={oldPd:"",newPd:"",newPdRepeat:""}}),$scope.updatePassword=function(){settingService.updatePassword($scope.pd.oldPd,$scope.pd.newPd,$scope.pd.newPdRepeat,function(){$state.go("/login")})}}]),angular.module("app.frame.setting").controller("ChangeTelephoneController",["$scope","SettingService","$stateParams","$ionicPopup","$state",function($scope,settingService,$stateParams,$ionicPopup,$state){$scope.$on("$ionicView.beforeEnter",function(){settingService.getUserDetail(function(data){$scope.modifyUser=data})}),$scope.updateTelephone=function(){settingService.upDateUser({telephone:$scope.modifyUser.telephone},function(result){200==result.status?$ionicPopup.alert({template:"修改成功！"}).then(function(res){$state.go("tabs.setting")}):$ionicPopup.alert({template:"修改失败,请稍后再试！"})})}}]),angular.module("app.frame.setting").controller("SettingController",["$scope","$ionicActionSheet","SettingService","$state","LocalStorageService","OfficeService","DashboardService",function($scope,$ionicActionSheet,settingService,$state,localStorageService,officeService,dashboardService){$scope.addAttachment=function(){$ionicActionSheet.show({buttons:[{text:"相机"},{text:"图库"}],cancelText:"关闭",cancel:function(){return!0},buttonClicked:function(index){return!0}})},$scope.$on("$ionicView.beforeEnter",function(){settingService.getUserDetail(function(data){$scope.user=data})}),$scope.editTelephone=function(){$state.go("frame/setting/change-telephone")},$scope.logOut=function(){localStorageService.remove("tkt"),localStorageService.remove("currentOrgId"),localStorageService.remove("orgList"),localStorageService.remove("moduleList"),localStorageService.remove("userInfo"),localStorageService.remove("notification"),officeService.clearAll(),dashboardService.clearCachedData(),JPushTool.stop(),$state.go("login")}}]),angular.module("app.frame.setting").factory("SettingService",["YTService","UserService","$ionicPopup",function(YT,userService,$ionicPopup){return{getUserDetail:function(callback){var filter=[{field:"id",value:userService.getUserId(),operator:"=",relation:"and"}];YT.query({data:{m:1004,t:"v_org_user",filter:JSON.stringify(filter)},successCallback:function(data){var login=data.object[0];callback(login)}})},upDateUser:function(data,callback){var filter=[{field:"id",value:userService.getUserId(),operator:"=",relation:"and"}];YT.update({data:{m:1004,t:"org_user",v:JSON.stringify([{t:"org_user",data:data,filter:filter}])},successCallback:callback})},updatePassword:function(old,newPd,newPdConfirm,callback){if(newPd.length<6)$ionicPopup.alert({template:"新密码最少6位！"});else if(old.length>15||newPd.length>15)$ionicPopup.alert({template:"密码最多15位！"});else if(newPd!=newPdConfirm)$ionicPopup.alert({template:"密码和确认密码填写不一致！"});else{var filter=[{field:"id",value:userService.getUserId(),operator:"=",relation:""}],userData={password:newPd},data={m:1002,t:"org_user",v:JSON.stringify([{t:"org_user",data:userData,filter:filter}]),params:'{"oldPd": "'+old+'"}'};YT.update({data:data,successCallback:function(data){200==data.status?$ionicPopup.alert({template:"密码修改成功！"}).then(function(res){callback()}):$ionicPopup.alert({template:data.object})}})}},isTelephoneRepeated:function(telephone,id,callback){var userId=0;id&&(userId=id);var filter=[{field:"telephone",value:telephone,operator:"=",relation:"and"},{field:"id",value:userId,operator:"<>",relation:"and"}];YT.query({data:{m:1004,t:"v_org_user",filter:JSON.stringify(filter)},successCallback:function(data){data.object.length>0?$ionicPopup.alert({template:"该号码已存在！"}):callback()}})}}}]);