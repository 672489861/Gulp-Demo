angular.module("app.frame.office",["com.yt.mui","app.service","app.frame.login"]).controller("OfficeController",["$scope","$state","$ionicPopup","OfficeService","UserService","LocalStorageService","$stateParams","LoginService","DashboardService","SubscribeModuleService",function($scope,$state,$ionicPopup,officeService,userService,localStorageService,$stateParams,loginService,dashboardService,subscribeModuleService){$scope.$on("$ionicView.loaded",function(){subscribeModuleService.getUserTypeInfo(function(data){subscribeModuleService.setMaxTypeObj(data),1==data.type?subscribeModuleService.getGroupProject(data.rootId,function(data){subscribeModuleService.setProjectModulesOrg(data),subscribeModuleService.setSubscribeModules()}):2==data.type?subscribeModuleService.getSubProject(data.rootId,function(data){subscribeModuleService.setProjectModulesOrg(data),subscribeModuleService.setSubscribeModules()}):subscribeModuleService.setSubscribeModules()})}),$scope.$on("$ionicView.beforeEnter",function(){$scope.orgList=userService.getOrgList(),$scope.orgName=officeService.getRootOrgName(),officeService.getMenuList(function(menuTree){$scope.menuList=menuTree.getNodes()});var width=window.screen.width/414;document.getElementById("ytH5Viewport").setAttribute("content","width=414, initial-scale="+width+", maximum-scale="+width+", user-scalable=no"),$scope.getNewsNum()}),$scope.getNewsNum=function(){dashboardService.queryNewsNum(function(){$scope.badges=dashboardService.getNewsBadge()})};var eventHandler={handleEvents:function(){this.handleChangeOrg(),this.handleSearchMenu(),this.handleSelectedMenu()},handleSearchMenu:function(){$scope.clearSearchText=function(){$scope.searchText=""}},handleChangeOrg:function(){$scope.showOrgList=!1,$scope.changeOrg=function(id,orgName){$scope.badges.num=0,dashboardService.clearCachedData(),$scope.showOrgList=!1,localStorageService.setObject("currentOrgId",id),loginService.cacheCurrentUserInfo(function(){}),officeService.getMenuList(function(menuTree){$scope.menuList=menuTree.getNodes()},!0),officeService.setOrgName(orgName),$scope.orgName=officeService.getRootOrgName(),$scope.getNewsNum()},$scope.switchOrgList=function(){$scope.showOrgList=!$scope.showOrgList}},handleSelectedMenu:function(){$scope.selectedMenu=function(data){$state.go("menu",{menuList:data})}}};eventHandler.handleEvents()}]),angular.module("app.frame",["ionic","app.frame.login","app.frame.office","app.frame.setting","app.frame.dashboard"]),angular.module("app.frame").config(function($ionicConfigProvider){$ionicConfigProvider.tabs.position("bottom"),$ionicConfigProvider.tabs.style("standard ")}).config(function($stateProvider,$urlRouterProvider){$stateProvider.state("tabs",{url:"/tabs",abstract:!0,templateUrl:"modules/frame/tabs/tabs.html",controller:"OfficeController"}).state("tabs.dashboard",{url:"/dashboard",cache:!1,views:{dashboard:{templateUrl:"modules/frame/dashboard/dashboard.html",controller:"DashboardController"}},params:{noRefresh:null}}).state("tabs.phone",{url:"/phone",views:{phone:{templateUrl:"modules/frame/phone/phone.html"}}}).state("tabs.office",{url:"/office",views:{office:{templateUrl:"modules/frame/office/office.html",controller:"OfficeController"}}}).state("tabs.setting",{url:"/setting",views:{setting:{templateUrl:"modules/frame/setting/setting.html",controller:"SettingController"}}}).state("login",{url:"/login",templateUrl:"modules/frame/login/login.html",controller:"LoginController"}).state("subscribeModule",{url:"/subscribeModule",templateUrl:"modules/frame/dashboard/choose-modal.html",controller:"SubscribeModuleController"}).state("chooseProject",{url:"/news/chooseProject",templateUrl:" modules/frame/dashboard/projectList.html",controller:"ProjectController"}).state("businessManagement",{url:"/dashboard/businessManagement",templateUrl:" modules/frame/dashboard/businessManagement.html",controller:"BusinessManagementController"}).state("projectManagement",{url:"/dashboard/projectManagement",templateUrl:" modules/frame/dashboard/projectManagement.html",controller:"ProjectManagementController"}),$urlRouterProvider.otherwise("/login")}),angular.module("app.frame.setting",[]).config(function($stateProvider,$urlRouterProvider){$stateProvider.state("frame/setting/change-telephone",{url:"frame/setting/change-telephone",templateUrl:"modules/frame/setting/change-telephone.html",controller:"ChangeTelephoneController"}).state("frame/setting/change-password",{url:"frame/setting/change-password",templateUrl:"modules/frame/setting/change-password.html",controller:"ChangePasswordController"}).state("frame/setting/change-email",{url:"frame/setting/change-email",templateUrl:"modules/frame/setting/change-email.html",controller:"ChangeEmailController"})}),angular.module("app.frame.dashboard",[]).config(function($stateProvider,$urlRouterProvider,$compileProvider){$compileProvider.directive("compile",function($compile){return function(scope,element,attrs){scope.$watch(function(scope){return scope.$eval(attrs.compile)},function(value){element.html(value),$compile(element.contents())(scope)})}})}),angular.module("app.frame.office").config(function($stateProvider,$urlRouterProvider){$stateProvider.state("menu",{url:"/menu",templateUrl:"modules/frame/office/menu.html",controller:"MenuController",cache:!1,params:{menuList:null}})}),angular.module("app.frame.login",["app.config","com.yt.mui"]).controller("LoginController",["LoginService","LocalStorageService","$scope","$ionicPopup","$state","UserService","$rootScope","$stateParams","$cordovaToast",function(loginService,localStorageService,$scope,$ionicPopup,$state,userService,$rootScope,$stateParams,$cordovaToast){$scope.loginInfo={username:"",password:"",rememberPassword:!1,autoLogin:!1},$scope.$on("$ionicView.beforeEnter",function(){$scope.openNotification=$stateParams.openNotification}),$scope.login=function(){loginService.loginCheck($scope.loginInfo.username,$scope.loginInfo.password).success(function(data){if(200==data.status){if(0==data.object.orgList.length)return void $ionicPopup.alert("您的账户未与组织机构关联，请联系管理员!");localStorageService.setObject("rememberPassword",$scope.loginInfo.rememberPassword),localStorageService.setObject("tkt",data.object.ticket),loginService.cacheUserInfo(data.object,$scope.loginInfo),loginService.cacheCurrentUserInfo(function(){document.addEventListener("deviceready",function(){JPushTool.init({alias:userService.getUserId(),openNotification:function(data){userService.getUserId()&&userService.getRootOrgId()?$rootScope.openPushMessage(data.extras.checkId,data.extras.module):(localStorageService.set("notification",data),$cordovaToast.showShortCenter("请先登录应用！"),$state.go("login",{openNotification:"true"}))}}),JPushTool.isPushStopped(function(){JPushTool.resumePush()})},!1),"true"==$scope.openNotification&&$rootScope.openPushMessage(localStorageService.get("notification")),$state.go("tabs.office",{login:"success"})})}else $ionicPopup.alert({title:"提示",template:"用户名或密码错误!"})}).error(function(){$ionicPopup.alert({title:"提示",template:"服务器异常,请稍后重试!"})})}}]);